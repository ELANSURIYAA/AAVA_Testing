### Documentation for Hive Script: `HiveHQL_Sales_Category_Revenue.sql`

---

#### 1. Script Overview
**Purpose**:  
The script calculates the top 3 categories by revenue for each region over the past 12 months. It aims to provide insights into category performance across regions, helping the business identify high-performing product categories and regions.

**Data Sources**:  
- `sales`: Contains sales transaction data, including `order_id`, `product_id`, `region_id`, `order_date`, `quantity`, and `price`.
- `products`: Contains product details, including `product_id` and `category_id`.
- `regions`: Contains region details, including `region_id`.

**KPI Definitions**:  
- **Total Revenue**: Calculated as `SUM(quantity * price)` for each category in a region.
- **Average Order Value**: Calculated as `AVG(quantity * price)` for each category in a region.
- **Category Rank**: Rank of a category within a region based on total revenue, in descending order.

---

#### 2. Query Breakdown

**Step 1: FilteredSales (CTE)**  
Filters sales data to include only transactions from the past 12 months. Joins the `sales` table with `products` and `regions` to enrich the data with `category_id` and `region_id`.  
- **Logic**: Filters rows where `order_date` is within the last 12 months using `ADD_MONTHS(CAST(CURRENT_TIMESTAMP AS DATE), -12)`.
- **Output**: A dataset with columns `order_id`, `product_id`, `category_id`, `region_id`, `order_date`, and calculated `revenue` (as `quantity * price`).

**Step 2: CategoryRevenue (CTE)**  
Aggregates revenue data at the `region_id` and `category_id` levels. Calculates total revenue and average order value for each category in each region.  
- **Logic**: Uses `SUM(revenue)` and `AVG(revenue)` grouped by `region_id` and `category_id`.
- **Output**: A dataset with columns `region_id`, `category_id`, `total_revenue`, and `avg_order_value`.

**Step 3: RankedCategories (CTE)**  
Ranks categories within each region based on total revenue in descending order.  
- **Logic**: Uses the `RANK()` window function with `PARTITION BY region_id ORDER BY total_revenue DESC`.
- **Output**: A dataset with columns `region_id`, `category_id`, `total_revenue`, `avg_order_value`, and `category_rank`.

**Step 4: Final Query**  
Selects the top 3 categories by revenue for each region.  
- **Logic**: Filters rows where `category_rank <= 3` and orders the results by `region_id` and `category_rank`.
- **Output**: Final result set with columns `region_id`, `category_id`, `total_revenue`, `avg_order_value`, and `category_rank`.

---

#### 3. Data Mapping Details

| Destination Table | Destination Column | Source Table | Source Column | Mapping                          |
|-------------------|--------------------|--------------|---------------|----------------------------------|
| FilteredSales     | order_id          | sales        | order_id      | 1-to-1 mapping                  |
| FilteredSales     | product_id        | sales        | product_id    | 1-to-1 mapping                  |
| FilteredSales     | category_id       | products     | category_id   | 1-to-1 mapping                  |
| FilteredSales     | region_id         | regions      | region_id     | 1-to-1 mapping                  |
| FilteredSales     | revenue           | sales        | quantity, price | Transformation: `quantity * price` |
| CategoryRevenue   | total_revenue     | FilteredSales | revenue       | Aggregation: `SUM(revenue)`     |
| CategoryRevenue   | avg_order_value   | FilteredSales | revenue       | Aggregation: `AVG(revenue)`     |
| RankedCategories  | category_rank     | CategoryRevenue | total_revenue | Transformation: `RANK()` window function |

---

#### 4. Complexity Metrics
- **Number of Lines**: 26
- **Tables Used**: 3 (`sales`, `products`, `regions`)
- **Joins**: 2 (INNER JOIN between `sales` and `products`, INNER JOIN between `sales` and `regions`)
- **Temporary Tables (CTEs)**: 3 (`FilteredSales`, `CategoryRevenue`, `RankedCategories`)
- **Aggregate Functions**: 2 (`SUM`, `AVG`)
- **DML Statements**: 1 (`SELECT`)
- **Conditional Logic**: 1 (`WHERE` clause for filtering by date)

---

#### 5. Key Outputs
The script generates a result set containing the top 3 categories by revenue for each region.  
**Columns in the Output**:  
- `region_id`: Identifier for the region.
- `category_id`: Identifier for the product category.
- `total_revenue`: Total revenue generated by the category in the region.
- `avg_order_value`: Average revenue per order for the category in the region.
- `category_rank`: Rank of the category within the region based on total revenue.

---

#### 6. Error Handling and Optimization

**Error Handling**:  
- The script does not include explicit error-handling mechanisms. However, the use of `CAST` ensures that data types are consistent during calculations.

**Optimization**:  
- **Partitioning**: The use of `PARTITION BY` in the `RANK()` function optimizes ranking within each region.
- **Date Filtering**: The `ADD_MONTHS` function ensures efficient filtering of recent data.
- **Joins**: The script uses INNER JOINs, which are efficient for filtering matching records.

**Migration to Delta**:  
- Delta Lake's ACID transactions and schema enforcement can enhance data integrity.
- Partitioning by `region_id` and `category_id` in Delta can improve query performance.

---

#### 7. API Cost Calculation
**apiCost**: 0.0012 USD