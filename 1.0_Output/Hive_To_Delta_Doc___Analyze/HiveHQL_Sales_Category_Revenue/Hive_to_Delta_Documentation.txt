### Detailed Documentation for Hive Script: `HiveHQL_Sales_Category_Revenue.sql`

---

#### 1. Script Overview:
**Purpose:**  
The script calculates the top 3 product categories by revenue for each region over the past 12 months. It provides insights into regional sales performance and identifies the most profitable product categories for business decision-making.

**Data Sources:**  
- `sales`: Contains transactional data, including `order_id`, `product_id`, `region_id`, `order_date`, `quantity`, and `price`.
- `products`: Maps `product_id` to `category_id`.
- `regions`: Maps `region_id` to region details.

**KPI Definitions:**  
- **Total Revenue:** Calculated as `quantity * price` for each order.
- **Average Order Value (AOV):** The average revenue per order for a category in a region.
- **Category Rank:** The rank of a category within a region based on total revenue, calculated using the `RANK()` window function.

---

#### 2. Query Breakdown:
**Step 1: FilteredSales (CTE)**  
Filters sales data to include only transactions from the past 12 months. Calculates revenue for each transaction.  
- **Logic:**  
  - Filters rows where `order_date` is within the last 12 months using `ADD_MONTHS(CURRENT_TIMESTAMP, -12)`.
  - Joins `sales` with `products` and `regions` to include `category_id` and `region_id`.
  - Calculates revenue as `quantity * price`.

**Step 2: CategoryRevenue (CTE)**  
Aggregates revenue and calculates the average order value for each category within each region.  
- **Logic:**  
  - Groups data by `region_id` and `category_id`.
  - Computes `SUM(revenue)` as `total_revenue` and `AVG(revenue)` as `avg_order_value`.

**Step 3: RankedCategories (CTE)**  
Ranks categories within each region based on total revenue.  
- **Logic:**  
  - Uses the `RANK()` window function with `PARTITION BY region_id` and `ORDER BY total_revenue DESC` to rank categories.

**Final Output:**  
Selects the top 3 categories by revenue for each region.  
- **Logic:**  
  - Filters rows where `category_rank <= 3`.
  - Orders the result by `region_id` and `category_rank`.

---

#### 3. Data Mapping Details:
| Destination Table | Destination Column | Source Table | Source Column | Mapping                          |
|--------------------|--------------------|--------------|---------------|----------------------------------|
| FilteredSales      | order_id           | sales        | order_id      | 1-to-1 mapping                  |
| FilteredSales      | product_id         | sales        | product_id    | 1-to-1 mapping                  |
| FilteredSales      | category_id        | products     | category_id   | 1-to-1 mapping                  |
| FilteredSales      | region_id          | regions      | region_id     | 1-to-1 mapping                  |
| FilteredSales      | order_date         | sales        | order_date    | 1-to-1 mapping                  |
| FilteredSales      | revenue            | sales        | quantity, price | Transformation: quantity * price |
| CategoryRevenue    | region_id          | FilteredSales| region_id     | 1-to-1 mapping                  |
| CategoryRevenue    | category_id        | FilteredSales| category_id   | 1-to-1 mapping                  |
| CategoryRevenue    | total_revenue      | FilteredSales| revenue       | Aggregation: SUM(revenue)       |
| CategoryRevenue    | avg_order_value    | FilteredSales| revenue       | Aggregation: AVG(revenue)       |
| RankedCategories   | region_id          | CategoryRevenue | region_id  | 1-to-1 mapping                  |
| RankedCategories   | category_id        | CategoryRevenue | category_id | 1-to-1 mapping                  |
| RankedCategories   | total_revenue      | CategoryRevenue | total_revenue | 1-to-1 mapping                  |
| RankedCategories   | avg_order_value    | CategoryRevenue | avg_order_value | 1-to-1 mapping              |
| RankedCategories   | category_rank      | CategoryRevenue | total_revenue | Transformation: RANK() function |

---

#### 4. Complexity Metrics:
- **Number of Lines:** 27
- **Tables Used:** 3 (`sales`, `products`, `regions`)
- **Joins:**  
  - 2 joins in `FilteredSales`:
    - `INNER JOIN` between `sales` and `products` on `product_id`.
    - `INNER JOIN` between `sales` and `regions` on `region_id`.
- **Temporary Tables:** 3 CTEs (`FilteredSales`, `CategoryRevenue`, `RankedCategories`)
- **Aggregate Functions:** 2 (`SUM`, `AVG`)
- **DML Statements:** 1 (`SELECT`)
- **Conditional Logic:** 1 (`WHERE` clause for filtering by date)

---

#### 5. Key Outputs:
The script generates a result set containing the following columns:
- `region_id`: The region identifier.
- `category_id`: The category identifier.
- `total_revenue`: Total revenue generated by the category in the region.
- `avg_order_value`: Average revenue per order for the category in the region.
- `category_rank`: The rank of the category within the region based on total revenue.

The final result includes only the top 3 categories by revenue for each region, ordered by `region_id` and `category_rank`.

---

#### 6. Error Handling and Optimization:
**Error Handling:**  
- The script does not include explicit error-handling mechanisms. However, the use of `CAST` ensures that revenue calculations do not fail due to type mismatches.

**Optimization Techniques:**  
- **Partitioning:** The `WHERE` clause filters data by `order_date`, which can benefit from partitioning on this column in the `sales` table.
- **Window Functions:** The use of `RANK()` with partitioning ensures efficient ranking of categories within each region.
- **Aggregations:** The script uses `SUM` and `AVG` functions to compute metrics efficiently.

**Performance Improvements for Migration to Delta:**  
- Delta tables can improve performance through features like data skipping and Z-order indexing.
- The script can leverage Delta's ACID compliance for more robust data handling.

---

#### 7. API Cost Calculation:
apiCost: 0.0045 USD