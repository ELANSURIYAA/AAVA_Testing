```
====================================================
Author:        Ascendion AAVA
Date:          
Description:   Loads FACT_EXECUTIVE_SUMMARY table with summarized holding metrics from staging and dimension tables.
====================================================

# Overview of Pipeline/Component

This Azure Synapse stored procedure (`dbo.LOAD_FACT_EXECUTIVE_SUMMARY`) is designed to populate the `FACT_EXECUTIVE_SUMMARY` table with aggregated holding metrics. It extracts data from the staging table `STG_HOLDING_METRICS`, performs business rule validations, joins with dimension tables for referential integrity, and applies necessary transformations before loading the fact table. The procedure supports regulatory reporting, executive dashboards, and downstream analytics by ensuring high data quality and consistency.

# Component Structure and Design

- **Source:** `dbo.STG_HOLDING_METRICS` (staging table)
- **Dimension Tables:** `dbo.DIM_DATE`, `dbo.DIM_INSTITUTION`, `dbo.DIM_CORPORATION`, `dbo.DIM_PRODUCT`
- **Transformation:** Temporary table creation, joins, business rule validation (e.g., income amount normalization)
- **Sink:** `dbo.FACT_EXECUTIVE_SUMMARY` (fact table)
- **Activities:**
  - Staging data preparation (`#staging_metrics`)
  - Data validation and transformation
  - Fact table insertion with referential integrity checks
  - Audit logging (row count)
  - Cleanup (drop temp table)
- **Parameters/Variables:** `@v_row_count`, `@error_message`
- **Triggers:** Manual or scheduled execution via Synapse pipeline or SQL agent

# Data Flow and Processing Logic

**Processed Datasets:**
- `STG_HOLDING_METRICS`
- `DIM_DATE`
- `DIM_INSTITUTION`
- `DIM_CORPORATION`
- `DIM_PRODUCT`
- `FACT_EXECUTIVE_SUMMARY`

**Data Flow:**
1. Extract all records from `STG_HOLDING_METRICS` into a temporary staging table.
2. For each record, join with dimension tables to resolve surrogate keys and ensure referential integrity.
3. Apply business rules (e.g., set negative or null income amounts to zero).
4. Insert validated and transformed records into `FACT_EXECUTIVE_SUMMARY`.
5. Log the number of inserted records for auditing.
6. Clean up temporary resources.

# Data Mapping (Lineage)

| Target Table Name         | Target Column Name     | Source Table Name      | Source Column Name      | Remarks                                                        |
|--------------------------|-----------------------|-----------------------|------------------------|---------------------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key              | DIM_DATE              | date_key               | 1:1 Mapping via join on `date_value`                          |
| FACT_EXECUTIVE_SUMMARY   | institution_id        | DIM_INSTITUTION       | institution_id         | 1:1 Mapping via join on `institution_id`                      |
| FACT_EXECUTIVE_SUMMARY   | corporation_id        | DIM_CORPORATION       | corporation_id         | 1:1 Mapping via join on `corporation_id`                      |
| FACT_EXECUTIVE_SUMMARY   | product_id            | DIM_PRODUCT           | product_id             | 1:1 Mapping via join on `product_id`                          |
| FACT_EXECUTIVE_SUMMARY   | a120_amount           | STG_HOLDING_METRICS   | a120_amount            | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | a120_count            | STG_HOLDING_METRICS   | a120_count             | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount      | STG_HOLDING_METRICS   | a30_to_59_amount       | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count       | STG_HOLDING_METRICS   | a30_to_59_count        | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount      | STG_HOLDING_METRICS   | a60_to_89_amount       | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count       | STG_HOLDING_METRICS   | a60_to_89_count        | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount     | STG_HOLDING_METRICS   | a90_to_119_amount      | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count      | STG_HOLDING_METRICS   | a90_to_119_count       | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount     | STG_HOLDING_METRICS   | charge_off_amount      | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count      | STG_HOLDING_METRICS   | charge_off_count       | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount          | STG_HOLDING_METRICS   | fraud_amount           | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | fraud_count           | STG_HOLDING_METRICS   | fraud_count            | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | income_amount         | STG_HOLDING_METRICS   | income_amount          | Transformation: If NULL or <0, set to 0                       |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts    | STG_HOLDING_METRICS   | number_of_accounts     | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount      | STG_HOLDING_METRICS   | purchases_amount       | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY   | purchases_count       | STG_HOLDING_METRICS   | purchases_count        | 1:1 Mapping                                                   |

# Transformation Logic

- **income_amount:** 
  - `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`
  - Ensures that income amounts are non-negative and not null.
- **Joins:** 
  - Inner joins to dimension tables (`DIM_DATE`, `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`) to resolve surrogate keys and maintain referential integrity.
- **Audit Logging:** 
  - `SET @v_row_count = @@ROWCOUNT; PRINT CAST(@v_row_count AS VARCHAR(10)) + ' records inserted...'`
- **Temporary Table:** 
  - Used for staging and intermediate processing.

# Complexity Analysis

| Metric                              | Value/Details                                   |
|--------------------------------------|-------------------------------------------------|
| Number of Pipeline Activities        | 1 (Stored Procedure)                            |
| Number of Dataflow Transformations   | 1 (income_amount normalization, joins)          |
| SQL Scripts or Stored Procedures Used| 1 (dbo.LOAD_FACT_EXECUTIVE_SUMMARY)             |
| Joins Used                          | 4 (Inner joins to dimension tables)             |
| Lookup Tables or Reference Data      | 4 (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Parameters/Variables/Triggers        | 2 variables, 0 parameters, 0 triggers           |
| Number of Output Datasets            | 1 (FACT_EXECUTIVE_SUMMARY)                      |
| Conditional Logic or if-else Flows   | 1 (income_amount CASE statement)                |
| External Dependencies                | 4 (dimension tables), staging table             |
| Overall Complexity Score             | 30                                              |

# Key Outputs

- **Output Table:** `FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse SQL Table
- **Intended Use:** Executive reporting, regulatory analytics, downstream BI, and ML model input.
- **Data Quality:** Validated, referentially consistent, and business-rule compliant metrics.

# API Cost

apiCost: 0.004 USD

```