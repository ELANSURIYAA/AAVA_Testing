# Azure Synapse Pipeline/Component Documentation

---
**Author:** Ascendion AAVA  
**Date:**  
**Description:** Loads the FACT_EXECUTIVE_SUMMARY table in Synapse DW with summarized holding metrics from staging, applying business rules, data quality checks, and referential integrity via dimension joins.

---

## 1. Overview of Pipeline/Component

The `LOAD_FACT_EXECUTIVE_SUMMARY` stored procedure is designed to populate the `FACT_EXECUTIVE_SUMMARY` fact table in Azure Synapse Analytics. It ingests data from the `STG_HOLDING_METRICS` staging table, applies business rules and data quality validations, and ensures referential integrity by joining with dimension tables. This process supports executive reporting and analytics by providing aggregated holding metrics at the institution, corporation, product, and date levels.

---

## 2. Component Structure and Design

- **Source:**  
  - `STG_HOLDING_METRICS` (staging table containing raw holding metrics)

- **Key Activities:**  
  - **Staging Preparation:** Data from `STG_HOLDING_METRICS` is loaded into a temporary table `#staging_metrics`.
  - **Fact Table Load:** Data is inserted into `FACT_EXECUTIVE_SUMMARY` after joining with dimension tables:
    - `DIM_DATE`
    - `DIM_INSTITUTION`
    - `DIM_CORPORATION`
    - `DIM_PRODUCT`
  - **Data Quality & Business Rules:**  
    - Null or negative `income_amount` values are set to 0.
    - Only records with valid dimension keys are loaded.
  - **Audit Logging:** Number of inserted records is logged.
  - **Cleanup:** Temporary staging table is dropped.

- **Connection Flow:**  
  1. Read from staging.
  2. Join with dimensions.
  3. Apply business rules.
  4. Insert into fact table.
  5. Log and cleanup.

- **Parameters/Variables:**  
  - `@v_row_count` (row count for audit)
  - `@error_message` (unused, placeholder for error handling)

- **Triggers:**  
  - Typically executed as part of a scheduled pipeline or orchestrated workflow.

---

## 3. Data Flow and Processing Logic

- **Processed Datasets:**  
  - `STG_HOLDING_METRICS`
  - `DIM_DATE`
  - `DIM_INSTITUTION`
  - `DIM_CORPORATION`
  - `DIM_PRODUCT`
  - `FACT_EXECUTIVE_SUMMARY`

- **Data Flow:**  
  1. Data is staged from `STG_HOLDING_METRICS` into `#staging_metrics`.
  2. Data is joined with dimension tables to resolve surrogate keys.
  3. Business rules are applied (e.g., income normalization).
  4. Validated and enriched data is inserted into `FACT_EXECUTIVE_SUMMARY`.
  5. Audit information is logged, and staging resources are cleaned up.

- **Business Rules/Transformations:**  
  - Null or negative `income_amount` values are replaced with 0.
  - Only records with matching dimension keys are loaded (inner joins).

---

## 4. Data Mapping (Lineage)

| Target Table Name        | Target Column Name    | Source Table Name      | Source Column Name      | Remarks                                                        |
|-------------------------|----------------------|-----------------------|------------------------|----------------------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY  | date_key             | DIM_DATE              | date_key               | 1:1 Mapping via join on stg.date_value = dt.date_key           |
| FACT_EXECUTIVE_SUMMARY  | institution_id       | DIM_INSTITUTION       | institution_id         | 1:1 Mapping via join on stg.institution_id = inst.institution_id|
| FACT_EXECUTIVE_SUMMARY  | corporation_id       | DIM_CORPORATION       | corporation_id         | 1:1 Mapping via join on stg.corporation_id = corp.corporation_id|
| FACT_EXECUTIVE_SUMMARY  | product_id           | DIM_PRODUCT           | product_id             | 1:1 Mapping via join on stg.product_id = prod.product_id       |
| FACT_EXECUTIVE_SUMMARY  | a120_amount          | STG_HOLDING_METRICS   | a120_amount            | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | a120_count           | STG_HOLDING_METRICS   | a120_count             | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | a30_to_59_amount     | STG_HOLDING_METRICS   | a30_to_59_amount       | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | a30_to_59_count      | STG_HOLDING_METRICS   | a30_to_59_count        | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | a60_to_89_amount     | STG_HOLDING_METRICS   | a60_to_89_amount       | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | a60_to_89_count      | STG_HOLDING_METRICS   | a60_to_89_count        | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | a90_to_119_amount    | STG_HOLDING_METRICS   | a90_to_119_amount      | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | a90_to_119_count     | STG_HOLDING_METRICS   | a90_to_119_count       | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | charge_off_amount    | STG_HOLDING_METRICS   | charge_off_amount      | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | charge_off_count     | STG_HOLDING_METRICS   | charge_off_count       | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | fraud_amount         | STG_HOLDING_METRICS   | fraud_amount           | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | fraud_count          | STG_HOLDING_METRICS   | fraud_count            | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | income_amount        | STG_HOLDING_METRICS   | income_amount          | Transformation: NULL or <0 set to 0                           |
| FACT_EXECUTIVE_SUMMARY  | number_of_accounts   | STG_HOLDING_METRICS   | number_of_accounts     | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | purchases_amount     | STG_HOLDING_METRICS   | purchases_amount       | 1:1 Mapping                                                   |
| FACT_EXECUTIVE_SUMMARY  | purchases_count      | STG_HOLDING_METRICS   | purchases_count        | 1:1 Mapping                                                   |

---

## 5. Transformation Logic

- **income_amount:**  
  - `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`
  - Ensures only non-negative, non-null values are loaded for income.

- **Dimension Joins:**  
  - Only records with valid foreign keys in all dimension tables are loaded (inner joins).

- **Audit Logging:**  
  - `@v_row_count = @@ROWCOUNT` captures the number of inserted records for monitoring.

- **No UDFs or reusable templates** are referenced in this procedure.

---

## 6. Complexity Analysis

| Metric                              | Value/Description                                              |
|--------------------------------------|---------------------------------------------------------------|
| Number of Pipeline Activities        | 1 (Stored Procedure)                                          |
| Number of Dataflow Transformations   | 1 (income_amount transformation)                              |
| SQL Scripts or Stored Procedures Used| 1 (LOAD_FACT_EXECUTIVE_SUMMARY)                               |
| Joins Used                          | 4 (All INNER JOINs: DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Lookup Tables or Reference Data      | 4 (Dimension tables)                                          |
| Parameters/Variables/Triggers        | 2 variables, 0 parameters, 0 triggers                         |
| Number of Output Datasets            | 1 (FACT_EXECUTIVE_SUMMARY)                                    |
| Conditional Logic or if-else Flows   | 1 (income_amount CASE WHEN)                                   |
| External Dependencies                | DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT       |
| Overall Complexity Score             | 25                                                            |

---

## 7. Key Outputs

- **Output Table:** `FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse Table (columnar storage, optimized for analytics)
- **Intended Use:** Executive reporting, regulatory analytics, and downstream BI/ML consumption.

---

## API Cost

- `apiCost: 0.008 USD`

---