import psycopg2
import json
import uuid
import requests
import logging

# Configure logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def connect_to_database(host, database, user, password):
    """
    Establish a connection to the PostgreSQL database.
    """
    try:
        connection = psycopg2.connect(
            host=host,
            database=database,
            user=user,
            password=password
        )
        logging.info("Database connection established.")
        return connection
    except Exception as e:
        logging.error(f"Error connecting to the database: {e}")
        raise

def fetch_records(connection, table_name):
    """
    Fetch records from the specified table using a server-side cursor.
    """
    try:
        cursor = connection.cursor(name='server_side_cursor')
        query = f"SELECT * FROM {table_name};"
        cursor.execute(query)
        logging.info(f"Fetching records from table: {table_name}")
        for record in cursor:
            yield record
    except Exception as e:
        logging.error(f"Error fetching records: {e}")
        raise

def transform_to_json(record, columns):
    """
    Transform a database record into a structured JSON format.
    """
    json_record = {}
    for col, value in zip(columns, record):
        col_name, col_type = col
        if col_type == 'uuid' and value is None:
            value = str(uuid.uuid4())
        json_record[col_name] = {
            "type": col_type,
            "value": value
        }
    return json_record

def send_to_api(json_data, api_endpoint, headers):
    """
    Send the transformed JSON data to the specified API endpoint.
    """
    try:
        response = requests.post(api_endpoint, json=json_data, headers=headers)
        if response.status_code == 200:
            logging.info("Data sent successfully.")
        else:
            logging.error(f"Failed to send data. Status code: {response.status_code}, Response: {response.text}")
    except Exception as e:
        logging.error(f"Error sending data to API: {e}")
        raise

def main():
    # Database connection details
    db_config = {
        "host": "localhost",
        "database": "your_database",
        "user": "your_user",
        "password": "your_password"
    }

    # API endpoint and headers
    api_endpoint = "https://example.com/api"
    headers = {
        "Authorization": "Bearer your_api_token",
        "Content-Type": "application/json"
    }

    # Table details
    table_name = "employee"
    columns = [
        ("id", "integer"),
        ("createddate", "timestamp"),
        ("modifieddate", "timestamp"),
        ("home_org_id", "integer"),
        ("borrowing_org_id", "integer"),
        ("home_org_approval", "boolean"),
        ("borrowing_org_approval", "boolean"),
        ("code_name", "string"),
        ("display_name", "string"),
        ("default_hour_threshold", "integer"),
        ("default_hours_capacity", "integer")
    ]

    try:
        # Connect to the database
        connection = connect_to_database(**db_config)

        # Fetch and process records
        for record in fetch_records(connection, table_name):
            json_data = transform_to_json(record, columns)
            send_to_api(json_data, api_endpoint, headers)

    except Exception as e:
        logging.error(f"An error occurred: {e}")
    finally:
        if connection:
            connection.close()
            logging.info("Database connection closed.")

if __name__ == "__main__":
    main()