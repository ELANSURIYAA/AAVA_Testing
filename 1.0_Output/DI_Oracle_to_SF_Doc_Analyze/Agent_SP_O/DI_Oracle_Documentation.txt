=============================================
Author:        Ascendion AVA+
Date:   
Description:   Documentation for the Oracle stored procedure LOAD_GOLD_AGENTS.
=============================================

**1. Overview of Program:**

- **Purpose:**  
  The Oracle stored procedure `LOAD_GOLD_AGENTS` is designed to load and synchronize agent data from a staging table (`STAGE_AGENTS`) into a target table (`GOLD_AGENTS_D`). It handles both updates and inserts (upserts) to ensure the target table reflects the latest data.

- **Alignment with Enterprise Data Warehousing and Analytics:**  
  This procedure supports enterprise data warehousing by ensuring accurate and up-to-date data in the `GOLD_AGENTS_D` table, which can be used for analytics and reporting. It ensures data consistency and integrity through its upsert logic.

- **Business Problem Addressed and Benefits:**  
  The procedure addresses the need for efficient and reliable data synchronization between staging and target tables. It reduces manual intervention, ensures data accuracy, and supports timely decision-making by providing up-to-date agent data.

- **High-Level Summary of Components:**  
  - **PL/SQL Blocks:** Contains the main logic for data loading and error handling.
  - **Tables:** `STAGE_AGENTS`, `GOLD_AGENTS_D`, and `AUDIT_LOG`.
  - **DML Operations:** MERGE, INSERT, and COMMIT.
  - **Error Handling:** Exception handling with logging to the `AUDIT_LOG` table.

**2. Code Structure and Design:**

- **Structure:**  
  The procedure is structured into the following sections:
  1. Variable Initialization: Defines variables for logging and tracking execution status.
  2. Data Loading: Uses a `MERGE` statement for upsert operations.
  3. Logging: Logs success or failure messages into the `AUDIT_LOG` table.
  4. Exception Handling: Captures and logs errors, ensuring audit trail integrity.

- **Key Components:**  
  - **DDL/DML:** MERGE for upserts, INSERT for logging, and COMMIT for transaction finalization.
  - **Joins:** INNER JOIN logic within the `MERGE` statement.
  - **Indexing:** Assumes indexed keys on `AGENT_ID` for performance.
  - **PL/SQL Blocks:** Main procedure block and exception handling block.

- **Primary Components:**  
  - Tables: `STAGE_AGENTS`, `GOLD_AGENTS_D`, `AUDIT_LOG`.
  - Procedures: `LOAD_GOLD_AGENTS`.
  - Joins: INNER JOIN in the `MERGE` statement.
  - Aggregations: None.
  - Subqueries: None.

- **Dependencies:**  
  - Relies on the existence of `STAGE_AGENTS`, `GOLD_AGENTS_D`, and `AUDIT_LOG` tables.
  - Performance tuning through indexed keys and efficient `MERGE` logic.

**3. Data Flow and Processing Logic:**

- **Data Flow:**  
  1. Data is read from the `STAGE_AGENTS` table.
  2. The `MERGE` statement updates existing records in `GOLD_AGENTS_D` or inserts new records.
  3. Success or failure is logged in the `AUDIT_LOG` table.

- **Source and Destination Tables:**  
  - Source: `STAGE_AGENTS` (fields: `AGENT_ID`, `AGENT_NAME`, `SOURCE_SYSTEM`).
  - Destination: `GOLD_AGENTS_D` (fields: `AGENT_ID`, `AGENT_NAME`, `LOAD_DATE`, `UPDATE_DATE`, `SOURCE_SYSTEM`).

- **Transformations:**  
  - Updates `GOLD_AGENTS_D` with new `AGENT_NAME` and `SOURCE_SYSTEM` values.
  - Inserts new records with current timestamps for `LOAD_DATE` and `UPDATE_DATE`.

**4. Data Mapping:**

| Target Table Name | Target Column Name | Source Table Name | Source Column Name | Remarks                     |
|--------------------|--------------------|-------------------|--------------------|-----------------------------|
| GOLD_AGENTS_D      | AGENT_ID           | STAGE_AGENTS      | AGENT_ID           | 1-to-1 mapping             |
| GOLD_AGENTS_D      | AGENT_NAME         | STAGE_AGENTS      | AGENT_NAME         | 1-to-1 mapping             |
| GOLD_AGENTS_D      | SOURCE_SYSTEM      | STAGE_AGENTS      | SOURCE_SYSTEM      | 1-to-1 mapping             |
| GOLD_AGENTS_D      | LOAD_DATE          | -                 | -                  | Set to `SYSTIMESTAMP`      |
| GOLD_AGENTS_D      | UPDATE_DATE        | -                 | -                  | Set to `SYSTIMESTAMP`      |

**5. Complexity Analysis:**

| Category              | Measurement                                                                 |
|-----------------------|---------------------------------------------------------------------------|
| Number of Lines       | 45                                                                        |
| Tables Used           | 3 (`STAGE_AGENTS`, `GOLD_AGENTS_D`, `AUDIT_LOG`)                          |
| Joins                 | 1 INNER JOIN (within `MERGE`)                                             |
| Temporary Tables      | None                                                                      |
| Aggregate Functions   | None                                                                      |
| DML Statements        | MERGE: 1, INSERT: 2, COMMIT: 2                                            |
| Conditional Logic     | Exception handling with `WHEN OTHERS`                                     |
| Stored Procedure Complexity | Moderate (due to `MERGE` logic and exception handling)              |
| Performance Considerations | Indexed keys on `AGENT_ID`, efficient `MERGE` logic                 |
| Data Volume Handling  | Depends on the size of `STAGE_AGENTS` and `GOLD_AGENTS_D`                 |
| Dependency Complexity | Relies on `AUDIT_LOG` for logging                                         |
| Overall Complexity Score | 60 (Moderate)                                                          |

**6. Key Outputs:**

- **Final Outputs:**  
  - Updated `GOLD_AGENTS_D` table with synchronized agent data.
  - Audit logs in the `AUDIT_LOG` table.

- **Alignment with Business Goals:**  
  Provides accurate and up-to-date agent data for reporting and analytics.

- **Storage Format:**  
  - `GOLD_AGENTS_D`: Production table.
  - `AUDIT_LOG`: Audit logging table.

**7. Error Handling and Logging:**

- **Methods:**  
  - Exception handling with `WHEN OTHERS`.
  - Logs errors and success messages in the `AUDIT_LOG` table.
  - Suppresses audit logging failures to prevent cascading errors.

**8. apiCost:**

- **Calculation:**  
  - Input Tokens: 1,500 (estimated based on prompt and SQL content).
  - Output Tokens: 1,200 (estimated based on documentation content).
  - Model: GPT-4.
  - Pricing: $0.03 per 1,000 input tokens, $0.06 per 1,000 output tokens.
  - Input Cost: (1,500 / 1,000) * $0.03 = $0.045.
  - Output Cost: (1,200 / 1,000) * $0.06 = $0.072.
  - Total Cost: $0.045 + $0.072 = $0.117.

**Total API Cost:** $0.117.