=============================================
Author:        Ascendion AVA+
Date:   
Description:   Documentation for the Oracle stored procedure LOAD_GOLD_AGENTS
=============================================

### 1. Metadata Requirements:
- **Author**: Ascendion AVA+
- **Date**: (Leave it Empty)
- **Description**: Documentation for the Oracle stored procedure LOAD_GOLD_AGENTS

---

### 2. Overview of Program:
- **Purpose**:  
  The Oracle stored procedure `LOAD_GOLD_AGENTS` is designed to load and synchronize agent data from a staging table (`STAGE_AGENTS`) into a target table (`GOLD_AGENTS_D`). It implements an upsert logic using the `MERGE` statement to handle both updates and inserts in a single operation. Additionally, it logs the success or failure of the operation in an `AUDIT_LOG` table.

- **Alignment with Enterprise Data Warehousing and Analytics**:  
  This procedure supports enterprise data warehousing by ensuring that the `GOLD_AGENTS_D` table contains the most up-to-date and accurate agent data. It enables consistent and reliable data integration from staging to production layers, which is critical for analytics and reporting.

- **Business Problem and Benefits**:  
  The procedure addresses the need for maintaining a single source of truth for agent data, ensuring data consistency and accuracy. This reduces manual intervention, improves data quality, and supports downstream analytics and reporting processes.

- **High-Level Summary of Components**:  
  - **PL/SQL Blocks**: Main logic for data processing and error handling.
  - **Tables**: `STAGE_AGENTS`, `GOLD_AGENTS_D`, `AUDIT_LOG`.
  - **DML Statements**: `MERGE`, `INSERT`.
  - **Error Handling**: Exception block with logging to `AUDIT_LOG`.

---

### 3. Code Structure and Design:
- **Structure**:  
  The procedure consists of the following key components:
  1. Variable declarations for logging and error handling.
  2. `MERGE` statement for upsert logic.
  3. Logging of success or failure in the `AUDIT_LOG` table.
  4. Exception handling to capture and log errors.

- **Key Components**:  
  - **DDL**: None.
  - **DML**: `MERGE`, `INSERT`.
  - **Joins**: None explicitly, but the `MERGE` statement uses a join condition.
  - **Indexing**: Assumes indexes on `GOLD_AGENTS_D.AGENT_ID` for performance.
  - **PL/SQL Blocks**: Main block and exception block.

- **Dependencies**:  
  - Tables: `STAGE_AGENTS`, `GOLD_AGENTS_D`, `AUDIT_LOG`.
  - Performance Tuning: Use of `MERGE` for efficient upsert operations.

---

### 4. Data Flow and Processing Logic:
- **Data Flow**:  
  1. Data is sourced from the `STAGE_AGENTS` table.
  2. The `MERGE` statement updates existing records in `GOLD_AGENTS_D` or inserts new records.
  3. Success or failure is logged in the `AUDIT_LOG` table.

- **Source and Destination Tables**:  
  - Source: `STAGE_AGENTS`
  - Destination: `GOLD_AGENTS_D`

- **Transformations**:  
  - Updates `GOLD_AGENTS_D` with new data from `STAGE_AGENTS`.
  - Sets `LOAD_DATE` and `UPDATE_DATE` to the current timestamp.

---

### 5. Data Mapping:
| Target Table Name | Target Column Name | Source Table Name | Source Column Name | Remarks                  |
|--------------------|--------------------|-------------------|--------------------|--------------------------|
| GOLD_AGENTS_D      | AGENT_ID          | STAGE_AGENTS      | AGENT_ID          | 1-to-1 mapping           |
| GOLD_AGENTS_D      | AGENT_NAME        | STAGE_AGENTS      | AGENT_NAME        | 1-to-1 mapping           |
| GOLD_AGENTS_D      | SOURCE_SYSTEM     | STAGE_AGENTS      | SOURCE_SYSTEM     | 1-to-1 mapping           |
| GOLD_AGENTS_D      | LOAD_DATE         | -                 | -                 | Set to `SYSTIMESTAMP`    |
| GOLD_AGENTS_D      | UPDATE_DATE       | -                 | -                 | Set to `SYSTIMESTAMP`    |

---

### 6. Complexity Analysis:
| Category               | Measurement                                                                 |
|------------------------|----------------------------------------------------------------------------|
| Number of Lines        | 40 lines                                                                  |
| Tables Used            | 3 (`STAGE_AGENTS`, `GOLD_AGENTS_D`, `AUDIT_LOG`)                          |
| Joins                  | 1 (`MERGE` ON condition)                                                  |
| Temporary Tables       | None                                                                      |
| Aggregate Functions    | None                                                                      |
| DML Statements         | 2 (`MERGE`, `INSERT`)                                                     |
| Conditional Logic      | 1 (`WHEN MATCHED THEN`, `WHEN NOT MATCHED THEN`)                          |
| Stored Procedure Complexity | Moderate (due to `MERGE` and exception handling)                     |
| Performance Considerations | Efficient `MERGE` operation, minimal temporary tablespace usage       |
| Data Volume Handling   | Depends on the size of `STAGE_AGENTS` and `GOLD_AGENTS_D`                 |
| Dependency Complexity  | Low (only dependent on 3 tables)                                          |
| Overall Complexity Score | 50 (Moderate complexity)                                                |

---

### 7. Key Outputs:
- **Final Outputs**:  
  - Updated or newly inserted records in `GOLD_AGENTS_D`.
  - Audit logs in `AUDIT_LOG`.

- **Alignment with Business Goals**:  
  Ensures accurate and up-to-date agent data for analytics and reporting.

- **Storage Format**:  
  - `GOLD_AGENTS_D`: Production table.
  - `AUDIT_LOG`: Logging table.

---

### 8. Error Handling and Logging:
- **Methods Used**:  
  - Exception block with `WHEN OTHERS THEN`.
  - Logs errors in `AUDIT_LOG`.
  - Suppresses audit failure errors to prevent cascading failures.

---

### 9. apiCost:
- **Model Used**: GPT-4
- **Pricing**: 
  - Input Cost: `input_tokens * input_cost_per_token`
  - Output Cost: `output_tokens * output_cost_per_token`
- **Calculation**: 
  - Input Tokens: 1500
  - Output Tokens: 1200
  - Input Cost: 1500 * $0.00003 = $0.045
  - Output Cost: 1200 * $0.00006 = $0.072
  - Total Cost: $0.045 + $0.072 = $0.117

--- 

This concludes the documentation for the Oracle stored procedure `LOAD_GOLD_AGENTS`.