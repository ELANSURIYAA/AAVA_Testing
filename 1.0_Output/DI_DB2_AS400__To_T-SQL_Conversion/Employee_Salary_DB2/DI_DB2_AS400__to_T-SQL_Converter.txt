====================================================
Author:        AAVA
Date:          
Description:   Returns total salary and bonus count for a department
====================================================

CREATE OR ALTER PROCEDURE RETURN_DEPT_SALARY
    @IN_DEPT CHAR(3),
    @OUT_TOTAL_SALARY DECIMAL(9,2) OUTPUT,
    @OUT_BONUS_COUNT INT OUTPUT
AS
BEGIN
    SET NOCOUNT ON;

    -- Declare local variables for salary and bonus
    DECLARE @EMP_SALARY DECIMAL(9,2);
    DECLARE @EMP_BONUS DECIMAL(9,2);

    -- Initialize output parameters
    SET @OUT_TOTAL_SALARY = 0;
    SET @OUT_BONUS_COUNT = 0;

    -- Declare a cursor for selecting employees in the specified department
    DECLARE employee_cursor CURSOR FOR
        SELECT SALARY, BONUS
        FROM CORPDATA.EMPLOYEE
        WHERE WORKDEPT = @IN_DEPT;

    -- Open the cursor
    OPEN employee_cursor;

    -- Fetch the first row from the cursor
    FETCH NEXT FROM employee_cursor INTO @EMP_SALARY, @EMP_BONUS;

    -- Loop through all rows in the cursor
    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Add the salary and bonus to the total salary
        SET @OUT_TOTAL_SALARY = @OUT_TOTAL_SALARY + ISNULL(@EMP_SALARY, 0) + ISNULL(@EMP_BONUS, 0);

        -- If the employee received a bonus, increment the bonus count
        IF ISNULL(@EMP_BONUS, 0) > 0
        BEGIN
            SET @OUT_BONUS_COUNT = @OUT_BONUS_COUNT + 1;
        END

        -- Fetch the next row from the cursor
        FETCH NEXT FROM employee_cursor INTO @EMP_SALARY, @EMP_BONUS;
    END

    -- Close and deallocate the cursor
    CLOSE employee_cursor;
    DEALLOCATE employee_cursor;

    -- Error handling: T-SQL uses TRY...CATCH for error management
    -- If an error occurs, output parameters will retain their last assigned values
    -- For more advanced error handling, wrap the above logic in TRY...CATCH and handle transactions as needed

END
-- API cost for this call: 0.004 USD