# Documentation: uspAPIPatchAccount Stored Procedure

## 1. Overview of Program

### Purpose of the SQL Server Code
The `uspAPIPatchAccount` stored procedure is designed to generate PATCH data in API-compatible JSON format for account information. This procedure is part of the IntegrationsMart database under the RCT schema and serves as a critical component in the data integration pipeline between internal systems and external APIs.

The procedure retrieves account data that needs to be updated (marked with 'Patch' status), transforms it into a structured JSON format with specific operations (primarily "replace" operations), and prepares it for API consumption.

### Business Problem Addressed
The procedure addresses the business need to synchronize account information between internal systems and external APIs. It enables automated updates of account data including contact information, addresses, policy details, and numerous extension fields containing business-specific data. This ensures that external systems have the most current account information for business operations, particularly for insurance policies and account management.

## 2. Code Structure and Design

### Structure and Flow
The stored procedure follows a modular design with the following key components:

1. **Parameter Definition**: 
   - Accepts a single parameter `@LoopInstance` (INT) to process data in batches of 250 records
   - Uses a date variable to filter records based on expiration dates

2. **Common Table Expressions (CTEs)**:
   - `NationalAccts`: Identifies national account flags from EDSMART.Semantic.PolicyDescriptors
   - `INForceListCode`: Maps status codes to human-readable values (inforce, prospect, inactive)
   - `BrandCode`: Maps brand IDs to brand names (Accident Fund, Third Coast Underwriters, etc.)
   - `Final`: Main data selection and transformation CTE that joins account data with mapping tables

3. **Main Query**:
   - Selects from the `Final` CTE
   - Filters by the provided loop instance
   - Dynamically constructs JSON patch operations for each field
   - Formats the output as a complete JSON message

### Primary SQL Server Components
- **Tables**: 
  - RCT.Account (main data source)
  - EDSMART.Semantic.PolicyDescriptors (for national accounts)
  - RCT.AccountID (for ID mapping)
  - RCT.IdOverride (for custom ID handling)

- **Views**: None used directly

- **Stored Procedures**: 
  - uspAPIPatchAccount (the procedure itself)

- **Joins**: 
  - 5 LEFT JOINs connecting account data with reference tables and mapping tables

- **Aggregations**: 
  - ROW_NUMBER() window function for pagination and sorting

- **Subqueries**: 
  - None used directly; logic is organized using CTEs instead

## 3. Data Flow and Processing Logic

### Processing Logic Components

1. **Data Filtering and Selection**:
   - **Functionality**: Identifies accounts that need to be patched but haven't been processed yet
   - **Transformations**: Filters where `PostPatch = 'Patch'`, `Validated IS NULL`, `DateSent IS NULL`, and `SubmissionFlag = 0`

2. **National Account Identification**:
   - **Functionality**: Identifies accounts flagged as national accounts
   - **Transformations**: Filters PolicyDescriptors where NationalAccountFlag = 1 and ExpirationDate > @Date

3. **Status Code Mapping**:
   - **Functionality**: Translates numeric status codes to human-readable values
   - **Transformations**: Maps ItemID to ItemCode for account status values

4. **Brand Code Mapping**:
   - **Functionality**: Translates numeric brand codes to brand names
   - **Transformations**: Maps ItemID to ItemCode for brand values

5. **Account ID Resolution**:
   - **Functionality**: Determines the correct account ID to use
   - **Transformations**: COALESCE(AC.AccountID, ID.RCT_ID) to use override ID when available

6. **Batch Processing Calculation**:
   - **Functionality**: Divides records into manageable batches
   - **Transformations**: (ROW_NUMBER() OVER (ORDER BY A.ContactNumber) -1) / 250 to assign batch numbers

7. **Special Field Handling**:
   - **Functionality**: Applies business rules to specific fields
   - **Transformations**: 
     - IIF(NA.AccountNumber IS NULL, UnderwriterId, NULL) to remove UnderwriterID for national accounts
     - IIF(EmailAddress like '%@%', EmailAddress, NULL) to validate email addresses

8. **JSON Construction**:
   - **Functionality**: Builds a properly formatted JSON patch document
   - **Transformations**: Extensive string concatenation with COALESCE to handle null values

## 4. Data Mapping

### Target to Source Mapping

| Target Table Name | Target Column Name | Source Table Name | Source Column Name | Remarks |
|-------------------|-------------------|-------------------|-------------------|---------|
| API Endpoint | UnderwriterId | RCT.Account | UnderwriterId | Conditional: Removed for National Accounts |
| API Endpoint | MailingAddress.ProvinceID | RCT.Account | MailingAddressProvinceId | 1:1 mapping |
| API Endpoint | MailingAddress.AddressLine | RCT.Account | MailingAddressAddressLine | 1:1 mapping |
| API Endpoint | MailingAddress.City | RCT.Account | MailingAddressCity | 1:1 mapping |
| API Endpoint | MailingAddress.PostalCode | RCT.Account | MailingAddressPostalCode | 1:1 mapping |
| API Endpoint | MailingAddress.Longitude | RCT.Account | MailingAddressLongitude | 1:1 mapping |
| API Endpoint | MailingAddress.Latitude | RCT.Account | MailingAddressLatitude | 1:1 mapping |
| API Endpoint | MailingAddress.County | RCT.Account | MailingAddressCounty | 1:1 mapping |
| API Endpoint | Name | RCT.Account | Name | 1:1 mapping |
| API Endpoint | Phone | RCT.Account | BusinessPhone | 1:1 mapping |
| API Endpoint | Fax | RCT.Account | FaxPhone | 1:1 mapping |
| API Endpoint | Email | RCT.Account | EmailAddress | Transformation: Validated with '%@%' pattern |
| API Endpoint | Notes | RCT.Account | Notes | Transformation: CAST as VARCHAR(150) |
| API Endpoint | ContactNumber | RCT.Account | ContactNumber | 1:1 mapping |
| API Endpoint | ExtensionFields[11] | INForceListCode CTE | ItemID | Mapping: Account status code |
| API Endpoint | ExtensionFields[37] | RCT.Account | BDCName | 1:1 mapping |
| API Endpoint | ExtensionFields[40] | RCT.Account | UnderwriterEmail | Transformation: Validated with '%@%' pattern |
| API Endpoint | ExtensionFields[67] | RCT.Account | OnBaseLink | 1:1 mapping |
| API Endpoint | ExtensionFields[69] | RCT.Account | Policy1 | 1:1 mapping |
| API Endpoint | ExtensionFields[72] | RCT.Account | LineOfBusiness1 | 1:1 mapping |
| API Endpoint | ExtensionFields[73] | RCT.Account | Premium1 | 1:1 mapping |
| API Endpoint | ExtensionFields[74] | RCT.Account | PolicyEffectiveDate1 | 1:1 mapping |
| API Endpoint | ExtensionFields[75] | RCT.Account | PolicyExpirationDATE1 | 1:1 mapping |
| API Endpoint | ExtensionFields[76] | RCT.Account | PricingType1 | 1:1 mapping |
| API Endpoint | ExtensionFields[77] | RCT.Account | GoverningClassCode1 | 1:1 mapping |
| API Endpoint | ExtensionFields[78] | RCT.Account | NAICSCode1 | 1:1 mapping |
| API Endpoint | ExtensionFields[79] | RCT.Account | Industry1 | 1:1 mapping |
| API Endpoint | ExtensionFields[80] | RCT.Account | HazardGroup1 | 1:1 mapping |
| API Endpoint | ExtensionFields[81] | RCT.Account | PMScore1 | 1:1 mapping |
| API Endpoint | ExtensionFields[82] | RCT.Account | ExperienceModificationFactor1 | Transformation: COALESCE with 0.0000 |
| API Endpoint | ExtensionFields[83] | RCT.Account | Payroll1 | 1:1 mapping |
| API Endpoint | ExtensionFields[85] | RCT.Account | Policy2 | 1:1 mapping |
| API Endpoint | ExtensionFields[88] | RCT.Account | LineOfBusiness2 | 1:1 mapping |
| API Endpoint | ExtensionFields[89] | RCT.Account | Premium2 | 1:1 mapping |
| API Endpoint | ExtensionFields[90] | RCT.Account | PolicyEffectiveDate2 | 1:1 mapping |
| API Endpoint | ExtensionFields[91] | RCT.Account | PolicyExpirationDATE2 | 1:1 mapping |
| API Endpoint | ExtensionFields[92] | RCT.Account | PricingType2 | 1:1 mapping |
| API Endpoint | ExtensionFields[93] | RCT.Account | GoverningClassCode2 | 1:1 mapping |
| API Endpoint | ExtensionFields[94] | RCT.Account | NAICSCode2 | 1:1 mapping |
| API Endpoint | ExtensionFields[95] | RCT.Account | Industry2 | 1:1 mapping |
| API Endpoint | ExtensionFields[96] | RCT.Account | HazardGroup2 | 1:1 mapping |
| API Endpoint | ExtensionFields[97] | RCT.Account | PMScore2 | 1:1 mapping |
| API Endpoint | ExtensionFields[98] | RCT.Account | ExperienceModificationFactor2 | 1:1 mapping |
| API Endpoint | ExtensionFields[99] | RCT.Account | Payroll2 | 1:1 mapping |
| API Endpoint | ExtensionFields[101] | RCT.Account | Policy3 | 1:1 mapping |
| API Endpoint | ExtensionFields[104] | RCT.Account | LineOfBusiness3 | 1:1 mapping |
| API Endpoint | ExtensionFields[105] | RCT.Account | Premium3 | 1:1 mapping |
| API Endpoint | ExtensionFields[106] | RCT.Account | PolicyEffectiveDate3 | 1:1 mapping |
| API Endpoint | ExtensionFields[107] | RCT.Account | PolicyExpirationDATE3 | 1:1 mapping |
| API Endpoint | ExtensionFields[108] | RCT.Account | PricingType3 | 1:1 mapping |
| API Endpoint | ExtensionFields[109] | RCT.Account | GoverningClassCode3 | 1:1 mapping |
| API Endpoint | ExtensionFields[110] | RCT.Account | NAICSCode3 | 1:1 mapping |
| API Endpoint | ExtensionFields[111] | RCT.Account | Industry3 | 1:1 mapping |
| API Endpoint | ExtensionFields[112] | RCT.Account | HazardGroup3 | 1:1 mapping |
| API Endpoint | ExtensionFields[113] | RCT.Account | PMScore3 | 1:1 mapping |
| API Endpoint | ExtensionFields[114] | RCT.Account | ExperienceModificationFactor3 | 1:1 mapping |
| API Endpoint | ExtensionFields[115] | RCT.Account | Payroll3 | 1:1 mapping |
| API Endpoint | ExtensionFields[116] | BrandCode CTE | ItemID | Mapping: Brand code |
| API Endpoint | ExtensionFields[117] | RCT.Account | OperatingCompany | 1:1 mapping |
| API Endpoint | ExtensionFields[118] | RCT.Account | PreviousAccountID | 1:1 mapping |
| API Endpoint | ExtensionFields[119] | RCT.Account | PolicyRegion | 1:1 mapping |
| API Endpoint | ExtensionFields[120] | RCT.Account | NewBusinessPolicyFlag | Transformation: IIF(NewBusinessPolicyFlag=1,'2444','2445') |
| API Endpoint | ExtensionFields[121] | RCT.Account | AgencyID | 1:1 mapping |
| API Endpoint | ExtensionFields[122] | RCT.Account | PrimaryContactName | 1:1 mapping |
| API Endpoint | ExtensionFields[123] | RCT.Account | PrimaryContactPhone | Transformation: COALESCE with 'Unknown' |
| API Endpoint | ExtensionFields[124] | RCT.Account | PrimaryContactEmail | Transformation: Validated with '%@%' pattern |
| API Endpoint | ExtensionFields[125] | RCT.Account | PrimaryContactTitle | 1:1 mapping |
| API Endpoint | ExtensionFields[126] | RCT.Account | UnderwriterName | 1:1 mapping |
| API Endpoint | ExtensionFields[127] | RCT.Account | UnderwriterPhone | 1:1 mapping |
| API Endpoint | ExtensionFields[129] | RCT.Account | ContractAgencyName | 1:1 mapping |
| API Endpoint | ExtensionFields[130] | RCT.Account | ContractAgencyBusinessEmail | Transformation: Validated with '%@%' pattern |
| API Endpoint | ExtensionFields[131] | RCT.Account | MasterAgent | 1:1 mapping |
| API Endpoint | ExtensionFields[160] | RCT.Account | MasterCompany | 1:1 mapping |
| API Endpoint | ExtensionFields[161] | RCT.Account | ComplianceFLAG | Transformation: COALESCE with 'N' |
| API Endpoint | ExtensionFields[167] | RCT.Account | ExternalUniqueId/ContactNumber | Transformation: IIF(LEN > 15, REPLACE ContactNumber, REPLACE ExternalUniqueId) |
| API Endpoint | ExtensionFields[168] | RCT.Account | WrittenLossRatio | 1:1 mapping |

## 5. Complexity Analysis

| Complexity Factor | Count/Value | Description |
|-------------------|-------------|-------------|
| Lines of Code (LOC) | 370 | Total lines including comments and blank lines |
| Cyclomatic Complexity | 8 | Base complexity (1) + 7 conditional operations |
| Nesting Depth | 3 | Maximum depth of nested structures |
| Tables | 5 | RCT.Account, EDSMART.Semantic.PolicyDescriptors, RCT.AccountID, RCT.IdOverride, plus CTEs |
| Temporary Tables | 0 | No explicit temporary tables created |
| DML Statements | 1 | 1 SELECT statement (no INSERT, UPDATE, DELETE) |
| Joins | 5 | 5 LEFT JOIN operations |
| Subqueries | 0 | Logic organized using CTEs instead |
| CTEs | 4 | NationalAccts, INForceListCode, BrandCode, Final |
| Aggregation Queries | 2 | 2 ROW_NUMBER() window functions |
| Input Parameters | 1 | @LoopInstance INT |
| Output Parameters | 0 | No explicit output parameters |
| Data Transformations | 65+ | Multiple CAST, COALESCE, string operations |
| Function Calls | 75+ | COALESCE, CAST, IIF, LEN, REPLACE, DATEADD, ROW_NUMBER() |
| **Overall Complexity Score** | **75/100** | High complexity due to extensive data transformations and JSON construction |

## 6. Key Outputs

The procedure produces the following key outputs:

1. **AccountID**: The unique identifier for the account in the target system
2. **ContactNumber**: The account's contact number for reference
3. **SubmissionFlag**: Indicates whether the account is a submission (0 in filtered records)
4. **LoopInstance**: The batch number for processing
5. **JSON_Message**: The primary output - a JSON Patch document containing:
   - A JSON array of "replace" operations for core account fields
   - Address information updates
   - An ExtensionFields array with ID-value pairs for business-specific attributes

The procedure does not perform any direct INSERT, UPDATE, or DELETE operations on database tables. Instead, it prepares data for API consumption, which will presumably perform these operations in the external system.

## 7. Error Handling and Logging

The procedure has limited explicit error handling mechanisms:

### Error Identification Methods:
- **Null Handling**: Uses COALESCE extensively to prevent null values from breaking the JSON structure
- **Email Validation**: Simple pattern matching (`like '%@%'`) to prevent invalid email formats
- **Data Type Conversion**: CAST operations to ensure proper string formatting for JSON

### Missing Error Handling Components:
- No TRY/CATCH blocks for exception handling
- No explicit transaction management
- No logging of execution status or errors
- No validation of input parameters

### Recommendations for Improvement:
- Add TRY/CATCH blocks to handle exceptions gracefully
- Implement logging of execution metrics (records processed, errors encountered)
- Add validation for the @LoopInstance parameter
- Consider adding transaction control for data consistency
- Implement more robust email validation
- Add comments explaining the business purpose of extension field IDs

The procedure relies on the calling application or process to handle any errors that might occur during execution. This approach places the responsibility for error handling and logging at a higher level in the application stack rather than within the stored procedure itself.