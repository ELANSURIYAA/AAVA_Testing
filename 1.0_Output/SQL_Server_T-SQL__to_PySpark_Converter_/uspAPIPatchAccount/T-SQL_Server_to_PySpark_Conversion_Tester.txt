# Comprehensive Test Cases for uspAPIPatchAccount PySpark Implementation

## 1. Test Case Document

### Test Case ID: TC-01
**Description:** Basic Data Filtering - Verify that the function correctly filters accounts based on required conditions (PostPatch = 'Patch', Validated IS NULL, DateSent IS NULL, SubmissionFlag = 0)

### Test Case ID: TC-02
**Description:** Loop Instance Filtering - Verify that the function correctly processes accounts based on the LoopInstance parameter

### Test Case ID: TC-03
**Description:** National Accounts Handling - Verify that UnderwriterID is removed for national accounts

### Test Case ID: TC-04
**Description:** Account ID Resolution - Verify that AccountID is correctly resolved using COALESCE(AC.AccountID, ID.RCT_ID)

### Test Case ID: TC-05
**Description:** Email Validation - Verify that email fields are only included if they contain '@' character

### Test Case ID: TC-06
**Description:** Extension Fields Generation - Verify that all extension fields are correctly generated in the JSON output

### Test Case ID: TC-07
**Description:** Required Field Handling - Verify that required fields (like field 167) are always included

### Test Case ID: TC-08
**Description:** External Unique ID Formatting - Verify the logic for field 167 (ExternalUniqueId formatting)

### Test Case ID: TC-09
**Description:** New Business Policy Flag - Verify that NewBusinessPolicyFlag is correctly converted to extension field 120

### Test Case ID: TC-10
**Description:** Primary Contact Phone Default - Verify that NULL primary contact phone is replaced with 'Unknown'

## 2. Pytest Script

```python
import pytest
import json
from datetime import datetime, timedelta
from pyspark.sql import SparkSession
from pyspark.sql.types import StructType, StructField, StringType, IntegerType, FloatType, BooleanType, DateType
import pandas as pd
from unittest.mock import patch, MagicMock

# Import the module containing the function to test
# Assuming the implementation is in a module called uspAPIPatchAccount_pyspark
from uspAPIPatchAccount_pyspark import process_api_patch_account

@pytest.fixture(scope="session")
def spark():
    """Create a Spark session for testing."""
    return (
        SparkSession.builder
        .master("local[*]")
        .appName("uspAPIPatchAccount_test")
        .config("spark.sql.shuffle.partitions", "1")
        .config("spark.default.parallelism", "1")
        .getOrCreate()
    )

@pytest.fixture
def mock_date():
    """Mock the current date for testing."""
    return datetime.now() - timedelta(days=1)

@pytest.fixture
def account_schema():
    """Define the schema for the Account table."""
    return StructType([
        StructField("ContactNumber", StringType(), True),
        StructField("Name", StringType(), True),
        StructField("BusinessPhone", StringType(), True),
        StructField("FaxPhone", StringType(), True),
        StructField("EmailAddress", StringType(), True),
        StructField("Notes", StringType(), True),
        StructField("UnderwriterId", StringType(), True),
        StructField("ExternalUniqueId", StringType(), True),
        StructField("PrimaryLocationAddressProvinceId", StringType(), True),
        StructField("PrimaryLocationAddressAddressLine", StringType(), True),
        StructField("PrimaryLocationAddressCity", StringType(), True),
        StructField("PrimaryLocationAddressPostalCode", StringType(), True),
        StructField("PrimaryLocationAddressLongitude", StringType(), True),
        StructField("PrimaryLocationAddressLatitude", StringType(), True),
        StructField("PrimaryLocationAddressCounty", StringType(), True),
        StructField("PrimaryLocationAddressExternalUniqueId", StringType(), True),
        StructField("PrimaryLocationAddressLocationNumber", StringType(), True),
        StructField("PrimaryLocationAddressDescription", StringType(), True),
        StructField("PrimaryLocationAddressAdditionalInfo", StringType(), True),
        StructField("MailingAddressProvinceId", StringType(), True),
        StructField("MailingAddressAddressLine", StringType(), True),
        StructField("MailingAddressCity", StringType(), True),
        StructField("MailingAddressPostalCode", StringType(), True),
        StructField("MailingAddressLongitude", StringType(), True),
        StructField("MailingAddressLatitude", StringType(), True),
        StructField("MailingAddressCounty", StringType(), True),
        StructField("BDCName", StringType(), True),
        StructField("AccountStatus", StringType(), True),
        StructField("Policy1", StringType(), True),
        StructField("LineOfBusiness1", StringType(), True),
        StructField("PricingType1", StringType(), True),
        StructField("ContractAgencyBusinessEmail", StringType(), True),
        StructField("MasterAgent", StringType(), True),
        StructField("OnBaseLink", StringType(), True),
        StructField("ComplianceFLAG", StringType(), True),
        StructField("PrimaryContactEmail", StringType(), True),
        StructField("PrimaryContactTitle", StringType(), True),
        StructField("UnderwriterName", StringType(), True),
        StructField("UnderwriterPhone", StringType(), True),
        StructField("UnderwriterEmail", StringType(), True),
        StructField("ContractAgencyName", StringType(), True),
        StructField("Brand", StringType(), True),
        StructField("OperatingCompany", StringType(), True),
        StructField("PreviousAccountID", StringType(), True),
        StructField("PolicyRegion", StringType(), True),
        StructField("PrimaryContactName", StringType(), True),
        StructField("PrimaryContactPhone", StringType(), True),
        StructField("LineOfBusiness3", StringType(), True),
        StructField("PricingType3", StringType(), True),
        StructField("GoverningClassCode3", StringType(), True),
        StructField("NAICSCode3", StringType(), True),
        StructField("Industry3", StringType(), True),
        StructField("HazardGroup3", StringType(), True),
        StructField("PricingType2", StringType(), True),
        StructField("GoverningClassCode2", StringType(), True),
        StructField("NAICSCode2", StringType(), True),
        StructField("Industry2", StringType(), True),
        StructField("HazardGroup2", StringType(), True),
        StructField("Policy3", StringType(), True),
        StructField("GoverningClassCode1", StringType(), True),
        StructField("NAICSCode1", StringType(), True),
        StructField("Industry1", StringType(), True),
        StructField("HazardGroup1", StringType(), True),
        StructField("Policy2", StringType(), True),
        StructField("LineOfBusiness2", StringType(), True),
        StructField("NewBusinessPolicyFlag", IntegerType(), True),
        StructField("AgencyID", StringType(), True),
        StructField("PolicyEffectiveDate1", StringType(), True),
        StructField("PolicyExpirationDATE1", StringType(), True),
        StructField("PolicyEffectiveDate2", StringType(), True),
        StructField("PolicyExpirationDATE2", StringType(), True),
        StructField("PolicyEffectiveDate3", StringType(), True),
        StructField("PolicyExpirationDATE3", StringType(), True),
        StructField("ExperienceModificationFactor1", FloatType(), True),
        StructField("ExperienceModificationFactor2", FloatType(), True),
        StructField("ExperienceModificationFactor3", FloatType(), True),
        StructField("Premium1", FloatType(), True),
        StructField("Payroll1", FloatType(), True),
        StructField("Premium2", FloatType(), True),
        StructField("Payroll2", FloatType(), True),
        StructField("Premium3", FloatType(), True),
        StructField("Payroll3", FloatType(), True),
        StructField("PMScore1", FloatType(), True),
        StructField("PMScore2", FloatType(), True),
        StructField("PMScore3", FloatType(), True),
        StructField("MasterCompany", StringType(), True),
        StructField("WrittenLossRatio", FloatType(), True),
        StructField("PostPatch", StringType(), True),
        StructField("Validated", StringType(), True),
        StructField("DateSent", DateType(), True),
        StructField("SubmissionFlag", IntegerType(), True)
    ])

@pytest.fixture
def account_id_schema():
    """Define the schema for the AccountID table."""
    return StructType([
        StructField("AccountID", StringType(), True),
        StructField("ContactNumber", StringType(), True)
    ])

@pytest.fixture
def id_override_schema():
    """Define the schema for the IdOverride table."""
    return StructType([
        StructField("RCT_ID", StringType(), True),
        StructField("ExternalUniqueID", StringType(), True),
        StructField("ObjectType", StringType(), True)
    ])

@pytest.fixture
def policy_descriptors_schema():
    """Define the schema for the PolicyDescriptors table."""
    return StructType([
        StructField("AccountNumber", StringType(), True),
        StructField("NationalAccountFlag", IntegerType(), True),
        StructField("ExpirationDate", DateType(), True)
    ])

@pytest.fixture
def sample_account_data(spark):
    """Create sample data for the Account table."""
    data = [
        # Regular account
        ("AF12345", "Test Company 1", "555-123-4567", "555-123-4568", "contact@testcompany1.com", 
         "Test notes", "UW123", "EXT123", "MI", "123 Main St", "Ann Arbor", "48104", 
         "-83.7430", "42.2808", "Washtenaw", "LOC123", "L001", "Main Office", "Additional info",
         "MI", "123 Main St", "Ann Arbor", "48104", "-83.7430", "42.2808", "Washtenaw",
         "BDC Name", "inforce", "POL123", "Workers Comp", "Guaranteed Cost", "agency@email.com",
         "Agent123", "http://onbase.link/123", "Y", "primary@email.com", "Manager",
         "John Underwriter", "555-987-6543", "underwriter@email.com", "Agency Name",
         "Accident Fund", "AF", "PREV123", "Midwest", "John Contact", "555-111-2222",
         "General Liability", "Retro", "8810", "123456", "Office", "A", "Loss Sensitive",
         "5551", "654321", "Manufacturing", "B", "POL456", "8742", "112233", "Services", "C",
         "POL789", "Auto", 1, "AG123", "2023-01-01", "2024-01-01", "2023-02-01", "2024-02-01",
         "2023-03-01", "2024-03-01", 1.2, 1.3, 1.4, 100000.0, 500000.0, 75000.0, 400000.0,
         50000.0, 300000.0, 0.95, 0.97, 0.99, "Master Co", 0.75, "Patch", None, None, 0),
        
        # National account
        ("AF67890", "National Company", "555-333-4444", "555-333-4445", "contact@nationalcompany.com", 
         "National account notes", "UW456", "EXT456", "CA", "456 Oak St", "Los Angeles", "90001", 
         "-118.2437", "34.0522", "Los Angeles", "LOC456", "L002", "LA Office", "National account",
         "CA", "456 Oak St", "Los Angeles", "90001", "-118.2437", "34.0522", "Los Angeles",
         "BDC Name 2", "inforce", "POL456", "Workers Comp", "Guaranteed Cost", "agency2@email.com",
         "Agent456", "http://onbase.link/456", "N", "primary2@email.com", "Director",
         "Jane Underwriter", "555-111-3333", "underwriter2@email.com", "Agency Name 2",
         "CompWest", "CW", "PREV456", "West", "Jane Contact", "555-444-5555",
         "General Liability", "Guaranteed Cost", "8810", "654321", "Office", "A", "Guaranteed Cost",
         "5551", "112233", "Manufacturing", "B", "POL789", "8742", "123456", "Services", "C",
         "POL012", "Auto", 0, "AG456", "2023-04-01", "2024-04-01", "2023-05-01", "2024-05-01",
         "2023-06-01", "2024-06-01", 0.9, 1.0, 1.1, 200000.0, 1000000.0, 150000.0, 800000.0,
         100000.0, 600000.0, 0.85, 0.87, 0.89, "Master Co 2", 0.65, "Patch", None, None, 0),
         
        # Account with missing email
        ("AF13579", "Missing Email Co", "555-222-3333", "555-222-3334", "invalid-email", 
         "Missing email notes", "UW789", "EXT789", "TX", "789 Pine St", "Houston", "77001", 
         "-95.3698", "29.7604", "Harris", "LOC789", "L003", "Houston Office", "Missing email",
         "TX", "789 Pine St", "Houston", "77001", "-95.3698", "29.7604", "Harris",
         "BDC Name 3", "prospect", "POL789", "Workers Comp", "Guaranteed Cost", "invalid-agency-email",
         "Agent789", "http://onbase.link/789", "Y", "invalid-primary-email", "Supervisor",
         "Bob Underwriter", "555-444-6666", "invalid-underwriter-email", "Agency Name 3",
         "United Heartland", "UH", "PREV789", "South", "Bob Contact", "555-666-7777",
         "General Liability", "Guaranteed Cost", "8810", "789012", "Office", "A", "Guaranteed Cost",
         "5551", "345678", "Manufacturing", "B", "POL012", "8742", "901234", "Services", "C",
         "POL345", "Auto", 1, "AG789", "2023-07-01", "2024-07-01", "2023-08-01", "2024-08-01",
         "2023-09-01", "2024-09-01", 1.5, 1.6, 1.7, 150000.0, 750000.0, 125000.0, 600000.0,
         75000.0, 450000.0, 1.05, 1.07, 1.09, "Master Co 3", 0.85, "Patch", None, None, 0)
    ]
    
    df = spark.createDataFrame(data, account_schema())
    return df

@pytest.fixture
def sample_account_id_data(spark):
    """Create sample data for the AccountID table."""
    data = [
        ("ACC123", "AF12345"),
        ("ACC456", "AF67890"),
        # No mapping for AF13579 to test the ID override case
    ]
    
    df = spark.createDataFrame(data, account_id_schema())
    return df

@pytest.fixture
def sample_id_override_data(spark):
    """Create sample data for the IdOverride table."""
    data = [
        ("OVR789", "EXT789", "Account"),
        ("OVR999", "EXT999", "Account"),  # Not used in our test
        ("OVR888", "EXT888", "Location")  # Different object type, should be ignored
    ]
    
    df = spark.createDataFrame(data, id_override_schema())
    return df

@pytest.fixture
def sample_policy_descriptors_data(spark, mock_date):
    """Create sample data for the PolicyDescriptors table."""
    future_date = mock_date + timedelta(days=30)
    past_date = mock_date - timedelta(days=30)
    
    data = [
        ("AF67890", 1, future_date),  # National account with future expiration
        ("AF24680", 1, past_date),    # National account with past expiration (should be ignored)
        ("AF12345", 0, future_date)   # Regular account (not national)
    ]
    
    df = spark.createDataFrame(data, policy_descriptors_schema())
    return df

@pytest.fixture
def expected_output_schema():
    """Define the schema for the expected output."""
    return StructType([
        StructField("AccountID", StringType(), True),
        StructField("ContactNumber", StringType(), True),
        StructField("SubmissionFlag", IntegerType(), True),
        StructField("LoopInstance", IntegerType(), True),
        StructField("JSON_Message", StringType(), True)
    ])

def test_process_api_patch_account_regular_account(spark, sample_account_data, sample_account_id_data, 
                                                  sample_id_override_data, sample_policy_descriptors_data):
    """Test the process_api_patch_account function with a regular account."""
    
    # Register the DataFrames as temporary views
    sample_account_data.createOrReplaceTempView("RCT_Account")
    sample_account_id_data.createOrReplaceTempView("RCT_AccountID")
    sample_id_override_data.createOrReplaceTempView("RCT_IdOverride")
    sample_policy_descriptors_data.createOrReplaceTempView("EDSMART_Semantic_PolicyDescriptors")
    
    # Call the function with loop instance 0
    result = process_api_patch_account(spark, 0)
    
    # Convert result to pandas for easier assertions
    result_pd = result.toPandas()
    
    # Check that we have the expected number of rows
    assert len(result_pd) > 0, "Result should contain at least one row"
    
    # Check that the regular account is in the result
    regular_account = result_pd[result_pd["ContactNumber"] == "AF12345"]
    assert len(regular_account) == 1, "Regular account should be in the result"
    
    # Check that the AccountID is correctly set
    assert regular_account.iloc[0]["AccountID"] == "ACC123", "AccountID should be from AccountID table"
    
    # Check that the JSON message contains the UnderwriterId
    assert "UnderwriterId" in regular_account.iloc[0]["JSON_Message"], "JSON should include UnderwriterId for regular account"
    
    # Check that the JSON message contains the expected fields
    json_message = regular_account.iloc[0]["JSON_Message"]
    assert "MailingAddress/ProvinceID" in json_message, "JSON should include MailingAddress/ProvinceID"
    assert "MailingAddress/AddressLine" in json_message, "JSON should include MailingAddress/AddressLine"
    assert "Name" in json_message, "JSON should include Name"
    assert "ExtensionFields" in json_message, "JSON should include ExtensionFields"
    
    # Check that email validation is working
    assert "contact@testcompany1.com" in json_message, "Valid email should be included"

def test_process_api_patch_account_national_account(spark, sample_account_data, sample_account_id_data, 
                                                   sample_id_override_data, sample_policy_descriptors_data):
    """Test the process_api_patch_account function with a national account."""
    
    # Register the DataFrames as temporary views
    sample_account_data.createOrReplaceTempView("RCT_Account")
    sample_account_id_data.createOrReplaceTempView("RCT_AccountID")
    sample_id_override_data.createOrReplaceTempView("RCT_IdOverride")
    sample_policy_descriptors_data.createOrReplaceTempView("EDSMART_Semantic_PolicyDescriptors")
    
    # Call the function with loop instance 0
    result = process_api_patch_account(spark, 0)
    
    # Convert result to pandas for easier assertions
    result_pd = result.toPandas()
    
    # Check that the national account is in the result
    national_account = result