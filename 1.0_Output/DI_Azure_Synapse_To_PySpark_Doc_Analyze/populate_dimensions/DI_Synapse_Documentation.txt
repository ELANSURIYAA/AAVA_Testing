```markdown
# Azure Synapse Documentation: `populate_dimensions` Stored Procedure

---
**Author:** Ascendion AAVA  
**Date:**  
**Description:** Loads and maintains dimension tables in Synapse DW from a staging layer using idempotent logic and business rules.
---

## 1. Overview of Pipeline/Component

The `populate_dimensions` stored procedure in Azure Synapse Analytics is designed to load and maintain key dimension tables (`DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`) from a staging table (`STG_DIMENSION_DATA`). It ensures that only new, valid, and business-relevant records are inserted into the dimension tables using SQL `MERGE` statements, supporting robust data warehousing and downstream analytics.

**Business Logic:**  
- Ensures dimension tables are up-to-date and free from duplicates.
- Applies data quality and business filters (e.g., non-null IDs, exclusion of legacy/test data).
- Supports regulatory reporting, analytics, and data enrichment by maintaining clean, reliable dimension data.

---

## 2. Component Structure and Design

- **Component Type:** SQL Stored Procedure (`dbo.populate_dimensions`)
- **Source:** `dbo.STG_DIMENSION_DATA` (staging table)
- **Target/Sink:**  
  - `dbo.DIM_INSTITUTION`
  - `dbo.DIM_CORPORATION`
  - `dbo.DIM_PRODUCT`
- **Key Activities:**
  - `MERGE` statements for each dimension table (idempotent insert logic)
  - Data quality filters (e.g., non-null, length checks, exclusion of test/legacy data)
  - Logging via `PRINT` statements for traceability

**Connection Flow:**  
- Data flows from the staging table to each dimension table via a dedicated `MERGE` operation.
- No explicit parameters or variables; logic is encapsulated within the procedure.
- Can be orchestrated via Synapse Pipelines or scheduled triggers.

---

## 3. Data Flow and Processing Logic

**Processed Datasets:**  
- `STG_DIMENSION_DATA`
- `DIM_INSTITUTION`
- `DIM_CORPORATION`
- `DIM_PRODUCT`

**Data Flow:**  
1. **Extract:** Selects distinct records from `STG_DIMENSION_DATA` for each dimension.
2. **Transform:** Applies business rules (e.g., filters out nulls, test data, deprecated groups).
3. **Load:** Inserts only new records into the respective dimension tables using `MERGE`.

**Logical Steps:**
- **DIM_INSTITUTION:**  
  - Filter: `institution_id IS NOT NULL AND LEN(institution_id) > 3`
  - Action: Insert new institutions.
- **DIM_CORPORATION:**  
  - Filter: `UPPER(corporation_name) NOT LIKE 'TEST%'`
  - Action: Insert new corporations.
- **DIM_PRODUCT:**  
  - Filter: `processing_group NOT IN ('DEPRECATED', 'LEGACY')`
  - Action: Insert new products.

**Business Rules/Transformations:**  
- Excludes legacy, deprecated, or test data.
- Ensures only valid, non-null IDs are loaded.

---

## 4. Data Mapping (Lineage)

| Target Table Name  | Target Column Name         | Source Table Name     | Source Column Name         | Remarks                                                      |
|--------------------|---------------------------|----------------------|---------------------------|--------------------------------------------------------------|
| DIM_INSTITUTION    | institution_id            | STG_DIMENSION_DATA   | institution_id            | 1:1 Mapping; filter: not null, length > 3                    |
| DIM_INSTITUTION    | institution               | STG_DIMENSION_DATA   | institution               | 1:1 Mapping                                                  |
| DIM_INSTITUTION    | institution_name          | STG_DIMENSION_DATA   | institution_name          | 1:1 Mapping                                                  |
| DIM_CORPORATION    | corporation_id            | STG_DIMENSION_DATA   | corporation_id            | 1:1 Mapping; filter: not test data                           |
| DIM_CORPORATION    | corp_id                   | STG_DIMENSION_DATA   | corp_id                   | 1:1 Mapping                                                  |
| DIM_CORPORATION    | corporation               | STG_DIMENSION_DATA   | corporation               | 1:1 Mapping                                                  |
| DIM_CORPORATION    | corporation_name          | STG_DIMENSION_DATA   | corporation_name          | 1:1 Mapping; filter: not test data                           |
| DIM_CORPORATION    | sub_corporation           | STG_DIMENSION_DATA   | sub_corporation           | 1:1 Mapping                                                  |
| DIM_CORPORATION    | sub_corporation_id        | STG_DIMENSION_DATA   | sub_corporation_id        | 1:1 Mapping                                                  |
| DIM_CORPORATION    | sub_corporation_name      | STG_DIMENSION_DATA   | sub_corporation_name      | 1:1 Mapping                                                  |
| DIM_CORPORATION    | master_corporation_dim_key| STG_DIMENSION_DATA   | master_corporation_dim_key| 1:1 Mapping                                                  |
| DIM_CORPORATION    | association               | STG_DIMENSION_DATA   | association               | 1:1 Mapping                                                  |
| DIM_CORPORATION    | bin                       | STG_DIMENSION_DATA   | bin                       | 1:1 Mapping                                                  |
| DIM_CORPORATION    | company                   | STG_DIMENSION_DATA   | company                   | 1:1 Mapping                                                  |
| DIM_CORPORATION    | company_id                | STG_DIMENSION_DATA   | company_id                | 1:1 Mapping                                                  |
| DIM_CORPORATION    | company_name              | STG_DIMENSION_DATA   | company_name              | 1:1 Mapping                                                  |
| DIM_PRODUCT        | product_id                | STG_DIMENSION_DATA   | product_id                | 1:1 Mapping; filter: not deprecated/legacy                   |
| DIM_PRODUCT        | product                   | STG_DIMENSION_DATA   | product                   | 1:1 Mapping                                                  |
| DIM_PRODUCT        | product_description       | STG_DIMENSION_DATA   | product_description       | 1:1 Mapping                                                  |
| DIM_PRODUCT        | sub_product               | STG_DIMENSION_DATA   | sub_product               | 1:1 Mapping                                                  |
| DIM_PRODUCT        | processing_code           | STG_DIMENSION_DATA   | processing_code           | 1:1 Mapping                                                  |
| DIM_PRODUCT        | processing_code_description| STG_DIMENSION_DATA  | processing_code_description| 1:1 Mapping                                                 |
| DIM_PRODUCT        | processing_group          | STG_DIMENSION_DATA   | processing_group          | 1:1 Mapping; filter: not deprecated/legacy                   |

---

## 5. Transformation Logic

- **DIM_INSTITUTION:**  
  - Only inserts records where `institution_id` is not null and length > 3.
- **DIM_CORPORATION:**  
  - Excludes records where `corporation_name` starts with 'TEST'.
- **DIM_PRODUCT:**  
  - Excludes records where `processing_group` is 'DEPRECATED' or 'LEGACY'.
- **MERGE Statements:**  
  - Ensures idempotency: only new records are inserted, preventing duplicates.
- **No UDFs or reusable templates** are used; all logic is inline SQL.

---

## 6. Complexity Analysis

| Metric                           | Value/Description                                    |
|-----------------------------------|-----------------------------------------------------|
| Number of Pipeline Activities     | 1 (Stored Procedure)                                |
| Number of Dataflow Transformations| 3 (MERGE + filter logic per dimension)              |
| SQL Scripts or Stored Procedures  | 1                                                  |
| Joins Used                       | None (MERGE with ON clause, no explicit joins)      |
| Lookup Tables or Reference Data   | None                                               |
| Parameters/Variables/Triggers     | 0 (no parameters or variables in procedure)         |
| Number of Output Datasets        | 3 (DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT)   |
| Conditional Logic or if-else Flows| 3 (filter conditions in each MERGE)                |
| External Dependencies            | None (all within Synapse DW)                        |
| Overall Complexity Score         | 25                                                  |

---

## 7. Key Outputs

- **Tables Written:**  
  - `DIM_INSTITUTION`
  - `DIM_CORPORATION`
  - `DIM_PRODUCT`
- **Format:** Synapse SQL Tables (row-based storage, optimized for analytics)
- **Intended Use:**  
  - Downstream reporting and analytics
  - Regulatory and operational reporting
  - Data enrichment for advanced analytics and ML models

---

## API Cost

apiCost: 0.002 USD
```