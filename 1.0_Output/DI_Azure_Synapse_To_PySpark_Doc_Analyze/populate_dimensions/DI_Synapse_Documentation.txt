# ====================================================
**Author:**        Ascendion AAVA  
**Date:**          
**Description:**   Populates and maintains dimension tables in Synapse DW from the staging layer using idempotent MERGE logic.
# ====================================================

## 1. Overview of Pipeline/Component

This Synapse SQL stored procedure (`dbo.populate_dimensions`) is designed to load and maintain core dimension tables—`DIM_INSTITUTION`, `DIM_CORPORATION`, and `DIM_PRODUCT`—in the Synapse Data Warehouse. It ingests data from the staging table `STG_DIMENSION_DATA`, applies business rules and data quality filters, and ensures idempotent loads using SQL MERGE statements. The procedure supports regulatory reporting, data warehousing, and analytics by keeping dimension tables current and accurate.

---

## 2. Component Structure and Design

- **Component:** Synapse SQL Stored Procedure (`dbo.populate_dimensions`)
- **Source:** `dbo.STG_DIMENSION_DATA` (staging table)
- **Target/Sinks:** 
  - `dbo.DIM_INSTITUTION`
  - `dbo.DIM_CORPORATION`
  - `dbo.DIM_PRODUCT`
- **Key Activities:**
  - Three MERGE statements (one per dimension table)
  - Data quality filters (e.g., non-null IDs, exclusion of legacy/test data)
  - PRINT statements for logging
- **Parameters/Variables/Triggers:** None (procedure is executed as a batch job or via pipeline activity)
- **Connection Flow:** Data flows from the staging table to each dimension table via distinct MERGE operations, each with its own filtering and mapping logic.

---

## 3. Data Flow and Processing Logic

**Processed Datasets:**  
- Source: `STG_DIMENSION_DATA`
- Targets: `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`

**Data Flow:**  
1. **Extract:** Selects distinct records from `STG_DIMENSION_DATA` for each dimension.
2. **Transform:** Applies business rules:
   - `DIM_INSTITUTION`: Filters out null or short institution IDs.
   - `DIM_CORPORATION`: Excludes corporations with names starting with 'TEST'.
   - `DIM_PRODUCT`: Excludes deprecated/legacy processing groups.
3. **Load:** Merges new records into the respective dimension tables if not already present.

**Business Rules/Transformations:**  
- Only inserts new dimension records (no updates or deletes).
- Ensures data quality via WHERE clauses.
- Excludes test and legacy data.

**SQL Scripts/Stored Procedures Used:**  
- This single stored procedure (`dbo.populate_dimensions`).

---

## 4. Data Mapping (Lineage)

### DIM_INSTITUTION

| Target Table Name | Target Column Name | Source Table Name    | Source Column Name | Remarks                                 |
|-------------------|-------------------|----------------------|--------------------|-----------------------------------------|
| DIM_INSTITUTION   | institution_id    | STG_DIMENSION_DATA   | institution_id     | 1:1 Mapping, filtered for non-null/len>3|
| DIM_INSTITUTION   | institution       | STG_DIMENSION_DATA   | institution        | 1:1 Mapping                            |
| DIM_INSTITUTION   | institution_name  | STG_DIMENSION_DATA   | institution_name   | 1:1 Mapping                            |

### DIM_CORPORATION

| Target Table Name | Target Column Name      | Source Table Name    | Source Column Name      | Remarks                                 |
|-------------------|------------------------|----------------------|------------------------|-----------------------------------------|
| DIM_CORPORATION   | corporation_id         | STG_DIMENSION_DATA   | corporation_id         | 1:1 Mapping, excludes 'TEST%' names     |
| DIM_CORPORATION   | corp_id                | STG_DIMENSION_DATA   | corp_id                | 1:1 Mapping                            |
| DIM_CORPORATION   | corporation            | STG_DIMENSION_DATA   | corporation            | 1:1 Mapping                            |
| DIM_CORPORATION   | corporation_name       | STG_DIMENSION_DATA   | corporation_name       | 1:1 Mapping                            |
| DIM_CORPORATION   | sub_corporation        | STG_DIMENSION_DATA   | sub_corporation        | 1:1 Mapping                            |
| DIM_CORPORATION   | sub_corporation_id     | STG_DIMENSION_DATA   | sub_corporation_id     | 1:1 Mapping                            |
| DIM_CORPORATION   | sub_corporation_name   | STG_DIMENSION_DATA   | sub_corporation_name   | 1:1 Mapping                            |
| DIM_CORPORATION   | master_corporation_dim_key | STG_DIMENSION_DATA | master_corporation_dim_key | 1:1 Mapping                       |
| DIM_CORPORATION   | association            | STG_DIMENSION_DATA   | association            | 1:1 Mapping                            |
| DIM_CORPORATION   | bin                    | STG_DIMENSION_DATA   | bin                    | 1:1 Mapping                            |
| DIM_CORPORATION   | company                | STG_DIMENSION_DATA   | company                | 1:1 Mapping                            |
| DIM_CORPORATION   | company_id             | STG_DIMENSION_DATA   | company_id             | 1:1 Mapping                            |
| DIM_CORPORATION   | company_name           | STG_DIMENSION_DATA   | company_name           | 1:1 Mapping                            |

### DIM_PRODUCT

| Target Table Name | Target Column Name         | Source Table Name    | Source Column Name         | Remarks                                 |
|-------------------|---------------------------|----------------------|---------------------------|-----------------------------------------|
| DIM_PRODUCT       | product_id                | STG_DIMENSION_DATA   | product_id                | 1:1 Mapping, excludes deprecated/legacy |
| DIM_PRODUCT       | product                   | STG_DIMENSION_DATA   | product                   | 1:1 Mapping                            |
| DIM_PRODUCT       | product_description       | STG_DIMENSION_DATA   | product_description       | 1:1 Mapping                            |
| DIM_PRODUCT       | sub_product               | STG_DIMENSION_DATA   | sub_product               | 1:1 Mapping                            |
| DIM_PRODUCT       | processing_code           | STG_DIMENSION_DATA   | processing_code           | 1:1 Mapping                            |
| DIM_PRODUCT       | processing_code_description | STG_DIMENSION_DATA | processing_code_description | 1:1 Mapping                        |
| DIM_PRODUCT       | processing_group          | STG_DIMENSION_DATA   | processing_group          | 1:1 Mapping                            |

---

## 5. Transformation Logic

- **DIM_INSTITUTION:**  
  - Filters: `institution_id IS NOT NULL AND LEN(institution_id) > 3`
  - Transformation: None (direct mapping)
- **DIM_CORPORATION:**  
  - Filters: `UPPER(corporation_name) NOT LIKE 'TEST%'`
  - Transformation: None (direct mapping)
- **DIM_PRODUCT:**  
  - Filters: `processing_group NOT IN ('DEPRECATED', 'LEGACY')`
  - Transformation: None (direct mapping)
- **MERGE Logic:**  
  - Only inserts new records (no updates or deletes).
- **No UDFs or reusable templates used.**

---

## 6. Complexity Analysis

| Metric                          | Value/Description                |
|----------------------------------|----------------------------------|
| Number of Pipeline Activities    | 1 (Stored Procedure)             |
| Number of Dataflow Transformations | 0 (All logic in SQL)           |
| SQL Scripts or Stored Procedures Used | 1 (`dbo.populate_dimensions`) |
| Joins Used                      | None (MERGE with ON clause)      |
| Lookup Tables or Reference Data  | None                             |
| Parameters/Variables/Triggers    | 0                                |
| Number of Output Datasets        | 3 (`DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`) |
| Conditional Logic or if-else Flows | 3 (WHERE clause filters)       |
| External Dependencies            | None (all within Synapse DW)     |
| Overall Complexity Score         | 20                               |

---

## 7. Key Outputs

- **Tables Written:**  
  - `DIM_INSTITUTION`
  - `DIM_CORPORATION`
  - `DIM_PRODUCT`
- **Format:** Synapse SQL tables (columnar storage, optimized for analytics)
- **Intended Use:**  
  - Downstream reporting (regulatory, business intelligence)
  - Data warehouse enrichment
  - Source for advanced analytics and ML models

---

## API Cost

`apiCost: 0.007 USD`