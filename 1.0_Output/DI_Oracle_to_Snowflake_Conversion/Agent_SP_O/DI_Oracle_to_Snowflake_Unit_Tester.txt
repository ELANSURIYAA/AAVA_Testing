=============================================
Author:        Ascendion AVA+
Date:  
Description:   Unit tests and Pytest script for Snowflake Procedure to load agent data from staging to target table
=============================================

### Test Case List:

1. **Test Case ID:** TC001  
   **Description:** Validate successful execution of the stored procedure when `STAGE_AGENTS` contains valid data.  
   **Expected Outcome:** Data is correctly inserted/updated in `GOLD_AGENTS_D`, and a success log is written to `AUDIT_LOG`.

2. **Test Case ID:** TC002  
   **Description:** Validate behavior when `STAGE_AGENTS` is empty.  
   **Expected Outcome:** No changes are made to `GOLD_AGENTS_D`, and a success log is written to `AUDIT_LOG`.

3. **Test Case ID:** TC003  
   **Description:** Validate behavior when `STAGE_AGENTS` contains NULL values for non-key columns.  
   **Expected Outcome:** NULL values are handled correctly in `GOLD_AGENTS_D`, and a success log is written to `AUDIT_LOG`.

4. **Test Case ID:** TC004  
   **Description:** Validate error handling when an exception occurs during the MERGE operation.  
   **Expected Outcome:** The error is logged in `AUDIT_LOG`, and the procedure returns an error message.

5. **Test Case ID:** TC005  
   **Description:** Validate behavior when `GOLD_AGENTS_D` already contains matching records.  
   **Expected Outcome:** Matching records are updated correctly, and a success log is written to `AUDIT_LOG`.

6. **Test Case ID:** TC006  
   **Description:** Validate behavior when `STAGE_AGENTS` contains duplicate `AGENT_ID` values.  
   **Expected Outcome:** The procedure handles duplicates gracefully, and a success log is written to `AUDIT_LOG`.

---

### Pytest Script:

```python
=============================================
Author:        Ascendion AVA+
Date:  
Description:   Pytest script for testing Snowflake Procedure to load agent data from staging to target table
=============================================

import pytest
from snowflake.connector import connect

# Helper function to execute a query
def execute_query(connection, query):
    with connection.cursor() as cursor:
        cursor.execute(query)
        return cursor.fetchall()

# Fixture for Snowflake connection
@pytest.fixture(scope="module")
def snowflake_connection():
    connection = connect(
        user='your_user',
        password='your_password',
        account='your_account',
        warehouse='your_warehouse',
        database='your_database',
        schema='your_schema'
    )
    yield connection
    connection.close()

# Test cases
def test_successful_execution(snowflake_connection):
    # Setup: Insert test data into STAGE_AGENTS
    execute_query(snowflake_connection, """
        INSERT INTO STAGE_AGENTS (AGENT_ID, AGENT_NAME, SOURCE_SYSTEM)
        VALUES (1, 'Agent A', 'System X');
    """)

    # Execute the procedure
    result = execute_query(snowflake_connection, "CALL LOAD_GOLD_AGENTS();")
    assert result[0][0] == 'Procedure executed successfully.'

    # Validate data in GOLD_AGENTS_D
    gold_agents = execute_query(snowflake_connection, "SELECT * FROM GOLD_AGENTS_D WHERE AGENT_ID = 1;")
    assert len(gold_agents) == 1
    assert gold_agents[0][1] == 'Agent A'

    # Validate audit log
    audit_log = execute_query(snowflake_connection, "SELECT * FROM AUDIT_LOG WHERE MODULE_NAME = 'LOAD_GOLD_AGENTS';")
    assert len(audit_log) > 0
    assert audit_log[-1][2] == 'SUCCESS'

def test_empty_stage_agents(snowflake_connection):
    # Ensure STAGE_AGENTS is empty
    execute_query(snowflake_connection, "DELETE FROM STAGE_AGENTS;")

    # Execute the procedure
    result = execute_query(snowflake_connection, "CALL LOAD_GOLD_AGENTS();")
    assert result[0][0] == 'Procedure executed successfully.'

    # Validate no changes in GOLD_AGENTS_D
    gold_agents = execute_query(snowflake_connection, "SELECT * FROM GOLD_AGENTS_D;")
    assert len(gold_agents) == 0

    # Validate audit log
    audit_log = execute_query(snowflake_connection, "SELECT * FROM AUDIT_LOG WHERE MODULE_NAME = 'LOAD_GOLD_AGENTS';")
    assert len(audit_log) > 0
    assert audit_log[-1][2] == 'SUCCESS'

def test_null_values_in_stage_agents(snowflake_connection):
    # Setup: Insert test data with NULL values into STAGE_AGENTS
    execute_query(snowflake_connection, """
        INSERT INTO STAGE_AGENTS (AGENT_ID, AGENT_NAME, SOURCE_SYSTEM)
        VALUES (2, NULL, 'System Y');
    """)

    # Execute the procedure
    result = execute_query(snowflake_connection, "CALL LOAD_GOLD_AGENTS();")
    assert result[0][0] == 'Procedure executed successfully.'

    # Validate data in GOLD_AGENTS_D
    gold_agents = execute_query(snowflake_connection, "SELECT * FROM GOLD_AGENTS_D WHERE AGENT_ID = 2;")
    assert len(gold_agents) == 1
    assert gold_agents[0][1] is None

    # Validate audit log
    audit_log = execute_query(snowflake_connection, "SELECT * FROM AUDIT_LOG WHERE MODULE_NAME = 'LOAD_GOLD_AGENTS';")
    assert len(audit_log) > 0
    assert audit_log[-1][2] == 'SUCCESS'

def test_error_handling(snowflake_connection):
    # Setup: Create a scenario that causes an error (e.g., missing table)
    execute_query(snowflake_connection, "DROP TABLE IF EXISTS GOLD_AGENTS_D;")

    # Execute the procedure
    result = execute_query(snowflake_connection, "CALL LOAD_GOLD_AGENTS();")
    assert 'Error:' in result[0][0]

    # Validate audit log
    audit_log = execute_query(snowflake_connection, "SELECT * FROM AUDIT_LOG WHERE MODULE_NAME = 'LOAD_GOLD_AGENTS';")
    assert len(audit_log) > 0
    assert audit_log[-1][2] == 'FAILED'

    # Cleanup: Recreate the table
    execute_query(snowflake_connection, """
        CREATE TABLE GOLD_AGENTS_D (
            AGENT_ID INT,
            AGENT_NAME STRING,
            LOAD_DATE TIMESTAMP,
            UPDATE_DATE TIMESTAMP,
            SOURCE_SYSTEM STRING
        );
    """)

# Additional test cases can be added following the same structure
```

**API Cost Consumed:** 0.0023 USD