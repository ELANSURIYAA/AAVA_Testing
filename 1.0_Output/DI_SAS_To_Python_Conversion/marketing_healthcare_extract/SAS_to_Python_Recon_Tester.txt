"""
=============================================

Author:        Ascendion AVAA

Created on:   (Leave it empty)

Description:   Python script for executing SAS logic, extracting data outputs, and validating results.

=============================================

"""
import pandas as pd
import numpy as np
from sqlalchemy import create_engine, text
import os

# --- Step 1: Secure Teradata connection using SQLAlchemy ---
# Replace with your credentials and connection details
TERADATA_USER = os.environ.get('TERADATA_USER')
TERADATA_PASS = os.environ.get('TERADATA_PASS')
TERADATA_HOST = 'your_server_name'
TERADATA_TDPID = 'your_tdpid'

# Example connection string for Teradata SQLAlchemy dialect (adjust as needed)
# Requires: pip install sqlalchemy teradatasql
engine = create_engine(
    f"teradatasql://{TERADATA_USER}:{TERADATA_PASS}@{TERADATA_HOST}/{TERADATA_TDPID}"
)

# --- Step 2: Extract and enrich data with business rules ---
sql_query = """
SELECT
    hp.member_id,
    TRIM(hp.member_first_name) || ' ' || TRIM(hp.member_last_name) AS member_full_name,
    hp.member_age,
    CASE
        WHEN hp.member_age BETWEEN 25 AND 35 THEN 'YOUNG_ADULT'
        WHEN hp.member_age BETWEEN 36 AND 50 THEN 'MID_AGE'
        WHEN hp.member_age > 50 THEN 'SENIOR'
        ELSE 'UNKNOWN'
    END AS age_group,
    hp.plan_id,
    hp.plan_type,
    hp.region,
    pn.network_type,
    UPPER(hp.plan_type) || '-' || hp.region AS marketing_segment,
    CASE
        WHEN hp.plan_status = 'ACTIVE'
             AND hp.member_age BETWEEN 25 AND 60
             AND hp.plan_type IN ('PPO', 'HMO')
             AND hp.region IN ('WEST', 'SOUTH')
             AND pn.network_type = 'IN_NETWORK'
        THEN 1
        ELSE 0
    END AS is_campaign_eligible
FROM tdata.healthcare_plans hp
LEFT JOIN tdata.provider_network pn
    ON hp.plan_id = pn.plan_id
WHERE hp.plan_status = 'ACTIVE'
  AND hp.member_age IS NOT NULL
"""

with engine.connect() as conn:
    marketing_extract = pd.read_sql(text(sql_query), conn)

# --- Step 3: Filter only eligible members ---
final_campaign_list = marketing_extract[marketing_extract['is_campaign_eligible'] == 1].copy()

# --- Step 4: Export final file ---
outpath = '/folders/myfolders/final_marketing_campaign_extract_2025.csv'
final_campaign_list.to_csv(outpath, index=False)

print(f"Exported {len(final_campaign_list)} eligible members to {outpath}")

apiCost: 0.00 USD