-- =============================================
-- Author:        Ascendion AVA+
-- Created on:    October 2023
-- Description:   Executes DQ validation checks on source table and logs violations
-- =============================================

-- Create a sequence for batch ID generation
CREATE OR REPLACE SEQUENCE MY_SAMPLE_DB.PUBLIC.BATCH_ID_SEQ START WITH 1 INCREMENT BY 1;

-- Stored Procedure to run DQ checks
CREATE OR REPLACE PROCEDURE MY_SAMPLE_DB.PUBLIC.sp_run_dq_checks()
RETURNS STRING
LANGUAGE JAVASCRIPT
AS
$$
    // Initialize the Snowflake context
    var snowflake = require('snowflake-sdk');
    var connection = snowflake.createConnection({
        account: '<your_account>',
        username: '<your_username>',
        password: '<your_password>',
        database: 'MY_SAMPLE_DB',
        schema: 'PUBLIC'
    });

    // Connect to Snowflake
    connection.connect(function(err, conn) {
        if (err) {
            throw err;
        }
    });

    // Generate a new batch ID
    var batchIdQuery = "SELECT MY_SAMPLE_DB.PUBLIC.BATCH_ID_SEQ.NEXTVAL AS BATCH_ID";
    var batchIdResult = connection.execute(batchIdQuery);
    var batchId = batchIdResult[0].BATCH_ID;

    // Define DQ rules
    var dqRules = [
        { column: 'FIRSTNAME', rule: 'IS NOT NULL', description: 'Ensure the first name is provided for every member.', severity: 'High' },
        { column: 'LASTNAME', rule: 'IS NOT NULL', description: 'Ensure the last name is provided for every member.', severity: 'High' },
        { column: 'COMPANY', rule: 'LENGTH(COMPANY) <= 255', description: 'Ensure the company name does not exceed 255 characters.', severity: 'Medium' },
        { column: 'ADDRESS', rule: 'LENGTH(ADDRESS) <= 16777216', description: 'Ensure the address does not exceed 16777216 characters.', severity: 'Low' },
        { column: 'CITY', rule: "CITY IN ('Los Angeles', 'New York', 'London')", description: 'Ensure the city is one of the approved locations: Los Angeles, New York, or London.', severity: 'High' },
        { column: 'COUNTRY', rule: 'IS NOT NULL', description: 'Ensure the country is provided for every member.', severity: 'High' },
        { column: 'STATE', rule: 'LENGTH(STATE) <= 100', description: 'Ensure the state name does not exceed 100 characters.', severity: 'Medium' },
        { column: 'ZIP', rule: 'ZIP REGEXP_MATCHES \'^[0-9A-Za-z]+$\'', description: 'Ensure the ZIP code matches the expected format (e.g., numeric or alphanumeric).', severity: 'Medium' },
        { column: 'PHONENUMBER1', rule: 'IS NOT NULL', description: 'Ensure the primary phone number is provided.', severity: 'High' },
        { column: 'PHONENUMBER2', rule: 'PHONENUMBER2 != PHONENUMBER1', description: 'Ensure PHONENUMBER2 is distinct from PHONENUMBER1 for each member.', severity: 'High' },
        { column: 'EMAIL', rule: 'EMAIL REGEXP_MATCHES \'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$\'', description: 'Ensure the email matches a valid email format.', severity: 'High' },
        { column: 'WEB', rule: 'WEB REGEXP_MATCHES \'^(https?://)?[A-Za-z0-9.-]+\\.[A-Za-z]{2,}(/.*)?$\'', description: 'Ensure the website URL matches a valid URL format.', severity: 'Medium' },
        { column: 'MEMBER_ID', rule: 'IS UNIQUE', description: 'Ensure MEMBER_ID is unique for each member.', severity: 'High' },
        { column: 'MEMBER_ID', rule: 'MEMBER_ID BETWEEN 10000000 AND 99999999', description: 'Ensure MEMBER_ID is within the range of 10000000 to 99999999.', severity: 'High' },
        { column: 'PHONENUMBER1, EMAIL, WEB', rule: 'PHONENUMBER1 IS NOT NULL OR EMAIL IS NOT NULL OR WEB IS NOT NULL', description: 'Ensure at least one valid form of contact information is provided (Phone, Email, or Website).', severity: 'High' }
    ];

    // Iterate through the rules and execute checks
    dqRules.forEach(function(rule) {
        var query = "INSERT INTO MY_SAMPLE_DB.PUBLIC.DQ_ISSUE_LOG (TABLE_NAME, COLUMN_NAME, RULE_DESCRIPTION, SEVERITY, LOGGED_AT, BATCH_ID, MEMBER_ID) " +
                    "SELECT 'MEMBERSDATA', '" + rule.column + "', '" + rule.description + "', '" + rule.severity + "', CURRENT_TIMESTAMP(), " + batchId + ", MEMBER_ID " +
                    "FROM MY_SAMPLE_DB.PUBLIC.MEMBERSDATA WHERE NOT (" + rule.rule + ")";
        connection.execute(query);
    });

    // Disconnect from Snowflake
    connection.disconnect(function(err) {
        if (err) {
            throw err;
        }
    });

    return "DQ checks completed successfully.";
$$;