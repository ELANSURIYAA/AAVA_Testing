=============================================

Author:        Ascendion AVA+

Created on:   

Description:   Pytest script for validating Snowflake SQL logic for employee backup table creation, data insertion via join, and sample data selection.

=============================================

**Test Case List:**

| Test Case ID | Description                                   | Input Data Description                                                      | Expected Outcome                                   |
|--------------|-----------------------------------------------|-----------------------------------------------------------------------------|----------------------------------------------------|
| TC001        | Validate employee_bkup table creation         | No input data; check schema after creation                                  | Table exists with correct schema                   |
| TC002        | Insert with matching EmployeeNo (happy path)  | Employee and Salary tables with matching EmployeeNo                         | Correct rows inserted into employee_bkup           |
| TC003        | Insert with no matching EmployeeNo            | Employee and Salary tables with no matching EmployeeNo                      | employee_bkup remains empty                        |
| TC004        | Insert with NULL values in join columns       | Employee or Salary table contains NULL in EmployeeNo                        | Rows with NULL EmployeeNo are excluded             |
| TC005        | Insert with NULL in non-key columns           | Employee and Salary tables with NULLs in non-key columns                    | NULLs are inserted as-is in employee_bkup          |
| TC006        | Select from EmployeeSample with data          | EmployeeSample table with sample records                                    | All records returned as expected                   |
| TC007        | Select from EmployeeSample with empty table   | EmployeeSample table is empty                                               | No records returned                                |
| TC008        | Error handling: insert with unexpected types  | Employee or Salary table contains unexpected data types (e.g., string in NetPay) | Error raised or handled gracefully                 |

**Pytest Script:**

import pytest
from snowflake.connector import connect

# Replace with your Snowflake credentials
SNOWFLAKE_USER = 'YOUR_USER'
SNOWFLAKE_PASSWORD = 'YOUR_PASSWORD'
SNOWFLAKE_ACCOUNT = 'YOUR_ACCOUNT'
SNOWFLAKE_DATABASE = 'YOUR_DATABASE'
SNOWFLAKE_SCHEMA = 'PUBLIC'

@pytest.fixture(scope="module")
def snowflake_connection():
    conn = connect(
        user=SNOWFLAKE_USER,
        password=SNOWFLAKE_PASSWORD,
        account=SNOWFLAKE_ACCOUNT,
        database=SNOWFLAKE_DATABASE,
        schema=SNOWFLAKE_SCHEMA
    )
    yield conn
    conn.close()

@pytest.fixture(autouse=True)
def cleanup_tables(snowflake_connection):
    cursor = snowflake_connection.cursor()
    # Clean up before each test
    cursor.execute("DROP TABLE IF EXISTS employee_bkup;")
    cursor.execute("DROP TABLE IF EXISTS Employee;")
    cursor.execute("DROP TABLE IF EXISTS Salary;")
    cursor.execute("DROP TABLE IF EXISTS EmployeeSample;")
    yield
    # Clean up after each test
    cursor.execute("DROP TABLE IF EXISTS employee_bkup;")
    cursor.execute("DROP TABLE IF EXISTS Employee;")
    cursor.execute("DROP TABLE IF EXISTS Salary;")
    cursor.execute("DROP TABLE IF EXISTS EmployeeSample;")
    cursor.close()

def test_table_creation(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("""
        CREATE TABLE employee_bkup (
            EmployeeNo INTEGER,
            FirstName CHAR(30),
            LastName CHAR(30),
            DepartmentNo SMALLINT,
            NetPay INTEGER
        );
    """)
    cursor.execute("SHOW TABLES LIKE 'employee_bkup';")
    result = cursor.fetchone()
    assert result is not None, "employee_bkup table was not created"
    cursor.close()

def test_insert_happy_path(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("""
        CREATE TABLE Employee (EmployeeNo INTEGER, FirstName CHAR(30), LastName CHAR(30), DepartmentNo SMALLINT);
        CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);
        CREATE TABLE employee_bkup (
            EmployeeNo INTEGER,
            FirstName CHAR(30),
            LastName CHAR(30),
            DepartmentNo SMALLINT,
            NetPay INTEGER
        );
    """)
    cursor.execute("""
        INSERT INTO Employee VALUES (1, 'John', 'Doe', 10), (2, 'Jane', 'Smith', 20);
        INSERT INTO Salary VALUES (1, 5000), (2, 6000);
    """)
    cursor.execute("""
        INSERT INTO employee_bkup
        SELECT a.EmployeeNo, a.FirstName, a.LastName, a.DepartmentNo, b.NetPay
        FROM Employee a INNER JOIN Salary b ON a.EmployeeNo = b.EmployeeNo;
    """)
    cursor.execute("SELECT * FROM employee_bkup ORDER BY EmployeeNo;")
    results = cursor.fetchall()
    assert results == [
        (1, 'John', 'Doe', 10, 5000),
        (2, 'Jane', 'Smith', 20, 6000)
    ], f"Inserted data mismatch: {results}"
    cursor.close()

def test_insert_no_matching_keys(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("""
        CREATE TABLE Employee (EmployeeNo INTEGER, FirstName CHAR(30), LastName CHAR(30), DepartmentNo SMALLINT);
        CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);
        CREATE TABLE employee_bkup (
            EmployeeNo INTEGER,
            FirstName CHAR(30),
            LastName CHAR(30),
            DepartmentNo SMALLINT,
            NetPay INTEGER
        );
    """)
    cursor.execute("""
        INSERT INTO Employee VALUES (1, 'John', 'Doe', 10);
        INSERT INTO Salary VALUES (2, 6000);
    """)
    cursor.execute("""
        INSERT INTO employee_bkup
        SELECT a.EmployeeNo, a.FirstName, a.LastName, a.DepartmentNo, b.NetPay
        FROM Employee a INNER JOIN Salary b ON a.EmployeeNo = b.EmployeeNo;
    """)
    cursor.execute("SELECT * FROM employee_bkup;")
    results = cursor.fetchall()
    assert results == [], "employee_bkup should be empty when no matching keys"
    cursor.close()

def test_insert_null_in_join_column(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("""
        CREATE TABLE Employee (EmployeeNo INTEGER, FirstName CHAR(30), LastName CHAR(30), DepartmentNo SMALLINT);
        CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);
        CREATE TABLE employee_bkup (
            EmployeeNo INTEGER,
            FirstName CHAR(30),
            LastName CHAR(30),
            DepartmentNo SMALLINT,
            NetPay INTEGER
        );
    """)
    cursor.execute("""
        INSERT INTO Employee VALUES (NULL, 'Null', 'Person', 30), (1, 'John', 'Doe', 10);
        INSERT INTO Salary VALUES (NULL, 7000), (1, 5000);
    """)
    cursor.execute("""
        INSERT INTO employee_bkup
        SELECT a.EmployeeNo, a.FirstName, a.LastName, a.DepartmentNo, b.NetPay
        FROM Employee a INNER JOIN Salary b ON a.EmployeeNo = b.EmployeeNo;
    """)
    cursor.execute("SELECT * FROM employee_bkup ORDER BY EmployeeNo;")
    results = cursor.fetchall()
    assert results == [(1, 'John', 'Doe', 10, 5000)], f"Rows with NULL join keys should be excluded: {results}"
    cursor.close()

def test_insert_null_in_non_key_columns(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("""
        CREATE TABLE Employee (EmployeeNo INTEGER, FirstName CHAR(30), LastName CHAR(30), DepartmentNo SMALLINT);
        CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);
        CREATE TABLE employee_bkup (
            EmployeeNo INTEGER,
            FirstName CHAR(30),
            LastName CHAR(30),
            DepartmentNo SMALLINT,
            NetPay INTEGER
        );
    """)
    cursor.execute("""
        INSERT INTO Employee VALUES (1, NULL, 'Doe', 10);
        INSERT INTO Salary VALUES (1, NULL);
    """)
    cursor.execute("""
        INSERT INTO employee_bkup
        SELECT a.EmployeeNo, a.FirstName, a.LastName, a.DepartmentNo, b.NetPay
        FROM Employee a INNER JOIN Salary b ON a.EmployeeNo = b.EmployeeNo;
    """)
    cursor.execute("SELECT * FROM employee_bkup;")
    results = cursor.fetchall()
    assert results == [(1, None, 'Doe', 10, None)], f"NULLs in non-key columns should be inserted: {results}"
    cursor.close()

def test_select_from_employee_sample_with_data(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("""
        CREATE TABLE EmployeeSample (EmployeeNo INTEGER, FirstName CHAR(30), LastName CHAR(30));
        INSERT INTO EmployeeSample VALUES (1, 'John', 'Doe'), (2, 'Jane', 'Smith');
    """)
    cursor.execute("SELECT * FROM EmployeeSample ORDER BY EmployeeNo;")
    results = cursor.fetchall()
    assert results == [(1, 'John', 'Doe'), (2, 'Jane', 'Smith')], f"EmployeeSample select failed: {results}"
    cursor.close()

def test_select_from_employee_sample_empty(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("CREATE TABLE EmployeeSample (EmployeeNo INTEGER, FirstName CHAR(30), LastName CHAR(30));")
    cursor.execute("SELECT * FROM EmployeeSample;")
    results = cursor.fetchall()
    assert results == [], "EmployeeSample should be empty"
    cursor.close()

def test_insert_with_unexpected_types(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("""
        CREATE TABLE Employee (EmployeeNo INTEGER, FirstName CHAR(30), LastName CHAR(30), DepartmentNo SMALLINT);
        CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);
        CREATE TABLE employee_bkup (
            EmployeeNo INTEGER,
            FirstName CHAR(30),
            LastName CHAR(30),
            DepartmentNo SMALLINT,
            NetPay INTEGER
        );
    """)
    # Insert string into NetPay (should error)
    cursor.execute("INSERT INTO Employee VALUES (1, 'John', 'Doe', 10);")
    try:
        cursor.execute("INSERT INTO Salary VALUES (1, 'FiveThousand');")
        cursor.execute("""
            INSERT INTO employee_bkup
            SELECT a.EmployeeNo, a.FirstName, a.LastName, a.DepartmentNo, b.NetPay
            FROM Employee a INNER JOIN Salary b ON a.EmployeeNo = b.EmployeeNo;
        """)
        cursor.execute("SELECT * FROM employee_bkup;")
        results = cursor.fetchall()
        # If it gets here, Snowflake allowed the string, which is unexpected
        assert False, "Unexpected data type should raise error"
    except Exception as e:
        assert "Numeric value" in str(e) or "conversion" in str(e), f"Unexpected error: {e}"
    cursor.close()


**Cost Analysis:**
API Cost: $0.05