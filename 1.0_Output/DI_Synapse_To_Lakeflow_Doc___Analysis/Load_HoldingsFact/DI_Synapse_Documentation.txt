```markdown
====================================================
Author:        Ascendion AAVA
Date:          
Description:   Load summarized holding metrics into the executive summary fact table in Synapse, ensuring data quality and referential integrity.
====================================================

# 1. Overview of Pipeline/Component

The `LOAD_FACT_EXECUTIVE_SUMMARY` stored procedure in Azure Synapse Analytics is designed to populate the `FACT_EXECUTIVE_SUMMARY` fact table with aggregated holding metrics sourced from the `STG_HOLDING_METRICS` staging table. The procedure enforces data quality, applies business rules, and ensures referential integrity by joining to dimension tables. This process supports regulatory reporting, executive dashboards, and downstream analytics by providing a cleansed, validated, and enriched summary of holdings data.

# 2. Component Structure and Design

- **Source:** `dbo.STG_HOLDING_METRICS` (staging table containing raw holding metrics)
- **Transformation & Validation:** 
  - Temporary staging table `#staging_metrics` is created from the source.
  - Business rules (e.g., non-negative income) are enforced.
  - Joins to dimension tables: `DIM_DATE`, `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT` ensure referential integrity.
- **Target (Sink):** `dbo.FACT_EXECUTIVE_SUMMARY` (fact table for executive summary metrics)
- **Audit Logging:** Row count of inserted records is logged.
- **Cleanup:** Temporary staging table is dropped after processing.

**Connection Flow:**
1. Data is loaded from the staging table into a temp table.
2. Data is validated and joined with dimension tables.
3. Transformed data is inserted into the fact table.
4. Audit and cleanup steps are performed.

**Parameters, Variables, Triggers:**
- Variables: `@v_row_count`, `@error_message`
- No explicit parameters or triggers in this stored procedure.

# 3. Data Flow and Processing Logic

**Processed Datasets:**
- `dbo.STG_HOLDING_METRICS`
- `dbo.DIM_DATE`
- `dbo.DIM_INSTITUTION`
- `dbo.DIM_CORPORATION`
- `dbo.DIM_PRODUCT`
- `dbo.FACT_EXECUTIVE_SUMMARY`

**Data Flow:**
1. Extract all records from `STG_HOLDING_METRICS` into `#staging_metrics`.
2. Join `#staging_metrics` with dimension tables to resolve surrogate keys and ensure referential integrity.
3. Apply business rules (e.g., set negative/null income to 0).
4. Insert validated and enriched records into `FACT_EXECUTIVE_SUMMARY`.
5. Log the number of inserted records and clean up temp resources.

**Business Rules/Transformations:**
- Income amount is set to 0 if null or negative.
- Only records with matching dimension keys are loaded.

**SQL Scripts/Stored Procedures Used:**
- This process is encapsulated in the `dbo.LOAD_FACT_EXECUTIVE_SUMMARY` stored procedure.

# 4. Data Mapping (Lineage)

| Target Table Name         | Target Column Name      | Source Table Name        | Source Column Name      | Remarks                                                      |
|--------------------------|------------------------|-------------------------|------------------------|--------------------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key               | DIM_DATE                | date_key               | 1:1 Mapping via join on stg.date_value = dt.date_key         |
| FACT_EXECUTIVE_SUMMARY   | institution_id         | DIM_INSTITUTION         | institution_id         | 1:1 Mapping via join on stg.institution_id = inst.institution_id |
| FACT_EXECUTIVE_SUMMARY   | corporation_id         | DIM_CORPORATION         | corporation_id         | 1:1 Mapping via join on stg.corporation_id = corp.corporation_id |
| FACT_EXECUTIVE_SUMMARY   | product_id             | DIM_PRODUCT             | product_id             | 1:1 Mapping via join on stg.product_id = prod.product_id     |
| FACT_EXECUTIVE_SUMMARY   | a120_amount            | STG_HOLDING_METRICS     | a120_amount            | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | a120_count             | STG_HOLDING_METRICS     | a120_count             | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount       | STG_HOLDING_METRICS     | a30_to_59_amount       | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count        | STG_HOLDING_METRICS     | a30_to_59_count        | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount       | STG_HOLDING_METRICS     | a60_to_89_amount       | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count        | STG_HOLDING_METRICS     | a60_to_89_count        | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount      | STG_HOLDING_METRICS     | a90_to_119_amount      | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count       | STG_HOLDING_METRICS     | a90_to_119_count       | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount      | STG_HOLDING_METRICS     | charge_off_amount      | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count       | STG_HOLDING_METRICS     | charge_off_count       | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount           | STG_HOLDING_METRICS     | fraud_amount           | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | fraud_count            | STG_HOLDING_METRICS     | fraud_count            | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | income_amount          | STG_HOLDING_METRICS     | income_amount          | Transformation: Set to 0 if NULL or < 0                     |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts     | STG_HOLDING_METRICS     | number_of_accounts     | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount       | STG_HOLDING_METRICS     | purchases_amount       | Direct mapping                                              |
| FACT_EXECUTIVE_SUMMARY   | purchases_count        | STG_HOLDING_METRICS     | purchases_count        | Direct mapping                                              |

# 5. Transformation Logic

- **income_amount:**  
  `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`  
  Ensures income is non-negative and not null.

- **Joins:**  
  - `stg.date_value = dt.date_key`
  - `stg.institution_id = inst.institution_id`
  - `stg.corporation_id = corp.corporation_id`
  - `stg.product_id = prod.product_id`

- **Audit Logging:**  
  - Captures the number of inserted rows with `@@ROWCOUNT`.

- **Cleanup:**  
  - Drops temporary table `#staging_metrics` after processing.

- **No user-defined functions (UDFs) or reusable templates** are used in this procedure.

# 6. Complexity Analysis

| Metric                           | Value/Details                                              |
|-----------------------------------|-----------------------------------------------------------|
| Number of Pipeline Activities     | 1 (Stored Procedure)                                      |
| Number of Dataflow Transformations| 1 (income_amount transformation)                          |
| SQL Scripts or Stored Procedures  | 1 (`LOAD_FACT_EXECUTIVE_SUMMARY`)                         |
| Joins Used                       | 4 (INNER JOINs to DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Lookup Tables or Reference Data   | 4 (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT)|
| Parameters/Variables/Triggers     | 2 variables (`@v_row_count`, `@error_message`), 0 triggers|
| Number of Output Datasets         | 1 (`FACT_EXECUTIVE_SUMMARY`)                              |
| Conditional Logic or if-else Flows| 1 (income_amount transformation)                          |
| External Dependencies             | None (all tables within Synapse DW)                       |
| Overall Complexity Score          | 20                                                        |

# 7. Key Outputs

- **Target Table:** `FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse Table (columnar storage, optimized for analytics)
- **Intended Use:** Regulatory and executive reporting, dashboards, and as a source for downstream analytics and machine learning models.

---

**API Cost:**  
apiCost: 0.002 USD
```