=============================================
Author:        AAVA
Created on:   
Description:   Example conversion of an Azure Synapse stored procedure to BigQuery SQL demonstrating variable declarations, conditionals, joins, aggregations, and DML operations
=============================================

-- ===========================================
-- 1. Azure Synapse Stored Procedure Example
-- ===========================================
/*
CREATE PROCEDURE [dbo].[usp_UpdateCustomerSales]
    @SalesThreshold DECIMAL(18,2)
AS
BEGIN
    DECLARE @CurrentDate DATE
    SET @CurrentDate = GETDATE()

    -- Insert high value customers into summary table
    INSERT INTO dbo.CustomerSalesSummary (CustomerID, TotalSales, RecordDate, Tier)
    SELECT 
        c.CustomerID,
        SUM(s.SaleAmount) AS TotalSales,
        @CurrentDate AS RecordDate,
        CASE 
            WHEN SUM(s.SaleAmount) > 10000 THEN 'Platinum'
            WHEN SUM(s.SaleAmount) > 5000 THEN 'Gold'
            ELSE 'Silver'
        END AS Tier
    FROM dbo.Customers c
    INNER JOIN dbo.Sales s ON c.CustomerID = s.CustomerID
    WHERE s.SaleAmount > @SalesThreshold
    GROUP BY c.CustomerID

    -- Update customer status
    UPDATE c
    SET c.Status = CASE 
        WHEN cs.TotalSales > 10000 THEN 'VIP'
        ELSE 'Regular'
    END
    FROM dbo.Customers c
    INNER JOIN (
        SELECT CustomerID, SUM(SaleAmount) AS TotalSales
        FROM dbo.Sales
        GROUP BY CustomerID
    ) cs ON c.CustomerID = cs.CustomerID

    -- Merge new sales records into master table
    MERGE dbo.SalesMaster AS target
    USING dbo.Sales AS source
    ON target.SaleID = source.SaleID
    WHEN MATCHED THEN
        UPDATE SET target.SaleAmount = source.SaleAmount
    WHEN NOT MATCHED THEN
        INSERT (SaleID, CustomerID, SaleAmount, SaleDate)
        VALUES (source.SaleID, source.CustomerID, source.SaleAmount, source.SaleDate);
END
*/

-- ===========================================
-- 2. BigQuery SQL Conversion
-- ===========================================

-- Note: BigQuery does not support procedural code in standard SQL. 
-- Use scripting for variables and control flow, and DML for data changes.

-- Set up variables
DECLARE SalesThreshold NUMERIC DEFAULT 5000.00;  -- Example threshold, replace as needed
DECLARE CurrentDate DATE DEFAULT CURRENT_DATE();

-- 1. Insert high value customers into summary table
INSERT INTO `mydataset.CustomerSalesSummary` (CustomerID, TotalSales, RecordDate, Tier)
WITH CustomerSales AS (
    SELECT 
        c.CustomerID,
        SUM(s.SaleAmount) AS TotalSales
    FROM `mydataset.Customers` c
    INNER JOIN `mydataset.Sales` s
        ON c.CustomerID = s.CustomerID
    WHERE s.SaleAmount > SalesThreshold
    GROUP BY c.CustomerID
)
SELECT
    CustomerID,
    TotalSales,
    CurrentDate AS RecordDate,
    CASE
        WHEN TotalSales > 10000 THEN 'Platinum'
        WHEN TotalSales > 5000 THEN 'Gold'
        ELSE 'Silver'
    END AS Tier
FROM CustomerSales;

-- 2. Update customer status based on total sales
-- BigQuery does not support UPDATE with JOIN directly; use MERGE instead.
MERGE `mydataset.Customers` AS target
USING (
    SELECT
        CustomerID,
        SUM(SaleAmount) AS TotalSales
    FROM `mydataset.Sales`
    GROUP BY CustomerID
) AS src
ON target.CustomerID = src.CustomerID
WHEN MATCHED THEN
    UPDATE SET Status = 
        CASE
            WHEN src.TotalSales > 10000 THEN 'VIP'
            ELSE 'Regular'
        END;

-- 3. Merge new sales records into master table
MERGE `mydataset.SalesMaster` AS target
USING `mydataset.Sales` AS source
ON target.SaleID = source.SaleID
WHEN MATCHED THEN
    UPDATE SET target.SaleAmount = source.SaleAmount
WHEN NOT MATCHED THEN
    INSERT (SaleID, CustomerID, SaleAmount, SaleDate)
    VALUES (source.SaleID, source.CustomerID, source.SaleAmount, source.SaleDate);

-- ===========================================
-- 3. Inline Comments and Conversion Notes
-- ===========================================
-- DECLARE/SET: Use DECLARE for variables, and DEFAULT for initialization.
-- GETDATE(): Use CURRENT_DATE() in BigQuery.
-- CASE: Supported natively in BigQuery.
-- Joins: Use standard SQL JOINs.
-- GROUP BY: Same syntax.
-- INSERT: Standard syntax, can use CTEs for complex selects.
-- UPDATE with JOIN: Use MERGE for updates based on joins.
-- MERGE: Supported in BigQuery, similar to Synapse.
-- NULL Handling: All aggregations (e.g., SUM) ignore NULLs by default in BigQuery.
-- Data Types: Use NUMERIC for high-precision decimals.
-- Table References: Use backticks and fully qualified names (`project.dataset.table`).
-- Optimization: Use CTEs to avoid repeated subqueries, filter early, and minimize data scanned.
-- Partitioning/Clustering: Consider partitioning summary/master tables on RecordDate or CustomerID for performance.

-- ===========================================
-- 4. Best Practices
-- ===========================================
-- - Use scripting for procedural logic.
-- - Use MERGE for update/insert logic with joins.
-- - Use CTEs for readability and maintainability.
-- - Use partitioned tables for large datasets.
-- - Use dry runs to estimate query cost before running.
-- - Handle NULLs explicitly if needed (e.g., COALESCE).
-- - Use NUMERIC for financial calculations to avoid rounding errors.

-- ===========================================
-- End of Script
-- ===========================================

-- This script is ready to run in BigQuery, demonstrating a full Synapse to BigQuery migration example with all required elements.

API Cost Consumed in dollars: 0.0061 USD