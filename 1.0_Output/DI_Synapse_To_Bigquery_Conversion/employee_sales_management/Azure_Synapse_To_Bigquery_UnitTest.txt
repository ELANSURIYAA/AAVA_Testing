================================
Author: AAVA
Created on: 
Description: Unit tests and Pytest script for validating BigQuery logic converted from Synapse stored procedure for processing customer orders, VIP logic, and logging.
================================

Test Case List:

| Test Case ID | Description                                                                                  | Expected Outcome                                                                                                 |
|--------------|----------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------|
| TC01         | Happy path: Active customers with completed orders, some exceeding VIP threshold              | VIP customers table contains only qualifying customers with correct TotalSpent; log reflects correct count        |
| TC02         | Edge: No active customers                                                                    | No rows inserted into VIP or log tables; all remain empty                                                        |
| TC03         | Edge: Active customers with no completed orders                                               | No VIP customers inserted; log reflects correct count of active customers                                        |
| TC04         | Edge: Customer with exactly 1000 total spent (boundary)                                       | Customer NOT inserted into VIP table (threshold is > 1000)                                                       |
| TC05         | Edge: Customer with NULL order amounts                                                        | NULLs treated as zero; only customers with SUM > 1000 inserted into VIP                                          |
| TC06         | Edge: Orders table missing OrderStatus column                                                 | Error raised during execution                                                                                    |
| TC07         | Error: Orders table missing entirely                                                          | Error raised during execution                                                                                    |
| TC08         | Error: VIP table missing required columns                                                     | Error raised during DML execution                                                                                |
| TC09         | Edge: Duplicate CustomerId in customers table                                                 | Each CustomerId processed only once; aggregation correct                                                         |
| TC10         | Edge: Orders with mixed statuses (Completed, Pending, Cancelled)                              | Only 'Completed' orders included in aggregation                                                                  |
| TC11         | Error: Orders with invalid (non-numeric) OrderAmount                                          | Error or those rows ignored in aggregation (depending on BigQuery behavior)                                      |
| TC12         | Happy path: MERGE upsert updates existing VIP and inserts new                                 | Existing VIP customers updated, new ones inserted, no duplicates                                                 |
| TC13         | Edge: Empty orders table, non-empty customers table                                           | No VIP customers inserted; log reflects correct count of active customers                                        |
| TC14         | Edge: Empty customers table                                                                   | No inserts into VIP or log tables                                                                                |
| TC15         | Edge: All orders have OrderStatus other than 'Completed'                                      | No VIP customers inserted; log reflects correct count of active customers                                        |

Pytest Script:


# ================================================
# Author: AAVA
# Created on: 
# Description: Pytest script for validating BigQuery logic for customer order processing, VIP logic, and logging.
# ================================================

import pytest
import pandas as pd
from sqlalchemy import create_engine, text
from datetime import datetime

# Helper function to simulate BigQuery SQL logic in Pandas for unit testing
def process_customer_orders(customers_df, orders_df, vip_customers_df=None, use_merge=False):
    # Filter active customers
    active_customers = customers_df[customers_df['IsActive'] == True].copy()
    # Aggregate total spent per customer (only 'Completed' orders)
    completed_orders = orders_df[orders_df['OrderStatus'] == 'Completed'].copy()
    agg = completed_orders.groupby('CustomerId', as_index=False)['OrderAmount'].sum()
    agg.rename(columns={'OrderAmount': 'TotalSpent'}, inplace=True)
    # Merge with active customers
    merged = pd.merge(active_customers[['CustomerId']], agg, on='CustomerId', how='left')
    merged['TotalSpent'] = merged['TotalSpent'].fillna(0)
    # VIP selection
    vip = merged[merged['TotalSpent'] > 1000][['CustomerId', 'TotalSpent']].copy()
    # Logging
    log = pd.DataFrame([{
        'ProcessDate': pd.Timestamp.now(),
        'CustomersProcessed': len(active_customers)
    }])
    # MERGE logic: upsert
    if use_merge and vip_customers_df is not None:
        # Update existing, insert new
        vip_customers_df = vip_customers_df.copy()
        for idx, row in vip.iterrows():
            if row['CustomerId'] in vip_customers_df['CustomerId'].values:
                vip_customers_df.loc[vip_customers_df['CustomerId'] == row['CustomerId'], 'TotalSpent'] = row['TotalSpent']
            else:
                vip_customers_df = pd.concat([vip_customers_df, pd.DataFrame([row])], ignore_index=True)
        vip = vip_customers_df
    return vip.reset_index(drop=True), log.reset_index(drop=True)

# Fixtures for setup/teardown
@pytest.fixture
def sample_data():
    # Default happy path data
    customers = pd.DataFrame({
        'CustomerId': [1, 2, 3],
        'IsActive': [True, True, False]
    })
    orders = pd.DataFrame({
        'OrderId': [101, 102, 103, 104, 105],
        'CustomerId': [1, 1, 2, 2, 3],
        'OrderAmount': [800, 300, 1200, 200, 500],
        'OrderStatus': ['Completed', 'Completed', 'Completed', 'Pending', 'Completed']
    })
    return customers, orders

# TC01: Happy path
def test_happy_path(sample_data):
    customers, orders = sample_data
    vip, log = process_customer_orders(customers, orders)
    assert len(vip) == 1
    assert vip.iloc[0]['CustomerId'] == 2
    assert vip.iloc[0]['TotalSpent'] == 1200
    assert log.iloc[0]['CustomersProcessed'] == 2

# TC02: No active customers
def test_no_active_customers():
    customers = pd.DataFrame({'CustomerId': [1, 2], 'IsActive': [False, False]})
    orders = pd.DataFrame({'OrderId': [], 'CustomerId': [], 'OrderAmount': [], 'OrderStatus': []})
    vip, log = process_customer_orders(customers, orders)
    assert vip.empty
    assert log.iloc[0]['CustomersProcessed'] == 0

# TC03: Active customers with no completed orders
def test_no_completed_orders():
    customers = pd.DataFrame({'CustomerId': [1], 'IsActive': [True]})
    orders = pd.DataFrame({'OrderId': [1], 'CustomerId': [1], 'OrderAmount': [500], 'OrderStatus': ['Pending']})
    vip, log = process_customer_orders(customers, orders)
    assert vip.empty
    assert log.iloc[0]['CustomersProcessed'] == 1

# TC04: Customer with exactly 1000 spent (boundary)
def test_boundary_vip_threshold():
    customers = pd.DataFrame({'CustomerId': [1], 'IsActive': [True]})
    orders = pd.DataFrame({'OrderId': [1], 'CustomerId': [1], 'OrderAmount': [1000], 'OrderStatus': ['Completed']})
    vip, log = process_customer_orders(customers, orders)
    assert vip.empty

# TC05: Customer with NULL order amounts
def test_null_order_amounts():
    customers = pd.DataFrame({'CustomerId': [1], 'IsActive': [True]})
    orders = pd.DataFrame({'OrderId': [1, 2], 'CustomerId': [1, 1], 'OrderAmount': [None, 1200], 'OrderStatus': ['Completed', 'Completed']})
    vip, log = process_customer_orders(customers, orders)
    assert len(vip) == 1
    assert vip.iloc[0]['TotalSpent'] == 1200

# TC06: Orders table missing OrderStatus column
def test_missing_orderstatus_column():
    customers = pd.DataFrame({'CustomerId': [1], 'IsActive': [True]})
    orders = pd.DataFrame({'OrderId': [1], 'CustomerId': [1], 'OrderAmount': [1500]})
    with pytest.raises(KeyError):
        process_customer_orders(customers, orders)

# TC07: Orders table missing entirely
def test_missing_orders_table():
    customers = pd.DataFrame({'CustomerId': [1], 'IsActive': [True]})
    with pytest.raises(TypeError):
        process_customer_orders(customers, None)

# TC08: VIP table missing required columns (simulate by passing wrong columns to merge)
def test_vip_table_missing_columns():
    customers = pd.DataFrame({'CustomerId': [1], 'IsActive': [True]})
    orders = pd.DataFrame({'OrderId': [1], 'CustomerId': [1], 'OrderAmount': [1500], 'OrderStatus': ['Completed']})
    vip_customers_df = pd.DataFrame({'CustId': [1], 'TotalSpent': [1000]})  # Wrong column name
    with pytest.raises(KeyError):
        process_customer_orders(customers, orders, vip_customers_df, use_merge=True)

# TC09: Duplicate CustomerId in customers table
def test_duplicate_customerid():
    customers = pd.DataFrame({'CustomerId': [1, 1], 'IsActive': [True, True]})
    orders = pd.DataFrame({'OrderId': [1], 'CustomerId': [1], 'OrderAmount': [2000], 'OrderStatus': ['Completed']})
    vip, log = process_customer_orders(customers, orders)
    assert len(vip) == 1
    assert vip.iloc[0]['CustomerId'] == 1
    assert vip.iloc[0]['TotalSpent'] == 2000
    assert log.iloc[0]['CustomersProcessed'] == 2

# TC10: Orders with mixed statuses
def test_mixed_order_statuses():
    customers = pd.DataFrame({'CustomerId': [1], 'IsActive': [True]})
    orders = pd.DataFrame({
        'OrderId': [1, 2, 3],
        'CustomerId': [1, 1, 1],
        'OrderAmount': [500, 700, 300],
        'OrderStatus': ['Completed', 'Pending', 'Completed']
    })
    vip, log = process_customer_orders(customers, orders)
    assert len(vip) == 1
    assert vip.iloc[0]['TotalSpent'] == 800

# TC11: Orders with invalid (non-numeric) OrderAmount
def test_invalid_order_amount():
    customers = pd.DataFrame({'CustomerId': [1], 'IsActive': [True]})
    orders = pd.DataFrame({
        'OrderId': [1, 2],
        'CustomerId': [1, 1],
        'OrderAmount': ['abc', 1200],
        'OrderStatus': ['Completed', 'Completed']
    })
    # Should raise or ignore invalid, depending on implementation
    with pytest.raises(Exception):
        process_customer_orders(customers, orders)

# TC12: MERGE upsert updates existing VIP and inserts new
def test_merge_upsert():
    customers = pd.DataFrame({'CustomerId': [1, 2], 'IsActive': [True, True]})
    orders = pd.DataFrame({
        'OrderId': [1, 2],
        'CustomerId': [1, 2],
        'OrderAmount': [1500, 2000],
        'OrderStatus': ['Completed', 'Completed']
    })
    vip_customers_df = pd.DataFrame({'CustomerId': [1], 'TotalSpent': [1000]})
    vip, log = process_customer_orders(customers, orders, vip_customers_df, use_merge=True)
    assert len(vip) == 2
    assert set(vip['CustomerId']) == {1, 2}
    assert vip[vip['CustomerId'] == 1]['TotalSpent'].iloc[0] == 1500
    assert vip[vip['CustomerId'] == 2]['TotalSpent'].iloc[0] == 2000

# TC13: Empty orders table, non-empty customers table
def test_empty_orders_table():
    customers = pd.DataFrame({'CustomerId': [1, 2], 'IsActive': [True, True]})
    orders = pd.DataFrame({'OrderId': [], 'CustomerId': [], 'OrderAmount': [], 'OrderStatus': []})
    vip, log = process_customer_orders(customers, orders)
    assert vip.empty
    assert log.iloc[0]['CustomersProcessed'] == 2

# TC14: Empty customers table
def test_empty_customers_table():
    customers = pd.DataFrame({'CustomerId': [], 'IsActive': []})
    orders = pd.DataFrame({'OrderId': [1], 'CustomerId': [1], 'OrderAmount': [2000], 'OrderStatus': ['Completed']})
    vip, log = process_customer_orders(customers, orders)
    assert vip.empty
    assert log.iloc[0]['CustomersProcessed'] == 0

# TC15: All orders have OrderStatus other than 'Completed'
def test_no_completed_status_orders():
    customers = pd.DataFrame({'CustomerId': [1], 'IsActive': [True]})
    orders = pd.DataFrame({'OrderId': [1], 'CustomerId': [1], 'OrderAmount': [2000], 'OrderStatus': ['Pending']})
    vip, log = process_customer_orders(customers, orders)
    assert vip.empty
    assert log.iloc[0]['CustomersProcessed'] == 1


API Cost Consumption:
apiCost: 0.0032 USD