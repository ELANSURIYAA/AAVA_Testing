# ====================================================
**Author:**        Ascendion AAVA  
**Date:**          
**Description:**   Load summarized holding metrics from staging to fact table in Synapse DW  
# ====================================================

## 1. Overview of Pipeline/Component

The `LOAD_FACT_EXECUTIVE_SUMMARY` stored procedure in Azure Synapse Analytics is designed to load summarized holding metrics from the staging table (`STG_HOLDING_METRICS`) into the fact table (`FACT_EXECUTIVE_SUMMARY`). It ensures data quality, applies business rules, and maintains referential integrity by joining with dimension tables. This process supports executive reporting and analytics by providing a cleansed, validated, and integrated summary of holdings data.

## 2. Component Structure and Design

- **Source:**  
  - `dbo.STG_HOLDING_METRICS` (staging table containing raw holding metrics)
- **Transformation/Processing:**  
  - Temporary table `#staging_metrics` is created from the staging source.
  - Data quality and business rule checks are performed (e.g., negative/NULL income amounts set to 0).
  - Joins to dimension tables: `DIM_DATE`, `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT` for referential integrity.
- **Sink:**  
  - `dbo.FACT_EXECUTIVE_SUMMARY` (target fact table for executive summary metrics)
- **Activities:**  
  - Data extraction from staging
  - Data validation and transformation
  - Insertion into fact table
  - Audit logging
  - Cleanup of temporary resources
- **Parameters/Variables:**  
  - `@v_row_count` (row count for audit logging)
  - `@error_message` (reserved for error handling)
- **Triggers:**  
  - Not explicitly defined in the script; typically scheduled or orchestrated via Synapse pipeline.

## 3. Data Flow and Processing Logic

**Processed Datasets:**  
- `dbo.STG_HOLDING_METRICS`
- `dbo.DIM_DATE`
- `dbo.DIM_INSTITUTION`
- `dbo.DIM_CORPORATION`
- `dbo.DIM_PRODUCT`
- `dbo.FACT_EXECUTIVE_SUMMARY`

**Data Flow:**  
1. Extract all records from `STG_HOLDING_METRICS` into a temporary table.
2. Join with dimension tables to resolve surrogate keys and ensure referential integrity.
3. Apply business rules (e.g., set negative or NULL income amounts to 0).
4. Insert validated and transformed records into `FACT_EXECUTIVE_SUMMARY`.
5. Log the number of inserted records.
6. Drop the temporary table.

**Business Rules/Transformations:**  
- Income amounts that are NULL or negative are set to 0.
- Only records with matching dimension keys are loaded (enforced by INNER JOINs).

## 4. Data Mapping (Lineage)

| Target Table Name         | Target Column Name      | Source Table Name         | Source Column Name      | Remarks                                                                 |
|--------------------------|------------------------|--------------------------|------------------------|-------------------------------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key               | DIM_DATE                 | date_key               | 1:1 Mapping via join on stg.date_value                                  |
| FACT_EXECUTIVE_SUMMARY   | institution_id         | DIM_INSTITUTION          | institution_id         | 1:1 Mapping via join on stg.institution_id                              |
| FACT_EXECUTIVE_SUMMARY   | corporation_id         | DIM_CORPORATION          | corporation_id         | 1:1 Mapping via join on stg.corporation_id                              |
| FACT_EXECUTIVE_SUMMARY   | product_id             | DIM_PRODUCT              | product_id             | 1:1 Mapping via join on stg.product_id                                  |
| FACT_EXECUTIVE_SUMMARY   | a120_amount            | STG_HOLDING_METRICS      | a120_amount            | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | a120_count             | STG_HOLDING_METRICS      | a120_count             | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount       | STG_HOLDING_METRICS      | a30_to_59_amount       | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count        | STG_HOLDING_METRICS      | a30_to_59_count        | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount       | STG_HOLDING_METRICS      | a60_to_89_amount       | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count        | STG_HOLDING_METRICS      | a60_to_89_count        | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount      | STG_HOLDING_METRICS      | a90_to_119_amount      | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count       | STG_HOLDING_METRICS      | a90_to_119_count       | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount      | STG_HOLDING_METRICS      | charge_off_amount      | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count       | STG_HOLDING_METRICS      | charge_off_count       | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount           | STG_HOLDING_METRICS      | fraud_amount           | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | fraud_count            | STG_HOLDING_METRICS      | fraud_count            | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | income_amount          | STG_HOLDING_METRICS      | income_amount          | Transformation: IF NULL or <0 THEN 0 ELSE income_amount                 |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts     | STG_HOLDING_METRICS      | number_of_accounts     | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount       | STG_HOLDING_METRICS      | purchases_amount       | Direct mapping                                                          |
| FACT_EXECUTIVE_SUMMARY   | purchases_count        | STG_HOLDING_METRICS      | purchases_count        | Direct mapping                                                          |

## 5. Transformation Logic

- **income_amount:**  
  - Expression: `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`
  - Purpose: Ensures that income amounts are always non-negative and not NULL in the fact table.
- **Joins:**  
  - Ensures only records with valid foreign keys in all dimension tables are loaded.
- **No UDFs or reusable templates** are used in this procedure.

## 6. Complexity Analysis

| Metric                              | Value/Details                                                                 |
|--------------------------------------|-------------------------------------------------------------------------------|
| Number of Pipeline Activities        | 1 (single stored procedure)                                                   |
| Number of Dataflow Transformations   | 1 (income_amount transformation)                                              |
| SQL Scripts or Stored Procedures Used| 1 (`LOAD_FACT_EXECUTIVE_SUMMARY`)                                             |
| Joins Used                          | 4 (INNER JOINs to DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT)   |
| Lookup Tables or Reference Data      | 4 (dimension tables)                                                          |
| Parameters/Variables/Triggers        | 2 variables (`@v_row_count`, `@error_message`), 0 parameters, 0 triggers      |
| Number of Output Datasets            | 1 (`FACT_EXECUTIVE_SUMMARY`)                                                  |
| Conditional Logic or if-else Flows   | 1 (income_amount transformation)                                              |
| External Dependencies                | DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT (dimension tables)    |
| Overall Complexity Score             | 25                                                                            |

## 7. Key Outputs

- **Output Table:** `FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse table (rowstore/columnstore, depending on Synapse configuration)
- **Intended Use:** Executive reporting, analytics, and downstream BI processes. The table provides a cleansed, validated, and integrated summary of holding metrics, suitable for dashboards and regulatory reporting.

---

**API Cost:**  
apiCost: 0.002 USD