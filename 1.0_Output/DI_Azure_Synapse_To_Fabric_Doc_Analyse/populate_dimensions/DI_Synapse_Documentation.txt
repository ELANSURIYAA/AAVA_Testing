```
====================================================
Author:        Ascendion AAVA
Date:          
Description:   Documentation for Synapse Stored Procedure: populate_dimensions
====================================================

# Overview of Program

The `populate_dimensions` stored procedure in Azure Synapse Analytics is designed to load and maintain key dimension tables (`DIM_INSTITUTION`, `DIM_CORPORATION`, and `DIM_PRODUCT`) from a staging layer (`STG_DIMENSION_DATA`). It ensures idempotent, high-quality data loads using SQL MERGE statements, applying business rules to filter out invalid, legacy, or test data. This process supports enterprise data warehousing, regulatory reporting, and downstream analytics by maintaining clean, up-to-date dimension tables.

# Code Structure and Design

- **Component Type:** Synapse SQL Stored Procedure (`dbo.populate_dimensions`)
- **Database:** Synapse DW
- **Key Activities:**
  - Three sequential MERGE operations for dimension tables.
  - Data quality filters (non-null IDs, exclusion of legacy/test data).
  - Print statements for operational logging.
- **Integration:** Designed to be invoked from Synapse pipelines or scheduled jobs. Consumes data from the staging table and writes to dimension tables.
- **Parameterization:** No runtime parameters; logic is embedded in SQL.
- **Triggers:** Typically executed as part of nightly/periodic ETL pipeline orchestration.

# Data Flow and Processing Logic

**Processed Datasets:**
- `dbo.STG_DIMENSION_DATA` (staging source)
- `dbo.DIM_INSTITUTION` (target dimension)
- `dbo.DIM_CORPORATION` (target dimension)
- `dbo.DIM_PRODUCT` (target dimension)

**Data Flow:**
1. **Source:** Data is read from `STG_DIMENSION_DATA`, which aggregates raw dimension records from upstream sources.
2. **Transformation:** Each dimension table is loaded using a MERGE statement:
   - **DIM_INSTITUTION:** Filters for non-null, valid institution IDs.
   - **DIM_CORPORATION:** Excludes test corporations using a name filter.
   - **DIM_PRODUCT:** Excludes deprecated/legacy products.
3. **Sink:** Data is written to respective dimension tables, ensuring only new records are inserted (idempotency).

**Business Rules Applied:**
- Institution IDs must be non-null and longer than 3 characters.
- Corporation names starting with 'TEST' are excluded.
- Products with processing group 'DEPRECATED' or 'LEGACY' are excluded.

# Data Mapping (Lineage)

| Target Table Name   | Target Column Name           | Source Table Name      | Source Column Name           | Remarks                                                      |
|---------------------|-----------------------------|-----------------------|------------------------------|--------------------------------------------------------------|
| DIM_INSTITUTION     | institution_id              | STG_DIMENSION_DATA    | institution_id               | 1:1 Mapping, filter: NOT NULL, LEN > 3                       |
| DIM_INSTITUTION     | institution                 | STG_DIMENSION_DATA    | institution                  | 1:1 Mapping                                                  |
| DIM_INSTITUTION     | institution_name            | STG_DIMENSION_DATA    | institution_name             | 1:1 Mapping                                                  |
| DIM_CORPORATION     | corporation_id              | STG_DIMENSION_DATA    | corporation_id               | 1:1 Mapping, filter: UPPER(corporation_name) NOT LIKE 'TEST%'|
| DIM_CORPORATION     | corp_id                     | STG_DIMENSION_DATA    | corp_id                      | 1:1 Mapping                                                  |
| DIM_CORPORATION     | corporation                 | STG_DIMENSION_DATA    | corporation                  | 1:1 Mapping                                                  |
| DIM_CORPORATION     | corporation_name            | STG_DIMENSION_DATA    | corporation_name             | 1:1 Mapping                                                  |
| DIM_CORPORATION     | sub_corporation             | STG_DIMENSION_DATA    | sub_corporation              | 1:1 Mapping                                                  |
| DIM_CORPORATION     | sub_corporation_id          | STG_DIMENSION_DATA    | sub_corporation_id           | 1:1 Mapping                                                  |
| DIM_CORPORATION     | sub_corporation_name        | STG_DIMENSION_DATA    | sub_corporation_name         | 1:1 Mapping                                                  |
| DIM_CORPORATION     | master_corporation_dim_key  | STG_DIMENSION_DATA    | master_corporation_dim_key   | 1:1 Mapping                                                  |
| DIM_CORPORATION     | association                 | STG_DIMENSION_DATA    | association                  | 1:1 Mapping                                                  |
| DIM_CORPORATION     | bin                         | STG_DIMENSION_DATA    | bin                          | 1:1 Mapping                                                  |
| DIM_CORPORATION     | company                     | STG_DIMENSION_DATA    | company                      | 1:1 Mapping                                                  |
| DIM_CORPORATION     | company_id                  | STG_DIMENSION_DATA    | company_id                   | 1:1 Mapping                                                  |
| DIM_CORPORATION     | company_name                | STG_DIMENSION_DATA    | company_name                 | 1:1 Mapping                                                  |
| DIM_PRODUCT         | product_id                  | STG_DIMENSION_DATA    | product_id                   | 1:1 Mapping, filter: processing_group NOT IN ('DEPRECATED', 'LEGACY') |
| DIM_PRODUCT         | product                     | STG_DIMENSION_DATA    | product                      | 1:1 Mapping                                                  |
| DIM_PRODUCT         | product_description         | STG_DIMENSION_DATA    | product_description          | 1:1 Mapping                                                  |
| DIM_PRODUCT         | sub_product                 | STG_DIMENSION_DATA    | sub_product                  | 1:1 Mapping                                                  |
| DIM_PRODUCT         | processing_code             | STG_DIMENSION_DATA    | processing_code              | 1:1 Mapping                                                  |
| DIM_PRODUCT         | processing_code_description | STG_DIMENSION_DATA    | processing_code_description  | 1:1 Mapping                                                  |
| DIM_PRODUCT         | processing_group            | STG_DIMENSION_DATA    | processing_group             | 1:1 Mapping                                                  |

# Transformation Logic

- **MERGE Statements:** Used for idempotent loads (insert only if not matched).
- **Filters:**
  - `institution_id IS NOT NULL AND LEN(institution_id) > 3` (DIM_INSTITUTION)
  - `UPPER(corporation_name) NOT LIKE 'TEST%'` (DIM_CORPORATION)
  - `processing_group NOT IN ('DEPRECATED', 'LEGACY')` (DIM_PRODUCT)
- **DISTINCT:** Ensures no duplicate records are inserted.
- **No UDFs or reusable templates** are used; all logic is inline SQL.

# Complexity Analysis

| Metric                              | Value/Details                                                                 |
|--------------------------------------|-------------------------------------------------------------------------------|
| Number of Pipeline Activities        | 1 (Stored Procedure, can be invoked in pipeline)                              |
| Number of Dataflow Transformations   | 3 (MERGE operations with embedded filters)                                    |
| SQL Scripts or Stored Procedures Used| 1 (dbo.populate_dimensions)                                                   |
| Joins Used                          | None (MERGE with ON clause, no explicit JOIN)                                 |
| Lookup Tables or Reference Data      | None                                                                          |
| Parameters/Variables/Triggers        | 0 (No parameters, variables, or triggers in procedure itself)                 |
| Number of Output Datasets           | 3 (DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT)                             |
| Conditional Logic or if-else Flows   | 3 (WHERE clause filters in each MERGE)                                        |
| External Dependencies                | Source: STG_DIMENSION_DATA; Target: Dimension tables; Invoked by Synapse pipeline |
| Overall Complexity Score             | 35                                                                            |

# Key Outputs

- **Tables Written:** `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`
- **Format:** Synapse SQL tables (rowstore/columnstore, depending on DW config)
- **Intended Use:** Enterprise reporting, regulatory analytics, ML model input, downstream fact table enrichment.

# API Cost

apiCost: 0.0025 USD

```