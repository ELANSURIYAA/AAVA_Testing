```
====================================================
Author:        Ascendion AAVA
Date:          
Description:   Documentation for Synapse Stored Procedure: dbo.LOAD_FACT_EXECUTIVE_SUMMARY
====================================================

# 1. Overview of Pipeline/Component

The `dbo.LOAD_FACT_EXECUTIVE_SUMMARY` stored procedure in Azure Synapse Analytics is designed to load the `FACT_EXECUTIVE_SUMMARY` fact table from the `STG_HOLDING_METRICS` staging table. It performs business rule validations, ensures referential integrity by joining with dimension tables, and applies data quality checks. This process supports executive reporting by summarizing holding metrics for downstream analytics and regulatory reporting.

# 2. Component Structure and Design

- **Source:** `dbo.STG_HOLDING_METRICS` (staging table)
- **Transformation/Validation:** Temporary table `#staging_metrics` is created from the staging source.
- **Joins:** Data is joined with dimension tables: `DIM_DATE`, `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`.
- **Business Rules:** Null or negative `income_amount` values are set to 0.
- **Sink:** `dbo.FACT_EXECUTIVE_SUMMARY` (fact table)
- **Audit Logging:** Row count of inserted records is logged.
- **Cleanup:** Temporary tables are dropped post-processing.

**Connection Flow:**
1. Data is staged from `STG_HOLDING_METRICS` into a temp table.
2. Data is validated and joined with dimension tables.
3. Transformed data is inserted into the fact table.
4. Audit and cleanup steps are executed.

**Parameters/Variables:**
- `@v_row_count` (row count for audit)
- `@error_message` (for error handling, not used in this script)

# 3. Data Flow and Processing Logic

**Processed Datasets:**
- `dbo.STG_HOLDING_METRICS`
- `dbo.DIM_DATE`
- `dbo.DIM_INSTITUTION`
- `dbo.DIM_CORPORATION`
- `dbo.DIM_PRODUCT`
- `dbo.FACT_EXECUTIVE_SUMMARY`

**Data Flow:**
1. Extract all records from `STG_HOLDING_METRICS` into `#staging_metrics`.
2. Join `#staging_metrics` with dimension tables to resolve surrogate keys and ensure referential integrity.
3. Apply business rules (e.g., set negative/null `income_amount` to 0).
4. Insert validated and enriched records into `FACT_EXECUTIVE_SUMMARY`.
5. Log the number of records inserted.
6. Drop the temporary staging table.

**Business Rules/Transformations:**
- Only records with valid dimension keys are loaded.
- `income_amount` is set to 0 if null or negative.

**SQL Scripts/Procedures Used:**
- This is a single stored procedure: `dbo.LOAD_FACT_EXECUTIVE_SUMMARY`.

# 4. Data Mapping (Lineage)

| Target Table Name         | Target Column Name      | Source Table Name      | Source Column Name      | Remarks                                                      |
|--------------------------|------------------------|-----------------------|------------------------|--------------------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key               | DIM_DATE              | date_key               | 1:1 Mapping via join on `date_value`                         |
| FACT_EXECUTIVE_SUMMARY   | institution_id         | DIM_INSTITUTION       | institution_id         | 1:1 Mapping via join                                         |
| FACT_EXECUTIVE_SUMMARY   | corporation_id         | DIM_CORPORATION       | corporation_id         | 1:1 Mapping via join                                         |
| FACT_EXECUTIVE_SUMMARY   | product_id             | DIM_PRODUCT           | product_id             | 1:1 Mapping via join                                         |
| FACT_EXECUTIVE_SUMMARY   | a120_amount            | STG_HOLDING_METRICS   | a120_amount            | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a120_count             | STG_HOLDING_METRICS   | a120_count             | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount       | STG_HOLDING_METRICS   | a30_to_59_amount       | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count        | STG_HOLDING_METRICS   | a30_to_59_count        | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount       | STG_HOLDING_METRICS   | a60_to_89_amount       | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count        | STG_HOLDING_METRICS   | a60_to_89_count        | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount      | STG_HOLDING_METRICS   | a90_to_119_amount      | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count       | STG_HOLDING_METRICS   | a90_to_119_count       | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount      | STG_HOLDING_METRICS   | charge_off_amount      | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count       | STG_HOLDING_METRICS   | charge_off_count       | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount           | STG_HOLDING_METRICS   | fraud_amount           | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | fraud_count            | STG_HOLDING_METRICS   | fraud_count            | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | income_amount          | STG_HOLDING_METRICS   | income_amount          | Transformation: If null or <0, set to 0                      |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts     | STG_HOLDING_METRICS   | number_of_accounts     | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount       | STG_HOLDING_METRICS   | purchases_amount       | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | purchases_count        | STG_HOLDING_METRICS   | purchases_count        | 1:1 Mapping                                                  |

# 5. Transformation Logic

- **income_amount:**  
  `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`  
  Ensures no negative or null income values are loaded.

- **Joins:**  
  - `INNER JOIN` to dimension tables ensures only valid, referentially complete records are loaded.

- **Audit Logging:**  
  - Row count of inserted records is captured and printed for monitoring.

- **Temporary Table Usage:**  
  - Data is staged in `#staging_metrics` for transformation and validation before loading to the fact table.

# 6. Complexity Analysis

| Metric                                | Value/Description                                         |
|----------------------------------------|-----------------------------------------------------------|
| Number of Pipeline Activities          | 1 (Stored Procedure)                                      |
| Number of Dataflow Transformations     | 1 (Staging, Validation, Join, Insert)                     |
| SQL Scripts or Stored Procedures Used  | 1                                                        |
| Joins Used                            | 4 (All INNER JOINs: Date, Institution, Corporation, Product)|
| Lookup Tables or Reference Data        | 4 (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT)|
| Parameters/Variables/Triggers          | 2 (Variables: @v_row_count, @error_message)               |
| Number of Output Datasets              | 1 (FACT_EXECUTIVE_SUMMARY)                                |
| Conditional Logic or if-else Flows     | 1 (income_amount transformation)                          |
| External Dependencies                  | None (all tables are internal to Synapse DW)              |
| Overall Complexity Score               | 30                                                        |

# 7. Key Outputs

- **Output Table:** `dbo.FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse Dedicated SQL Table
- **Intended Use:** Executive summary reporting, regulatory analytics, and downstream BI/ML workloads.
- **Data Volume:** Up to ~1 TB (as per indicative data volumes provided).

---

**API Cost:**  
apiCost: 0.01 USD
```