# Azure Synapse Documentation: dbo.LOAD_FACT_EXECUTIVE_SUMMARY

---

## Metadata

| Field            | Value                                   |
|------------------|-----------------------------------------|
| Author           | Ascendion AAVA                          |
| Date             |                                         |
| Description      | Loads FACT_EXECUTIVE_SUMMARY with summarized holding metrics from staging, applying business rules and referential integrity checks. |

---

## 1. Overview of Pipeline/Component

The stored procedure `dbo.LOAD_FACT_EXECUTIVE_SUMMARY` in Synapse DW is designed to populate the `FACT_EXECUTIVE_SUMMARY` fact table from the `STG_HOLDING_METRICS` staging table. It enforces data quality, applies business rules (such as handling negative or null income amounts), and ensures referential integrity by joining with multiple dimension tables. This process supports executive reporting by providing accurate, validated, and enriched holding metrics data.

---

## 2. Component Structure and Design

- **Component Type:** SQL Stored Procedure
- **Source:** `STG_HOLDING_METRICS` (staging table)
- **Transformations:** Data quality checks, business rule enforcement (e.g., income_amount logic), referential integrity via joins
- **Dimension Tables:** `DIM_DATE`, `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`
- **Sink:** `FACT_EXECUTIVE_SUMMARY` (fact table)
- **Activities:** 
  - Temporary staging table creation
  - Data validation and transformation
  - Joins to dimension tables
  - Insert into fact table
  - Audit logging
  - Cleanup of temp resources
- **Parameters/Variables:** 
  - `@v_row_count` (row count for audit)
  - `@error_message` (reserved for error handling)
- **Triggers:** Typically orchestrated by Synapse pipeline or scheduled job (not shown in code)

---

## 3. Data Flow and Processing Logic

**Processed Datasets:**  
- `STG_HOLDING_METRICS` (source/staging)
- `DIM_DATE`, `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT` (dimensions)
- `FACT_EXECUTIVE_SUMMARY` (target/fact)

**Data Flow:**  
1. Extract all records from `STG_HOLDING_METRICS` into a temp table `#staging_metrics`.
2. For each record, join with dimension tables to resolve surrogate keys.
3. Apply business rules (e.g., set negative/null `income_amount` to 0).
4. Insert validated and enriched records into `FACT_EXECUTIVE_SUMMARY`.
5. Log the number of inserted records.
6. Clean up temporary resources.

---

## 4. Data Mapping (Lineage)

| Target Table Name        | Target Column Name     | Source Table Name      | Source Column Name      | Remarks                                                                 |
|-------------------------|-----------------------|-----------------------|------------------------|-------------------------------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY  | date_key              | DIM_DATE              | date_key               | 1:1 Mapping via join on `stg.date_value = dt.date_key`                  |
| FACT_EXECUTIVE_SUMMARY  | institution_id        | DIM_INSTITUTION       | institution_id         | 1:1 Mapping via join on `stg.institution_id = inst.institution_id`      |
| FACT_EXECUTIVE_SUMMARY  | corporation_id        | DIM_CORPORATION       | corporation_id         | 1:1 Mapping via join on `stg.corporation_id = corp.corporation_id`      |
| FACT_EXECUTIVE_SUMMARY  | product_id            | DIM_PRODUCT           | product_id             | 1:1 Mapping via join on `stg.product_id = prod.product_id`              |
| FACT_EXECUTIVE_SUMMARY  | a120_amount           | STG_HOLDING_METRICS   | a120_amount            | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | a120_count            | STG_HOLDING_METRICS   | a120_count             | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | a30_to_59_amount      | STG_HOLDING_METRICS   | a30_to_59_amount       | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | a30_to_59_count       | STG_HOLDING_METRICS   | a30_to_59_count        | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | a60_to_89_amount      | STG_HOLDING_METRICS   | a60_to_89_amount       | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | a60_to_89_count       | STG_HOLDING_METRICS   | a60_to_89_count        | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | a90_to_119_amount     | STG_HOLDING_METRICS   | a90_to_119_amount      | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | a90_to_119_count      | STG_HOLDING_METRICS   | a90_to_119_count       | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | charge_off_amount     | STG_HOLDING_METRICS   | charge_off_amount      | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | charge_off_count      | STG_HOLDING_METRICS   | charge_off_count       | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | fraud_amount          | STG_HOLDING_METRICS   | fraud_amount           | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | fraud_count           | STG_HOLDING_METRICS   | fraud_count            | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | income_amount         | STG_HOLDING_METRICS   | income_amount          | Transformation: CASE WHEN NULL or <0 THEN 0 ELSE value                 |
| FACT_EXECUTIVE_SUMMARY  | number_of_accounts    | STG_HOLDING_METRICS   | number_of_accounts     | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | purchases_amount      | STG_HOLDING_METRICS   | purchases_amount       | 1:1 Mapping                                                            |
| FACT_EXECUTIVE_SUMMARY  | purchases_count       | STG_HOLDING_METRICS   | purchases_count        | 1:1 Mapping                                                            |

---

## 5. Transformation Logic

- **income_amount**:  
  sql
  CASE 
      WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0
      ELSE stg.income_amount
  END AS income_amount
  
  *Sets income_amount to 0 if null or negative, enforcing business rule for data quality.*

- **Joins for Referential Integrity**:  
  - `INNER JOIN dbo.DIM_DATE dt ON dt.date_key = stg.date_value`
  - `INNER JOIN dbo.DIM_INSTITUTION inst ON inst.institution_id = stg.institution_id`
  - `INNER JOIN dbo.DIM_CORPORATION corp ON corp.corporation_id = stg.corporation_id`
  - `INNER JOIN dbo.DIM_PRODUCT prod ON prod.product_id = stg.product_id`
  *Ensures only records with valid dimension references are loaded.*

- **Audit Logging**:  
  - `SET @v_row_count = @@ROWCOUNT;`
  - `PRINT CAST(@v_row_count AS VARCHAR(10)) + ' records inserted into FACT_EXECUTIVE_SUMMARY.';`
  *Captures and logs the number of inserted records for monitoring.*

---

## 6. Complexity Analysis

| Metric                          | Value/Description                                      |
|----------------------------------|-------------------------------------------------------|
| Number of Pipeline Activities    | 1 (Stored Procedure)                                  |
| Number of Dataflow Transformations | 1 (income_amount business rule)                     |
| SQL Scripts or Stored Procedures Used | 1 (this procedure)                             |
| Joins Used                      | 4 (INNER JOINs to dimension tables)                   |
| Lookup Tables or Reference Data  | 4 (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Parameters/Variables/Triggers    | 2 variables (`@v_row_count`, `@error_message`)        |
| Number of Output Datasets        | 1 (FACT_EXECUTIVE_SUMMARY)                            |
| Conditional Logic or if-else Flows | 1 (income_amount CASE)                             |
| External Dependencies            | 4 (dimension tables)                                  |
| Overall Complexity Score         | 30 (on a scale of 0â€“100; moderate, standard ETL logic)|

---

## 7. Key Outputs

- **Target Table:** `FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse Table (row-based, suitable for reporting and analytics)
- **Intended Use:** Executive summary reporting, regulatory reporting, downstream analytics, and business intelligence dashboards.
- **Data Quality:** Only records passing referential integrity and business rule checks are loaded.
- **Audit:** Number of records inserted is logged for traceability.

---

## API Cost

apiCost: 0.002 USD

---