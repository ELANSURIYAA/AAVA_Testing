```
====================================================
Author:        Ascendion AAVA
Date:          
Description:   Loads summarized holding metrics into FACT_EXECUTIVE_SUMMARY from staging, applying business rules and validations.
====================================================

# Azure Synapse Pipeline Documentation: LOAD_FACT_EXECUTIVE_SUMMARY

## 1. Overview of Pipeline/Component

The `LOAD_FACT_EXECUTIVE_SUMMARY` stored procedure in Azure Synapse Analytics is designed to load summarized holding metrics from the staging table `STG_HOLDING_METRICS` into the fact table `FACT_EXECUTIVE_SUMMARY`. It performs data quality validation, applies business rules, and ensures referential integrity by joining with dimension tables. This process supports enterprise reporting and analytics by providing a cleansed, validated, and integrated fact dataset.

## 2. Component Structure and Design

- **Source:** `dbo.STG_HOLDING_METRICS` (Staging table)
- **Transformation:** Temporary table `#staging_metrics` for intermediate processing
- **Joins:** 
  - `DIM_DATE` (on `date_key`)
  - `DIM_INSTITUTION` (on `institution_id`)
  - `DIM_CORPORATION` (on `corporation_id`)
  - `DIM_PRODUCT` (on `product_id`)
- **Business Rule:** Income amount is set to 0 if null or negative
- **Sink:** `dbo.FACT_EXECUTIVE_SUMMARY` (Fact table)
- **Audit Logging:** Row count printed after insert
- **Cleanup:** Temporary table dropped after processing

### Connection Flow

1. Data is selected from the staging table into a temp table.
2. Valid records are inserted into the fact table using inner joins to dimension tables.
3. Business rules (e.g., income amount validation) are applied during transformation.
4. Audit logging captures the number of inserted records.
5. Temporary resources are cleaned up post-processing.

## 3. Data Flow and Processing Logic

### Processed Datasets

- `dbo.STG_HOLDING_METRICS`
- `dbo.DIM_DATE`
- `dbo.DIM_INSTITUTION`
- `dbo.DIM_CORPORATION`
- `dbo.DIM_PRODUCT`
- `dbo.FACT_EXECUTIVE_SUMMARY`

### Data Flow

1. Extract all records from `STG_HOLDING_METRICS` into `#staging_metrics`.
2. For each record, join with dimension tables to resolve surrogate keys.
3. Apply business rules (e.g., income amount normalization).
4. Insert validated and enriched records into `FACT_EXECUTIVE_SUMMARY`.
5. Log the number of inserted records for audit purposes.

### Logical Steps

| Step | Description |
|------|-------------|
| 1 | Prepare staging data in temp table |
| 2 | Join with dimension tables for referential integrity |
| 3 | Apply business rules (income amount validation) |
| 4 | Insert into fact table |
| 5 | Audit logging and cleanup |

## 4. Data Mapping (Lineage)

| Target Table Name         | Target Column Name      | Source Table Name      | Source Column Name      | Remarks                                      |
|--------------------------|------------------------|-----------------------|------------------------|----------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key               | DIM_DATE              | date_key               | 1:1 Mapping via join                         |
| FACT_EXECUTIVE_SUMMARY   | institution_id         | DIM_INSTITUTION       | institution_id         | 1:1 Mapping via join                         |
| FACT_EXECUTIVE_SUMMARY   | corporation_id         | DIM_CORPORATION       | corporation_id         | 1:1 Mapping via join                         |
| FACT_EXECUTIVE_SUMMARY   | product_id             | DIM_PRODUCT           | product_id             | 1:1 Mapping via join                         |
| FACT_EXECUTIVE_SUMMARY   | a120_amount            | STG_HOLDING_METRICS   | a120_amount            | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a120_count             | STG_HOLDING_METRICS   | a120_count             | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount       | STG_HOLDING_METRICS   | a30_to_59_amount       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count        | STG_HOLDING_METRICS   | a30_to_59_count        | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount       | STG_HOLDING_METRICS   | a60_to_89_amount       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count        | STG_HOLDING_METRICS   | a60_to_89_count        | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount      | STG_HOLDING_METRICS   | a90_to_119_amount      | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count       | STG_HOLDING_METRICS   | a90_to_119_count       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount      | STG_HOLDING_METRICS   | charge_off_amount      | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count       | STG_HOLDING_METRICS   | charge_off_count       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount           | STG_HOLDING_METRICS   | fraud_amount           | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | fraud_count            | STG_HOLDING_METRICS   | fraud_count            | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | income_amount          | STG_HOLDING_METRICS   | income_amount          | Transformation: If null or <0, set to 0      |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts     | STG_HOLDING_METRICS   | number_of_accounts     | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount       | STG_HOLDING_METRICS   | purchases_amount       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | purchases_count        | STG_HOLDING_METRICS   | purchases_count        | 1:1 Mapping                                  |

## 5. Transformation Logic

- **income_amount:** 
  - Expression: `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`
  - Purpose: Ensures income values are non-negative and not null.
- **Joins:** 
  - Surrogate key resolution for date, institution, corporation, and product.
- **No UDFs or reusable templates** are used in this stored procedure.

## 6. Complexity Analysis

| Metric                          | Value/Details                                  |
|----------------------------------|-----------------------------------------------|
| Number of Pipeline Activities    | 1 (Stored Procedure)                          |
| Number of Dataflow Transformations | 1 (income_amount transformation)              |
| SQL Scripts or Stored Procedures Used | 1 (LOAD_FACT_EXECUTIVE_SUMMARY)           |
| Joins Used                      | 4 (INNER JOIN: DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Lookup Tables or Reference Data  | 4 (dimension tables)                          |
| Parameters/Variables/Triggers    | 2 (variables: @v_row_count, @error_message)   |
| Number of Output Datasets        | 1 (FACT_EXECUTIVE_SUMMARY)                    |
| Conditional Logic or if-else Flows | 1 (income_amount CASE)                      |
| External Dependencies           | None (all tables within Synapse DW)            |
| Overall Complexity Score         | 30                                            |

## 7. Key Outputs

- **Output Table:** `FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse Table (columnar storage)
- **Intended Use:** Enterprise reporting, analytics, and downstream BI processes
- **Data Quality:** Validated and enriched with business rules and referential integrity

---

## API Cost

apiCost: 0.002 USD

```