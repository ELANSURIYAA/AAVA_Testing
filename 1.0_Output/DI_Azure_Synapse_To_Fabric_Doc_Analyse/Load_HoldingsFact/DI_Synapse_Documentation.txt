```
====================================================
Author:        Ascendion AAVA
Date:          
Description:   Documentation for Synapse Stored Procedure: LOAD_FACT_EXECUTIVE_SUMMARY
====================================================

# 1. Overview of Pipeline/Component

The `LOAD_FACT_EXECUTIVE_SUMMARY` stored procedure in Azure Synapse Analytics is designed to load the `FACT_EXECUTIVE_SUMMARY` table with summarized holding metrics. It ingests data from the staging table `STG_HOLDING_METRICS`, applies business rule validations, ensures referential integrity by joining with dimension tables, and performs necessary transformations before inserting the data into the fact table. This process supports executive reporting and analytics for institutional holdings.

**Business Logic/Requirement:**  
- Aggregate and validate holding metrics for reporting.
- Ensure data quality and referential integrity.
- Apply business rules for income and other metrics.

# 2. Component Structure and Design

- **Source:**  
  - `dbo.STG_HOLDING_METRICS` (Staging table for holding metrics)
  - Dimension tables: `dbo.DIM_DATE`, `dbo.DIM_INSTITUTION`, `dbo.DIM_CORPORATION`, `dbo.DIM_PRODUCT`
- **Activities:**  
  - Temporary staging of source data (`#staging_metrics`)
  - Data validation and transformation
  - Insert into fact table (`dbo.FACT_EXECUTIVE_SUMMARY`)
  - Audit logging (row count)
  - Cleanup (drop temp table)
- **Connection Flow:**  
  - Data flows from staging to temp table, then is joined with dimension tables for referential integrity, transformed, and loaded into the fact table.
- **Parameters/Variables:**  
  - `@v_row_count` (row count for audit)
  - `@error_message` (for error handling, not used in this code)
- **Triggers:**  
  - Manual or scheduled execution of stored procedure.

# 3. Data Flow and Processing Logic

**Processed Datasets:**  
- `dbo.STG_HOLDING_METRICS`
- `dbo.DIM_DATE`
- `dbo.DIM_INSTITUTION`
- `dbo.DIM_CORPORATION`
- `dbo.DIM_PRODUCT`
- `dbo.FACT_EXECUTIVE_SUMMARY`

**Data Flow:**  
1. Copy all records from `STG_HOLDING_METRICS` to a temporary table `#staging_metrics`.
2. Join `#staging_metrics` with dimension tables to ensure referential integrity.
3. Apply business rules (e.g., set `income_amount` to 0 if null or negative).
4. Insert validated and transformed records into `FACT_EXECUTIVE_SUMMARY`.
5. Log the number of inserted records.
6. Drop the temporary table.

**Business Rules/Transformations:**  
- `income_amount` is set to 0 if null or less than 0.
- Only records with valid foreign keys in dimension tables are loaded.

**SQL Scripts/Stored Procedures Used:**  
- `dbo.LOAD_FACT_EXECUTIVE_SUMMARY` (this procedure)

# 4. Data Mapping (Lineage)

| Target Table Name         | Target Column Name     | Source Table Name         | Source Column Name     | Remarks                                                   |
|--------------------------|-----------------------|--------------------------|-----------------------|-----------------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key              | DIM_DATE                 | date_key              | 1:1 Mapping via join on `date_value`                      |
| FACT_EXECUTIVE_SUMMARY   | institution_id        | DIM_INSTITUTION          | institution_id        | 1:1 Mapping via join on `institution_id`                  |
| FACT_EXECUTIVE_SUMMARY   | corporation_id        | DIM_CORPORATION          | corporation_id        | 1:1 Mapping via join on `corporation_id`                  |
| FACT_EXECUTIVE_SUMMARY   | product_id            | DIM_PRODUCT              | product_id            | 1:1 Mapping via join on `product_id`                      |
| FACT_EXECUTIVE_SUMMARY   | a120_amount           | STG_HOLDING_METRICS      | a120_amount           | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | a120_count            | STG_HOLDING_METRICS      | a120_count            | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount      | STG_HOLDING_METRICS      | a30_to_59_amount      | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count       | STG_HOLDING_METRICS      | a30_to_59_count       | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount      | STG_HOLDING_METRICS      | a60_to_89_amount      | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count       | STG_HOLDING_METRICS      | a60_to_89_count       | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount     | STG_HOLDING_METRICS      | a90_to_119_amount     | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count      | STG_HOLDING_METRICS      | a90_to_119_count      | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount     | STG_HOLDING_METRICS      | charge_off_amount     | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count      | STG_HOLDING_METRICS      | charge_off_count      | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount          | STG_HOLDING_METRICS      | fraud_amount          | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | fraud_count           | STG_HOLDING_METRICS      | fraud_count           | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | income_amount         | STG_HOLDING_METRICS      | income_amount         | Transformation: If null or <0, set to 0                   |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts    | STG_HOLDING_METRICS      | number_of_accounts    | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount      | STG_HOLDING_METRICS      | purchases_amount      | 1:1 Mapping                                               |
| FACT_EXECUTIVE_SUMMARY   | purchases_count       | STG_HOLDING_METRICS      | purchases_count       | 1:1 Mapping                                               |

# 5. Transformation Logic

- **income_amount:**  
  ```sql
  CASE 
      WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0
      ELSE stg.income_amount
  END AS income_amount
  ```
  *Sets income to zero if missing or negative.*

- **Joins for Referential Integrity:**  
  - `INNER JOIN` to dimension tables ensures only valid records are loaded.

- **Audit Logging:**  
  - Row count of inserted records is printed for monitoring.

- **No UDFs or reusable templates are used in this procedure.**

# 6. Complexity Analysis

| Metric                           | Value / Description                                   |
|-----------------------------------|------------------------------------------------------|
| Number of Pipeline Activities     | 1 (Stored Procedure)                                 |
| Number of Dataflow Transformations| 1 (income_amount transformation)                     |
| SQL Scripts or Stored Procedures  | 1 (LOAD_FACT_EXECUTIVE_SUMMARY)                      |
| Joins Used                       | 4 (INNER JOINs to DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Lookup Tables or Reference Data   | 4 (dimension tables)                                 |
| Parameters/Variables/Triggers     | 2 variables, 0 parameters, 0 triggers                |
| Number of Output Datasets        | 1 (FACT_EXECUTIVE_SUMMARY)                           |
| Conditional Logic or if-else Flows| 1 (income_amount CASE statement)                     |
| External Dependencies            | Dimension tables (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Overall Complexity Score         | 30                                                   |

# 7. Key Outputs

- **Output Table:** `dbo.FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse Table (SQL DW)
- **Intended Use:** Executive reporting, analytics, downstream BI and ML processes.

---

**API Cost:**  
apiCost: 0.002 USD

```