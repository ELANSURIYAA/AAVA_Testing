```
====================================================
Author:        Ascendion AAVA
Date:          
Description:   Loads the FACT_EXECUTIVE_SUMMARY fact table with summarized holding metrics from staging, ensuring data quality, referential integrity, and business rule enforcement.
====================================================

# 1. Overview of Pipeline/Component

The `LOAD_FACT_EXECUTIVE_SUMMARY` stored procedure in Azure Synapse Analytics is designed to populate the `FACT_EXECUTIVE_SUMMARY` table with aggregated holding metrics sourced from the `STG_HOLDING_METRICS` staging table. It enforces data quality checks, applies business rules, and ensures referential integrity by joining with dimension tables. This process supports executive reporting and analytics by providing a cleansed, validated, and integrated data foundation.

# 2. Component Structure and Design

- **Source:** `dbo.STG_HOLDING_METRICS` (staging table)
- **Staging:** Data is loaded into a temporary table `#staging_metrics` for processing.
- **Data Quality & Business Rules:** 
  - Null or negative `income_amount` values are set to 0.
- **Joins for Referential Integrity:** 
  - `DIM_DATE` (on `date_key`)
  - `DIM_INSTITUTION` (on `institution_id`)
  - `DIM_CORPORATION` (on `corporation_id`)
  - `DIM_PRODUCT` (on `product_id`)
- **Target (Sink):** `dbo.FACT_EXECUTIVE_SUMMARY`
- **Audit Logging:** Row count of inserted records is logged.
- **Cleanup:** Temporary staging table is dropped at the end.

**Parameters, Variables, Triggers:**
- Internal variables: `@v_row_count`, `@error_message`
- No external parameters or triggers in this procedure.

# 3. Data Flow and Processing Logic

**Processed Datasets:**
- `dbo.STG_HOLDING_METRICS`
- `dbo.DIM_DATE`
- `dbo.DIM_INSTITUTION`
- `dbo.DIM_CORPORATION`
- `dbo.DIM_PRODUCT`
- `dbo.FACT_EXECUTIVE_SUMMARY`

**Data Flow:**
1. Data is selected from `STG_HOLDING_METRICS` into a temp table.
2. Data is joined with dimension tables to resolve surrogate keys and ensure referential integrity.
3. Business rules are applied (e.g., income amount normalization).
4. Validated and enriched records are inserted into the fact table.
5. Audit logging captures the number of inserted records.
6. Temporary resources are cleaned up.

# 4. Data Mapping (Lineage)

| Target Table Name         | Target Column Name      | Source Table Name      | Source Column Name      | Remarks                                                      |
|--------------------------|------------------------|-----------------------|------------------------|--------------------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key               | DIM_DATE              | date_key               | 1:1 Mapping via join on date_key/date_value                  |
| FACT_EXECUTIVE_SUMMARY   | institution_id         | DIM_INSTITUTION       | institution_id         | 1:1 Mapping via join                                         |
| FACT_EXECUTIVE_SUMMARY   | corporation_id         | DIM_CORPORATION       | corporation_id         | 1:1 Mapping via join                                         |
| FACT_EXECUTIVE_SUMMARY   | product_id             | DIM_PRODUCT           | product_id             | 1:1 Mapping via join                                         |
| FACT_EXECUTIVE_SUMMARY   | a120_amount            | STG_HOLDING_METRICS   | a120_amount            | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a120_count             | STG_HOLDING_METRICS   | a120_count             | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount       | STG_HOLDING_METRICS   | a30_to_59_amount       | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count        | STG_HOLDING_METRICS   | a30_to_59_count        | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount       | STG_HOLDING_METRICS   | a60_to_89_amount       | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count        | STG_HOLDING_METRICS   | a60_to_89_count        | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount      | STG_HOLDING_METRICS   | a90_to_119_amount      | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count       | STG_HOLDING_METRICS   | a90_to_119_count       | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount      | STG_HOLDING_METRICS   | charge_off_amount      | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count       | STG_HOLDING_METRICS   | charge_off_count       | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount           | STG_HOLDING_METRICS   | fraud_amount           | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | fraud_count            | STG_HOLDING_METRICS   | fraud_count            | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | income_amount          | STG_HOLDING_METRICS   | income_amount          | Transformation: NULL or <0 set to 0                          |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts     | STG_HOLDING_METRICS   | number_of_accounts     | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount       | STG_HOLDING_METRICS   | purchases_amount       | 1:1 Mapping                                                  |
| FACT_EXECUTIVE_SUMMARY   | purchases_count        | STG_HOLDING_METRICS   | purchases_count        | 1:1 Mapping                                                  |

# 5. Transformation Logic

- **income_amount:**  
  `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`  
  Ensures that income is never negative or null in the fact table.

- **Joins:**  
  - `stg.date_value` → `dt.date_key`
  - `stg.institution_id` → `inst.institution_id`
  - `stg.corporation_id` → `corp.corporation_id`
  - `stg.product_id` → `prod.product_id`

- **No UDFs or reusable templates** are used in this procedure.

# 6. Complexity Analysis

| Metric                           | Value/Details                                  |
|----------------------------------|------------------------------------------------|
| Number of Pipeline Activities    | 1 (Stored Procedure)                           |
| Number of Dataflow Transformations| 1 (income_amount transformation)               |
| SQL Scripts or Stored Procedures Used | 1 (LOAD_FACT_EXECUTIVE_SUMMARY)           |
| Joins Used                       | 4 (All INNER JOINs)                            |
| Lookup Tables or Reference Data   | 4 (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Parameters/Variables/Triggers    | 2 variables, 0 parameters, 0 triggers          |
| Number of Output Datasets        | 1 (FACT_EXECUTIVE_SUMMARY)                     |
| Conditional Logic or if-else Flows| 1 (income_amount normalization)                |
| External Dependencies            | None (all within Synapse SQL DW)               |
| Overall Complexity Score         | 25                                             |

# 7. Key Outputs

- **Target Table:** `dbo.FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse SQL Table (row-store)
- **Intended Use:** Executive dashboards, regulatory and management reporting, downstream analytics and data science workloads.

---

**API Cost:**  
apiCost: 0.012 USD

```