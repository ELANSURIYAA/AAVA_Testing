==========================================================================================
Author:      Ascendion  AAVA
Created on:  
Description: Convert Azure Synapse stored procedures into Fabric SQL code. Loads FACT_EXECUTIVE_SUMMARY from STG_HOLDING_METRICS, performs data quality validation, ensures referential integrity via joins to dimension tables, and logs/audits the row count. All operations use Delta tables and are optimized for Fabric SQL.
==========================================================================================

-- Step 1: Prepare staging data using a CTE (no temp tables in Fabric SQL)
WITH staging_metrics AS (
    SELECT *
    FROM dbo.STG_HOLDING_METRICS
)

-- Step 2: Insert valid records into Fact table using Delta Lake MERGE for idempotency and upsert
MERGE INTO dbo.FACT_EXECUTIVE_SUMMARY AS target
USING (
    SELECT 
        dt.date_key,
        inst.institution_id,
        corp.corporation_id,
        prod.product_id,
        stg.a120_amount,
        stg.a120_count,
        stg.a30_to_59_amount,
        stg.a30_to_59_count,
        stg.a60_to_89_amount,
        stg.a60_to_89_count,
        stg.a90_to_119_amount,
        stg.a90_to_119_count,
        stg.charge_off_amount,
        stg.charge_off_count,
        stg.fraud_amount,
        stg.fraud_count,
        CASE 
            WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0
            ELSE stg.income_amount
        END AS income_amount,
        stg.number_of_accounts,
        stg.purchases_amount,
        stg.purchases_count
    FROM staging_metrics stg
    INNER JOIN dbo.DIM_DATE dt ON dt.date_key = stg.date_value
    INNER JOIN dbo.DIM_INSTITUTION inst ON inst.institution_id = stg.institution_id
    INNER JOIN dbo.DIM_CORPORATION corp ON corp.corporation_id = stg.corporation_id
    INNER JOIN dbo.DIM_PRODUCT prod ON prod.product_id = stg.product_id
) AS source
ON
    target.date_key = source.date_key AND
    target.institution_id = source.institution_id AND
    target.corporation_id = source.corporation_id AND
    target.product_id = source.product_id
WHEN MATCHED THEN
    UPDATE SET
        target.a120_amount = source.a120_amount,
        target.a120_count = source.a120_count,
        target.a30_to_59_amount = source.a30_to_59_amount,
        target.a30_to_59_count = source.a30_to_59_count,
        target.a60_to_89_amount = source.a60_to_89_amount,
        target.a60_to_89_count = source.a60_to_89_count,
        target.a90_to_119_amount = source.a90_to_119_amount,
        target.a90_to_119_count = source.a90_to_119_count,
        target.charge_off_amount = source.charge_off_amount,
        target.charge_off_count = source.charge_off_count,
        target.fraud_amount = source.fraud_amount,
        target.fraud_count = source.fraud_count,
        target.income_amount = source.income_amount,
        target.number_of_accounts = source.number_of_accounts,
        target.purchases_amount = source.purchases_amount,
        target.purchases_count = source.purchases_count
WHEN NOT MATCHED THEN
    INSERT (
        date_key,
        institution_id,
        corporation_id,
        product_id,
        a120_amount,
        a120_count,
        a30_to_59_amount,
        a30_to_59_count,
        a60_to_89_amount,
        a60_to_89_count,
        a90_to_119_amount,
        a90_to_119_count,
        charge_off_amount,
        charge_off_count,
        fraud_amount,
        fraud_count,
        income_amount,
        number_of_accounts,
        purchases_amount,
        purchases_count
    )
    VALUES (
        source.date_key,
        source.institution_id,
        source.corporation_id,
        source.product_id,
        source.a120_amount,
        source.a120_count,
        source.a30_to_59_amount,
        source.a30_to_59_count,
        source.a60_to_89_amount,
        source.a60_to_89_count,
        source.a90_to_119_amount,
        source.a90_to_119_count,
        source.charge_off_amount,
        source.charge_off_count,
        source.fraud_amount,
        source.fraud_count,
        source.income_amount,
        source.number_of_accounts,
        source.purchases_amount,
        source.purchases_count
    );

-- Step 3: Audit logging (row count for this load)
SELECT 
    COUNT(*) AS inserted_row_count
FROM dbo.FACT_EXECUTIVE_SUMMARY
WHERE date_key IN (
    SELECT DISTINCT date_value FROM dbo.STG_HOLDING_METRICS
);

-- Step 4: Completion message (use SELECT for logging in Fabric SQL)
SELECT 'LOAD_FACT_EXECUTIVE_SUMMARY completed successfully.' AS status_message;

-- Notes:
-- * All staging is performed using a CTE for compatibility with Fabric SQL.
-- * Data quality and business rules are enforced inline (e.g., income_amount logic).
-- * Delta Lake MERGE is used for efficient upsert and transactional integrity.
-- * Audit logging is performed using SELECT statements.
-- * No temp tables or PRINT statements are used, as per Fabric SQL best practices.
-- * All joins are INNER JOINs to enforce referential integrity.

-- apiCost: 0.0047 USD