=============================================
Author:      Ascendion  AAVA
Created on:   
Description:   Converts Azure Synapse stored procedure logic for maintaining dimension tables (DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) from a staging table (STG_DIMENSION_DATA) into Microsoft Fabric SQL code. Implements upsert (insert/update) logic using Delta Lake operations, applies data quality filters, and ensures idempotent, high-quality dimension data loads.
=============================================

-- Fabric SQL Script: Dimension Table Upserts from Staging

-- NOTE: This script assumes the existence of the following tables in your Fabric Lakehouse or Warehouse:
--   - STG_DIMENSION_DATA (staging source)
--   - DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT (Delta target tables)
-- Adjust schema/table references as needed for your environment.

-- ===========================================
-- Step 1: Upsert DIM_INSTITUTION
-- ===========================================

MERGE INTO DIM_INSTITUTION AS target
USING (
    SELECT DISTINCT
        institution_id,
        institution_name,
        institution_type
    FROM STG_DIMENSION_DATA
    WHERE 
        institution_id IS NOT NULL
        AND LENGTH(TRIM(institution_id)) > 0
        AND UPPER(institution_name) NOT LIKE '%TEST%'
        AND UPPER(institution_name) NOT LIKE '%LEGACY%'
        AND institution_type IS NOT NULL
        AND LENGTH(TRIM(institution_type)) > 0
) AS source
ON target.institution_id = source.institution_id
WHEN MATCHED THEN
    UPDATE SET
        target.institution_name = source.institution_name,
        target.institution_type = source.institution_type
WHEN NOT MATCHED THEN
    INSERT (institution_id, institution_name, institution_type)
    VALUES (source.institution_id, source.institution_name, source.institution_type);

-- ===========================================
-- Step 2: Upsert DIM_CORPORATION
-- ===========================================

MERGE INTO DIM_CORPORATION AS target
USING (
    SELECT DISTINCT
        corporation_id,
        corporation_name,
        institution_id,
        corporation_type,
        region,
        country,
        address,
        city,
        state,
        zip_code,
        phone,
        email,
        status
    FROM STG_DIMENSION_DATA
    WHERE
        corporation_id IS NOT NULL
        AND LENGTH(TRIM(corporation_id)) > 0
        AND UPPER(corporation_name) NOT LIKE '%TEST%'
        AND UPPER(corporation_name) NOT LIKE '%LEGACY%'
        AND institution_id IS NOT NULL
        AND LENGTH(TRIM(institution_id)) > 0
) AS source
ON target.corporation_id = source.corporation_id
WHEN MATCHED THEN
    UPDATE SET
        target.corporation_name = source.corporation_name,
        target.institution_id = source.institution_id,
        target.corporation_type = source.corporation_type,
        target.region = source.region,
        target.country = source.country,
        target.address = source.address,
        target.city = source.city,
        target.state = source.state,
        target.zip_code = source.zip_code,
        target.phone = source.phone,
        target.email = source.email,
        target.status = source.status
WHEN NOT MATCHED THEN
    INSERT (
        corporation_id, corporation_name, institution_id, corporation_type, region,
        country, address, city, state, zip_code, phone, email, status
    )
    VALUES (
        source.corporation_id, source.corporation_name, source.institution_id, source.corporation_type, source.region,
        source.country, source.address, source.city, source.state, source.zip_code, source.phone, source.email, source.status
    );

-- ===========================================
-- Step 3: Upsert DIM_PRODUCT
-- ===========================================

MERGE INTO DIM_PRODUCT AS target
USING (
    SELECT DISTINCT
        product_id,
        product_name,
        corporation_id,
        product_type,
        product_category,
        launch_date,
        status
    FROM STG_DIMENSION_DATA
    WHERE
        product_id IS NOT NULL
        AND LENGTH(TRIM(product_id)) > 0
        AND UPPER(product_name) NOT LIKE '%TEST%'
        AND UPPER(product_name) NOT LIKE '%LEGACY%'
        AND corporation_id IS NOT NULL
        AND LENGTH(TRIM(corporation_id)) > 0
) AS source
ON target.product_id = source.product_id
WHEN MATCHED THEN
    UPDATE SET
        target.product_name = source.product_name,
        target.corporation_id = source.corporation_id,
        target.product_type = source.product_type,
        target.product_category = source.product_category,
        target.launch_date = source.launch_date,
        target.status = source.status
WHEN NOT MATCHED THEN
    INSERT (
        product_id, product_name, corporation_id, product_type, product_category, launch_date, status
    )
    VALUES (
        source.product_id, source.product_name, source.corporation_id, source.product_type, source.product_category, source.launch_date, source.status
    );

-- ===========================================
-- End of Script
-- ===========================================

-- Inline Comments:
-- - All LEN() functions are replaced with LENGTH() for Fabric SQL compatibility.
-- - UPPER() and LIKE are retained for case-insensitive filtering.
-- - All procedural and PRINT/logging statements are omitted; use Fabric monitoring for operational logging.
-- - The script is modular: each MERGE can be run independently.
-- - Data quality filters are applied in each source selection.
-- - All operations are idempotent and safe for repeated execution.

-- API Cost Consumed in dollars:
apiCost: 0.0087 USD