=============================================
Author:      Ascendion  AAVA
Created on:   
Description:   Converts the Azure Synapse stored procedure 'populate_dimensions' into Microsoft Fabric SQL code. This script loads and maintains the DIM_INSTITUTION, DIM_CORPORATION, and DIM_PRODUCT dimension tables from the STG_DIMENSION_DATA staging table using idempotent upsert logic, data quality filters, and Delta Lake operations optimized for Fabric SQL.
=============================================

-- Fabric SQL Script: Populate Dimension Tables from Staging Layer
-- This script replaces the Synapse stored procedure 'populate_dimensions'
-- and is intended for execution in a Microsoft Fabric Lakehouse or Warehouse.

-- ==============================
-- 1. Populate DIM_INSTITUTION
-- ==============================

-- Upsert new institutions (idempotent insert)
MERGE INTO DIM_INSTITUTION AS target
USING (
    SELECT DISTINCT 
        institution_id, 
        institution, 
        institution_name
    FROM STG_DIMENSION_DATA
    WHERE institution_id IS NOT NULL 
      AND LENGTH(institution_id) > 3 -- Fabric SQL uses LENGTH() instead of LEN()
) AS source
ON target.institution_id = source.institution_id
WHEN NOT MATCHED THEN
    INSERT (institution_id, institution, institution_name)
    VALUES (source.institution_id, source.institution, source.institution_name);

-- ==============================
-- 2. Populate DIM_CORPORATION
-- ==============================

-- Upsert new corporations (idempotent insert)
MERGE INTO DIM_CORPORATION AS target
USING (
    SELECT DISTINCT 
        corporation_id, 
        corp_id, 
        corporation, 
        corporation_name,
        sub_corporation, 
        sub_corporation_id, 
        sub_corporation_name,
        master_corporation_dim_key, 
        association, 
        bin, 
        company,
        company_id, 
        company_name
    FROM STG_DIMENSION_DATA
    WHERE UPPER(corporation_name) NOT LIKE 'TEST%'
) AS source
ON target.corporation_id = source.corporation_id
WHEN NOT MATCHED THEN
    INSERT (
        corporation_id, corp_id, corporation, corporation_name,
        sub_corporation, sub_corporation_id, sub_corporation_name,
        master_corporation_dim_key, association, bin, company, 
        company_id, company_name
    )
    VALUES (
        source.corporation_id, source.corp_id, source.corporation, 
        source.corporation_name, source.sub_corporation, 
        source.sub_corporation_id, source.sub_corporation_name,
        source.master_corporation_dim_key, source.association, 
        source.bin, source.company, source.company_id, source.company_name
    );

-- ==============================
-- 3. Populate DIM_PRODUCT
-- ==============================

-- Upsert new products (idempotent insert)
MERGE INTO DIM_PRODUCT AS target
USING (
    SELECT DISTINCT 
        product_id, 
        product, 
        product_description,
        sub_product, 
        processing_code,
        processing_code_description, 
        processing_group
    FROM STG_DIMENSION_DATA
    WHERE processing_group NOT IN ('DEPRECATED', 'LEGACY')
) AS source
ON target.product_id = source.product_id
WHEN NOT MATCHED THEN
    INSERT (
        product_id, product, product_description, sub_product,
        processing_code, processing_code_description, processing_group
    )
    VALUES (
        source.product_id, source.product, source.product_description, 
        source.sub_product, source.processing_code, 
        source.processing_code_description, source.processing_group
    );

-- ==============================
-- End of Script
-- ==============================

-- Notes:
-- - All table references are assumed to be in the default schema or as configured in Fabric.
-- - PRINT statements and SET NOCOUNT ON are omitted, as Fabric SQL does not support these.
-- - Data quality filters are preserved and optimized for Fabric SQL syntax.
-- - This script is modular and can be executed as a Fabric SQL notebook or script cell.
-- - Ensure that DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT, and STG_DIMENSION_DATA are Delta tables for optimal performance.

-- API Cost Consumed in dollars:
apiCost: 0.0087 USD