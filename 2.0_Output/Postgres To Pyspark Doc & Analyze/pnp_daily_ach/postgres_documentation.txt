# Documentation for PostgreSQL Function: `moneymovement_source.pnp_daily_ach`

---

## 1. Overview of Program

**Purpose:**  
The `pnp_daily_ach` function orchestrates the daily processing of Automated Clearing House (ACH) transaction data. It extracts, transforms, classifies, and loads ACH transaction records, applying business rules to identify transaction parties (Person, Business, Unidentifiable), and enriches the data with additional business codes. The function also logs audit details for traceability and error management.

**Business Problem Addressed:**  
The function addresses the need to accurately classify and enrich ACH transaction data for downstream financial processing, compliance, and reporting. By standardizing customer names, classifying entity types, and updating business codes, it ensures data quality and supports business analytics, fraud detection, and regulatory compliance.

---

## 2. Code Structure and Design

**Structure and Flow:**  
- The function is written in PL/pgSQL and is executed in the `moneymovement_source` schema.
- It processes data in several staged steps using temporary tables.
- It applies transformations, invokes helper functions, and performs updates and inserts.
- It logs execution details and handles errors gracefully.

**Primary PostgreSQL Components Used:**  
- **Tables:**  
  - `moneymovement_source.tbl_transaction_detail_ach`
  - `moneymovement_source.staging_cust360_ach_batch_item`
  - `moneymovement_source.tbl_evn_na_merchant_details`
  - `moneymovement_source.audit_job_log`
  - Multiple temp tables: `wxlu_pnp_ach_daily_tmp_s0` to `wxlu_pnp_ach_daily_tmp_s7`
- **Stored Procedures/Functions:**  
  - `moneymovement_source.pnp_cust_name`
  - `moneymovement_source.update_tbl_trans_details_ach_0`
  - `moneymovement_source.log_job_run_status`
- **Joins:**  
  - Used extensively for data enrichment and classification.
- **Aggregations:**  
  - `max(business_dt)`, `row_number() over (partition by ...)`
- **Subqueries & CTEs:**  
  - Used for filtering and staging data.
- **DML Statements:**  
  - `SELECT`, `INSERT`, `UPDATE`, `DROP TABLE`, `CREATE TABLE`
- **Exception Handling:**  
  - `EXCEPTION WHEN OTHERS THEN ...`

---

## 3. Data Flow and Processing Logic

### Step-by-Step Processing Logic

#### Step 0: Initialization & Audit Start
- Capture initial timestamp and record count from `tbl_transaction_detail_ach`.

#### Step 1: Data Extraction & Staging
- Extract latest business date from `tbl_transaction_detail_ach`.
- Filter new records from `staging_cust360_ach_batch_item` based on business date.
- Store results in `wxlu_pnp_ach_daily_tmp_s0`.

#### Step 2: Name Cleaning & Transformation
- Select and rename relevant columns.
- Clean and standardize customer names using regex (remove extra spaces, uppercase, remove '1/').
- Store results in `wxlu_pnp_ach_daily_tmp_s1`.

#### Step 3: Name Classification
- Call `pnp_cust_name` function to classify names (Person, Business, etc.), output to `wxlu_pnp_ach_daily_tmp_s2`.
- Join classification results to `wxlu_pnp_ach_daily_tmp_s1` to create `wxlu_pnp_ach_daily_tmp_s3`.
- Update `entity_type` based on business logic:
  - If not clearly identified, set as 'PERSON-TBR' or 'BUSINESS-TBR' based on amount and flags.
  - Use regex patterns to further classify as 'PERSON' or 'BUSINESS'.
  - Set as 'UNIDENTIFIABLE' if name is too short.

#### Step 4: Data Enrichment
- Join enriched data back to original, add new columns (destination_pnp_cde, etc.) in `wxlu_pnp_ach_daily_tmp_s4`.
- Further filter and classify using merchant details and company IDs in `wxlu_pnp_ach_daily_tmp_s5`.
- Update `destination_pnp_cde` for certain records.

#### Step 5: De-duplication & Final Preparation
- Deduplicate on `transaction_par_nbr` and `business_dt` using `row_number()`, keep first.
- Store in `wxlu_pnp_ach_daily_tmp_s6`.
- Prepare update table for transaction details.

#### Step 6: External Function Calls
- Call `update_tbl_trans_details_ach_0()` to further update details, output to `wxlu_pnp_ach_daily_tmp_s7`.

#### Step 7: Final Enrichment
- Update DP Code, USB Cashflow Code, and On-US/Off-US status from `wxlu_pnp_ach_daily_tmp_s7` into `wxlu_pnp_ach_daily_tmp_s6`.

#### Step 8: Insert Final Results
- Insert processed records into `tbl_transaction_detail_ach`.

#### Step 9: Audit Logging
- Log job run status and record counts.
- Handle exceptions and log failures.

---

### Transformations Applied

- **Filtering:**  
  - By business date, company ID, and entity type.
- **Joins:**  
  - To enrich with classification and merchant details.
- **Aggregations:**  
  - Max date, deduplication via `row_number()`.
- **Regex & String Functions:**  
  - Cleaning and standardizing customer names.
- **Conditional Updates:**  
  - Business logic for entity classification.
- **Data Enrichment:**  
  - Adding business codes and party IDs.

---

## 4. Data Mapping

| Target Table Name                      | Target Column Name           | Source Table Name                                 | Source Column Name         | Remarks                                                                                  |
|----------------------------------------|-----------------------------|---------------------------------------------------|---------------------------|------------------------------------------------------------------------------------------|
| wxlu_pnp_ach_daily_tmp_s0              | * (all columns)             | staging_cust360_ach_batch_item                    | *                         | 1 to 1 mapping; filtered by business date                                                |
| wxlu_pnp_ach_daily_tmp_s1              | trans_id                    | wxlu_pnp_ach_daily_tmp_s0                         | transaction_par_nbr       | 1 to 1 mapping; column rename                                                            |
| wxlu_pnp_ach_daily_tmp_s1              | zxx__cust_name              | wxlu_pnp_ach_daily_tmp_s0                         | dest_customer_nm          | 1 to 1 mapping; column rename                                                            |
| wxlu_pnp_ach_daily_tmp_s1              | trans_amt                   | wxlu_pnp_ach_daily_tmp_s0                         | dest_transaction_amt      | 1 to 1 mapping; column rename                                                            |
| wxlu_pnp_ach_daily_tmp_s1              | bus_date                    | wxlu_pnp_ach_daily_tmp_s0                         | business_dt               | 1 to 1 mapping; column rename                                                            |
| wxlu_pnp_ach_daily_tmp_s1              | zxx__cust_name_mod          | wxlu_pnp_ach_daily_tmp_s0                         | dest_customer_nm          | Transformation; cleaned and uppercased using regex                                       |
| wxlu_pnp_ach_daily_tmp_s3              | entity_type                 | wxlu_pnp_ach_daily_tmp_s2                         | entity_type               | 1 to 1 mapping; with conditional updates                                                 |
| wxlu_pnp_ach_daily_tmp_s3              | zxx__cust_name_mod_new      | wxlu_pnp_ach_daily_tmp_s2                         | zxx__cust_name_mod_new    | 1 to 1 mapping                                                                          |
| wxlu_pnp_ach_daily_tmp_s4              | destination_pnp_cde         | wxlu_pnp_ach_daily_tmp_s3                         | entity_type               | 1 to 1 mapping                                                                          |
| wxlu_pnp_ach_daily_tmp_s4              | originator_pnp_cde          | -                                                 | -                         | Default value: ''                                                                        |
| wxlu_pnp_ach_daily_tmp_s4              | dp_cde                      | -                                                 | -                         | Default value: ''                                                                        |
| wxlu_pnp_ach_daily_tmp_s4              | destination_party_mma_id    | -                                                 | -                         | Default value: ''                                                                        |
| wxlu_pnp_ach_daily_tmp_s4              | originator_party_mma_id     | -                                                 | -                         | Default value: ''                                                                        |
| wxlu_pnp_ach_daily_tmp_s4              | destination_party_lpid      | -                                                 | -                         | Default value: ''                                                                        |
| wxlu_pnp_ach_daily_tmp_s4              | originator_party_lpid       | -                                                 | -                         | Default value: ''                                                                        |
| wxlu_pnp_ach_daily_tmp_s4              | originator_3rdparty_mma_id  | -                                                 | -                         | Default value: ''                                                                        |
| wxlu_pnp_ach_daily_tmp_s4              | usb_onus_external_tnx_cde   | -                                                 | -                         | Default value: ''                                                                        |
| wxlu_pnp_ach_daily_tmp_s4              | usb_cashflow_cde            | -                                                 | -                         | Default value: ''                                                                        |
| wxlu_pnp_ach_daily_tmp_s4              | pymt_purpose_cde            | -                                                 | -                         | Default value: ''                                                                        |
| wxlu_pnp_ach_daily_tmp_s5              | destination_pnp_cde         | wxlu_pnp_ach_daily_tmp_s4                         | destination_pnp_cde       | 1 to 1 mapping                                                                          |
| wxlu_pnp_ach_daily_tmp_s5              | dest_customer_nm            | wxlu_pnp_ach_daily_tmp_s4                         | dest_customer_nm          | 1 to 1 mapping                                                                          |
| wxlu_pnp_ach_daily_tmp_s5              | dest_check_nbr              | wxlu_pnp_ach_daily_tmp_s4                         | dest_check_nbr            | 1 to 1 mapping                                                                          |
| wxlu_pnp_ach_daily_tmp_s5              | originator_company_id       | wxlu_pnp_ach_daily_tmp_s4                         | originator_company_id     | 1 to 1 mapping                                                                          |
| wxlu_pnp_ach_daily_tmp_s5              | ...                         | ...                                               | ...                       | ...                                                                                      |
| tbl_transaction_detail_ach             | transaction_par_nbr         | wxlu_pnp_ach_daily_tmp_s6                         | transaction_par_nbr       | 1 to 1 mapping                                                                          |
| tbl_transaction_detail_ach             | dest_transaction_amt        | wxlu_pnp_ach_daily_tmp_s6                         | dest_transaction_amt      | 1 to 1 mapping                                                                          |
| tbl_transaction_detail_ach             | credit_debit_cde            | wxlu_pnp_ach_daily_tmp_s6                         | credit_debit_cde          | 1 to 1 mapping                                                                          |
| tbl_transaction_detail_ach             | nacha_sec_code              | wxlu_pnp_ach_daily_tmp_s6                         | nacha_sec_code            | 1 to 1 mapping                                                                          |
| tbl_transaction_detail_ach             | destination_pnp_cde         | wxlu_pnp_ach_daily_tmp_s6                         | destination_pnp_cde       | 1 to 1 mapping                                                                          |
| tbl_transaction_detail_ach             | originator_pnp_cde          | wxlu_pnp_ach_daily_tmp_s6                         | originator_pnp_cde        | 1 to 1 mapping                                                                          |
| tbl_transaction_detail_ach             | dp_cde                      | wxlu_pnp_ach_daily_tmp_s6                         | dp_cde                    | 1 to 1 mapping                                                                          |
| tbl_transaction_detail_ach             | usb_cashflow_cde            | wxlu_pnp_ach_daily_tmp_s6                         | usb_cashflow_cde          | 1 to 1 mapping                                                                          |
| tbl_transaction_detail_ach             | usb_onus_external_tnx_cde   | wxlu_pnp_ach_daily_tmp_s6                         | usb_onus_external_tnx_cde | 1 to 1 mapping                                                                          |
| tbl_transaction_detail_ach             | pymt_purpose_cde            | wxlu_pnp_ach_daily_tmp_s6                         | pymt_purpose_cde          | 1 to 1 mapping                                                                          |
| tbl_transaction_detail_ach             | ...                         | wxlu_pnp_ach_daily_tmp_s6                         | ...                       | 1 to 1 mapping for all other columns                                                     |

*Note: The table above is a representative sample. All columns from the final staging table are inserted into the target table, with some being defaulted or transformed as described.*

---

## 5. Complexity Analysis

| Metric                    | Value (Approximate) |
|---------------------------|---------------------|
| Lines of Code (LOC)       | 250                 |
| Cyclomatic Complexity     | 18                  |
| Nesting Depth             | 3                   |
| Tables                    | 8                   |
| Temporary tables          | 8                   |
| DML Statements            | 30                  |
| Joins                     | 8                   |
| Subqueries                | 6                   |
| CTEs                      | 3                   |
| Aggregation Queries       | 2                   |
| Input Parameters          | 0                   |
| Output Parameters         | 1 (array)           |
| Data Transformations      | 10+                 |
| Function Calls            | 3                   |

**Overall Complexity Score:** 78/100  
*This function is moderately complex due to multiple transformation steps, business logic, regex usage, and error handling.*

---

## 6. Key Outputs

- **Inserts:**  
  - Final processed ACH transaction records are inserted into `moneymovement_source.tbl_transaction_detail_ach`.
- **Updates:**  
  - Entity type and business codes are updated in staging tables.
- **Audit Logging:**  
  - Job execution details are logged in `moneymovement_source.audit_job_log` via `log_job_run_status`.

---

## 7. Error Handling and Logging

- **Try-Catch Mechanism:**  
  - The function uses an `EXCEPTION WHEN OTHERS THEN` block to catch and handle all errors.
- **Error Logging:**  
  - On error, logs the failure in `audit_job_log` with status 'FAILED' and records the error message and state.
- **Audit Trail:**  
  - Logs job name, status, timestamps, and record counts for both successful and failed runs.
- **No explicit retry mechanism** is present, but errors are logged for operational follow-up.

---

## 8. Field Descriptions

Below are key fields used and their descriptions:

| Field Name                  | Description                                                        |
|-----------------------------|--------------------------------------------------------------------|
| transaction_par_nbr         | Unique transaction identifier                                      |
| dest_customer_nm            | Destination customer name                                          |
| dest_transaction_amt        | Transaction amount                                                 |
| business_dt                 | Business date                                                      |
| entity_type                 | Classified entity type (PERSON, BUSINESS, UNIDENTIFIABLE, etc.)    |
| destination_pnp_cde         | Final classified party code                                        |
| originator_pnp_cde          | Originator party code (defaulted)                                  |
| dp_cde                      | DP Code (business logic derived)                                   |
| usb_cashflow_cde            | USB Cashflow Code (business logic derived)                         |
| usb_onus_external_tnx_cde   | On-US/Off-US transaction code                                      |
| pymt_purpose_cde            | Payment purpose code                                               |
| credit_debit_cde            | Credit/Debit indicator                                             |
| nacha_sec_code              | NACHA SEC code (transaction type)                                  |
| originator_company_id       | Originator company identifier                                      |
| dest_check_nbr              | Destination check number                                           |
| ...                         | Other fields as per transaction detail table                       |

---

## 9. Summary

This function is a critical data pipeline component for ACH transaction processing. It ensures data quality through cleaning, classification, and enrichment, and provides robust logging and error handling for operational transparency. The design leverages temporary tables for stepwise transformation, modular function calls for classification and enrichment, and comprehensive audit logging for traceability.

---