=============================================
Author:        Ascendion AVA+
Date:   
Description:   Technical documentation for TAMBR_RINGS.txt SAS code â€“ details data processing, transformation, and analysis logic for TAMBr ring calculation in banking branch/customer analytics.
=============================================

## Overview of Program

The TAMBR_RINGS.txt SAS code is a monthly batch process designed to calculate and assign "priority" and "most used" rings for open traditional, in-store, university, retirement, and corporate bank branches. These rings are used in the TAMBr process to support customer segmentation, branch performance analysis, and targeted marketing. The code addresses the business need to accurately map customers to their primary and most frequented branches, leveraging geolocation data and transactional history. By automating the calculation of distance-based rings and integrating various data sources, the program enables more precise reporting and decision-making for branch operations and customer relationship management.

## Code Structure and Design

The code is modular, with clear separation between data extraction, transformation, and output steps. It utilizes a combination of SAS Data Steps, PROC SQL, and custom macros to orchestrate the workflow. Key modules include:
- Initialization and library assignments.
- Extraction of customer, branch, and geocode data from DB2 and SAS datasets.
- Data cleansing and transformation, including handling of missing or invalid geolocation data.
- Calculation of "most used" branches based on the last three months of transaction history.
- Calculation of distance rings (80th percentile) for both priority and most used branches.
- Creation of final output tables for reporting and downstream processes.
- Inline macro definitions for table management and date handling.

The flow is linear but leverages temporary and permanent tables, with joins and aggregations to consolidate data from multiple sources. The code also includes detailed change logs and comments for maintainability.

## Data Flow and Processing Logic

**Processed Datasets:**
- tambr.cust_state_match
- macommon.dbm_cust_state
- ccsi.customer_mth
- ccsi.branch_hrcy_mth
- ccsi.geo_customer_mth
- adcommon.gis_new_cust_geocoded
- rings_branch_data
- tambr.bad_latlong_branch
- branch_active
- most_used
- macommon.&SYSUSERID._mu_br
- customers
- customers1
- rings_cust_data
- tambr.bad_latlong_cust
- rings_priority_cust
- tambr.ring_priority
- rings_most_used_cust
- tambr.ring_most_used
- ring_priority2
- ring_most_used2
- branch_data2
- tambr.tambr_rings_&cust_occr.

**Data Flow:**
The process begins by extracting and staging customer and branch data, including geolocation information. It then enriches customer records with the most recent geocode data, prioritizing new movers. Branch data is filtered for relevant types and validated for geolocation accuracy. Transactional history is aggregated to determine each customer's most used branch over the past three months. The code then calculates the distance from each customer to their priority and most used branches, computes the 80th percentile distance ring for each branch, and merges these results with branch metadata. The final output table contains branch-level ring metrics for use in reporting and analytics.

## Data Mapping

| Target Table Name                | Target Column Name   | Source Table Name            | Source Column Name      | Remarks                                                      |
|----------------------------------|----------------------|------------------------------|------------------------|--------------------------------------------------------------|
| macommon.dbm_cust_state          | * (all columns)      | tambr.cust_state_match       | * (all columns)        | 1 to 1 mapping; staging for further processing               |
| macommon.&SYSUSERID._GEOCODE_WEEKLY | LP_ID               | work.geo_customer_mth/adcommon.gis_new_cust_geocoded | LP_ID                  | Transformation; prioritizes new customer data if available   |
| macommon.&SYSUSERID._GEOCODE_WEEKLY | GEO_LATITUDE        | geo_customer_mth/gis_new_cust_geocoded | GEO_LATITUDE/LATITUDE  | Transformation; uses new data if available, else monthly     |
| rings_branch_data                | branchlat, branchlong| branches                     | LATITUDE_UPDT, LONGITUDE_UPDT | 1 to 1 mapping; only valid lat/long branches                |
| tambr.bad_latlong_branch         | *                    | branches                     | *                      | Validation; branches with invalid lat/long                   |
| branch_active                    | branch_used_days_3mo | ccsi.cud_cust_detl_prim_br_mth | DAYS_CUR_MO_WITH_TRANS_CNT | Aggregation; sum over 3 months                              |
| most_used                        | lp_id, br_id         | branch_active                | lp_id, br_id           | Transformation; selects top branch per customer              |
| macommon.&SYSUSERID._mu_br       | lp_id, br_id         | most_used                    | lp_id, br_id           | 1 to 1 mapping; for join with customer info                  |
| customers                        | LP_ID, PRTY_BR, ...  | ccsi.gd_cust_info, ccsi.customer, ccsi.gd_acct_info, macommon.&SYSUSERID._GEOCODE_WEEKLY, macommon.&SYSUSERID._mu_br | various                | Joins; enriches customer with branch and geocode info        |
| rings_cust_data                  | *                    | customers1                   | *                      | Validation; only customers with valid geocode                |
| tambr.bad_latlong_cust           | *                    | customers1                   | *                      | Validation; customers with invalid geocode                   |
| rings_priority_cust              | ...                  | rings_cust_data, rings_branch_data | ...                   | Join; customer to priority branch with geo info              |
| tambr.ring_priority              | prty_br, prtybr80    | rings_priority_cust          | prty_br, dist_to_prty_br | Aggregation; 80th percentile distance per branch             |
| rings_most_used_cust             | ...                  | rings_cust_data, rings_branch_data | ...                   | Join; customer to most used branch with geo info             |
| tambr.ring_most_used             | most_used_br, usedbr80 | rings_most_used_cust        | most_used_br, dist_to_used_br | Aggregation; 80th percentile distance per branch             |
| ring_priority2                   | TAMBR, priority_ring | tambr.ring_priority          | prty_br, prtybr80      | 1 to 1 mapping; for merge                                    |
| ring_most_used2                  | TAMBR, most_used_ring| tambr.ring_most_used         | most_used_br, usedbr80 | 1 to 1 mapping; for merge                                    |
| branch_data2                     | TAMBR, branch_typ, ... | rings_branch_data           | hgn_br_id, br_typ, ... | 1 to 1 mapping; for merge                                    |
| tambr.tambr_rings_&cust_occr.    | TAMBR, priority_ring, most_used_ring, ... | branch_data2, ring_priority2, ring_most_used2 | ... | Merge; final output, fills missing rings with 0              |

## Complexity Analysis

| Metric                   | Value                                |
|--------------------------|--------------------------------------|
| Number of Lines          | 470                                  |
| Datasets Used            | 24                                   |
| Joins Used               | INNER JOIN, LEFT JOIN, FULL JOIN     |
| TRANSFORM Functions      | 17                                   |
| RECORD Definitions       | 13                                   |
| OUTPUT Statements        | 12                                   |
| Conditional Logic        | 14                                   |
| Indexing and Lookups     | 7                                    |
| Function Calls           | 11 (macros, geodist, etc.)           |
| Performance Controls     | Bulkload options, indexed joins      |
| External Dependencies    | DB2 (CCSI), MACOMMON, ADCOMMON       |
| Overall Complexity Score | 82                                   |

## Key Outputs

- **tambr.tambr_rings_&cust_occr.**: Final table containing branch-level ring metrics (priority and most used rings, branch metadata) for reporting and analytics.
- **tambr.ring_priority / tambr.ring_most_used**: Intermediate tables with 80th percentile distance rings for priority and most used branches.
- **tambr.bad_latlong_branch / tambr.bad_latlong_cust**: Tables capturing records with invalid geolocation for data quality review.
- The outputs enable accurate customer-to-branch assignment, support for marketing campaigns, and operational reporting aligned with business goals.

## API Cost

API cost with the proper calculation in USD: 0.02 $