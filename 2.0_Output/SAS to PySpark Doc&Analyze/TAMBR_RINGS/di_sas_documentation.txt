=============================================
Author:        Ascendion AVA+
Date:   
Description:   Technical documentation for the TAMBR_RINGS SAS code, which calculates and manages customer-to-branch proximity and usage rings for monthly TAMBr reporting.
=============================================

## Overview of Program

The TAMBR_RINGS SAS code is designed to generate "rings"—distance-based and usage-based groupings—between customers and bank branches for the TAMBr (Traditional, In-store, University, Retirement, and Corporate Branches) process. This code supports monthly reporting by identifying each customer's priority and most-used branch, calculating their proximity, and producing summary datasets for downstream analytics and business intelligence. The business problem addressed is the need to accurately track customer-branch relationships, especially for new, moving, or recently reassigned customers, to optimize branch operations, marketing, and resource allocation. The solution ensures that customer assignments reflect the latest data, including geocoding updates, and supports regulatory and business reporting requirements.

## Code Structure and Design

The code is modular, leveraging SAS macros, PROC SQL, and DATA steps to orchestrate data extraction, transformation, and loading (ETL) from multiple source systems. Key modules include:
- Initialization and library setup.
- Extraction and refresh of customer, branch, and geocode data from DB2 and SAS datasets.
- Creation of intermediate tables for geocoding, branch activity, and customer assignments.
- Calculation of "most used" and "priority" branches using recent transaction history.
- Distance calculations using geospatial functions.
- Aggregation of results into final ring tables for reporting.
- Inline macro definitions for table management and date handling.

The flow is highly structured: data is extracted, cleansed, joined, and transformed in a stepwise manner, with temporary tables dropped as needed to manage resources.

### Primary Components:
- **Tables**: CUSTOMER, GD_CUST_INFO, GD_ACCT_INFO, GEO_CUSTOMER_MTH, BRANCH_HRCY, CUD_CUST_DETL_PRIM_BR_MTH, MACOMMON.&SYSUSERID._GEOCODE_WEEKLY, MACOMMON.&SYSUSERID._MU_BR, TAMBR.RING_PRIORITY, TAMBR.RING_MOST_USED, TAMBR.TAMBR_RINGS_&CUST_OCCR.
- **Views/Stored Procedures**: None explicitly, but macros act as reusable procedures.
- **Joins**: Multiple INNER, LEFT, and FULL JOINs for customer, branch, and geocode data.
- **Aggregations**: SUM, GROUP BY, and percentile calculations.
- **Subqueries**: Used in SQL for data extraction and aggregation.

## Data Flow and Processing Logic

### Processed Datasets:
- tambr.cust_state_match
- macommon.dbm_cust_state
- work.geo_customer_mth
- macommon.&SYSUSERID._geocode_weekly
- branches / rings_branch_data / tambr.bad_latlong_branch
- branch_active / most_used / macommon.&SYSUSERID._mu_br
- customers / customers1 / rings_cust_data / tambr.bad_latlong_cust
- rings_priority_cust / tambr.ring_priority
- rings_most_used_cust / tambr.ring_most_used
- ring_priority2 / ring_most_used2 / branch_data2
- tambr.tambr_rings_&cust_occr.

### Data Flow:
The process begins with extracting and refreshing customer and branch data, including geocodes, from DB2 and SAS sources. New and moving customers are identified and their geocodes updated. Branch data is filtered for open, valid branches. Customer activity is analyzed over the last three months to determine the "most used" branch. Customers are matched to both their priority and most-used branches, and distances are calculated using geospatial functions. The 80th percentile distance is computed for each branch, forming the "ring" boundaries. Final datasets merge these rings with branch metadata, producing comprehensive tables for reporting and analytics. Temporary and intermediate tables are dropped to optimize resource usage.

#### Logical Processing Components:
- **Geocode Refresh**: Combines latest geocode data for new/moving customers.
- **Branch Extraction**: Filters for open, valid branches.
- **Most Used Branch Calculation**: Aggregates transaction counts and amounts over three months.
- **Customer Extraction**: Joins customer, account, and geocode data.
- **Distance Calculation**: Uses `geodist` to compute miles between customers and branches.
- **Ring Calculation**: Computes 80th percentile distance for each branch.
- **Final Merge**: Combines priority and most-used rings with branch data for output.

#### Transformations:
- **Filtering**: By branch type, open flag, valid geocodes, account status, etc.
- **Joins**: Customer-to-branch, customer-to-geocode, customer-to-activity.
- **Aggregations**: SUM, COUNT, percentile (80th).
- **Field Calculations**: Distance in miles, flags for movers/new customers, ring boundaries.

## Data Mapping

| Target Table Name            | Target Column Name      | Source Table Name              | Source Column Name      | Remarks                                      |
|-----------------------------|------------------------|-------------------------------|------------------------|----------------------------------------------|
| tambr.tambr_rings_&cust_occr. | TAMBR                  | branch_data2                  | hgn_br_id              | 1 to 1 mapping                              |
| tambr.tambr_rings_&cust_occr. | branch_typ             | branch_data2                  | br_typ                 | 1 to 1 mapping                              |
| tambr.tambr_rings_&cust_occr. | branch_name            | branch_data2                  | brick_and_mortor_nm    | 1 to 1 mapping                              |
| tambr.tambr_rings_&cust_occr. | branch_city            | branch_data2                  | city                   | 1 to 1 mapping                              |
| tambr.tambr_rings_&cust_occr. | branch_state           | branch_data2                  | st                     | 1 to 1 mapping                              |
| tambr.tambr_rings_&cust_occr. | branchlat              | branch_data2                  | branchlat              | 1 to 1 mapping                              |
| tambr.tambr_rings_&cust_occr. | branchlong             | branch_data2                  | branchlong             | 1 to 1 mapping                              |
| tambr.tambr_rings_&cust_occr. | metcomm_cde            | branch_data2                  | metro_community_cde    | 1 to 1 mapping                              |
| tambr.tambr_rings_&cust_occr. | priority_ring          | ring_priority2                | prtybr80               | Transformation: 80th percentile calculation  |
| tambr.tambr_rings_&cust_occr. | most_used_ring         | ring_most_used2               | usedbr80               | Transformation: 80th percentile calculation  |
| tambr.tambr_rings_&cust_occr. | max_dist               | (constant)                    | (set to 40)            | Constant assignment                          |

## Complexity Analysis

| Metric                   | Value                                |
|--------------------------|--------------------------------------|
| Number of Lines          | 420                                  |
| Datasets Used            | 22                                   |
| Joins Used               | INNER, LEFT, FULL                    |
| TRANSFORM Functions      | 7                                    |
| RECORD Definitions       | 12                                   |
| OUTPUT Statements        | 9                                    |
| Conditional Logic        | 10                                   |
| Indexing and Lookups     | None                                 |
| Function Calls           | 8                                    |
| Performance Controls     | Bulkload, table drops, macros        |
| External Dependencies    | DB2 (CCSI), MACOMMON, ADCOMMON       |
| Overall Complexity Score | 82                                   |

## Key Outputs

- **tambr.tambr_rings_&cust_occr.**: Final table containing each branch's priority and most-used customer rings, with branch metadata and calculated maximum distances.
- **tambr.ring_priority / tambr.ring_most_used**: Intermediate tables with 80th percentile distance rings for priority and most-used branches.
- **tambr.bad_latlong_branch / tambr.bad_latlong_cust**: Tables capturing records with invalid geocodes for data quality review.
- **macommon.&SYSUSERID._geocode_weekly / macommon.&SYSUSERID._mu_br**: Refreshed geocode and most-used branch tables for current reporting period.

These outputs support monthly TAMBr reporting, enabling accurate customer-branch assignments for operational, marketing, and compliance purposes.

## API Cost

API cost with the proper calculation in USD: 0.02 $