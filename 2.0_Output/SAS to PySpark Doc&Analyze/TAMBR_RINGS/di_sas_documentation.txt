```
=============================================
Author:        Ascendion AVA+
Date:   
Description:   Technical documentation for TAMBR_RINGS.txt SAS code, which generates branch-customer distance rings for priority and most-used branches in support of TAMBr process reporting and analytics.
=============================================

## Overview of Program

The TAMBR_RINGS.txt SAS code is a monthly batch process designed to generate "rings"—distance bands—around bank branches, identifying the priority and most-used branches for each customer. This is used in the TAMBr process to support branch network optimization, customer segmentation, and targeted marketing. The code integrates customer, account, branch, and geolocation data to calculate the proximity of customers to their assigned and most-used branches, and determines percentile-based distance thresholds for each branch. The business problem addressed is to enable data-driven decisions for branch performance, customer outreach, and resource allocation by quantifying customer-branch relationships spatially and behaviorally.

## Code Structure and Design

The code is modular and sequential, leveraging SAS Data Steps, PROC SQL, and custom macros to orchestrate data extraction, transformation, and output. It begins by setting up libraries and macro variables, then loads and cleanses source datasets from DB2 and SAS libraries. The code creates intermediate tables for geocoded customer locations, branch attributes, and customer-branch usage statistics. Key components include:
- **Macros**: `%masofdt`, `%mdrop_mac` for dynamic date and table management.
- **Tables/Views**: Temporary and permanent SAS datasets for branches, customers, geocodes, and ring calculations.
- **Joins**: SQL joins across customer, account, branch, and geocode tables.
- **Aggregations**: Summing transaction counts and amounts over a rolling 3-month window.
- **Subqueries**: Used in SQL to filter and aggregate data.
The flow is linear but includes conditional logic for data quality (e.g., handling missing geocodes, bad lat/longs) and business rules (e.g., branch types, account age).

## Data Flow and Processing Logic

**Processed Datasets**:
- tambr.cust_state_match
- macommon.dbm_cust_state
- work.geo_customer_mth
- macommon.&SYSUSERID._GEOCODE_WEEKLY
- branches, rings_branch_data, tambr.bad_latlong_branch
- branch_active, most_used, macommon.&SYSUSERID._mu_br
- customers, customers1, rings_cust_data, tambr.bad_latlong_cust
- rings_priority_cust, tambr.ring_priority
- rings_most_used_cust, tambr.ring_most_used
- ring_priority2, ring_most_used2, branch_data2
- tambr.tambr_rings_&cust_occr.

**Data Flow**:
The process starts by extracting and staging customer and branch data, including geocoded locations. It then builds a current snapshot of branch and customer tables, filters for valid geocodes, and calculates the most-used branch for each customer based on transaction activity over the last three months. For each customer, the code computes the distance to their priority and most-used branches using latitude/longitude and the `geodist` function. It then calculates the 80th percentile distance for each branch, forming the "ring" boundaries. These rings are merged with branch metadata to produce the final output table, which is used for reporting and analytics.

## Data Mapping

| Target Table Name         | Target Column Name   | Source Table Name         | Source Column Name      | Remarks                                            |
|--------------------------|--------------------- |--------------------------|------------------------ |----------------------------------------------------|
| tambr.tambr_rings_&cust_occr. | TAMBR                | branch_data2              | hgn_br_id               | 1 to 1 mapping: Branch unique identifier            |
| tambr.tambr_rings_&cust_occr. | branch_typ           | branch_data2              | br_typ                  | 1 to 1 mapping: Branch type code                    |
| tambr.tambr_rings_&cust_occr. | branch_name          | branch_data2              | brick_and_mortor_nm     | 1 to 1 mapping: Branch name                         |
| tambr.tambr_rings_&cust_occr. | branch_city          | branch_data2              | city                    | 1 to 1 mapping: Branch city                         |
| tambr.tambr_rings_&cust_occr. | branch_state         | branch_data2              | st                      | 1 to 1 mapping: Branch state                        |
| tambr.tambr_rings_&cust_occr. | branchlat            | branch_data2              | branchlat               | 1 to 1 mapping: Branch latitude                     |
| tambr.tambr_rings_&cust_occr. | branchlong           | branch_data2              | branchlong              | 1 to 1 mapping: Branch longitude                    |
| tambr.tambr_rings_&cust_occr. | metcomm_cde          | branch_data2              | metro_community_cde     | 1 to 1 mapping: Metro community code                |
| tambr.tambr_rings_&cust_occr. | priority_ring        | ring_priority2            | priority_ring           | 1 to 1 mapping: 80th percentile distance to priority|
| tambr.tambr_rings_&cust_occr. | most_used_ring       | ring_most_used2           | most_used_ring          | 1 to 1 mapping: 80th percentile distance to most-used|
| tambr.tambr_rings_&cust_occr. | max_dist             | (calculated)              | (constant 40)           | Transformation: Set to 40 for all branches          |

## Complexity Analysis

| Metric                   | Value                                |
|--------------------------|--------------------------------------|
| Number of Lines          | 420                                  |
| Datasets Used            | 19                                   |
| Joins Used               | INNER JOIN, LEFT JOIN, FULL JOIN     |
| TRANSFORM Functions      | 8 (geodist, case, sum, percentile)   |
| RECORD Definitions       | 12                                   |
| OUTPUT Statements        | 10                                   |
| Conditional Logic        | 14                                   |
| Indexing and Lookups     | 3                                    |
| Function Calls           | 7 (macros, geodist, put, intnx, etc) |
| Performance Controls     | Bulkload, bl_method, noprint         |
| External Dependencies    | DB2 (CCSI), MACOMMON, ADCOMMON       |
| Overall Complexity Score | 82                                   |

## Key Outputs

- **tambr.tambr_rings_&cust_occr.**: Final table containing each branch with its calculated priority and most-used customer distance rings, branch metadata, and a standardized max_dist value.
- **tambr.ring_priority, tambr.ring_most_used**: Intermediate tables with 80th percentile distance calculations for each branch.
- **tambr.bad_latlong_branch, tambr.bad_latlong_cust**: Tables capturing records with invalid geocodes for data quality review.
- **Reporting Tables**: Frequency tables for branch types and metro codes, supporting monthly analytics.

These outputs enable the business to analyze customer proximity to branches, optimize branch network strategies, and support targeted outreach based on customer behavior and geography.

## API Cost

API cost: 0.01 $
```