=============================================
Author:        AAVA
Created on:   
Description:   Sales fact table loading procedure with data quality validation and audit logging
=============================================

-- BigQuery SQL Script: Sales Fact Table Loading with Data Quality Validation and Audit Logging

-- This script implements the ETL workflow for loading sales transactions from staging to the fact table,
-- including data quality checks, dimensional enrichment, audit logging, and error handling.

-- Assumptions:
--   - Source tables: `stg_Sales_Transactions`, `dw_Dim_Customer`, `dw_Dim_Date`
--   - Target tables: `dw_Fact_Sales`, `dw_Audit_Log`, `dw_DQ_Failures`
--   - All table and column names are generic (remove dataset/project prefixes as needed)
--   - All timestamps use CURRENT_DATETIME()
--   - UUIDs generated with GENERATE_UUID()
--   - Procedure name is hardcoded as 'sp_load_sales_fact'
--   - Uses BigQuery scripting and exception handling

CREATE OR REPLACE PROCEDURE sp_load_sales_fact()
BEGIN
  -- Variable Declarations
  DECLARE batch_id STRING DEFAULT GENERATE_UUID();
  DECLARE start_time DATETIME DEFAULT CURRENT_DATETIME();
  DECLARE end_time DATETIME;
  DECLARE rows_inserted INT64 DEFAULT 0;
  DECLARE rows_rejected INT64 DEFAULT 0;
  DECLARE error_message STRING;
  DECLARE proc_name STRING DEFAULT 'sp_load_sales_fact';

  -- 1. Start Audit Logging
  INSERT INTO dw_Audit_Log (
    Batch_ID,
    Procedure_Name,
    Start_Time,
    Status,
    Message
  )
  VALUES (
    batch_id,
    proc_name,
    start_time,
    'STARTED',
    'Sales Fact Load Initiated'
  );

  -- Use a BEGIN ... EXCEPTION block for error handling
  BEGIN
    -- 2. Data Quality Validation: Identify Invalid Rows
    WITH InvalidRows AS (
      SELECT Transaction_ID, 'Missing CustomerID' AS Reason
      FROM stg_Sales_Transactions
      WHERE Customer_ID IS NULL

      UNION ALL

      SELECT Transaction_ID, 'Invalid Quantity' AS Reason
      FROM stg_Sales_Transactions
      WHERE Quantity <= 0
    ),

    -- 3. Remove Invalid Rows from Staging (and count them)
    DeletedRows AS (
      SELECT Transaction_ID
      FROM InvalidRows
    ),

    -- 4. Prepare Clean Data for Fact Table Load
    transformed AS (
      SELECT
        s.Transaction_ID,
        s.Customer_ID,
        s.Product_ID,
        s.Sales_Date,
        s.Quantity,
        s.Unit_Price,
        s.Quantity * s.Unit_Price AS Total_Sales_Amount,
        d.Region_ID,
        c.Customer_Segment,
        CURRENT_DATETIME() AS Load_Timestamp,
        batch_id AS Batch_ID
      FROM stg_Sales_Transactions s
      INNER JOIN dw_Dim_Customer c
        ON s.Customer_ID = c.Customer_ID
      INNER JOIN dw_Dim_Date d
        ON DATE(s.Sales_Date) = d.Date_Value
      WHERE s.Transaction_ID NOT IN (SELECT Transaction_ID FROM DeletedRows)
    )

    -- 5. Insert Cleaned Data into Fact Table
    INSERT INTO dw_Fact_Sales (
      Transaction_ID,
      Customer_ID,
      Product_ID,
      Sales_Date,
      Quantity,
      Unit_Price,
      Total_Sales_Amount,
      Region_ID,
      Customer_Segment,
      Load_Timestamp,
      Batch_ID
    )
    SELECT *
    FROM transformed;

    -- 6. Count Inserted Rows
    SET rows_inserted = (SELECT COUNT(*) FROM transformed);

    -- 7. Archive or Truncate Staging Table
    DELETE FROM stg_Sales_Transactions WHERE TRUE;

    -- 8. Log Validation Failures
    INSERT INTO dw_DQ_Failures (
      Transaction_ID,
      Failure_Reason,
      Logged_Timestamp,
      Batch_ID
    )
    SELECT
      Transaction_ID,
      Reason,
      CURRENT_DATETIME(),
      batch_id
    FROM InvalidRows;

    -- 9. Count Rejected Rows
    SET rows_rejected = (SELECT COUNT(*) FROM InvalidRows);

    -- 10. End Audit Log
    SET end_time = CURRENT_DATETIME();

    UPDATE dw_Audit_Log
    SET
      End_Time = end_time,
      Rows_Inserted = rows_inserted,
      Rows_Rejected = rows_rejected,
      Status = 'COMPLETED',
      Message = CONCAT('Inserted ', CAST(rows_inserted AS STRING), ' rows; Rejected ', CAST(rows_rejected AS STRING), ' rows.')
    WHERE Batch_ID = batch_id;

  EXCEPTION WHEN ERROR THEN
    -- 11. Error Handling
    SET end_time = CURRENT_DATETIME();
    SET error_message = ERROR_MESSAGE();

    UPDATE dw_Audit_Log
    SET
      End_Time = end_time,
      Status = 'FAILED',
      Message = error_message
    WHERE Batch_ID = batch_id;

    -- Optionally re-raise error for pipeline monitoring
    RAISE USING MESSAGE = error_message;
  END;
END;

-- Notes:
-- - All table and column names are generic and should be adapted to your environment.
-- - For large staging tables, consider partitioning and clustering for performance.
-- - The script assumes all referenced tables exist and have compatible schemas.
-- - For production, consider adding more granular error handling and logging as needed.

API Cost Consumed in dollars: 0.0040 USD