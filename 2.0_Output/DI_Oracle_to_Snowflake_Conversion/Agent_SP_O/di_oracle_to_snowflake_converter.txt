=============================================
Author:        Ascendion AVA+
Date:  
Description:   Snowflake stored procedure to load agent data from staging to gold table with upsert logic and audit logging.
=============================================

-- Converted from Oracle PL/SQL to Snowflake JavaScript Stored Procedure

CREATE OR REPLACE PROCEDURE LOAD_GOLD_AGENTS()
RETURNS STRING
LANGUAGE JAVASCRIPT
AS
$$
    try {
        // Record start time
        var v_start_time = new Date();
        var v_status = '';
        var v_message = '';

        // Upsert logic using Snowflake MERGE
        var merge_sql = `
            MERGE INTO GOLD_AGENTS_D AS tgt
            USING (
                SELECT 
                    AGENT_ID,
                    AGENT_NAME,
                    SOURCE_SYSTEM
                FROM STAGE_AGENTS
            ) AS src
            ON tgt.AGENT_ID = src.AGENT_ID

            WHEN MATCHED THEN
                UPDATE SET
                    AGENT_NAME = src.AGENT_NAME,
                    UPDATE_DATE = CURRENT_TIMESTAMP(),
                    SOURCE_SYSTEM = src.SOURCE_SYSTEM

            WHEN NOT MATCHED THEN
                INSERT (
                    AGENT_ID,
                    AGENT_NAME,
                    LOAD_DATE,
                    UPDATE_DATE,
                    SOURCE_SYSTEM
                ) VALUES (
                    src.AGENT_ID,
                    src.AGENT_NAME,
                    CURRENT_TIMESTAMP(),
                    CURRENT_TIMESTAMP(),
                    src.SOURCE_SYSTEM
                );
        `;

        snowflake.execute({sqlText: merge_sql});

        // Log success
        v_status = 'SUCCESS';
        v_message = 'Agents data loaded successfully.';

        var audit_sql = `
            INSERT INTO AUDIT_LOG (MODULE_NAME, RUN_TIME, STATUS, MESSAGE)
            VALUES ('LOAD_GOLD_AGENTS', ?, ?, ?)
        `;

        snowflake.execute({
            sqlText: audit_sql,
            binds: [ 'LOAD_GOLD_AGENTS', v_start_time, v_status, v_message ]
        });

        return v_message;

    } catch (err) {
        var v_status = 'FAILED';
        var v_message = 'Error: ' + err.message;

        // Attempt to log the error
        try {
            var audit_sql = `
                INSERT INTO AUDIT_LOG (MODULE_NAME, RUN_TIME, STATUS, MESSAGE)
                VALUES ('LOAD_GOLD_AGENTS', ?, ?, ?)
            `;
            snowflake.execute({
                sqlText: audit_sql,
                binds: [ 'LOAD_GOLD_AGENTS', v_start_time, v_status, v_message ]
            });
        } catch (audit_err) {
            // Suppress audit failure
        }

        throw err;
    }
$$;

-- Overview of Conversion:
-- 1. Oracle PL/SQL procedure converted to Snowflake JavaScript stored procedure.
-- 2. Oracle variables and timestamps adapted to JavaScript and Snowflake functions (CURRENT_TIMESTAMP()).
-- 3. Oracle MERGE logic translated to Snowflake MERGE syntax.
-- 4. Audit logging implemented using INSERT statements with binds.
-- 5. Exception handling adapted to JavaScript try/catch blocks.
-- 6. Metadata header added as per requirements.

-- API Cost Consumed: 1 file read, 0 directory reads, 0 coworker calls.