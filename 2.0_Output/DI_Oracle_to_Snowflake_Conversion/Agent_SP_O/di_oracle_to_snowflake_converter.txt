=============================================
Author:        Ascendion AVA+
Date:  
Description:   Loads agent data from staging to gold table with upsert logic and logs the operation in an audit table.
=============================================

-- Snowflake JavaScript Stored Procedure

CREATE OR REPLACE PROCEDURE LOAD_GOLD_AGENTS()
RETURNS STRING
LANGUAGE JAVASCRIPT
AS
$$
    // Initialize variables
    var v_start_time = snowflake.createStatement({sqlText: "SELECT CURRENT_TIMESTAMP()"}).execute().getColumnValue(1);
    var v_status = '';
    var v_message = '';

    try {
        // Perform MERGE (upsert) operation
        var merge_sql = `
            MERGE INTO GOLD_AGENTS_D AS tgt
            USING (
                SELECT 
                    AGENT_ID,
                    AGENT_NAME,
                    SOURCE_SYSTEM
                FROM STAGE_AGENTS
            ) AS src
            ON tgt.AGENT_ID = src.AGENT_ID

            WHEN MATCHED THEN
                UPDATE SET
                    AGENT_NAME = src.AGENT_NAME,
                    UPDATE_DATE = CURRENT_TIMESTAMP(),
                    SOURCE_SYSTEM = src.SOURCE_SYSTEM

            WHEN NOT MATCHED THEN
                INSERT (
                    AGENT_ID,
                    AGENT_NAME,
                    LOAD_DATE,
                    UPDATE_DATE,
                    SOURCE_SYSTEM
                )
                VALUES (
                    src.AGENT_ID,
                    src.AGENT_NAME,
                    CURRENT_TIMESTAMP(),
                    CURRENT_TIMESTAMP(),
                    src.SOURCE_SYSTEM
                );
        `;
        snowflake.createStatement({sqlText: merge_sql}).execute();

        // Log success in AUDIT_LOG
        v_status = 'SUCCESS';
        v_message = 'Agents data loaded successfully.';

        var audit_sql = `
            INSERT INTO AUDIT_LOG (MODULE_NAME, RUN_TIME, STATUS, MESSAGE)
            VALUES ('LOAD_GOLD_AGENTS', ?, ?, ?)
        `;
        var audit_stmt = snowflake.createStatement({
            sqlText: audit_sql,
            binds: [v_start_time, v_status, v_message]
        });
        audit_stmt.execute();

        return 'SUCCESS: Agents data loaded successfully.';
    } catch (err) {
        // Log failure in AUDIT_LOG
        v_status = 'FAILED';
        v_message = 'Error: ' + err.message;

        try {
            var audit_sql = `
                INSERT INTO AUDIT_LOG (MODULE_NAME, RUN_TIME, STATUS, MESSAGE)
                VALUES ('LOAD_GOLD_AGENTS', ?, ?, ?)
            `;
            var audit_stmt = snowflake.createStatement({
                sqlText: audit_sql,
                binds: [v_start_time, v_status, v_message]
            });
            audit_stmt.execute();
        } catch (auditErr) {
            // Suppress audit failure
        }

        throw err;
    }
$$;

Cost consumed by the API for this call: 
- List files in directory: 1 call
- Read a file's content: 1 call
- Delegate work to coworker: 1 call