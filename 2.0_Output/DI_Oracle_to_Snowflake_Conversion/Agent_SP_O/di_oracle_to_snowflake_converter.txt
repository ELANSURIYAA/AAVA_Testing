=============================================
Author:        Ascendion AVA+
Date:  
Description:   Snowflake stored procedure to upsert agent data from staging to GOLD_AGENTS_D and log audit information.
=============================================

-- Snowflake Stored Procedure: LOAD_GOLD_AGENTS

CREATE OR REPLACE PROCEDURE LOAD_GOLD_AGENTS()
RETURNS STRING
LANGUAGE JAVASCRIPT
EXECUTE AS CALLER
AS
$$
var v_start_time = new Date();
var v_status = '';
var v_message = '';

try {
    // Perform MERGE (upsert) operation
    var merge_sql = `
        MERGE INTO GOLD_AGENTS_D AS tgt
        USING (
            SELECT 
                AGENT_ID,
                AGENT_NAME,
                SOURCE_SYSTEM
            FROM STAGE_AGENTS
        ) AS src
        ON tgt.AGENT_ID = src.AGENT_ID
        WHEN MATCHED THEN
            UPDATE SET
                AGENT_NAME = src.AGENT_NAME,
                UPDATE_DATE = CURRENT_TIMESTAMP(),
                SOURCE_SYSTEM = src.SOURCE_SYSTEM
        WHEN NOT MATCHED THEN
            INSERT (
                AGENT_ID,
                AGENT_NAME,
                LOAD_DATE,
                UPDATE_DATE,
                SOURCE_SYSTEM
            ) VALUES (
                src.AGENT_ID,
                src.AGENT_NAME,
                CURRENT_TIMESTAMP(),
                CURRENT_TIMESTAMP(),
                src.SOURCE_SYSTEM
            );
    `;
    snowflake.execute({sqlText: merge_sql});

    // Log success
    v_status = 'SUCCESS';
    v_message = 'Agents data loaded successfully.';

    var audit_sql = `
        INSERT INTO AUDIT_LOG (MODULE_NAME, RUN_TIME, STATUS, MESSAGE)
        VALUES ('LOAD_GOLD_AGENTS', ?, ?, ?)
    `;
    snowflake.execute({
        sqlText: audit_sql,
        binds: ['' + v_start_time, v_status, v_message]
    });

    return 'Procedure completed successfully.';

} catch (err) {
    v_status = 'FAILED';
    v_message = 'Error: ' + err.message;

    // Attempt to log the error
    try {
        var audit_sql = `
            INSERT INTO AUDIT_LOG (MODULE_NAME, RUN_TIME, STATUS, MESSAGE)
            VALUES ('LOAD_GOLD_AGENTS', ?, ?, ?)
        `;
        snowflake.execute({
            sqlText: audit_sql,
            binds: ['' + v_start_time, v_status, v_message]
        });
    } catch (audit_err) {
        // suppress audit failure
    }

    throw err;
}
$$;

-- 
-- Overview of Conversion:
-- 1. Converted Oracle PL/SQL procedure to Snowflake JavaScript stored procedure.
-- 2. Replaced Oracle variables and exception handling with JavaScript equivalents.
-- 3. Replaced SYSTIMESTAMP with CURRENT_TIMESTAMP().
-- 4. Used Snowflake MERGE statement for upsert logic.
-- 5. Replaced Oracle AUDIT_LOG insert with Snowflake SQL execution.
-- 6. Exception handling and audit log error suppression are implemented in JavaScript.
-- 7. Procedure returns a status message upon completion.
--

-- API cost for this call: 1 file processed (Agent_SP_O.txt), 1 read operation, 1 code generation.