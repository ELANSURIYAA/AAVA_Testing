=============================================
Author:        Ascendion AVA+
Date:  
Description:   Snowflake stored procedure to upsert agent data from STAGE_AGENTS to GOLD_AGENTS_D and log the process in AUDIT_LOG.
=============================================

-- Converted from Oracle PL/SQL to Snowflake JavaScript stored procedure
CREATE OR REPLACE PROCEDURE LOAD_GOLD_AGENTS()
RETURNS STRING
LANGUAGE JAVASCRIPT
AS
$$
try {
    // Capture start time
    var v_start_time = new Date();
    var v_status = 'SUCCESS';
    var v_message = 'Agents data loaded successfully.';

    // Upsert agent data using MERGE statement
    var merge_sql = `
        MERGE INTO GOLD_AGENTS_D AS tgt
        USING (
            SELECT 
                AGENT_ID,
                AGENT_NAME,
                SOURCE_SYSTEM
            FROM STAGE_AGENTS
        ) AS src
        ON tgt.AGENT_ID = src.AGENT_ID
        WHEN MATCHED THEN
            UPDATE SET
                AGENT_NAME = src.AGENT_NAME,
                UPDATE_DATE = CURRENT_TIMESTAMP(),
                SOURCE_SYSTEM = src.SOURCE_SYSTEM
        WHEN NOT MATCHED THEN
            INSERT (
                AGENT_ID,
                AGENT_NAME,
                LOAD_DATE,
                UPDATE_DATE,
                SOURCE_SYSTEM
            ) VALUES (
                src.AGENT_ID,
                src.AGENT_NAME,
                CURRENT_TIMESTAMP(),
                CURRENT_TIMESTAMP(),
                src.SOURCE_SYSTEM
            );
    `;
    snowflake.execute({sqlText: merge_sql});

    // Insert audit log for success
    var audit_sql = `
        INSERT INTO AUDIT_LOG (MODULE_NAME, RUN_TIME, STATUS, MESSAGE)
        VALUES ('LOAD_GOLD_AGENTS', ?, ?, ?)
    `;
    snowflake.execute({
        sqlText: audit_sql,
        binds: [v_start_time, v_status, v_message]
    });

    return 'SUCCESS: Agents data loaded successfully.';
} catch (err) {
    var v_status = 'FAILED';
    var v_message = 'Error: ' + err.message;

    // Attempt to log the error
    try {
        var audit_sql = `
            INSERT INTO AUDIT_LOG (MODULE_NAME, RUN_TIME, STATUS, MESSAGE)
            VALUES ('LOAD_GOLD_AGENTS', ?, ?, ?)
        `;
        snowflake.execute({
            sqlText: audit_sql,
            binds: [new Date(), v_status, v_message]
        });
    } catch (auditErr) {
        // Suppress audit failure
    }

    throw err;
}
$$;

-- Overview of Conversion:
-- 1. Oracle PL/SQL procedure converted to Snowflake JavaScript stored procedure.
-- 2. Oracle variables (TIMESTAMP, VARCHAR2) mapped to JavaScript variables.
-- 3. SYSTIMESTAMP replaced with CURRENT_TIMESTAMP() in SQL, and JavaScript Date object for logging.
-- 4. Oracle MERGE statement syntax adapted to Snowflake ANSI SQL.
-- 5. COMMIT is not required in Snowflake; each statement is auto-committed.
-- 6. Exception handling moved to JavaScript try/catch blocks.
-- 7. AUDIT_LOG inserts use parameter binding for safety and clarity.
-- 8. All Oracle-specific constructs replaced with Snowflake equivalents.

-- API Cost Consumed: 1 directory listing + 1 file read = 2 API calls.