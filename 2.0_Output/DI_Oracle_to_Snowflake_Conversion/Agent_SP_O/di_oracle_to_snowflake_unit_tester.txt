=============================================
Author:        Ascendion AVA+
Date:  
Description:   Pytest script for unit testing the Snowflake stored procedure LOAD_GOLD_AGENTS, which upserts agent data from STAGE_AGENTS to GOLD_AGENTS_D and logs the process in AUDIT_LOG.
============================================

Test Case List:
---------------
| Test Case ID | Description                                                                                  | Expected Outcome                                                                                  |
|--------------|---------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| TC01         | Happy path: STAGE_AGENTS contains new agents not in GOLD_AGENTS_D                            | New agents inserted into GOLD_AGENTS_D; AUDIT_LOG records success                                 |
| TC02         | Happy path: STAGE_AGENTS contains agents already in GOLD_AGENTS_D                            | Existing agents updated in GOLD_AGENTS_D; AUDIT_LOG records success                               |
| TC03         | Edge case: STAGE_AGENTS contains NULL values in AGENT_NAME or SOURCE_SYSTEM                  | NULL values handled gracefully; GOLD_AGENTS_D reflects NULLs; AUDIT_LOG records success           |
| TC04         | Edge case: STAGE_AGENTS is empty                                                             | No changes to GOLD_AGENTS_D; AUDIT_LOG records success                                            |
| TC05         | Edge case: GOLD_AGENTS_D is empty, STAGE_AGENTS has data                                     | All STAGE_AGENTS inserted into GOLD_AGENTS_D; AUDIT_LOG records success                           |
| TC06         | Error handling: STAGE_AGENTS contains invalid data types (e.g., string in AGENT_ID)          | Procedure fails; AUDIT_LOG records failure                                                        |
| TC07         | Error handling: STAGE_AGENTS table missing                                                   | Procedure fails; AUDIT_LOG records failure                                                        |
| TC08         | Boundary: AGENT_ID at max/min allowed value                                                  | GOLD_AGENTS_D updated/inserted correctly; AUDIT_LOG records success                               |
| TC09         | Edge case: Duplicate AGENT_IDs in STAGE_AGENTS                                               | Procedure fails or handles duplicates per Snowflake behavior; AUDIT_LOG records outcome           |
| TC10         | Edge case: Long AGENT_NAME/SOURCE_SYSTEM strings (boundary length)                           | GOLD_AGENTS_D updated/inserted correctly; AUDIT_LOG records success                               |

Pytest Script:
--------------
```python
=============================================
Author:        Ascendion AVA+
Date:  
Description:   Pytest script for unit testing the Snowflake stored procedure LOAD_GOLD_AGENTS, which upserts agent data from STAGE_AGENTS to GOLD_AGENTS_D and logs the process in AUDIT_LOG.
=============================================

import pytest
import snowflake.connector
from datetime import datetime

# Helper functions
def setup_stage_agents(cur, rows):
    cur.execute("DELETE FROM STAGE_AGENTS")
    for row in rows:
        cur.execute(
            "INSERT INTO STAGE_AGENTS (AGENT_ID, AGENT_NAME, SOURCE_SYSTEM) VALUES (%s, %s, %s)",
            row,
        )

def setup_gold_agents(cur, rows):
    cur.execute("DELETE FROM GOLD_AGENTS_D")
    for row in rows:
        cur.execute(
            "INSERT INTO GOLD_AGENTS_D (AGENT_ID, AGENT_NAME, LOAD_DATE, UPDATE_DATE, SOURCE_SYSTEM) VALUES (%s, %s, %s, %s, %s)",
            row,
        )

def clear_audit_log(cur):
    cur.execute("DELETE FROM AUDIT_LOG")

def call_proc(cur):
    cur.execute("CALL LOAD_GOLD_AGENTS()")

def fetch_gold_agents(cur):
    cur.execute("SELECT AGENT_ID, AGENT_NAME, SOURCE_SYSTEM FROM GOLD_AGENTS_D ORDER BY AGENT_ID")
    return cur.fetchall()

def fetch_audit_log(cur):
    cur.execute("SELECT STATUS, MESSAGE FROM AUDIT_LOG WHERE MODULE_NAME='LOAD_GOLD_AGENTS' ORDER BY RUN_TIME DESC")
    return cur.fetchall()

@pytest.fixture(scope="function")
def snowflake_conn():
    # Replace with your Snowflake connection parameters
    conn = snowflake.connector.connect(
        user='YOUR_USER',
        password='YOUR_PASSWORD',
        account='YOUR_ACCOUNT',
        warehouse='YOUR_WAREHOUSE',
        database='YOUR_DATABASE',
        schema='YOUR_SCHEMA'
    )
    cur = conn.cursor()
    yield cur
    cur.close()
    conn.close()

@pytest.mark.parametrize("stage_rows,gold_rows,expected_gold,expected_status", [
    # TC01: Happy path - new agents
    (
        [(1, 'Alice', 'CRM'), (2, 'Bob', 'CRM')],
        [],
        [(1, 'Alice', 'CRM'), (2, 'Bob', 'CRM')],
        'SUCCESS'
    ),
    # TC02: Happy path - update existing agents
    (
        [(1, 'Alice Updated', 'CRM')],
        [(1, 'Alice', datetime.now(), datetime.now(), 'CRM')],
        [(1, 'Alice Updated', 'CRM')],
        'SUCCESS'
    ),
    # TC03: Edge - NULL values
    (
        [(3, None, None)],
        [],
        [(3, None, None)],
        'SUCCESS'
    ),
    # TC04: Edge - STAGE_AGENTS empty
    (
        [],
        [(4, 'Charlie', datetime.now(), datetime.now(), 'CRM')],
        [(4, 'Charlie', 'CRM')],
        'SUCCESS'
    ),
    # TC05: Edge - GOLD_AGENTS_D empty, STAGE_AGENTS has data
    (
        [(5, 'Dana', 'CRM')],
        [],
        [(5, 'Dana', 'CRM')],
        'SUCCESS'
    ),
    # TC08: Boundary - AGENT_ID at max/min
    (
        [(0, 'MinID', 'CRM'), (2147483647, 'MaxID', 'CRM')],
        [],
        [(0, 'MinID', 'CRM'), (2147483647, 'MaxID', 'CRM')],
        'SUCCESS'
    ),
    # TC10: Edge - Long strings
    (
        [(6, 'A'*255, 'B'*255)],
        [],
        [(6, 'A'*255, 'B'*255)],
        'SUCCESS'
    ),
])
def test_load_gold_agents_happy_and_edge(stage_rows, gold_rows, expected_gold, expected_status, snowflake_conn):
    cur = snowflake_conn
    setup_stage_agents(cur, stage_rows)
    setup_gold_agents(cur, gold_rows)
    clear_audit_log(cur)
    call_proc(cur)
    gold_agents = fetch_gold_agents(cur)
    # Compare only AGENT_ID, AGENT_NAME, SOURCE_SYSTEM for simplicity
    gold_agents_simple = [(row[0], row[1], row[2]) for row in gold_agents]
    assert sorted(gold_agents_simple) == sorted(expected_gold)
    audit_log = fetch_audit_log(cur)
    assert audit_log[0][0] == expected_status

def test_load_gold_agents_error_invalid_data(snowflake_conn):
    cur = snowflake_conn
    setup_stage_agents(cur, [('invalid_id', 'Eve', 'CRM')])  # AGENT_ID should be int
    setup_gold_agents(cur, [])
    clear_audit_log(cur)
    with pytest.raises(Exception):
        call_proc(cur)
    audit_log = fetch_audit_log(cur)
    assert audit_log[0][0] == 'FAILED'
    assert 'Error:' in audit_log[0][1]

def test_load_gold_agents_error_missing_stage_table(snowflake_conn):
    cur = snowflake_conn
    # Drop STAGE_AGENTS table to simulate missing table
    cur.execute("DROP TABLE IF EXISTS STAGE_AGENTS")
    setup_gold_agents(cur, [])
    clear_audit_log(cur)
    with pytest.raises(Exception):
        call_proc(cur)
    audit_log = fetch_audit_log(cur)
    assert audit_log[0][0] == 'FAILED'
    assert 'Error:' in audit_log[0][1]
    # Recreate table for further tests
    cur.execute("""
        CREATE TABLE STAGE_AGENTS (
            AGENT_ID INT,
            AGENT_NAME VARCHAR(255),
            SOURCE_SYSTEM VARCHAR(255)
        )
    """)

def test_load_gold_agents_duplicate_agent_ids(snowflake_conn):
    cur = snowflake_conn
    setup_stage_agents(cur, [(7, 'Frank', 'CRM'), (7, 'Frank Duplicate', 'CRM')])
    setup_gold_agents(cur, [])
    clear_audit_log(cur)
    with pytest.raises(Exception):
        call_proc(cur)
    audit_log = fetch_audit_log(cur)
    assert audit_log[0][0] == 'FAILED'

# API Cost Consumed: 1 directory listing + 1 file read = 2 API calls.
```

Cost Consumed:
--------------
API Cost Consumed: 1 directory listing + 1 file read = 2 API calls.