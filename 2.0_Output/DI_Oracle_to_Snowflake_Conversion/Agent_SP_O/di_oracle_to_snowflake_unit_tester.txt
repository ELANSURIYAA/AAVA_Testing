=============================================
Author:        Ascendion AVA+
Date:  
Description:   Pytest script and comprehensive unit test cases for Snowflake stored procedure to load agent data from staging to gold table with upsert logic and audit logging.
============================================

**Test Case List**

| Test Case ID | Description                                                                                   | Expected Outcome                                                                                  |
|--------------|----------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| TC01         | Happy path: All agents in STAGE_AGENTS are new, GOLD_AGENTS_D is empty                        | All agents inserted into GOLD_AGENTS_D; AUDIT_LOG records SUCCESS; procedure returns success msg  |
| TC02         | Happy path: Some agents in STAGE_AGENTS already exist in GOLD_AGENTS_D                        | Existing agents updated, new agents inserted; AUDIT_LOG records SUCCESS; procedure returns msg    |
| TC03         | Edge: STAGE_AGENTS contains NULL values for AGENT_NAME or SOURCE_SYSTEM                       | NULL values handled as per Snowflake rules; upsert occurs; AUDIT_LOG records SUCCESS              |
| TC04         | Edge: STAGE_AGENTS is empty                                                                   | No changes to GOLD_AGENTS_D; AUDIT_LOG records SUCCESS; procedure returns success msg             |
| TC05         | Edge: GOLD_AGENTS_D contains agents not in STAGE_AGENTS                                       | Unmatched agents remain unchanged; AUDIT_LOG records SUCCESS                                      |
| TC06         | Error: STAGE_AGENTS contains invalid data types (e.g., non-numeric AGENT_ID)                  | Procedure fails; AUDIT_LOG records FAILED with error message                                      |
| TC07         | Error: AUDIT_LOG table is missing or inaccessible                                             | Procedure completes upsert, fails to log audit; error suppressed; procedure returns success/error |
| TC08         | Edge: Boundary values for AGENT_ID (e.g., max int, min int)                                   | Upsert logic handles boundary AGENT_IDs; AUDIT_LOG records SUCCESS                                |
| TC09         | Edge: Duplicate AGENT_IDs in STAGE_AGENTS                                                     | Procedure fails or handles as per Snowflake rules; AUDIT_LOG records FAILED/SUCCESS               |
| TC10         | Error: GOLD_AGENTS_D table is missing or inaccessible                                         | Procedure fails; AUDIT_LOG records FAILED with error message                                      |

---

**Pytest Script**

```python
=============================================
Author:        Ascendion AVA+
Date:  
Description:   Pytest script for unit testing Snowflake stored procedure LOAD_GOLD_AGENTS with upsert and audit logging.
=============================================

import pytest
import snowflake.connector
from datetime import datetime

# Helper function to execute procedure and fetch audit log
def execute_procedure_and_fetch_audit(conn):
    cs = conn.cursor()
    try:
        cs.execute("CALL LOAD_GOLD_AGENTS()")
        cs.execute("SELECT STATUS, MESSAGE FROM AUDIT_LOG WHERE MODULE_NAME = 'LOAD_GOLD_AGENTS' ORDER BY RUN_TIME DESC LIMIT 1")
        return cs.fetchone()
    finally:
        cs.close()

@pytest.fixture(scope="function")
def snowflake_conn():
    # Setup Snowflake connection (replace with valid credentials/environment variables)
    conn = snowflake.connector.connect(
        user='YOUR_USER',
        password='YOUR_PASSWORD',
        account='YOUR_ACCOUNT',
        warehouse='YOUR_WAREHOUSE',
        database='YOUR_DATABASE',
        schema='YOUR_SCHEMA'
    )
    yield conn
    conn.close()

@pytest.fixture(autouse=True)
def setup_and_teardown_tables(snowflake_conn):
    cs = snowflake_conn.cursor()
    try:
        # Setup: Clean and recreate tables
        cs.execute("DROP TABLE IF EXISTS STAGE_AGENTS")
        cs.execute("DROP TABLE IF EXISTS GOLD_AGENTS_D")
        cs.execute("DROP TABLE IF EXISTS AUDIT_LOG")
        cs.execute("""
            CREATE TABLE STAGE_AGENTS (
                AGENT_ID INT,
                AGENT_NAME VARCHAR,
                SOURCE_SYSTEM VARCHAR
            )
        """)
        cs.execute("""
            CREATE TABLE GOLD_AGENTS_D (
                AGENT_ID INT PRIMARY KEY,
                AGENT_NAME VARCHAR,
                LOAD_DATE TIMESTAMP,
                UPDATE_DATE TIMESTAMP,
                SOURCE_SYSTEM VARCHAR
            )
        """)
        cs.execute("""
            CREATE TABLE AUDIT_LOG (
                MODULE_NAME VARCHAR,
                RUN_TIME TIMESTAMP,
                STATUS VARCHAR,
                MESSAGE VARCHAR
            )
        """)
        yield
    finally:
        # Teardown: Drop tables
        cs.execute("DROP TABLE IF EXISTS STAGE_AGENTS")
        cs.execute("DROP TABLE IF EXISTS GOLD_AGENTS_D")
        cs.execute("DROP TABLE IF EXISTS AUDIT_LOG")
        cs.close()

def test_TC01_happy_path_insert(snowflake_conn):
    cs = snowflake_conn.cursor()
    try:
        # GOLD_AGENTS_D empty, STAGE_AGENTS has new agents
        cs.execute("INSERT INTO STAGE_AGENTS VALUES (1, 'Alice', 'CRM'), (2, 'Bob', 'CRM')")
        status, message = execute_procedure_and_fetch_audit(snowflake_conn)
        cs.execute("SELECT COUNT(*) FROM GOLD_AGENTS_D")
        count = cs.fetchone()[0]
        assert count == 2
        assert status == 'SUCCESS'
        assert 'Agents data loaded successfully' in message
    finally:
        cs.close()

def test_TC02_happy_path_upsert(snowflake_conn):
    cs = snowflake_conn.cursor()
    try:
        # GOLD_AGENTS_D has agent 1, STAGE_AGENTS has agent 1 (update) and agent 2 (insert)
        cs.execute("INSERT INTO GOLD_AGENTS_D VALUES (1, 'OldAlice', CURRENT_TIMESTAMP(), CURRENT_TIMESTAMP(), 'CRM')")
        cs.execute("INSERT INTO STAGE_AGENTS VALUES (1, 'Alice', 'CRM'), (2, 'Bob', 'CRM')")
        status, message = execute_procedure_and_fetch_audit(snowflake_conn)
        cs.execute("SELECT AGENT_NAME FROM GOLD_AGENTS_D WHERE AGENT_ID = 1")
        agent_name = cs.fetchone()[0]
        assert agent_name == 'Alice'
        cs.execute("SELECT COUNT(*) FROM GOLD_AGENTS_D")
        count = cs.fetchone()[0]
        assert count == 2
        assert status == 'SUCCESS'
    finally:
        cs.close()

def test_TC03_null_values(snowflake_conn):
    cs = snowflake_conn.cursor()
    try:
        cs.execute("INSERT INTO STAGE_AGENTS VALUES (3, NULL, 'CRM'), (4, 'Dana', NULL)")
        status, message = execute_procedure_and_fetch_audit(snowflake_conn)
        cs.execute("SELECT AGENT_NAME, SOURCE_SYSTEM FROM GOLD_AGENTS_D WHERE AGENT_ID = 3")
        agent_name, source_system = cs.fetchone()
        assert agent_name is None
        assert source_system == 'CRM'
        cs.execute("SELECT AGENT_NAME, SOURCE_SYSTEM FROM GOLD_AGENTS_D WHERE AGENT_ID = 4")
        agent_name, source_system = cs.fetchone()
        assert agent_name == 'Dana'
        assert source_system is None
        assert status == 'SUCCESS'
    finally:
        cs.close()

def test_TC04_empty_stage_agents(snowflake_conn):
    status, message = execute_procedure_and_fetch_audit(snowflake_conn)
    assert status == 'SUCCESS'
    assert 'Agents data loaded successfully' in message

def test_TC05_unmatched_gold_agents(snowflake_conn):
    cs = snowflake_conn.cursor()
    try:
        cs.execute("INSERT INTO GOLD_AGENTS_D VALUES (5, 'Eve', CURRENT_TIMESTAMP(), CURRENT_TIMESTAMP(), 'CRM')")
        status, message = execute_procedure_and_fetch_audit(snowflake_conn)
        cs.execute("SELECT AGENT_NAME FROM GOLD_AGENTS_D WHERE AGENT_ID = 5")
        agent_name = cs.fetchone()[0]
        assert agent_name == 'Eve'
        assert status == 'SUCCESS'
    finally:
        cs.close()

def test_TC06_invalid_data_type(snowflake_conn):
    cs = snowflake_conn.cursor()
    try:
        # AGENT_ID as string should fail
        cs.execute("INSERT INTO STAGE_AGENTS VALUES ('not_an_int', 'Frank', 'CRM')")
        with pytest.raises(Exception):
            execute_procedure_and_fetch_audit(snowflake_conn)
        cs.execute("SELECT STATUS, MESSAGE FROM AUDIT_LOG WHERE STATUS = 'FAILED' ORDER BY RUN_TIME DESC LIMIT 1")
        status, message = cs.fetchone()
        assert status == 'FAILED'
        assert 'Error:' in message
    finally:
        cs.close()

def test_TC07_missing_audit_log_table(snowflake_conn):
    cs = snowflake_conn.cursor()
    try:
        cs.execute("DROP TABLE AUDIT_LOG")
        cs.execute("INSERT INTO STAGE_AGENTS VALUES (6, 'Grace', 'CRM')")
        try:
            execute_procedure_and_fetch_audit(snowflake_conn)
        except Exception:
            pass  # Audit log failure suppressed
        # Procedure should not raise error due to audit log failure
    finally:
        cs.close()

def test_TC08_boundary_agent_id(snowflake_conn):
    cs = snowflake_conn.cursor()
    try:
        max_int = 2147483647
        min_int = -2147483648
        cs.execute(f"INSERT INTO STAGE_AGENTS VALUES ({max_int}, 'Max', 'CRM'), ({min_int}, 'Min', 'CRM')")
        status, message = execute_procedure_and_fetch_audit(snowflake_conn)
        cs.execute(f"SELECT AGENT_NAME FROM GOLD_AGENTS_D WHERE AGENT_ID = {max_int}")
        agent_name = cs.fetchone()[0]
        assert agent_name == 'Max'
        cs.execute(f"SELECT AGENT_NAME FROM GOLD_AGENTS_D WHERE AGENT_ID = {min_int}")
        agent_name = cs.fetchone()[0]
        assert agent_name == 'Min'
        assert status == 'SUCCESS'
    finally:
        cs.close()

def test_TC09_duplicate_agent_ids(snowflake_conn):
    cs = snowflake_conn.cursor()
    try:
        cs.execute("INSERT INTO STAGE_AGENTS VALUES (7, 'Henry', 'CRM'), (7, 'Henry2', 'CRM')")
        with pytest.raises(Exception):
            execute_procedure_and_fetch_audit(snowflake_conn)
        cs.execute("SELECT STATUS, MESSAGE FROM AUDIT_LOG WHERE STATUS = 'FAILED' ORDER BY RUN_TIME DESC LIMIT 1")
        status, message = cs.fetchone()
        assert status == 'FAILED'
    finally:
        cs.close()

def test_TC10_missing_gold_agents_table(snowflake_conn):
    cs = snowflake_conn.cursor()
    try:
        cs.execute("DROP TABLE GOLD_AGENTS_D")
        cs.execute("INSERT INTO STAGE_AGENTS VALUES (8, 'Ivy', 'CRM')")
        with pytest.raises(Exception):
            execute_procedure_and_fetch_audit(snowflake_conn)
        cs.execute("SELECT STATUS, MESSAGE FROM AUDIT_LOG WHERE STATUS = 'FAILED' ORDER BY RUN_TIME DESC LIMIT 1")
        status, message = cs.fetchone()
        assert status == 'FAILED'
        assert 'Error:' in message
    finally:
        cs.close()
```

---

**API Cost Consumed:**  
- 2 file reads  
- 1 directory read  
- 0 coworker calls  
- apiCost: 0.0023 USD (from analyzer file)