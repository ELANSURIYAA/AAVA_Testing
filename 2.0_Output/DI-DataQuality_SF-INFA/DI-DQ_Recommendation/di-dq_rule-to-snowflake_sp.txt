-- =============================================
-- Author:       Ascendion AVA+
-- Created on:   2024-06-12
-- Description:  Executes DQ validation checks on MEMBERSDATA and logs violations in DQ_ISSUE_LOG
-- =============================================

CREATE OR REPLACE PROCEDURE MY_SAMPLE_DB.PUBLIC.SP_RUN_DQ_CHECKS()
RETURNS STRING
LANGUAGE JAVASCRIPT
AS
$$
/**
 * Snowflake Stored Procedure: SP_RUN_DQ_CHECKS
 * Executes DQ validation checks on MEMBERSDATA table based on DI-DQ_Recommendation.txt
 * Logs violations into DQ_ISSUE_LOG table
 */

// Helper function to escape single quotes for SQL literals
function escapeSql(str) {
    if (str === null || str === undefined) return '';
    return str.replace(/'/g, "''");
}

// Ensure sequence exists for batch id
var seq_check_sql = `CREATE SEQUENCE IF NOT EXISTS MY_SAMPLE_DB.PUBLIC.SEQ_BATCH_ID;`;
snowflake.createStatement({sqlText: seq_check_sql}).execute();

// Get new batch id
var batch_id_sql = `SELECT MY_SAMPLE_DB.PUBLIC.SEQ_BATCH_ID.NEXTVAL AS BATCH_ID;`;
var batch_id_stmt = snowflake.createStatement({sqlText: batch_id_sql});
var batch_id_result = batch_id_stmt.execute();
batch_id_result.next();
var batch_id = batch_id_result.getColumnValue('BATCH_ID');

// DQ rules definition (from DI-DQ_Recommendation.txt)
var dq_rules = [
    {Column:"FIRSTNAME",RuleType:"NotNullCheck",RuleDescription:"Ensure the first name is provided for every member.",Severity:"High"},
    {Column:"LASTNAME",RuleType:"NotNullCheck",RuleDescription:"Ensure the last name is provided for every member.",Severity:"High"},
    {Column:"COMPANY",RuleType:"StringLengthCheck",RuleDescription:"Ensure the company name does not exceed 255 characters.",Severity:"Medium"},
    {Column:"ADDRESS",RuleType:"StringLengthCheck",RuleDescription:"Ensure the address does not exceed 16777216 characters.",Severity:"Low"},
    {Column:"CITY",RuleType:"ValueCheck",RuleDescription:"Ensure the city is one of the approved locations: Los Angeles, New York, or London.",Severity:"High"},
    {Column:"COUNTRY",RuleType:"NotNullCheck",RuleDescription:"Ensure the country is provided for every member.",Severity:"High"},
    {Column:"STATE",RuleType:"StringLengthCheck",RuleDescription:"Ensure the state name does not exceed 100 characters.",Severity:"Medium"},
    {Column:"ZIP",RuleType:"FormatCheck",RuleDescription:"Ensure the ZIP code matches the expected format (e.g., numeric or alphanumeric).",Severity:"Medium"},
    {Column:"PHONENUMBER1",RuleType:"NotNullCheck",RuleDescription:"Ensure the primary phone number is provided.",Severity:"High"},
    {Column:"PHONENUMBER2",RuleType:"UniquenessCheck",RuleDescription:"Ensure PHONENUMBER2 is distinct from PHONENUMBER1 for each member.",Severity:"High"},
    {Column:"EMAIL",RuleType:"FormatCheck",RuleDescription:"Ensure the email matches a valid email format.",Severity:"High"},
    {Column:"WEB",RuleType:"FormatCheck",RuleDescription:"Ensure the website URL matches a valid URL format.",Severity:"Medium"},
    {Column:"MEMBER_ID",RuleType:"UniquenessCheck",RuleDescription:"Ensure MEMBER_ID is unique for each member.",Severity:"High"},
    {Column:"MEMBER_ID",RuleType:"RangeCheck",RuleDescription:"Ensure MEMBER_ID is within the range of 10000000 to 99999999.",Severity:"High"},
    {Column:"PHONENUMBER1, EMAIL, WEB",RuleType:"NotNullCheck",RuleDescription:"Ensure at least one valid form of contact information is provided (Phone, Email, or Website).",Severity:"High"}
];

// Table and log table names
var source_table = "MY_SAMPLE_DB.PUBLIC.MEMBERSDATA";
var log_table = "MY_SAMPLE_DB.PUBLIC.DQ_ISSUE_LOG";

// For error tracking
var error_msgs = [];

// Loop through DQ rules and execute checks
for (var i = 0; i < dq_rules.length; i++) {
    var rule = dq_rules[i];
    var column = rule.Column;
    var rule_type = rule.RuleType;
    var rule_desc = rule.RuleDescription;
    var severity = rule.Severity;

    var validation_sql = "";
    var issue_insert_sql = "";

    // Build validation SQL for each rule
    if (rule_type === "NotNullCheck") {
        if (column.indexOf(',') === -1) {
            // Single column not null
            validation_sql = `SELECT MEMBER_ID FROM ${source_table} WHERE ${column} IS NULL`;
        } else {
            // Multi-column: at least one not null
            var cols = column.split(',').map(c => c.trim());
            var cond = cols.map(c => `${c} IS NOT NULL`).join(' OR ');
            validation_sql = `SELECT MEMBER_ID FROM ${source_table} WHERE NOT (${cond})`;
        }
    }
    else if (rule_type === "StringLengthCheck") {
        // Extract max length from rule description
        var max_len_match = rule_desc.match(/exceed (\d+) characters/);
        var max_len = max_len_match ? parseInt(max_len_match[1]) : null;
        if (max_len !== null) {
            validation_sql = `SELECT MEMBER_ID FROM ${source_table} WHERE LENGTH(${column}) > ${max_len}`;
        }
    }
    else if (rule_type === "ValueCheck") {
        // Approved values from rule description
        var values_match = rule_desc.match(/approved locations: (.+)\./);
        var values = values_match ? values_match[1].split(',').map(v => `'${escapeSql(v.trim())}'`) : [];
        if (values.length > 0) {
            validation_sql = `SELECT MEMBER_ID FROM ${source_table} WHERE ${column} IS NULL OR ${column} NOT IN (${values.join(',')})`;
        }
    }
    else if (rule_type === "FormatCheck") {
        if (column === "ZIP") {
            // Numeric or alphanumeric ZIP (allow letters, digits, hyphen at end)
            validation_sql = `SELECT MEMBER_ID FROM ${source_table} WHERE ZIP IS NOT NULL AND ZIP NOT RLIKE '^[A-Za-z0-9-]+$'`;
        }
        else if (column === "EMAIL") {
            // Valid email regex (hyphen at end)
            validation_sql = `SELECT MEMBER_ID FROM ${source_table} WHERE EMAIL IS NOT NULL AND EMAIL NOT RLIKE '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$'`;
        }
        else if (column === "WEB") {
            // Valid URL regex (hyphen at end)
            validation_sql = `SELECT MEMBER_ID FROM ${source_table} WHERE WEB IS NOT NULL AND WEB NOT RLIKE '^(https?://)?[A-Za-z0-9.-]+\\.[A-Za-z]{2,}(/.*)?$'`;
        }
    }
    else if (rule_type === "UniquenessCheck") {
        if (column === "MEMBER_ID") {
            // MEMBER_ID unique
            validation_sql = `SELECT MEMBER_ID FROM ${source_table} GROUP BY MEMBER_ID HAVING COUNT(*) > 1`;
        }
        else if (column === "PHONENUMBER2") {
            // PHONENUMBER2 distinct from PHONENUMBER1
            validation_sql = `SELECT MEMBER_ID FROM ${source_table} WHERE PHONENUMBER2 IS NOT NULL AND PHONENUMBER2 = PHONENUMBER1`;
        }
    }
    else if (rule_type === "RangeCheck") {
        if (column === "MEMBER_ID") {
            validation_sql = `SELECT MEMBER_ID FROM ${source_table} WHERE MEMBER_ID < 10000000 OR MEMBER_ID > 99999999`;
        }
    }

    // If validation SQL is constructed, execute and log issues
    if (validation_sql) {
        try {
            var stmt = snowflake.createStatement({sqlText: validation_sql});
            var result = stmt.execute();
            while (result.next()) {
                var member_id = result.getColumnValue('MEMBER_ID');
                issue_insert_sql = `
                    INSERT INTO ${log_table} (TABLE_NAME, COLUMN_NAME, RULE_DESCRIPTION, SEVERITY, LOGGED_AT, BATCH_ID, MEMBER_ID)
                    VALUES (
                        '${escapeSql(source_table)}',
                        '${escapeSql(column)}',
                        '${escapeSql(rule_desc)}',
                        '${escapeSql(severity)}',
                        CURRENT_TIMESTAMP(),
                        ${batch_id},
                        ${member_id === null ? 'NULL' : member_id}
                    );
                `;
                snowflake.createStatement({sqlText: issue_insert_sql}).execute();
            }
        } catch (err) {
            error_msgs.push(`Error executing rule for column ${column}: ${err}`);
        }
    }
}

// Return result or error
if (error_msgs.length > 0) {
    return 'DQ checks completed with errors: ' + error_msgs.join('; ');
} else {
    return 'DQ checks completed successfully. Batch ID: ' + batch_id;
}
$$;
-- =============================================
-- End of Procedure
-- =============================================