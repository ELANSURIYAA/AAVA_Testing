=============================================

Author:        Ascendion AVA+

Created on:   

Description:   Snowflake SQL script to back up employee data by creating and populating employee_bkup from Employee and Salary tables, with idempotent table handling.

=============================================

**Test Case List:**  
| Test Case ID | Description                                   | Input Data Description                                              | Expected Outcome                                    |
|--------------|-----------------------------------------------|---------------------------------------------------------------------|-----------------------------------------------------|
| TC001        | Happy path: All employees have matching salary| Employee and Salary tables with matching EmployeeNo values          | All employees inserted into employee_bkup with NetPay|
| TC002        | Employee without matching salary              | Employee table has EmployeeNo not in Salary                         | Only employees with matching Salary are inserted     |
| TC003        | Salary without matching employee              | Salary table has EmployeeNo not in Employee                         | Only employees with matching Employee are inserted   |
| TC004        | Handle NULL values in join keys               | Employee or Salary tables have NULL EmployeeNo                      | Rows with NULL EmployeeNo are not joined/inserted    |
| TC005        | Empty Employee and Salary tables              | Both tables are empty                                               | employee_bkup is created but remains empty           |
| TC006        | Edge: Duplicate EmployeeNo in Salary table    | Salary table has duplicate EmployeeNo values                        | Each EmployeeNo in Employee is joined to all matches |
| TC007        | Edge: Large dataset performance               | Large Employee and Salary tables                                    | Insert completes successfully and efficiently        |
| TC008        | Edge: Semi-structured data in unused columns  | Employee table has VARIANT/JSON column (not used in join/insert)    | Script ignores extra columns, works as expected      |

**Pytest Script:**  
```python
import pytest
from snowflake.connector import connect

@pytest.fixture(scope="module")
def snowflake_connection():
    conn = connect(
        user='YOUR_USER',
        password='YOUR_PASSWORD',
        account='YOUR_ACCOUNT',
        warehouse='YOUR_WAREHOUSE',
        database='YOUR_DATABASE',
        schema='PUBLIC'
    )
    yield conn
    conn.close()

@pytest.fixture(autouse=True)
def cleanup_tables(snowflake_connection):
    # Cleanup before and after each test
    cursor = snowflake_connection.cursor()
    cursor.execute("DROP TABLE IF EXISTS employee_bkup;")
    cursor.execute("DROP TABLE IF EXISTS Employee;")
    cursor.execute("DROP TABLE IF EXISTS Salary;")
    yield
    cursor.execute("DROP TABLE IF EXISTS employee_bkup;")
    cursor.execute("DROP TABLE IF EXISTS Employee;")
    cursor.execute("DROP TABLE IF EXISTS Salary;")

def run_script(cursor):
    cursor.execute("DROP TABLE IF EXISTS employee_bkup;")
    cursor.execute("""
        CREATE TABLE employee_bkup (
            EmployeeNo INTEGER,
            FirstName VARCHAR(30),
            LastName VARCHAR(30),
            DepartmentNo SMALLINT,
            NetPay INTEGER
        );
    """)
    cursor.execute("""
        INSERT INTO employee_bkup
        SELECT 
            a.EmployeeNo,
            a.FirstName,
            a.LastName,
            a.DepartmentNo,
            b.NetPay
        FROM 
            Employee a
            INNER JOIN Salary b
                ON a.EmployeeNo = b.EmployeeNo;
    """)

def fetch_all(cursor, query):
    cursor.execute(query)
    return cursor.fetchall()

def test_happy_path(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("CREATE TABLE Employee (EmployeeNo INTEGER, FirstName VARCHAR(30), LastName VARCHAR(30), DepartmentNo SMALLINT);")
    cursor.execute("CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);")
    cursor.execute("INSERT INTO Employee VALUES (1, 'John', 'Doe', 10), (2, 'Jane', 'Smith', 20);")
    cursor.execute("INSERT INTO Salary VALUES (1, 1000), (2, 2000);")
    run_script(cursor)
    results = fetch_all(cursor, "SELECT * FROM employee_bkup ORDER BY EmployeeNo;")
    assert results == [(1, 'John', 'Doe', 10, 1000), (2, 'Jane', 'Smith', 20, 2000)]

def test_employee_without_matching_salary(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("CREATE TABLE Employee (EmployeeNo INTEGER, FirstName VARCHAR(30), LastName VARCHAR(30), DepartmentNo SMALLINT);")
    cursor.execute("CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);")
    cursor.execute("INSERT INTO Employee VALUES (1, 'John', 'Doe', 10), (2, 'Jane', 'Smith', 20);")
    cursor.execute("INSERT INTO Salary VALUES (1, 1000);")
    run_script(cursor)
    results = fetch_all(cursor, "SELECT * FROM employee_bkup;")
    assert results == [(1, 'John', 'Doe', 10, 1000)]

def test_salary_without_matching_employee(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("CREATE TABLE Employee (EmployeeNo INTEGER, FirstName VARCHAR(30), LastName VARCHAR(30), DepartmentNo SMALLINT);")
    cursor.execute("CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);")
    cursor.execute("INSERT INTO Employee VALUES (1, 'John', 'Doe', 10);")
    cursor.execute("INSERT INTO Salary VALUES (1, 1000), (2, 2000);")
    run_script(cursor)
    results = fetch_all(cursor, "SELECT * FROM employee_bkup;")
    assert results == [(1, 'John', 'Doe', 10, 1000)]

def test_null_employee_no(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("CREATE TABLE Employee (EmployeeNo INTEGER, FirstName VARCHAR(30), LastName VARCHAR(30), DepartmentNo SMALLINT);")
    cursor.execute("CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);")
    cursor.execute("INSERT INTO Employee VALUES (NULL, 'Null', 'Emp', 10), (2, 'Jane', 'Smith', 20);")
    cursor.execute("INSERT INTO Salary VALUES (2, 2000), (NULL, 9999);")
    run_script(cursor)
    results = fetch_all(cursor, "SELECT * FROM employee_bkup;")
    assert results == [(2, 'Jane', 'Smith', 20, 2000)]

def test_empty_tables(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("CREATE TABLE Employee (EmployeeNo INTEGER, FirstName VARCHAR(30), LastName VARCHAR(30), DepartmentNo SMALLINT);")
    cursor.execute("CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);")
    run_script(cursor)
    results = fetch_all(cursor, "SELECT * FROM employee_bkup;")
    assert results == []

def test_duplicate_employee_no_in_salary(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("CREATE TABLE Employee (EmployeeNo INTEGER, FirstName VARCHAR(30), LastName VARCHAR(30), DepartmentNo SMALLINT);")
    cursor.execute("CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);")
    cursor.execute("INSERT INTO Employee VALUES (1, 'John', 'Doe', 10);")
    cursor.execute("INSERT INTO Salary VALUES (1, 1000), (1, 1100);")
    run_script(cursor)
    results = fetch_all(cursor, "SELECT * FROM employee_bkup ORDER BY NetPay;")
    assert results == [(1, 'John', 'Doe', 10, 1000), (1, 'John', 'Doe', 10, 1100)]

def test_large_dataset_performance(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("CREATE TABLE Employee (EmployeeNo INTEGER, FirstName VARCHAR(30), LastName VARCHAR(30), DepartmentNo SMALLINT);")
    cursor.execute("CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);")
    # Insert 1000 employees and salaries
    cursor.execute("INSERT INTO Employee SELECT seq4(), 'First', 'Last', 1 FROM TABLE(GENERATOR(ROWCOUNT => 1000));")
    cursor.execute("INSERT INTO Salary SELECT seq4(), 1000 FROM TABLE(GENERATOR(ROWCOUNT => 1000));")
    run_script(cursor)
    cursor.execute("SELECT COUNT(*) FROM employee_bkup;")
    count = cursor.fetchone()[0]
    assert count == 1000

def test_semi_structured_data_ignored(snowflake_connection):
    cursor = snowflake_connection.cursor()
    cursor.execute("CREATE TABLE Employee (EmployeeNo INTEGER, FirstName VARCHAR(30), LastName VARCHAR(30), DepartmentNo SMALLINT, Extra VARIANT);")
    cursor.execute("CREATE TABLE Salary (EmployeeNo INTEGER, NetPay INTEGER);")
    cursor.execute("INSERT INTO Employee (EmployeeNo, FirstName, LastName, DepartmentNo, Extra) VALUES (1, 'John', 'Doe', 10, PARSE_JSON('{\"info\": \"test\"}'));")
    cursor.execute("INSERT INTO Salary VALUES (1, 1000);")
    run_script(cursor)
    results = fetch_all(cursor, "SELECT EmployeeNo, FirstName, LastName, DepartmentNo, NetPay FROM employee_bkup;")
    assert results == [(1, 'John', 'Doe', 10, 1000)]
```

Cost Analysis:
API Cost: $0.0028