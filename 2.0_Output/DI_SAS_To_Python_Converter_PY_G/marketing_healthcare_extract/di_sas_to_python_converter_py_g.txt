/***********************************************************************
* Program Name : marketing_healthcare_extract.py
* Description  : 
*   This Python script connects securely to Teradata using SQLAlchemy, extracts healthcare 
*   plan and provider network data, applies marketing eligibility logic, enriches data with 
*   business rules, filters eligible members, and exports the final dataset for marketing campaign use.
*   Includes API cost calculation as described.
************************************************************************/

import pandas as pd
from sqlalchemy import create_engine
from sqlalchemy.engine.url import URL

def get_teradata_engine():
    """
    Establishes a secure connection to Teradata using SQLAlchemy.
    Replace placeholders with actual credentials and connection details.
    """
    teradata_url = URL.create(
        drivername='teradata',
        username='YOUR_USERNAME',      # Replace with your Teradata username
        password='YOUR_PASSWORD',      # Replace with your Teradata password
        host='your_server_name',       # Replace with your Teradata server name
        database='your_database',      # Replace with your Teradata database
        query={'tdpid': 'your_tdpid'}  # Replace with your Teradata TDPID
    )
    engine = create_engine(teradata_url)
    return engine

def extract_healthcare_data(engine):
    """
    Extracts healthcare plan and provider network data, applies business rules,
    and enriches with marketing eligibility logic.
    Returns a pandas DataFrame.
    """
    query = """
        SELECT 
            hp.member_id,
            TRIM(hp.member_first_name) || ' ' || TRIM(hp.member_last_name) AS member_full_name,
            hp.member_age,
            CASE 
                WHEN hp.member_age BETWEEN 25 AND 35 THEN 'YOUNG_ADULT'
                WHEN hp.member_age BETWEEN 36 AND 50 THEN 'MID_AGE'
                WHEN hp.member_age > 50 THEN 'SENIOR'
                ELSE 'UNKNOWN'
            END AS age_group,
            hp.plan_id,
            hp.plan_type,
            hp.region,
            pn.network_type,
            UPPER(hp.plan_type) || '-' || hp.region AS marketing_segment,
            CASE 
                WHEN hp.plan_status = 'ACTIVE' 
                     AND hp.member_age BETWEEN 25 AND 60 
                     AND hp.plan_type IN ('PPO', 'HMO') 
                     AND hp.region IN ('WEST', 'SOUTH')
                     AND pn.network_type = 'IN_NETWORK'
                THEN 1
                ELSE 0
            END AS is_campaign_eligible
        FROM healthcare_plans hp
        LEFT JOIN provider_network pn
            ON hp.plan_id = pn.plan_id
        WHERE hp.plan_status = 'ACTIVE'
          AND hp.member_age IS NOT NULL
    """
    df = pd.read_sql(query, engine)
    return df

def filter_eligible_members(df):
    """
    Filters the DataFrame to include only eligible members for the campaign.
    """
    eligible_df = df[df['is_campaign_eligible'] == 1].copy()
    return eligible_df

def export_to_csv(df, outpath):
    """
    Exports the final DataFrame to a CSV file.
    """
    df.to_csv(outpath, index=False)

def calculate_api_cost(num_records, cost_per_record=0.02):
    """
    Calculates API cost for the campaign as described.
    Args:
        num_records (int): Number of eligible records.
        cost_per_record (float): Cost per API call/record.
    Returns:
        float: Total API cost.
    """
    return num_records * cost_per_record

def main():
    """
    Main workflow for extracting, processing, and exporting healthcare marketing data.
    """
    # Step 1: Secure Teradata connection
    engine = get_teradata_engine()

    # Step 2: Data extraction and enrichment
    df = extract_healthcare_data(engine)

    # Step 3: Filter eligible members
    eligible_df = filter_eligible_members(df)

    # Step 4: Export final dataset to CSV
    outpath = '/folders/myfolders/final_marketing_campaign_extract_2025.csv'
    export_to_csv(eligible_df, outpath)

    # Step 5: API cost calculation
    num_records = len(eligible_df)
    total_cost = calculate_api_cost(num_records)
    print(f"API Cost Calculation: {num_records} records x $0.02 = ${total_cost:.2f}")

if __name__ == '__main__':
    main()