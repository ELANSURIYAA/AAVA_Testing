# marketing_healthcare_extract.py

"""
This script replicates the SAS program 'marketing_healthcare_extract_production.sas' in Python,
using pandas for data manipulation. It connects to Teradata (or simulates extraction), applies
business rules, joins provider network data, filters eligible members, and exports the result as CSV.

Author: [Your Name or Team Name]
Created On: 10-Apr-2025
"""

import pandas as pd
import numpy as np

# Uncomment and configure the following if you want to connect to Teradata for real extraction.
# import teradatasql
# def extract_from_teradata(sql_query):
#     '''
#     Connects to Teradata and extracts data using the provided SQL query.
#     Returns a pandas DataFrame.
#     '''
#     conn = teradatasql.connect(host='your_server_name', user='your_username', password='your_password')
#     df = pd.read_sql(sql_query, conn)
#     conn.close()
#     return df

def simulate_healthcare_plans():
    """
    Simulates the healthcare_plans table for demonstration purposes.
    Returns a pandas DataFrame.
    """
    data = {
        'member_id': [1, 2, 3, 4, 5],
        'member_first_name': ['Alice', 'Bob', 'Carol', 'David', 'Eve'],
        'member_last_name': ['Smith', 'Jones', 'Brown', 'Taylor', 'Wilson'],
        'member_age': [28, 45, 52, 34, None],
        'plan_id': [101, 102, 103, 104, 105],
        'plan_type': ['PPO', 'HMO', 'EPO', 'PPO', 'HMO'],
        'region': ['WEST', 'SOUTH', 'EAST', 'WEST', 'SOUTH'],
        'plan_status': ['ACTIVE', 'ACTIVE', 'INACTIVE', 'ACTIVE', 'ACTIVE']
    }
    return pd.DataFrame(data)

def simulate_provider_network():
    """
    Simulates the provider_network table for demonstration purposes.
    Returns a pandas DataFrame.
    """
    data = {
        'plan_id': [101, 102, 103, 104, 105],
        'network_type': ['IN_NETWORK', 'IN_NETWORK', 'OUT_NETWORK', 'IN_NETWORK', 'IN_NETWORK']
    }
    return pd.DataFrame(data)

def enrich_data(hp_df, pn_df):
    """
    Applies business rules, joins provider network, and creates enriched columns.
    Returns an enriched DataFrame.
    """
    # Merge healthcare_plans with provider_network (LEFT JOIN)
    df = pd.merge(hp_df, pn_df, how='left', on='plan_id')

    # Filter: plan_status == 'ACTIVE' and member_age is not null
    df = df[(df['plan_status'] == 'ACTIVE') & (df['member_age'].notnull())]

    # Create member_full_name
    df['member_full_name'] = df['member_first_name'].str.strip() + ' ' + df['member_last_name'].str.strip()

    # Age group assignment
    def age_group(age):
        if 25 <= age <= 35:
            return 'YOUNG_ADULT'
        elif 36 <= age <= 50:
            return 'MID_AGE'
        elif age > 50:
            return 'SENIOR'
        else:
            return 'UNKNOWN'

    df['age_group'] = df['member_age'].apply(lambda x: age_group(x) if pd.notnull(x) else 'UNKNOWN')

    # Marketing segment
    df['marketing_segment'] = df['plan_type'].str.upper() + '-' + df['region']

    # Campaign eligibility logic
    def is_campaign_eligible(row):
        return int(
            row['plan_status'] == 'ACTIVE' and
            25 <= row['member_age'] <= 60 and
            row['plan_type'] in ['PPO', 'HMO'] and
            row['region'] in ['WEST', 'SOUTH'] and
            row['network_type'] == 'IN_NETWORK'
        )

    df['is_campaign_eligible'] = df.apply(is_campaign_eligible, axis=1)

    # Select columns as per SAS output
    cols = [
        'member_id',
        'member_full_name',
        'member_age',
        'age_group',
        'plan_id',
        'plan_type',
        'region',
        'network_type',
        'marketing_segment',
        'is_campaign_eligible'
    ]
    return df[cols]

def filter_eligible_members(df):
    """
    Filters DataFrame to only eligible members (is_campaign_eligible == 1).
    Returns filtered DataFrame.
    """
    return df[df['is_campaign_eligible'] == 1].reset_index(drop=True)

def export_to_csv(df, outpath):
    """
    Exports DataFrame to CSV at the specified path.
    """
    df.to_csv(outpath, index=False)

def main():
    """
    Main workflow: extract, enrich, filter, export.
    """
    # Step 1: Extract data (simulate here)
    hp_df = simulate_healthcare_plans()
    pn_df = simulate_provider_network()

    # Step 2: Enrich data and apply business rules
    enriched_df = enrich_data(hp_df, pn_df)

    # Step 3: Filter eligible members
    final_campaign_list = filter_eligible_members(enriched_df)

    # Step 4: Export final file
    outpath = '/folders/myfolders/final_marketing_campaign_extract_2025.csv'
    export_to_csv(final_campaign_list, outpath)
    print(f"Exported {len(final_campaign_list)} eligible members to {outpath}")

if __name__ == '__main__':
    main()