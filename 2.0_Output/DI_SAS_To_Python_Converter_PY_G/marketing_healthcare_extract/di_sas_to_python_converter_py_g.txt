"""
marketing_healthcare_extract.py

This script replicates the SAS logic for extracting healthcare plan data, applying marketing eligibility logic, joining provider network details, and exporting the final dataset for marketing campaign use.

Dependencies:
- pandas
- teradatasql (or SQLAlchemy for Teradata)
- numpy

Install with:
pip install pandas teradatasql numpy

"""

import pandas as pd
import numpy as np
import teradatasql

def connect_to_teradata(host, user, password, database):
    """
    Establishes a connection to Teradata.
    """
    conn = teradatasql.connect(
        host=host,
        user=user,
        password=password,
        database=database
    )
    return conn

def extract_healthcare_data(conn):
    """
    Extracts healthcare plan and provider network data from Teradata.
    """
    query = """
    SELECT
        hp.member_id,
        hp.member_first_name,
        hp.member_last_name,
        hp.member_age,
        hp.plan_id,
        hp.plan_type,
        hp.region,
        hp.plan_status,
        pn.network_type
    FROM healthcare_plans hp
    LEFT JOIN provider_network pn
        ON hp.plan_id = pn.plan_id
    WHERE hp.plan_status = 'ACTIVE'
      AND hp.member_age IS NOT NULL
    """
    df = pd.read_sql(query, conn)
    return df

def enrich_data(df):
    """
    Applies business rules, marketing eligibility logic, and creates new columns.
    """
    # Create member_full_name
    df['member_full_name'] = df['member_first_name'].str.strip() + ' ' + df['member_last_name'].str.strip()

    # Age group categorization
    def age_group(age):
        if 25 <= age <= 35:
            return 'YOUNG_ADULT'
        elif 36 <= age <= 50:
            return 'MID_AGE'
        elif age > 50:
            return 'SENIOR'
        else:
            return 'UNKNOWN'
    df['age_group'] = df['member_age'].apply(age_group)

    # Marketing segment
    df['marketing_segment'] = df['plan_type'].str.upper() + '-' + df['region']

    # Campaign eligibility logic
    def campaign_eligible(row):
        return int(
            row['plan_status'] == 'ACTIVE' and
            25 <= row['member_age'] <= 60 and
            row['plan_type'] in ['PPO', 'HMO'] and
            row['region'] in ['WEST', 'SOUTH'] and
            row['network_type'] == 'IN_NETWORK'
        )
    df['is_campaign_eligible'] = df.apply(campaign_eligible, axis=1)

    return df

def filter_eligible_members(df):
    """
    Filters only eligible members for the campaign.
    """
    return df[df['is_campaign_eligible'] == 1]

def export_to_csv(df, outpath):
    """
    Exports the final campaign list to CSV.
    """
    df.to_csv(outpath, index=False)

def main():
    """
    Main workflow for extracting, processing, and exporting healthcare marketing data.
    """
    # Teradata connection parameters (replace with your credentials)
    host = 'your_server_name'
    user = 'your_username'
    password = 'your_password'
    database = 'your_database'

    # Output path
    outpath = '/folders/myfolders/final_marketing_campaign_extract_2025.csv'

    # Connect to Teradata
    conn = connect_to_teradata(host, user, password, database)

    # Extract data
    raw_df = extract_healthcare_data(conn)

    # Enrich data with business logic
    enriched_df = enrich_data(raw_df)

    # Filter eligible members
    final_campaign_list = filter_eligible_members(enriched_df)

    # Export to CSV
    export_to_csv(final_campaign_list, outpath)

    print(f"Exported final campaign list to {outpath}")

if __name__ == "__main__":
    main()

# End of marketing_healthcare_extract.py