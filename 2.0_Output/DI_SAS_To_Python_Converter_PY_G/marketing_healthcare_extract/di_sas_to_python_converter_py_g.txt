# marketing_healthcare_extract.py

"""
This script replicates the SAS logic from marketing_healthcare_extract.sas for extracting, transforming, and exporting healthcare marketing data.
- Connects to Teradata using SQLAlchemy.
- Extracts and joins healthcare_plans and provider_network tables.
- Applies all business logic, including age grouping and campaign eligibility.
- Filters eligible members.
- Exports the final result to CSV.

Dependencies:
- pandas
- sqlalchemy
- teradatasqlalchemy (for Teradata connection)
- (Optional) python-dotenv for managing credentials

Usage:
    python marketing_healthcare_extract.py

Author: [Your Name or Team Name]
Created On: 10-Apr-2025
"""

import pandas as pd
from sqlalchemy import create_engine, text
import os

# ---------------------------
# CONFIGURATION
# ---------------------------
# Set your Teradata connection parameters here
TERADATA_HOST = os.getenv('TERADATA_HOST', 'your_server_name')
TERADATA_USERNAME = os.getenv('TERADATA_USERNAME', 'your_username')
TERADATA_PASSWORD = os.getenv('TERADATA_PASSWORD', 'your_password')
TERADATA_TDPID = os.getenv('TERADATA_TDPID', 'your_tdpid')
OUTPATH = os.getenv('OUTPATH', '/folders/myfolders/final_marketing_campaign_extract_2025.csv')

# ---------------------------
# DATABASE CONNECTION
# ---------------------------
def get_teradata_engine():
    """
    Create a SQLAlchemy engine for Teradata.
    """
    # Example Teradata SQLAlchemy URI: teradatasql://user:pass@host
    # You may need to install teradatasqlalchemy: pip install teradatasqlalchemy
    uri = f"teradatasql://{TERADATA_USERNAME}:{TERADATA_PASSWORD}@{TERADATA_HOST}/?TDPID={TERADATA_TDPID}"
    return create_engine(uri)

# ---------------------------
# DATA EXTRACTION & TRANSFORMATION
# ---------------------------
def extract_and_transform(engine):
    """
    Extracts data from Teradata, applies business rules, and returns a DataFrame.
    """
    # SQL replicating the SAS PROC SQL logic
    sql = """
    SELECT 
        hp.member_id,
        TRIM(hp.member_first_name) || ' ' || TRIM(hp.member_last_name) AS member_full_name,
        hp.member_age,
        CASE 
            WHEN hp.member_age BETWEEN 25 AND 35 THEN 'YOUNG_ADULT'
            WHEN hp.member_age BETWEEN 36 AND 50 THEN 'MID_AGE'
            WHEN hp.member_age > 50 THEN 'SENIOR'
            ELSE 'UNKNOWN'
        END AS age_group,
        hp.plan_id,
        hp.plan_type,
        hp.region,
        pn.network_type,
        UPPER(hp.plan_type) || '-' || hp.region AS marketing_segment,
        CASE 
            WHEN hp.plan_status = 'ACTIVE' 
                 AND hp.member_age BETWEEN 25 AND 60 
                 AND hp.plan_type IN ('PPO', 'HMO') 
                 AND hp.region IN ('WEST', 'SOUTH')
                 AND pn.network_type = 'IN_NETWORK'
            THEN 1
            ELSE 0
        END AS is_campaign_eligible
    FROM tdata.healthcare_plans hp
    LEFT JOIN tdata.provider_network pn
        ON hp.plan_id = pn.plan_id
    WHERE hp.plan_status = 'ACTIVE'
      AND hp.member_age IS NOT NULL
    """
    df = pd.read_sql(text(sql), engine)
    return df

# ---------------------------
# FILTER ELIGIBLE MEMBERS
# ---------------------------
def filter_eligible_members(df):
    """
    Filters DataFrame for campaign-eligible members.
    """
    return df[df['is_campaign_eligible'] == 1].copy()

# ---------------------------
# EXPORT TO CSV
# ---------------------------
def export_to_csv(df, outpath):
    """
    Exports DataFrame to CSV.
    """
    df.to_csv(outpath, index=False)
    print(f"Exported {len(df)} records to {outpath}")

# ---------------------------
# MAIN WORKFLOW
# ---------------------------
def main():
    """
    Main orchestration function.
    """
    print("Connecting to Teradata...")
    engine = get_teradata_engine()
    print("Extracting and transforming data...")
    df = extract_and_transform(engine)
    print(f"Total records extracted: {len(df)}")
    print("Filtering eligible members...")
    eligible_df = filter_eligible_members(df)
    print(f"Eligible records: {len(eligible_df)}")
    print("Exporting to CSV...")
    export_to_csv(eligible_df, OUTPATH)
    print("Done.")

if __name__ == '__main__':
    main()

# ---------------------------
# END OF SCRIPT
# ---------------------------

# Notes:
# - Ensure you have the required Python packages installed:
#   pip install pandas sqlalchemy teradatasqlalchemy
# - You can set environment variables for credentials or replace them directly in the script.
# - All SAS macro logic (e.g., &outpath) is mapped to Python variables.
# - The SQL logic is executed directly in the database for efficiency.
# - For large data, consider chunked reading/writing.