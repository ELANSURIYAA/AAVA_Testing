import pandas as pd
import teradatasql
from sqlalchemy import create_engine
import os

def get_teradata_connection(user, password, host, database=None):
    """
    Establish a secure connection to Teradata using SQLAlchemy and teradatasql.
    Args:
        user (str): Teradata username.
        password (str): Teradata password.
        host (str): Teradata server hostname or IP.
        database (str, optional): Default database/schema.
    Returns:
        sqlalchemy.engine.base.Engine: SQLAlchemy engine object.
    """
    url = f"teradatasql://{user}:{password}@{host}/"
    if database:
        url += f"?database={database}"
    engine = create_engine(url)
    return engine

def extract_healthcare_data(engine):
    """
    Extract and join healthcare plan and provider network data from Teradata.
    Returns:
        pd.DataFrame: Joined and raw data.
    """
    query = """
        SELECT 
            hp.member_id,
            TRIM(hp.member_first_name) AS member_first_name,
            TRIM(hp.member_last_name) AS member_last_name,
            hp.member_age,
            hp.plan_id,
            hp.plan_type,
            hp.region,
            hp.plan_status,
            pn.network_type
        FROM tdata.healthcare_plans hp
        LEFT JOIN tdata.provider_network pn
            ON hp.plan_id = pn.plan_id
        WHERE hp.plan_status = 'ACTIVE'
          AND hp.member_age IS NOT NULL
    """
    df = pd.read_sql(query, engine)
    return df

def assign_age_group(age):
    """
    Assign age group based on member_age.
    """
    if pd.isnull(age):
        return 'UNKNOWN'
    if 25 <= age <= 35:
        return 'YOUNG_ADULT'
    elif 36 <= age <= 50:
        return 'MID_AGE'
    elif age > 50:
        return 'SENIOR'
    else:
        return 'UNKNOWN'

def build_marketing_segment(plan_type, region):
    """
    Build marketing segment string.
    """
    if pd.isnull(plan_type) or pd.isnull(region):
        return None
    return f"{str(plan_type).upper()}-{region}"

def is_campaign_eligible(row):
    """
    Apply campaign eligibility logic.
    """
    return int(
        row['plan_status'] == 'ACTIVE'
        and 25 <= row['member_age'] <= 60
        and row['plan_type'] in ('PPO', 'HMO')
        and row['region'] in ('WEST', 'SOUTH')
        and row['network_type'] == 'IN_NETWORK'
    )

def enrich_data(df):
    """
    Create enriched dataframe with business rules and derived columns.
    Args:
        df (pd.DataFrame): Raw dataframe.
    Returns:
        pd.DataFrame: Enriched dataframe.
    """
    df['member_full_name'] = df['member_first_name'].str.strip() + ' ' + df['member_last_name'].str.strip()
    df['age_group'] = df['member_age'].apply(assign_age_group)
    df['marketing_segment'] = df.apply(lambda x: build_marketing_segment(x['plan_type'], x['region']), axis=1)
    df['is_campaign_eligible'] = df.apply(is_campaign_eligible, axis=1)
    return df

def filter_eligible_members(df):
    """
    Filter dataframe to only eligible members.
    Args:
        df (pd.DataFrame): Enriched dataframe.
    Returns:
        pd.DataFrame: Filtered dataframe.
    """
    return df[df['is_campaign_eligible'] == 1].copy()

def export_to_csv(df, output_path):
    """
    Export dataframe to CSV.
    Args:
        df (pd.DataFrame): Data to export.
        output_path (str): Path to output CSV file.
    """
    df.to_csv(output_path, index=False)

def main():
    """
    Main function to orchestrate the ETL process.
    """
    # --- User configuration ---
    TERADATA_USER = os.getenv('TERADATA_USER')
    TERADATA_PASSWORD = os.getenv('TERADATA_PASSWORD')
    TERADATA_HOST = os.getenv('TERADATA_HOST')
    OUTPUT_PATH = '/folders/myfolders/final_marketing_campaign_extract_2025.csv'
    # --------------------------

    # Connect to Teradata
    engine = get_teradata_connection(
        user=TERADATA_USER,
        password=TERADATA_PASSWORD,
        host=TERADATA_HOST
    )

    # Extract data
    raw_df = extract_healthcare_data(engine)

    # Enrich data with business rules
    enriched_df = enrich_data(raw_df)

    # Filter only eligible members
    final_df = filter_eligible_members(enriched_df)

    # Export to CSV
    export_to_csv(final_df, OUTPUT_PATH)

if __name__ == '__main__':
    main()