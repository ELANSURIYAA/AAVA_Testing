# Documentation for SQL Server Stored Procedure: [RCT].[uspAPIPatchAccount]

---

## 1. Overview of Program

### Purpose
The stored procedure `[RCT].[uspAPIPatchAccount]` is designed to generate and return a JSON-formatted data payload for PATCH operations in an API. It collects, transforms, and structures account and related data from multiple tables in the `IntegrationsMart` database, specifically under the `RCT` schema, to support downstream API consumers.

### Business Problem Addressed
The business problem addressed is the need to synchronize and patch account-related data between internal systems and external consumers via an API. The procedure ensures that only validated, unsent, and relevant account records are packaged in a standardized JSON format, including extension fields and nested address/location data, for PATCH operations. This supports integration, data consistency, and automation in business workflows.

---

## 2. Code Structure and Design

### Structure and Flow

- **Input Parameter:**  
  - `@LoopInstance INT`: Used to paginate or batch the data returned for processing.

- **Variable Declaration:**  
  - `@Date DATETIME2`: Set to yesterday's date for filtering active records.

- **Common Table Expressions (CTEs):**
  - `NationalAccts`: Identifies national accounts from `EDSMART.Semantic.PolicyDescriptors`.
  - `INForceListCode`: Provides a mapping of status codes to item codes.
  - `BrandCode`: Maps brand codes to item codes.
  - `Final`: The main CTE that aggregates, joins, and transforms all required fields from various sources.

- **Main Query:**
  - Selects from `Final` CTE, filters by `LoopInstance`, and constructs a JSON message using string concatenation and COALESCE.

### Primary SQL Server Components

- **Tables:**
  - `RCT.Account`
  - `EDSMART.Semantic.PolicyDescriptors`
  - `RCT.AccountID`
  - `RCT.IdOverride`

- **Views:**  
  - None explicitly referenced.

- **Stored Procedures:**  
  - This is a stored procedure.

- **Joins:**  
  - Multiple LEFT JOINs to enrich account data.

- **Aggregations:**  
  - Uses `ROW_NUMBER()` for batching and ordering.

- **Subqueries:**  
  - Implemented via CTEs.

---

## 3. Data Flow and Processing Logic

### Processing Logic Data Flow Components

1. **Input Parameter Handling**
   - Accepts `@LoopInstance` for batching.

2. **Date Calculation**
   - Sets `@Date` to yesterday for filtering.

3. **CTEs for Reference Data**
   - `NationalAccts`: Filters for current national accounts.
   - `INForceListCode` and `BrandCode`: Provide lookup values.

4. **Main Data Aggregation (`Final` CTE)**
   - Joins account data with reference CTEs and lookup tables.
   - Applies transformations (e.g., COALESCE, IIF, CAST, string manipulation).
   - Calculates `LoopInstance` for batching (every 250 records).

5. **Filtering**
   - Only includes accounts with `PostPatch = 'Patch'`, `Validated IS NULL`, `DateSent IS NULL`, and `SubmissionFlag = 0`.

6. **JSON Message Construction**
   - Builds a JSON PATCH message string with all required fields and extension fields.

### Transformations

- **Field Calculations:**  
  - Use of `COALESCE` to provide fallback values.
  - `IIF` for conditional logic (e.g., email validation, flag translation).
  - `CAST` to ensure all extension fields are stringified for JSON.
  - String manipulation for IDs (e.g., removing 'AF' prefix).
  - `ROW_NUMBER()` for batching and ordering.

- **Filtering:**  
  - Only unvalidated, unsent, and patch-flagged accounts are processed.

- **Joins:**  
  - Enriches account data with national account status, brand, status codes, and ID overrides.

---

## 4. Data Mapping

| Target Table Name | Target Column Name              | Source Table Name                        | Source Column Name                | Remarks                                                                                   |
|-------------------|------------------------------- |------------------------------------------|-----------------------------------|------------------------------------------------------------------------------------------|
| JSON Output       | AccountID                      | RCT.Account / RCT.IdOverride             | AccountID / RCT_ID                | 1-to-1 mapping with COALESCE fallback                                                    |
| JSON Output       | LoopInstance                   | Derived                                  | ROW_NUMBER()                      | Transformation: Calculated for batching                                                  |
| JSON Output       | UnderwriterId                  | RCT.Account                              | UnderwriterId                     | Conditional: Only if not a National Account                                              |
| JSON Output       | ExternalUniqueId               | RCT.Account                              | ExternalUniqueId                  | 1-to-1 mapping                                                                          |
| JSON Output       | Location.Address.ProvinceID    | RCT.Account                              | PrimaryLocationAddressProvinceId   | 1-to-1 mapping                                                                          |
| JSON Output       | Location.Address.AddressLine   | RCT.Account                              | PrimaryLocationAddressAddressLine  | 1-to-1 mapping                                                                          |
| JSON Output       | Location.Address.City          | RCT.Account                              | PrimaryLocationAddressCity         | 1-to-1 mapping                                                                          |
| JSON Output       | Location.Address.PostalCode    | RCT.Account                              | PrimaryLocationAddressPostalCode   | 1-to-1 mapping                                                                          |
| JSON Output       | Location.Address.Longitude     | RCT.Account                              | PrimaryLocationAddressLongitude    | 1-to-1 mapping                                                                          |
| JSON Output       | Location.Address.Latitude      | RCT.Account                              | PrimaryLocationAddressLatitude     | 1-to-1 mapping                                                                          |
| JSON Output       | Location.Address.County        | RCT.Account                              | PrimaryLocationAddressCounty       | 1-to-1 mapping                                                                          |
| JSON Output       | Location.ExternalUniqueId      | RCT.Account                              | PrimaryLocationAddressExternalUniqueId | Transformation: CAST to varchar(100)                                                |
| JSON Output       | MailingAddress.ProvinceID      | RCT.Account                              | MailingAddressProvinceId           | 1-to-1 mapping                                                                          |
| JSON Output       | MailingAddress.AddressLine     | RCT.Account                              | MailingAddressAddressLine          | 1-to-1 mapping                                                                          |
| JSON Output       | MailingAddress.City            | RCT.Account                              | MailingAddressCity                 | 1-to-1 mapping                                                                          |
| JSON Output       | MailingAddress.PostalCode      | RCT.Account                              | MailingAddressPostalCode           | 1-to-1 mapping                                                                          |
| JSON Output       | MailingAddress.Longitude       | RCT.Account                              | MailingAddressLongitude            | 1-to-1 mapping                                                                          |
| JSON Output       | MailingAddress.Latitude        | RCT.Account                              | MailingAddressLatitude             | 1-to-1 mapping                                                                          |
| JSON Output       | MailingAddress.County          | RCT.Account                              | MailingAddressCounty               | 1-to-1 mapping                                                                          |
| JSON Output       | Name                           | RCT.Account                              | Name                              | 1-to-1 mapping                                                                          |
| JSON Output       | Phone                          | RCT.Account                              | BusinessPhone                     | 1-to-1 mapping                                                                          |
| JSON Output       | Fax                            | RCT.Account                              | FaxPhone                          | 1-to-1 mapping                                                                          |
| JSON Output       | Email                          | RCT.Account                              | EmailAddress                      | Validation: Only if contains '@'                                                         |
| JSON Output       | Notes                          | RCT.Account                              | Notes                             | Transformation: CAST to varchar(150)                                                     |
| JSON Output       | ContactNumber                  | RCT.Account                              | ContactNumber                     | 1-to-1 mapping                                                                          |
| JSON Output       | SubmissionFlag                 | RCT.Account                              | SubmissionFlag                    | 1-to-1 mapping                                                                          |
| JSON Output       | ExtensionFields (IDs 11-168)   | RCT.Account and Lookups                  | Various fields                    | Transformation: Each field is mapped, cast, or conditionally set for JSON extension      |
| JSON Output       | JSON_Message                   | Derived                                  | All above fields                   | Transformation: Assembled into JSON string                                               |

*Note: The above is a representative sample; the actual mapping includes all fields as seen in the SELECT and JSON construction.*

---

## 5. Complexity Analysis

| Metric                  | Value        | Notes                                                                 |
|-------------------------|-------------|-----------------------------------------------------------------------|
| Lines of Code (LOC)     | ~200        | Includes comments, CTEs, and main query                               |
| Cyclomatic Complexity   | 8           | Multiple branches (IIFs, COALESCE, conditional joins, filters)        |
| Nesting Depth           | 3           | CTEs nested up to 3 levels                                            |
| Tables                  | 4           | RCT.Account, RCT.AccountID, RCT.IdOverride, EDSMART.Semantic.PolicyDescriptors |
| Temporary Tables        | 0           | Only CTEs used                                                        |
| DML Statements          | 1           | SELECT (no INSERT/UPDATE/DELETE)                                      |
| Joins                   | 5           | Multiple LEFT JOINs                                                   |
| Subqueries              | 0           | All logic handled via CTEs                                            |
| CTEs                    | 4           | NationalAccts, INForceListCode, BrandCode, Final                      |
| Aggregation Queries     | 1           | Uses ROW_NUMBER() OVER (ORDER BY ...)                                 |
| Input Parameters        | 1           | @LoopInstance                                                         |
| Output Parameters       | 0           | Output is via SELECT                                                  |
| Data Transformations    | 20+         | Extensive use of CAST, COALESCE, IIF, string manipulation             |
| Function Calls          | 0           | No external function/procedure calls                                  |

**Overall Complexity Score:** 65/100  
- The procedure is moderately complex due to the number of fields, conditional logic, and JSON construction, but it is well-structured and uses standard SQL Server constructs.

---

## 6. Key Outputs

- **JSON_Message:**  
  - The main output is a JSON-formatted string containing all account data, extension fields, and nested address/location information, suitable for PATCH API consumption.
  - Includes all mapped fields, extension fields (IDs 11-168), and is filtered by `LoopInstance` for batching.

- **Other Output Columns:**
  - `AccountID`
  - `ContactNumber`
  - `SubmissionFlag`
  - `LoopInstance`

- **No Inserts, Updates, or Deletes** are performed by this procedure; it is a read-only data extraction and transformation for API output.

---

## 7. Error Handling and Logging

- **Error Handling:**  
  - No explicit TRY-CATCH or error handling blocks are present in the code.
  - The procedure relies on SQL Server's default error propagation.
  - Any errors during execution would result in a failure of the procedure, which should be handled by the calling application or API layer.

- **Logging:**  
  - No explicit logging to error tables or audit tables is implemented in this procedure.

- **Retry Mechanisms:**  
  - No retry logic is present within the stored procedure.
  - Any retry logic should be implemented by the API or orchestration layer that calls this procedure.

---

## Field List and Descriptions

| Field Name                          | Description                                                                                  |
|--------------------------------------|----------------------------------------------------------------------------------------------|
| AccountID                           | Unique identifier for the account (from Account or IdOverride)                               |
| LoopInstance                        | Batch number for pagination (every 250 records)                                              |
| UnderwriterId                       | Underwriter's ID, null for national accounts                                                 |
| ExternalUniqueId                    | External system unique identifier for the account                                            |
| Location.Address.ProvinceID          | Province/State ID for primary location                                                       |
| Location.Address.AddressLine         | Address line for primary location                                                            |
| Location.Address.City                | City for primary location                                                                    |
| Location.Address.PostalCode          | Postal code for primary location                                                             |
| Location.Address.Longitude           | Longitude for primary location                                                               |
| Location.Address.Latitude            | Latitude for primary location                                                                |
| Location.Address.County              | County for primary location                                                                  |
| Location.ExternalUniqueId            | External unique ID for primary location                                                      |
| MailingAddress.ProvinceID            | Province/State ID for mailing address                                                        |
| MailingAddress.AddressLine           | Address line for mailing address                                                             |
| MailingAddress.City                  | City for mailing address                                                                     |
| MailingAddress.PostalCode            | Postal code for mailing address                                                              |
| MailingAddress.Longitude             | Longitude for mailing address                                                                |
| MailingAddress.Latitude              | Latitude for mailing address                                                                 |
| MailingAddress.County                | County for mailing address                                                                   |
| Name                                | Account name                                                                                 |
| Phone                               | Business phone number                                                                        |
| Fax                                 | Fax number                                                                                   |
| Email                               | Email address (only if valid)                                                                |
| Notes                               | Notes about the account                                                                      |
| ContactNumber                       | Account contact number                                                                       |
| SubmissionFlag                      | Submission flag (0 = not submitted)                                                          |
| ExtensionFields (IDs 11-168)        | Additional fields mapped as extension fields for API consumption                             |
| JSON_Message                        | The assembled JSON PATCH message for the account                                             |

---

**End of Documentation**