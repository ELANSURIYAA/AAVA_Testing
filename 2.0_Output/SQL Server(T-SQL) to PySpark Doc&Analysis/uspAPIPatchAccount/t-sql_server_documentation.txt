# Technical and Functional Documentation: [RCT].[uspAPIPatchAccount]

---

## 1. Overview of Program

**Purpose:**  
The `[RCT].[uspAPIPatchAccount]` stored procedure is designed to generate and return a JSON message payload for PATCH operations in an API, specifically for account data. It selects, transforms, and packages account information from the `RCT.Account` table and related tables, preparing it for PATCH updates to downstream systems via an API.

**Business Problem Addressed:**  
The procedure addresses the need for standardized, validated, and up-to-date account data to be sent to external systems via PATCH API calls. It ensures that only accounts meeting certain criteria (e.g., not already patched, validated, or sent) are included, and that the data is enriched with related information (e.g., underwriting, location, agency, and policy details). This supports business processes such as account synchronization, compliance, and reporting.

---

## 2. Code Structure and Design

**Structure and Flow:**
- The procedure accepts one input parameter: `@LoopInstance` (INT), used for batch processing.
- Declares a date variable for filtering.
- Defines three CTEs for reference data:
  - `NationalAccts`: Identifies national accounts.
  - `INForceListCode`: Maps item IDs to account status codes.
  - `BrandCode`: Maps item IDs to brand names.
- The main CTE (`Final`) performs the core data extraction, transformation, and joining.
- The final SELECT statement generates a JSON message for each qualifying account, including both core fields and a set of extension fields.

**Primary SQL Server Components:**
- **Tables:**  
  - `RCT.Account`
  - `EDSMART.Semantic.PolicyDescriptors`
  - `RCT.AccountID`
  - `RCT.IdOverride`
- **Views:** None explicitly used.
- **Stored Procedures:** This is a stored procedure.
- **Joins:** Multiple LEFT JOINs to enrich account data.
- **Aggregations:** Uses `ROW_NUMBER()` for batching and ordering.
- **Subqueries:** Implemented via CTEs.
- **CTEs:** Four (`NationalAccts`, `INForceListCode`, `BrandCode`, `Final`).

---

## 3. Data Flow and Processing Logic

### Processing Logic Data Flow Components

1. **Parameter Initialization:**
   - `@LoopInstance` is used to select a batch of records for processing.
   - `@Date` is set to yesterday's date for filtering.

2. **Reference Data CTEs:**
   - `NationalAccts`: Selects distinct `AccountNumber` where `NationalAccountFlag = 1` and `ExpirationDate > @Date`.
   - `INForceListCode`: Maps item IDs to account status codes.
   - `BrandCode`: Maps item IDs to brand names.

3. **Main Data Extraction (`Final` CTE):**
   - Joins `RCT.Account` with the above CTEs and other tables to enrich account data.
   - Applies business rules, such as:
     - Only include accounts where `PostPatch = 'Patch'`, `Validated IS NULL`, `DateSent IS NULL`, and `SubmissionFlag = 0`.
     - Exclude UnderwriterId for national accounts.
     - Handles various field transformations and null handling.
   - Uses `ROW_NUMBER()` to support batch processing by `LoopInstance`.

4. **JSON Message Construction:**
   - For each qualifying account, constructs a JSON PATCH message string.
   - Core fields and a set of extension fields (by ID) are included.
   - Handles nulls and formatting for PATCH payload compatibility.

### Transformations

- **Filtering:**  
  - Only accounts ready for PATCH (not already patched, validated, or sent, and not flagged for submission).
- **Joins:**  
  - Enriches with national account status, brand, account status, and ID overrides.
- **Aggregations:**  
  - Uses `ROW_NUMBER()` for batching.
- **Field Calculations:**  
  - Conditional logic for fields (e.g., email validation, underwriter exclusion for national accounts).
  - Various fields are cast to string types for JSON serialization.
  - Extension fields mapped by ID.

---

## 4. Data Mapping

### Mapping Table

| Target Table Name | Target Column Name           | Source Table Name                  | Source Column Name                | Remarks                                  |
|-------------------|-----------------------------|------------------------------------|-----------------------------------|-------------------------------------------|
| JSON_Message      | AccountID                   | RCT.Account / RCT.AccountID / RCT.IdOverride | AccountID / RCT_ID / AccountID    | 1 to 1 mapping with COALESCE logic       |
| JSON_Message      | UnderwriterId               | RCT.Account                        | UnderwriterId                     | Null if National Account, else direct     |
| JSON_Message      | MailingAddress.ProvinceID   | RCT.Account                        | MailingAddressProvinceId          | 1 to 1 mapping                           |
| JSON_Message      | MailingAddress.AddressLine  | RCT.Account                        | MailingAddressAddressLine         | 1 to 1 mapping                           |
| JSON_Message      | MailingAddress.City         | RCT.Account                        | MailingAddressCity                | 1 to 1 mapping                           |
| JSON_Message      | MailingAddress.PostalCode   | RCT.Account                        | MailingAddressPostalCode          | 1 to 1 mapping                           |
| JSON_Message      | MailingAddress.Longitude    | RCT.Account                        | MailingAddressLongitude           | 1 to 1 mapping                           |
| JSON_Message      | MailingAddress.Latitude     | RCT.Account                        | MailingAddressLatitude            | 1 to 1 mapping                           |
| JSON_Message      | MailingAddress.County       | RCT.Account                        | MailingAddressCounty              | 1 to 1 mapping                           |
| JSON_Message      | Name                        | RCT.Account                        | Name                              | 1 to 1 mapping                           |
| JSON_Message      | Phone                       | RCT.Account                        | BusinessPhone                     | 1 to 1 mapping                           |
| JSON_Message      | Fax                         | RCT.Account                        | FaxPhone                          | 1 to 1 mapping                           |
| JSON_Message      | Email                       | RCT.Account                        | EmailAddress                      | Validation: Only if contains '@'          |
| JSON_Message      | Notes                       | RCT.Account                        | Notes                             | Cast to varchar(150)                     |
| JSON_Message      | ContactNumber               | RCT.Account                        | ContactNumber                     | 1 to 1 mapping                           |
| JSON_Message      | SubmissionFlag              | RCT.Account                        | SubmissionFlag                    | 1 to 1 mapping                           |
| JSON_Message      | ExtensionFields (various)   | RCT.Account and joined tables      | See below                         | Extension fields mapped by ID             |

#### Example Extension Field Mapping

| Target Table Name | Target Column Name | Source Table Name | Source Column Name | Remarks                                 |
|-------------------|-------------------|-------------------|-------------------|------------------------------------------|
| JSON_Message      | [11]              | INForceListCode   | ItemID            | Transformation: Maps AccountStatus code  |
| JSON_Message      | [37]              | RCT.Account       | BDCName           | 1 to 1 mapping, cast to varchar(MAX)     |
| JSON_Message      | [40]              | RCT.Account       | UnderwriterEmail  | Validation: Only if contains '@'         |
| JSON_Message      | [67]              | RCT.Account       | OnBaseLink        | 1 to 1 mapping, cast to varchar(MAX)     |
| ...               | ...               | ...               | ...               | ...                                      |

*See code for full list of extension fields and their mappings.*

---

## 5. Complexity Analysis

| Metric                    | Value         | Notes                                                        |
|---------------------------|--------------|--------------------------------------------------------------|
| Lines of Code (LOC)       | ~250         | Including comments and formatting                            |
| Cyclomatic Complexity     | 7            | Multiple joins, CTEs, conditional logic                      |
| Nesting Depth             | 3            | CTEs nested, some IIF/COALESCE logic                         |
| Tables                    | 6            | RCT.Account, RCT.AccountID, RCT.IdOverride, PolicyDescriptors, INForceListCode (CTE), BrandCode (CTE) |
| Temporary Tables          | 0            | Only CTEs used                                               |
| DML Statements            | 1 SELECT     | No INSERT/UPDATE/DELETE                                      |
| Joins                     | 5            | LEFT JOINs in main CTE                                       |
| Subqueries                | 4            | 4 CTEs                                                       |
| CTEs                      | 4            | NationalAccts, INForceListCode, BrandCode, Final             |
| Aggregation Queries       | 2            | ROW_NUMBER() used twice                                      |
| Input Parameters          | 1            | @LoopInstance                                                |
| Output Parameters         | 0            | Returns result set                                           |
| Data Transformations      | 20+          | Many CAST, COALESCE, IIF, string manipulations               |
| Function Calls            | 0            | No external procedure/function calls                         |

**Overall Complexity Score:** 55/100  
- Moderate complexity due to multiple CTEs, joins, and JSON construction logic. No DML, recursion, or advanced error handling.

---

## 6. Key Outputs

- **Result Set:**  
  Each row represents an account to be PATCHed, with the following columns:
  - `AccountID`
  - `ContactNumber`
  - `SubmissionFlag`
  - `LoopInstance`
  - `JSON_Message` (the PATCH payload for the API)

- **No Inserts/Updates/Deletes:**  
  This procedure is read-only; it does not modify data.

---

## 7. Error Handling and Logging

- **Error Handling:**  
  - No explicit TRY-CATCH blocks or error handling logic in this procedure.
  - Assumes that any errors will be surfaced by SQL Server to the calling process.
- **Logging:**  
  - No logging or error tracking implemented within the procedure.
- **Retry Mechanisms:**  
  - None implemented in this procedure.

---

## Field List and Descriptions

| Field Name                      | Description                                                                                  |
|---------------------------------|----------------------------------------------------------------------------------------------|
| AccountID                       | Unique identifier for the account (from AccountID, RCT_ID, or AccountID table)              |
| UnderwriterId                   | Underwriter ID, null for national accounts                                                   |
| MailingAddress.ProvinceID       | Province ID for mailing address                                                              |
| MailingAddress.AddressLine      | Mailing address line                                                                         |
| MailingAddress.City             | Mailing address city                                                                         |
| MailingAddress.PostalCode       | Mailing address postal code                                                                  |
| MailingAddress.Longitude        | Mailing address longitude                                                                    |
| MailingAddress.Latitude         | Mailing address latitude                                                                     |
| MailingAddress.County           | Mailing address county                                                                       |
| Name                            | Account name                                                                                 |
| Phone                           | Business phone number                                                                        |
| Fax                             | Fax number                                                                                   |
| Email                           | Email address (only if valid)                                                                |
| Notes                           | Notes (truncated to 150 characters)                                                         |
| ContactNumber                   | Account contact number                                                                       |
| SubmissionFlag                  | Submission flag (0 = not submitted)                                                          |
| LoopInstance                    | Batch instance number for processing                                                         |
| JSON_Message                    | JSON PATCH payload for API                                                                   |
| [11], [37], ..., [168]          | Extension fields, see code for mapping to source columns                                     |
| ...                             | ...                                                                                          |

---

## Additional Notes

- **Batch Processing:**  
  The use of `LoopInstance` and `ROW_NUMBER()` allows the procedure to process accounts in batches of 250, supporting scalable PATCH operations.

- **Extension Fields:**  
  The `[Id]` fields in the extension array correspond to various account, policy, and related attributes, each mapped from source columns and cast to string for JSON compatibility.

- **Validation:**  
  Email fields are only included if they contain an '@' character, ensuring valid email addresses in the payload.

---

**This documentation provides a comprehensive breakdown of the uspAPIPatchAccount stored procedure, suitable for both technical and non-technical stakeholders.**