---

# Documentation for SQL Server Stored Procedure: `uspAPIPatchAccount`

## 1. Overview of Program

**Purpose:**  
The stored procedure `[RCT].[uspAPIPatchAccount]` is designed to generate a PATCH data payload for an API integration. It retrieves account and related information from various tables, applies business logic and transformations, and outputs a JSON-formatted message for each account that meets certain criteria. This message is intended for use in PATCH operations via an API, updating account records with the latest information.

**Business Problem Addressed:**  
The procedure addresses the need to synchronize and update account data between internal systems and external consumers via an API. It ensures that only validated, unsent, and flagged accounts are included, and applies business rules such as handling National Accounts, mapping extension fields, and formatting the output as a JSON PATCH document. This supports business operations by keeping external systems up-to-date with the latest account information and reducing manual data reconciliation.

---

## 2. Code Structure and Design

**Structure and Flow:**  
- The procedure takes one input parameter: `@LoopInstance INT`.
- It declares a date variable `@Date` for filtering.
- Several Common Table Expressions (CTEs) are defined:
  - `NationalAccts`: Identifies national accounts.
  - `INForceListCode`: Maps account status codes.
  - `BrandCode`: Maps brand codes.
  - `Final`: Aggregates and transforms account data, joining with the above CTEs and other tables.
- The main SELECT statement produces a JSON PATCH message for each account in the specified loop instance.

**Primary SQL Server Components:**
- **Tables:**
  - `RCT.Account`
  - `EDSMART.Semantic.PolicyDescriptors`
  - `RCT.AccountID`
  - `RCT.IdOverride`
- **Views:** None explicitly referenced.
- **Stored Procedures:** This is a stored procedure.
- **Joins:** Multiple LEFT JOINs to enrich account data.
- **Aggregations:** Uses `ROW_NUMBER()` for pagination and splitting.
- **Subqueries:** Implemented via CTEs.
- **CTEs:** Four CTEs (`NationalAccts`, `INForceListCode`, `BrandCode`, `Final`).
- **Functions:** Uses SQL built-in functions (`COALESCE`, `IIF`, `CAST`, `LEN`, `REPLACE`).

---

## 3. Data Flow and Processing Logic

**Processing Logic Data Flow Components:**
- **Input Parameter:** `@LoopInstance` controls which batch of accounts to process.
- **Date Filtering:** Only accounts with expiration dates after yesterday are considered for National Accounts.
- **Account Selection:** Only accounts with `PostPatch = 'Patch'`, `Validated IS NULL`, `DateSent IS NULL`, and `SubmissionFlag = 0` are processed.
- **Joins and Enrichments:** Data is joined from multiple tables and CTEs to enrich the account record.
- **Transformations:**
  - **Field Calculations:** Many fields are calculated or transformed using SQL functions (e.g., `COALESCE`, `IIF`, `CAST`).
  - **Conditional Logic:** UnderwriterId is set to NULL for National Accounts.
  - **Data Formatting:** Output is formatted as a JSON PATCH message, with extension fields mapped by ID.
  - **Pagination:** Accounts are split into batches using `ROW_NUMBER()` and `LoopInstance`.
  - **Email Validation:** Email fields are validated to contain '@'.
  - **Field Defaults:** Unknown values are handled with defaults (e.g., phone).
  - **Loss Ratio and Unique ID:** Special logic for fields like WrittenLossRatio and ExternalUniqueId.

---

## 4. Data Mapping

**Detailed Mappings Between Source and Target Tables**

| Target Table Name | Target Column Name           | Source Table Name / CTE | Source Column Name               | Remarks                                  |
|-------------------|-----------------------------|------------------------|-----------------------------------|-------------------------------------------|
| Output JSON       | AccountID                   | Final                  | COALESCE(AC.AccountID,ID.RCT_ID) | Transformation: fallback logic            |
| Output JSON       | LoopInstance                | Final                  | (ROW_NUMBER() OVER ...)/250       | Transformation: batch calculation         |
| Output JSON       | UnderwriterId               | Final                  | IIF(NA.AccountNumber IS NULL, UnderwriterId, NULL) | Conditional transformation               |
| Output JSON       | ExternalUniqueId            | Final                  | A.ExternalUniqueId                | 1 to 1 mapping                           |
| Output JSON       | Location.Address.ProvinceID | Final                  | PrimaryLocationAddressProvinceId  | 1 to 1 mapping                           |
| Output JSON       | Location.Address.AddressLine| Final                  | PrimaryLocationAddressAddressLine | 1 to 1 mapping                           |
| Output JSON       | Location.Address.City       | Final                  | PrimaryLocationAddressCity        | 1 to 1 mapping                           |
| Output JSON       | Location.Address.PostalCode | Final                  | PrimaryLocationAddressPostalCode  | 1 to 1 mapping                           |
| Output JSON       | Location.Address.Longitude  | Final                  | PrimaryLocationAddressLongitude   | 1 to 1 mapping                           |
| Output JSON       | Location.Address.Latitude   | Final                  | PrimaryLocationAddressLatitude    | 1 to 1 mapping                           |
| Output JSON       | Location.Address.County     | Final                  | PrimaryLocationAddressCounty      | 1 to 1 mapping                           |
| Output JSON       | Location.ExternalUniqueId   | Final                  | PrimaryLocationAddressExternalUniqueId | Transformation: CAST to varchar(100) |
| Output JSON       | Location.LocationNumber     | Final                  | PrimaryLocationAddressLocationNumber | 1 to 1 mapping                       |
| Output JSON       | Location.Description        | Final                  | PrimaryLocationAddressDescription | 1 to 1 mapping                           |
| Output JSON       | Location.AdditionalInfo     | Final                  | PrimaryLocationAddressAdditionalInfo | 1 to 1 mapping                       |
| Output JSON       | MailingAddress.ProvinceID   | Final                  | MailingAddressProvinceId          | 1 to 1 mapping                           |
| Output JSON       | MailingAddress.AddressLine  | Final                  | MailingAddressAddressLine         | 1 to 1 mapping                           |
| Output JSON       | MailingAddress.City         | Final                  | MailingAddressCity                | 1 to 1 mapping                           |
| Output JSON       | MailingAddress.PostalCode   | Final                  | MailingAddressPostalCode          | 1 to 1 mapping                           |
| Output JSON       | MailingAddress.Longitude    | Final                  | MailingAddressLongitude           | 1 to 1 mapping                           |
| Output JSON       | MailingAddress.Latitude     | Final                  | MailingAddressLatitude            | 1 to 1 mapping                           |
| Output JSON       | MailingAddress.County       | Final                  | MailingAddressCounty              | 1 to 1 mapping                           |
| Output JSON       | [11], [37], ... [168]       | Final                  | Various fields                    | Transformation: CAST, conditional logic   |
| Output JSON       | Name                        | Final                  | Name                             | 1 to 1 mapping                           |
| Output JSON       | Phone                       | Final                  | BusinessPhone                    | 1 to 1 mapping                           |
| Output JSON       | Fax                         | Final                  | FaxPhone                         | 1 to 1 mapping                           |
| Output JSON       | Email                       | Final                  | EmailAddress                     | Validation: must contain '@'              |
| Output JSON       | Notes                       | Final                  | Notes                            | Transformation: CAST to varchar(150)      |
| Output JSON       | ContactNumber               | Final                  | ContactNumber                    | 1 to 1 mapping                           |
| Output JSON       | SubmissionFlag              | Final                  | SubmissionFlag                   | 1 to 1 mapping                           |
| Output JSON       | JSON_Message                | Final                  | Constructed JSON                  | Transformation: JSON PATCH construction   |

*Note: Extension fields [11], [37], ... [168] are mapped from various source columns with transformations and conditional logic as shown in the code.*

---

## 5. Complexity Analysis

| Metric                   | Value / Description                                                                 |
|--------------------------|-------------------------------------------------------------------------------------|
| Lines of Code (LOC)      | ~210 (including comments and formatting)                                            |
| Cyclomatic Complexity    | 10+ (multiple joins, conditional logic, CTEs, CASE/IIF, COALESCE, etc.)             |
| Nesting Depth            | 3 (CTEs, joins, conditional logic)                                                  |
| Tables                   | 5 (RCT.Account, EDSMART.Semantic.PolicyDescriptors, RCT.AccountID, RCT.IdOverride, CTEs) |
| Temporary Tables         | 0 (uses CTEs instead)                                                               |
| DML Statements           | 1 SELECT (main output), no INSERT/UPDATE/DELETE                                     |
| Joins                    | 6 (multiple LEFT JOINs in Final CTE)                                                |
| Subqueries               | 0 (all handled via CTEs)                                                            |
| CTEs                     | 4 (NationalAccts, INForceListCode, BrandCode, Final)                                |
| Aggregation Queries      | 2 (ROW_NUMBER(), GROUP BY in CTEs)                                                  |
| Input Parameters         | 1 (`@LoopInstance`)                                                                 |
| Output Parameters        | 0 (output is via SELECT)                                                            |
| Data Transformations     | 40+ (CAST, COALESCE, IIF, conditional logic, string manipulation)                   |
| Function Calls           | 0 external, multiple built-in SQL functions                                         |

**Overall Complexity Score:** **75/100**

- The procedure is moderately complex due to multiple joins, conditional logic, heavy use of CTEs, and extensive data transformation for JSON output.

---

## 6. Key Outputs

**Final Outputs Created by the Code:**
- **SELECT Statement:**  
  - Outputs a JSON PATCH message for each account in the specified loop instance.
  - Includes all relevant account fields, extension fields, and transformed data.
  - No INSERT, UPDATE, or DELETE operations are performed; the output is read-only.

**Fields Included in Output:**
- AccountID
- ContactNumber
- SubmissionFlag
- LoopInstance
- JSON_Message (contains all PATCH operations and extension fields)

---

## 7. Error Handling and Logging

**Error Identification and Management Methods:**
- **Try-Catch Mechanisms:**  
  - Not explicitly implemented in this procedure. No TRY...CATCH blocks are present.
- **Error Logging Tables:**  
  - Not used in this procedure. No error logging or tracking of failures.
- **Retry Mechanisms:**  
  - Not present. The procedure is designed for read-only data extraction and formatting.

**Note:**  
For production use, it is recommended to wrap the procedure logic in TRY...CATCH blocks and implement error logging for better reliability and troubleshooting.

---

## Field Descriptions

| Field Name                              | Description                                                                 |
|------------------------------------------|-----------------------------------------------------------------------------|
| AccountID                               | Unique identifier for the account                                           |
| LoopInstance                            | Batch number for pagination                                                 |
| UnderwriterId                           | Identifier for the underwriter (null for national accounts)                 |
| ExternalUniqueId                        | External unique identifier for the account                                  |
| Location.Address.ProvinceID              | Province ID of the primary location address                                 |
| Location.Address.AddressLine              | Address line of the primary location                                        |
| Location.Address.City                    | City of the primary location                                                |
| Location.Address.PostalCode              | Postal code of the primary location                                         |
| Location.Address.Longitude               | Longitude of the primary location                                           |
| Location.Address.Latitude                | Latitude of the primary location                                            |
| Location.Address.County                  | County of the primary location                                              |
| Location.ExternalUniqueId                | External unique ID for the location                                         |
| Location.LocationNumber                  | Location number                                                            |
| Location.Description                     | Description of the location                                                 |
| Location.AdditionalInfo                  | Additional info for the location                                            |
| MailingAddress.ProvinceID                | Province ID of the mailing address                                          |
| MailingAddress.AddressLine               | Address line of the mailing address                                         |
| MailingAddress.City                      | City of the mailing address                                                 |
| MailingAddress.PostalCode                | Postal code of the mailing address                                          |
| MailingAddress.Longitude                 | Longitude of the mailing address                                            |
| MailingAddress.Latitude                  | Latitude of the mailing address                                             |
| MailingAddress.County                    | County of the mailing address                                               |
| [11], [37], ... [168]                    | Extension fields, mapped to various account attributes                      |
| Name                                     | Name of the account                                                        |
| Phone                                    | Business phone number                                                       |
| Fax                                      | Fax phone number                                                            |
| Email                                    | Email address (validated to contain '@')                                    |
| Notes                                    | Notes field (truncated to 150 characters)                                   |
| ContactNumber                            | Contact number for the account                                              |
| SubmissionFlag                           | Flag indicating submission status                                           |
| JSON_Message                             | JSON PATCH message containing all field updates                             |

---

**End of Documentation**