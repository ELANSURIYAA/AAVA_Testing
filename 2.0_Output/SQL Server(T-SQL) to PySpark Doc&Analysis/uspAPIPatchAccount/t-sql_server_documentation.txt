----------------------------------------------------------------------
# 1. Overview of Program

**Purpose:**  
The stored procedure `[RCT].[uspAPIPatchAccount]` is designed to generate and return PATCH data for an API, specifically for account records that require updates (PATCH operations). The output is a JSON message containing the necessary fields and extension fields for each account, formatted to comply with the API's requirements.

**Business Problem Addressed:**  
The procedure addresses the need to synchronize or update account information in downstream systems via an API. It identifies accounts that have been marked for PATCH (i.e., require updates), compiles all relevant data fields, applies business logic and transformations, and outputs the data in a structured JSON format. This ensures data consistency and streamlines integration between the SQL Server backend and external applications.

----------------------------------------------------------------------

# 2. Code Structure and Design

**Structure and Flow:**
- The procedure accepts a single input parameter: `@LoopInstance INT`.
- It declares a date variable `@Date` set to yesterday.
- Three Common Table Expressions (CTEs) are defined:
  - `NationalAccts`: Identifies national accounts from `EDSMART.Semantic.PolicyDescriptors`.
  - `INForceListCode`: Maps item IDs to account status codes.
  - `BrandCode`: Maps item IDs to brand names.
- The main CTE, `Final`, performs the bulk of the data selection, transformation, and joining.
- The final SELECT statement generates a JSON message for each account in the specified loop instance.

**Primary SQL Server Components:**
- **Tables:**  
  - `RCT.Account`
  - `EDSMART.Semantic.PolicyDescriptors`
  - `RCT.AccountID`
  - `RCT.IdOverride`
- **Views:** None explicitly referenced.
- **Stored Procedures:** This code is itself a stored procedure.
- **Joins:** Multiple LEFT JOINs to enrich account data.
- **Aggregations:** Uses `ROW_NUMBER()` for pagination/looping.
- **Subqueries:** Implemented via CTEs.
- **CTEs:** Four (`NationalAccts`, `INForceListCode`, `BrandCode`, `Final`).

----------------------------------------------------------------------

# 3. Data Flow and Processing Logic

**Processing Logic Data Flow Components:**
- **Input Parameter:** `@LoopInstance` (controls which batch of accounts to process).
- **Date Calculation:** Sets `@Date` to yesterday for filtering.
- **CTEs:** Used for lookup and enrichment.
- **Joins:** Enriches account data with national account status, account status codes, brand codes, and ID overrides.
- **Filtering:** Only accounts with `PostPatch = 'Patch'`, `Validated IS NULL`, `DateSent IS NULL`, and `SubmissionFlag = 0` are processed.
- **Pagination:** Uses `ROW_NUMBER()` to split accounts into batches of 250.
- **Transformations:** Extensive use of `CAST`, `COALESCE`, and conditional logic (`IIF`) to format and validate data fields.
- **JSON Construction:** Builds a JSON PATCH message for each account, including both standard and extension fields.

**Detailed Explanation of Logical Components:**

- **NationalAccts CTE:**  
  - Selects distinct `AccountNumber` where `NationalAccountFlag = 1` and `ExpirationDate > @Date`.
- **INForceListCode CTE:**  
  - Maps item IDs to account status codes (inforce, prospect, inactive).
- **BrandCode CTE:**  
  - Maps item IDs to brand names.
- **Final CTE:**  
  - Joins `RCT.Account` with the above CTEs and other tables to collect all necessary fields.
  - Applies business logic, such as:
    - If not a national account, include `UnderwriterId`.
    - Validates email fields (must contain '@').
    - Handles nulls and default values for various fields.
    - Calculates derived fields (e.g., cleans up `ContactNumber` or `ExternalUniqueId`).
    - Prepares extension fields with specific IDs for the API.
- **Final SELECT:**  
  - Filters on the specified `@LoopInstance` batch.
  - Constructs the JSON PATCH message, including all required fields and extension fields.

**Applied Transformations:**
- **Filtering:**  
  - Only accounts needing PATCH and not yet validated or sent are included.
- **Joins:**  
  - Enriches account data with national account status, brand, and account status.
- **Aggregations:**  
  - Uses `ROW_NUMBER()` for batching.
- **Field Calculations:**  
  - Conditional inclusion of underwriter ID.
  - Email validation.
  - Default values for missing data.
  - String manipulation for IDs.
- **Type Casting:**  
  - All extension fields are cast to `VARCHAR(MAX)` for JSON compatibility.

----------------------------------------------------------------------

# 4. Data Mapping

| Target Table Name | Target Column Name                 | Source Table Name                        | Source Column Name                | Remarks                                              |
|-------------------|-----------------------------------|------------------------------------------|-----------------------------------|------------------------------------------------------|
| JSON_Message      | AccountID                         | RCT.Account / RCT.AccountID / RCT.IdOverride | AccountID / RCT_ID / ExternalUniqueId | 1 to 1 mapping with fallback via COALESCE            |
| JSON_Message      | LoopInstance                      | Derived                                  | ROW_NUMBER()                      | Transformation: batch calculation                    |
| JSON_Message      | UnderwriterId                     | RCT.Account                              | UnderwriterId                     | Transformation: Only if not a National Account       |
| JSON_Message      | ExternalUniqueId                  | RCT.Account                              | ExternalUniqueId                  | 1 to 1 mapping                                      |
| JSON_Message      | Location.Address.ProvinceID       | RCT.Account                              | PrimaryLocationAddressProvinceId  | 1 to 1 mapping                                      |
| JSON_Message      | Location.Address.AddressLine      | RCT.Account                              | PrimaryLocationAddressAddressLine | 1 to 1 mapping                                      |
| JSON_Message      | Location.Address.City             | RCT.Account                              | PrimaryLocationAddressCity        | 1 to 1 mapping                                      |
| JSON_Message      | Location.Address.PostalCode       | RCT.Account                              | PrimaryLocationAddressPostalCode  | 1 to 1 mapping                                      |
| JSON_Message      | Location.Address.Longitude        | RCT.Account                              | PrimaryLocationAddressLongitude   | 1 to 1 mapping                                      |
| JSON_Message      | Location.Address.Latitude         | RCT.Account                              | PrimaryLocationAddressLatitude    | 1 to 1 mapping                                      |
| JSON_Message      | Location.Address.County           | RCT.Account                              | PrimaryLocationAddressCounty      | 1 to 1 mapping                                      |
| JSON_Message      | Location.ExternalUniqueId         | RCT.Account                              | PrimaryLocationAddressExternalUniqueId | Transformation: CAST to VARCHAR(100)           |
| JSON_Message      | Location.LocationNumber           | RCT.Account                              | PrimaryLocationAddressLocationNumber | 1 to 1 mapping                                  |
| JSON_Message      | Location.Description              | RCT.Account                              | PrimaryLocationAddressDescription | 1 to 1 mapping                                      |
| JSON_Message      | Location.AdditionalInfo           | RCT.Account                              | PrimaryLocationAddressAdditionalInfo | 1 to 1 mapping                                 |
| JSON_Message      | MailingAddress.ProvinceID         | RCT.Account                              | MailingAddressProvinceId          | 1 to 1 mapping                                      |
| JSON_Message      | MailingAddress.AddressLine        | RCT.Account                              | MailingAddressAddressLine         | 1 to 1 mapping                                      |
| JSON_Message      | MailingAddress.City               | RCT.Account                              | MailingAddressCity                | 1 to 1 mapping                                      |
| JSON_Message      | MailingAddress.PostalCode         | RCT.Account                              | MailingAddressPostalCode          | 1 to 1 mapping                                      |
| JSON_Message      | MailingAddress.Longitude          | RCT.Account                              | MailingAddressLongitude           | 1 to 1 mapping                                      |
| JSON_Message      | MailingAddress.Latitude           | RCT.Account                              | MailingAddressLatitude            | 1 to 1 mapping                                      |
| JSON_Message      | MailingAddress.County             | RCT.Account                              | MailingAddressCounty              | 1 to 1 mapping                                      |
| JSON_Message      | [11], [37], ... [168] (ExtensionFields) | RCT.Account and joined tables           | Various columns                   | Transformation: CAST, COALESCE, conditional logic    |
| JSON_Message      | Name                              | RCT.Account                              | Name                              | 1 to 1 mapping                                      |
| JSON_Message      | Phone                             | RCT.Account                              | BusinessPhone                     | 1 to 1 mapping                                      |
| JSON_Message      | Fax                               | RCT.Account                              | FaxPhone                          | 1 to 1 mapping                                      |
| JSON_Message      | Email                             | RCT.Account                              | EmailAddress                      | Validation: must contain '@'                        |
| JSON_Message      | Notes                             | RCT.Account                              | Notes                             | Transformation: CAST to VARCHAR(150)                 |
| JSON_Message      | ContactNumber                     | RCT.Account                              | ContactNumber                     | 1 to 1 mapping                                      |
| JSON_Message      | SubmissionFlag                    | RCT.Account                              | SubmissionFlag                    | 1 to 1 mapping                                      |

**Note:**  
- The extension fields `[11]` to `[168]` are mapped to various business fields, each with its own transformation logic, type casting, and validation as required by the API.

----------------------------------------------------------------------

# 5. Complexity Analysis

| Metric                  | Value    | Notes                                                                 |
|-------------------------|----------|-----------------------------------------------------------------------|
| Lines of Code (LOC)     | ~250     | Includes comments and formatting.                                     |
| Cyclomatic Complexity   | 10       | Multiple joins, CTEs, conditional logic, and JSON construction.       |
| Nesting Depth           | 3        | CTEs nested up to 3 levels.                                           |
| Tables                  | 5        | RCT.Account, EDSMART.Semantic.PolicyDescriptors, RCT.AccountID, RCT.IdOverride, plus lookup CTEs. |
| Temporary Tables        | 0        | No explicit temp tables; CTEs used instead.                           |
| DML Statements          | 1        | Single SELECT for output.                                             |
| Joins                   | 5        | LEFT JOINs in the main CTE.                                           |
| Subqueries              | 0        | All logic in CTEs, not subqueries.                                    |
| CTEs                    | 4        | NationalAccts, INForceListCode, BrandCode, Final.                     |
| Aggregation Queries     | 1        | ROW_NUMBER() used for batching.                                       |
| Input Parameters        | 1        | @LoopInstance                                                         |
| Output Parameters       | 0        | Output is via SELECT, not parameters.                                 |
| Data Transformations    | 40+      | Many fields use CAST, COALESCE, IIF, etc.                             |
| Function Calls          | 0        | No external function/procedure calls.                                 |

**Overall Complexity Score:** **60/100**  
- The procedure is moderately complex due to the number of fields, transformations, and the JSON construction logic, but is manageable for experienced SQL developers.

----------------------------------------------------------------------

# 6. Key Outputs

- **JSON_Message:**  
  - For each account in the specified batch (`@LoopInstance`), a JSON PATCH message is generated, containing:
    - Standard fields (e.g., AccountID, UnderwriterId, Address fields, Contact info).
    - Extension fields (IDs 11 to 168), each mapped to a specific business field.
    - The message is formatted for direct consumption by the PATCH API.
- **No Inserts, Updates, or Deletes** are performed by this procedure; it is read-only and generates output for API consumption.

----------------------------------------------------------------------

# 7. Error Handling and Logging

- **Error Handling:**  
  - This procedure does **not** include explicit TRY-CATCH error handling blocks.
  - There is **no logging** to error tables or retry mechanisms implemented within the procedure.
  - Any errors would be surfaced to the calling application or process.
- **Recommendation:**  
  - For production use, consider wrapping the logic in TRY-CATCH and logging errors to a designated error table for traceability.

----------------------------------------------------------------------

# Field List and Descriptions

| Field Name                          | Description                                                                 |
|-------------------------------------|-----------------------------------------------------------------------------|
| AccountID                           | Unique identifier for the account (from Account or IdOverride).             |
| LoopInstance                        | Batch number for processing (pagination).                                   |
| UnderwriterId                       | Underwriter assigned to the account (if not national account).              |
| ExternalUniqueId                    | External unique identifier for the account.                                 |
| Location.Address.ProvinceID         | Province ID of the primary location address.                                |
| Location.Address.AddressLine        | Address line of the primary location.                                       |
| Location.Address.City               | City of the primary location.                                               |
| Location.Address.PostalCode         | Postal code of the primary location.                                        |
| Location.Address.Longitude          | Longitude of the primary location.                                          |
| Location.Address.Latitude           | Latitude of the primary location.                                           |
| Location.Address.County             | County of the primary location.                                             |
| Location.ExternalUniqueId           | External unique ID for the location.                                        |
| Location.LocationNumber             | Location number.                                                            |
| Location.Description                | Description of the location.                                                |
| Location.AdditionalInfo             | Additional information for the location.                                    |
| MailingAddress.ProvinceID           | Province ID of the mailing address.                                         |
| MailingAddress.AddressLine          | Address line of the mailing address.                                        |
| MailingAddress.City                 | City of the mailing address.                                                |
| MailingAddress.PostalCode           | Postal code of the mailing address.                                         |
| MailingAddress.Longitude            | Longitude of the mailing address.                                           |
| MailingAddress.Latitude             | Latitude of the mailing address.                                            |
| MailingAddress.County               | County of the mailing address.                                              |
| [11] - [168] (ExtensionFields)      | Various business fields (e.g., policy info, scores, IDs, etc.).             |
| Name                                | Name of the account.                                                        |
| Phone                               | Business phone number.                                                      |
| Fax                                 | Fax phone number.                                                           |
| Email                               | Email address (validated to contain '@').                                   |
| Notes                               | Notes about the account (max 150 chars).                                    |
| ContactNumber                       | Contact number for the account.                                             |
| SubmissionFlag                      | Indicates if the account is a submission (0 = not submitted).               |
| JSON_Message                        | The complete PATCH message for the API.                                     |

----------------------------------------------------------------------

**This documentation provides a comprehensive breakdown of the uspAPIPatchAccount stored procedure, including its purpose, structure, data flow, mappings, complexity, outputs, and field descriptions. It is suitable for both technical and business audiences.**