-----------------------------------------------------------------
# 1. Overview of Program

**Stored Procedure Name:** `[RCT].[uspAPIPatchAccount]`  
**Purpose:**  
This stored procedure is designed to generate and return PATCH data for an API, specifically for account records that require patching in the system. It compiles and transforms account information from various tables, applies business rules, and outputs the data in a JSON PATCH format suitable for API consumption.

**Business Problem Addressed:**  
The procedure addresses the need for synchronizing and updating account information between the internal IntegrationsMart system and external systems via an API. It ensures that only validated, unsent, and relevant account records are processed, and that the data is formatted and mapped according to business requirements, including handling National Accounts, various address fields, and extension fields required by downstream consumers.

---

# 2. Code Structure and Design

**Structure and Flow:**
- **Input Parameter:** `@LoopInstance INT` (used for batch processing/pagination)
- **Variable Declaration:** `@Date` (set to yesterday's date)
- **Common Table Expressions (CTEs):**
  - `NationalAccts`: Identifies active National Accounts.
  - `INForceListCode`: Maps status codes to status names.
  - `BrandCode`: Maps brand codes to brand names.
  - `Final`: Main data selection and transformation logic, joining all sources and applying business logic.
- **Main SELECT:**  
  - Filters data for the given `@LoopInstance` and outputs a JSON PATCH message for each account.

**Primary SQL Server Components:**
- **Tables:**  
  - `RCT.Account`
  - `RCT.AccountID`
  - `RCT.IdOverride`
  - `EDSMART.Semantic.PolicyDescriptors`
- **Views:** None explicitly referenced.
- **Stored Procedures:** This code itself is a stored procedure.
- **Joins:** Multiple LEFT JOINs to enrich account data.
- **Aggregations:** Uses `ROW_NUMBER()` for pagination.
- **Subqueries:** Implemented as CTEs.
- **CTEs:** 4 CTEs (`NationalAccts`, `INForceListCode`, `BrandCode`, `Final`).

---

# 3. Data Flow and Processing Logic

## Processing Logic Data Flow Components:

### a. **NationalAccts CTE**
- **Functionality:**  
  Selects distinct `AccountNumber` values for National Accounts with `NationalAccountFlag = 1` and `ExpirationDate > @Date`.
- **Transformation:**  
  Filters and deduplicates active National Accounts.

### b. **INForceListCode CTE**
- **Functionality:**  
  Maps hardcoded status IDs to status codes (e.g., 'inforce', 'propsect', 'inactive').
- **Transformation:**  
  Static mapping for use in joins.

### c. **BrandCode CTE**
- **Functionality:**  
  Maps hardcoded brand IDs to brand names.
- **Transformation:**  
  Static mapping for use in joins.

### d. **Final CTE**
- **Functionality:**  
  Main data selection and transformation logic:
  - Joins `RCT.Account` with National Accounts, status codes, brand codes, account IDs, and ID overrides.
  - Applies business rules (e.g., only include records with `PostPatch = 'Patch'`, `Validated IS NULL`, `DateSent IS NULL`, `SubmissionFlag = 0`).
  - Calculates `LoopInstance` for pagination.
  - Applies conditional logic for fields like `UnderwriterId`.
  - Transforms and maps address and extension fields.
  - Handles email validation, null handling, and field formatting.
- **Transformations:**  
  - Conditional logic using `COALESCE`, `IIF`, and `CAST`.
  - Field formatting for JSON output.
  - Row numbering for batch processing.
  - Filtering based on business rules.

### e. **Main SELECT Statement**
- **Functionality:**  
  For each account in the current `@LoopInstance`, generates a JSON PATCH message with all required fields and extension fields.
- **Transformations:**  
  - Concatenates and formats fields into a JSON PATCH structure.
  - Handles nulls and default values.
  - Outputs a single JSON message per account.

---

# 4. Data Mapping

## Example Data Mapping Table

| Target Table Name | Target Column Name            | Source Table Name         | Source Column Name             | Remarks                                      |
|-------------------|------------------------------|--------------------------|-------------------------------|-----------------------------------------------|
| JSON_Message      | AccountID                    | RCT.Account / RCT.IdOverride | AccountID / RCT_ID         | 1 to 1 mapping with COALESCE fallback         |
| JSON_Message      | UnderwriterId                | RCT.Account              | UnderwriterId                  | Nullified if National Account                 |
| JSON_Message      | MailingAddress.ProvinceID    | RCT.Account              | MailingAddressProvinceId        | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.AddressLine   | RCT.Account              | MailingAddressAddressLine       | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.City          | RCT.Account              | MailingAddressCity              | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.PostalCode    | RCT.Account              | MailingAddressPostalCode        | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.Longitude     | RCT.Account              | MailingAddressLongitude         | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.Latitude      | RCT.Account              | MailingAddressLatitude          | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.County        | RCT.Account              | MailingAddressCounty            | 1 to 1 mapping                               |
| JSON_Message      | Name                         | RCT.Account              | Name                           | 1 to 1 mapping                               |
| JSON_Message      | Phone                        | RCT.Account              | BusinessPhone                  | 1 to 1 mapping                               |
| JSON_Message      | Fax                          | RCT.Account              | FaxPhone                       | 1 to 1 mapping                               |
| JSON_Message      | Email                        | RCT.Account              | EmailAddress                   | Validation: Only if contains '@'              |
| JSON_Message      | Notes                        | RCT.Account              | Notes                          | Transformation: Cast to varchar(150)          |
| JSON_Message      | ContactNumber                | RCT.Account              | ContactNumber                  | 1 to 1 mapping                               |
| JSON_Message      | SubmissionFlag               | RCT.Account              | SubmissionFlag                 | 1 to 1 mapping                               |
| JSON_Message      | ExtensionFields (by Id)      | RCT.Account and Joins    | Various                        | Transformation: See below                     |

**Extension Fields Mapping (Partial):**

| Target Table Name | Target Column Name | Source Table Name | Source Column Name | Remarks |
|-------------------|-------------------|-------------------|--------------------|---------|
| JSON_Message      | [11]              | INForceListCode   | ItemID             | Mapped via join to AccountStatus |
| JSON_Message      | [37]              | RCT.Account       | BDCName            | Transformation: Cast to varchar(MAX) |
| JSON_Message      | [40]              | RCT.Account       | UnderwriterEmail   | Validation: Only if contains '@' |
| JSON_Message      | [67]              | RCT.Account       | OnBaseLink         | Transformation: Cast to varchar(MAX) |
| ...               | ...               | ...               | ...                | ...     |

*(The full list of extension fields is as per the SELECT statement, with each field mapped and transformed as specified.)*

---

# 5. Complexity Analysis

| Metric                   | Value (Estimate) | Notes                                                                                   |
|--------------------------|------------------|-----------------------------------------------------------------------------------------|
| Lines of Code (LOC)      | ~220             | Including comments, CTEs, and main SELECT                                               |
| Cyclomatic Complexity    | 8                | Multiple joins, conditional logic, and CTEs                                             |
| Nesting Depth            | 3                | CTEs nested, conditional logic in SELECT                                                |
| Tables                   | 6                | RCT.Account, RCT.AccountID, RCT.IdOverride, EDSMART.Semantic.PolicyDescriptors, 2 CTEs  |
| Temporary Tables         | 0                | No #temp or @table variables                                                            |
| DML Statements           | 1                | Main SELECT (no INSERT/UPDATE/DELETE in this proc)                                      |
| Joins                    | 5                | Multiple LEFT JOINs in Final CTE                                                        |
| Subqueries               | 0                | All logic in CTEs, no nested SELECTs in SELECT list                                     |
| CTEs                     | 4                | NationalAccts, INForceListCode, BrandCode, Final                                        |
| Aggregation Queries      | 1                | Uses ROW_NUMBER() OVER (ORDER BY ...)                                                   |
| Input Parameters         | 1                | @LoopInstance                                                                           |
| Output Parameters        | 0                | None (returns result set)                                                               |
| Data Transformations     | 30+              | Multiple CAST, COALESCE, IIF, and string operations                                     |
| Function Calls           | 0                | No external function/procedure calls                                                    |

**Overall Complexity Score:** **60/100**  
- The procedure is moderately complex due to multiple joins, CTEs, and significant data transformation logic, but does not use advanced error handling, recursion, or dynamic SQL.

---

# 6. Key Outputs

- **Output:**  
  - For each account in the specified `@LoopInstance`, returns a single row with:
    - `AccountID`
    - `ContactNumber`
    - `SubmissionFlag`
    - `LoopInstance`
    - `JSON_Message`: A JSON PATCH message containing all mapped and transformed fields, ready for API PATCH operations.

- **No Inserts, Updates, or Deletes:**  
  - This procedure is read-only and does not modify any data; it only selects and transforms data for API consumption.

---

# 7. Error Handling and Logging

- **Error Handling:**  
  - **None implemented in this procedure.**
  - There are no TRY-CATCH blocks, error logging tables, or retry mechanisms present in the code.
  - All error handling is expected to be managed by the calling application or API layer.

---

# 8. Field List and Descriptions

Below is a partial list of fields used, with descriptions (as inferred from names):

| Field Name                      | Description                                              |
|----------------------------------|---------------------------------------------------------|
| AccountID                       | Unique identifier for the account                       |
| UnderwriterId                   | Underwriter assigned to the account                     |
| ExternalUniqueId                | External system unique identifier                       |
| Location.Address.ProvinceID     | Province ID of primary location                         |
| Location.Address.AddressLine    | Address line of primary location                        |
| Location.Address.City           | City of primary location                                |
| Location.Address.PostalCode     | Postal code of primary location                         |
| MailingAddress.ProvinceID       | Province ID of mailing address                          |
| MailingAddress.AddressLine      | Address line of mailing address                         |
| MailingAddress.City             | City of mailing address                                 |
| MailingAddress.PostalCode       | Postal code of mailing address                          |
| Name                            | Name of the account                                     |
| Phone                           | Business phone number                                   |
| Fax                             | Fax phone number                                        |
| Email                           | Email address (validated for '@')                       |
| Notes                           | Notes about the account                                 |
| ContactNumber                   | Account contact number                                  |
| SubmissionFlag                  | Submission status flag                                  |
| ExtensionFields (by Id)         | Additional mapped fields (see SELECT for full list)     |

*(For a full list of extension fields, refer to the SELECT statement in the Final CTE.)*

---

# 9. Summary

This stored procedure is a moderately complex data extraction and transformation process for preparing account data for PATCH operations via an API. It applies multiple business rules, joins, and transformations, and outputs a JSON PATCH message per account. The code is well-structured with CTEs and clear mapping logic, but lacks built-in error handling.

---