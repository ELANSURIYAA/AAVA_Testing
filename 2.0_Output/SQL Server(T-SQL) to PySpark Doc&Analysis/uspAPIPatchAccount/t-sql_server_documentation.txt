-------------------------------------------------------------------
# 1. Overview of Program

**Purpose:**  
The `[RCT].[uspAPIPatchAccount]` stored procedure is designed to generate PATCH data for the API integration layer. It compiles and transforms account data from various tables in the `IntegrationsMart` database, preparing it in a structured JSON format for PATCH operations via an API.

**Business Problem Being Addressed:**  
The procedure addresses the need to synchronize and update account information in downstream systems through an API PATCH operation. It ensures that only validated, unsent, and relevant account records are included, supporting business processes such as policy management, compliance, and integration with external partners.

---

# 2. Code Structure and Design

**Structure and Flow:**
- The procedure accepts one input parameter: `@LoopInstance INT`, used for batch processing.
- It declares a date variable to filter recent records.
- Defines three Common Table Expressions (CTEs): `NationalAccts`, `INForceListCode`, and `BrandCode` for lookup and filtering.
- The main CTE, `Final`, aggregates and transforms data from multiple tables using joins and applies business rules.
- The final SELECT statement generates a JSON message for each account, mapping fields and extension fields as required by the API PATCH schema.

**Primary SQL Server Components:**
- **Tables:** `RCT.Account`, `EDSMART.Semantic.PolicyDescriptors`, `RCT.AccountID`, `RCT.IdOverride`
- **Views:** Not directly referenced.
- **Stored Procedures:** This is a stored procedure.
- **Joins:** Multiple LEFT JOINs for lookups and enrichment.
- **Aggregations:** Uses `ROW_NUMBER()` for batching.
- **Subqueries:** Implemented via CTEs.
- **CTEs:** `NationalAccts`, `INForceListCode`, `BrandCode`, `Final`

---

# 3. Data Flow and Processing Logic

**Processing Logic Data Flow Components:**
1. **Parameter Initialization:**  
   - `@LoopInstance` for batch selection.
   - `@Date` for filtering active records.

2. **CTEs:**
   - **NationalAccts:** Selects distinct national account numbers with active policies.
   - **INForceListCode:** Maps status codes to item codes.
   - **BrandCode:** Maps brand codes to brand names.
   - **Final:** Main transformation CTE joining all sources, applying business logic, and preparing fields for the API.

3. **Main SELECT:**  
   - Filters for the current batch (`LoopInstance`).
   - Constructs a JSON PATCH message using concatenation and COALESCE for null handling.

**Functionality and Transformations:**
- **Filtering:** Only accounts with `PostPatch = 'Patch'`, `Validated IS NULL`, `DateSent IS NULL`, and `SubmissionFlag = 0` are processed.
- **Joins:** Enriches account data with national account status, brand, force list, and ID overrides.
- **Field Calculations:**  
  - Uses `COALESCE`, `IIF`, and `CAST` for data normalization and null handling.
  - Applies email validation (`LIKE '%@%'`) to ensure valid emails.
  - Uses `ROW_NUMBER()` for batching (`LoopInstance`).
  - Extension fields are mapped by IDs and values.
- **Business Logic:**  
  - UnderwriterId is nullified for national accounts.
  - Handles legacy and override IDs.
  - Maps and transforms multiple address, contact, and policy fields.

---

# 4. Data Mapping

| Target Table Name | Target Column Name           | Source Table Name                    | Source Column Name                | Remarks                                      |
|-------------------|-----------------------------|--------------------------------------|-----------------------------------|-----------------------------------------------|
| JSON_Message      | AccountID                   | RCT.Account / RCT.AccountID / RCT.IdOverride | AccountID / RCT_ID / AccountID    | 1 to 1 mapping with COALESCE for override     |
| JSON_Message      | LoopInstance                | Derived (ROW_NUMBER)                 | ROW_NUMBER() OVER (...)           | Transformation for batching                   |
| JSON_Message      | UnderwriterId               | RCT.Account                         | UnderwriterId                     | Nullified for national accounts (business rule)|
| JSON_Message      | MailingAddress.ProvinceID   | RCT.Account                         | MailingAddressProvinceId           | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.AddressLine  | RCT.Account                         | MailingAddressAddressLine          | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.City         | RCT.Account                         | MailingAddressCity                 | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.PostalCode   | RCT.Account                         | MailingAddressPostalCode           | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.Longitude    | RCT.Account                         | MailingAddressLongitude            | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.Latitude     | RCT.Account                         | MailingAddressLatitude             | 1 to 1 mapping                               |
| JSON_Message      | MailingAddress.County       | RCT.Account                         | MailingAddressCounty               | 1 to 1 mapping                               |
| JSON_Message      | Name                        | RCT.Account                         | Name                              | 1 to 1 mapping                               |
| JSON_Message      | Phone                       | RCT.Account                         | BusinessPhone                     | 1 to 1 mapping (renamed)                     |
| JSON_Message      | Fax                         | RCT.Account                         | FaxPhone                          | 1 to 1 mapping (renamed)                     |
| JSON_Message      | Email                       | RCT.Account                         | EmailAddress                      | Validation: Only if contains '@'              |
| JSON_Message      | Notes                       | RCT.Account                         | Notes                             | Transformation: CAST to varchar(150)          |
| JSON_Message      | ContactNumber               | RCT.Account                         | ContactNumber                     | 1 to 1 mapping                               |
| JSON_Message      | SubmissionFlag              | RCT.Account                         | SubmissionFlag                    | 1 to 1 mapping                               |
| JSON_Message      | ExtensionFields (various)   | RCT.Account + Lookups               | Multiple columns                  | Mapped by ID, transformation and validation   |
| JSON_Message      | [167]                       | RCT.Account                         | ExternalUniqueId/ContactNumber    | Transformation: Conditional REPLACE           |
| JSON_Message      | [168]                       | RCT.Account                         | WrittenLossRatio                  | 1 to 1 mapping                               |
| ...               | ...                         | ...                                  | ...                               | ...                                           |

*Note: The full mapping table would enumerate all extension fields (IDs 11, 37, 40, ..., 168) as per the code.*

---

# 5. Complexity Analysis

| Metric                  | Value           | Notes                                                                 |
|-------------------------|-----------------|-----------------------------------------------------------------------|
| Lines of Code (LOC)     | ~230            | Includes comments and code                                            |
| Cyclomatic Complexity   | 7               | Multiple joins, CTEs, conditional logic, but no deep branching        |
| Nesting Depth           | 2               | CTEs nested; no deep IF/ELSE or loops                                 |
| Tables                  | 7               | RCT.Account, RCT.AccountID, RCT.IdOverride, EDSMART.Semantic.PolicyDescriptors, plus CTEs |
| Temporary Tables        | 0               | Uses CTEs instead                                                     |
| DML Statements          | 1 SELECT        | No INSERT/UPDATE/DELETE                                               |
| Joins                   | 5               | LEFT JOINs in main CTE                                                |
| Subqueries              | 0               | All logic in CTEs                                                     |
| CTEs                    | 4               | NationalAccts, INForceListCode, BrandCode, Final                      |
| Aggregation Queries     | 1               | Uses ROW_NUMBER()                                                     |
| Input Parameters        | 1               | @LoopInstance                                                         |
| Output Parameters       | 0               | Returns result set                                                    |
| Data Transformations    | 20+             | Multiple CAST, COALESCE, IIF, REPLACE, etc.                           |
| Function Calls          | 0               | No external function/procedure calls                                  |

**Overall Complexity Score:** 48/100  
*Moderate complexity due to multiple joins, CTEs, and JSON construction, but no deep nesting or procedural logic.*

---

# 6. Key Outputs

- **Output:**  
  - A result set containing the following fields per account:
    - `AccountID`
    - `ContactNumber`
    - `SubmissionFlag`
    - `LoopInstance`
    - `JSON_Message` (the constructed JSON PATCH message for the API)
- **No Inserts, Updates, or Deletes** are performed; this is a read-only, transformation-focused procedure.

---

# 7. Error Handling and Logging

- **Error Handling:**  
  - No explicit TRY-CATCH or error handling is present in this procedure.
  - No error logging tables or retry mechanisms are implemented.
  - Assumes that any errors will be handled by the calling process or API layer.

---

# 8. Field List and Descriptions

| Field Name                        | Description                                                                                  |
|-----------------------------------|----------------------------------------------------------------------------------------------|
| AccountID                         | Unique identifier for the account (from Account, AccountID, or IdOverride)                   |
| LoopInstance                      | Batch number for processing (derived from ROW_NUMBER)                                        |
| UnderwriterId                     | Underwriter assigned to the account, null for national accounts                              |
| ExternalUniqueId                  | External unique identifier for the account                                                   |
| Location.Address.ProvinceID       | Province ID for the primary location                                                         |
| Location.Address.AddressLine      | Address line for the primary location                                                        |
| Location.Address.City             | City for the primary location                                                                |
| Location.Address.PostalCode       | Postal code for the primary location                                                         |
| Location.Address.Longitude        | Longitude for the primary location                                                           |
| Location.Address.Latitude         | Latitude for the primary location                                                            |
| Location.Address.County           | County for the primary location                                                              |
| Location.ExternalUniqueId         | External unique ID for the location                                                          |
| Location.LocationNumber           | Location number                                                                              |
| Location.Description              | Description of the location                                                                  |
| Location.AdditionalInfo           | Additional info for the location                                                             |
| MailingAddress.ProvinceID         | Province ID for the mailing address                                                          |
| MailingAddress.AddressLine        | Address line for the mailing address                                                         |
| MailingAddress.City               | City for the mailing address                                                                 |
| MailingAddress.PostalCode         | Postal code for the mailing address                                                          |
| MailingAddress.Longitude          | Longitude for the mailing address                                                            |
| MailingAddress.Latitude           | Latitude for the mailing address                                                             |
| MailingAddress.County             | County for the mailing address                                                               |
| Name                              | Account name                                                                                 |
| Phone                             | Business phone number                                                                        |
| Fax                               | Fax number                                                                                   |
| Email                             | Email address (validated to contain '@')                                                     |
| Notes                             | Notes (cast to varchar(150))                                                                 |
| ContactNumber                     | Account contact number                                                                       |
| SubmissionFlag                    | Submission flag for the account                                                              |
| ExtensionFields (IDs 11-168)      | Various extension fields mapped by ID, see mapping in code                                   |
| [167]                             | Derived field: conditional REPLACE on ExternalUniqueId or ContactNumber                      |
| [168]                             | WrittenLossRatio                                                                             |
| ...                               | ...                                                                                          |

---

**Summary:**  
This documentation provides a comprehensive breakdown of the `[RCT].[uspAPIPatchAccount]` stored procedure, including its business context, code structure, data flow, field mappings, complexity analysis, outputs, and error handling. It is suitable as both a technical specification for developers and a functional overview for business analysts.