-------------------------------------------------------------------
# 1. Overview of Program

**Purpose:**  
The stored procedure `[RCT].[uspAPIPatchAccount]` is designed to generate data for PATCH operations in an API context, specifically for accounts that require updates. The procedure retrieves and transforms account data from various tables, compiles it into a structured JSON format, and outputs it for use by downstream API consumers.

**Business Problem Addressed:**  
The business need is to synchronize and update account information in external systems via API PATCH operations. This procedure ensures only validated, unsent, and flagged accounts are considered, providing a robust mechanism for updating account records with the latest business and contact information, including extension fields for advanced attributes.

---

# 2. Code Structure and Design

**Structure:**  
- The procedure accepts one parameter: `@LoopInstance INT`.
- Several Common Table Expressions (CTEs) are defined for lookup and filtering:
  - `NationalAccts`: Identifies national accounts from `EDSMART.Semantic.PolicyDescriptors`.
  - `INForceListCode`: Maps account status codes.
  - `BrandCode`: Maps brand codes.
  - `Final`: Main CTE that aggregates and transforms account data.
- The final SELECT statement outputs account data and a JSON message for PATCH API consumption.

**Primary SQL Server Components:**
- **Tables:**
  - `RCT.Account`
  - `EDSMART.Semantic.PolicyDescriptors`
  - `[RCT].[AccountID]`
  - `RCT.IdOverride`
- **Views:** None explicitly referenced.
- **Stored Procedures:** This is the main procedure.
- **Joins:** Multiple LEFT JOINs for lookup and enrichment.
- **Aggregations:** `ROW_NUMBER()` for partitioning and loop instance calculation.
- **Subqueries:** Used within CTEs.
- **CTEs:** Four CTEs (`NationalAccts`, `INForceListCode`, `BrandCode`, `Final`).
- **Functions:** `COALESCE`, `CAST`, `IIF`, `LEN`, `REPLACE`, `DATEADD`, `GETDATE`.

---

# 3. Data Flow and Processing Logic

**Processing Logic Components:**

### a. Input Parameter
- `@LoopInstance INT`: Used to segment data for batch processing.

### b. CTEs
- **NationalAccts:**  
  - Filters accounts with `NationalAccountFlag = 1` and `ExpirationDate > yesterday`.
- **INForceListCode & BrandCode:**  
  - Static mappings for status and brand codes.
- **Final:**  
  - Joins account data with lookups.
  - Applies transformations (e.g., conditional logic for `UnderwriterId`).
  - Calculates `LoopInstance` for batching.
  - Maps and transforms fields for output.

### c. Filtering Logic
- Only accounts where:
  - `PostPatch = 'Patch'`
  - `Validated IS NULL`
  - `DateSent IS NULL`
  - `SubmissionFlag = 0`

### d. Transformations
- **Field Calculations:**
  - Many fields are cast to `VARCHAR(MAX)` for JSON compatibility.
  - Conditional logic for emails (`like '%@%'`), phone (`COALESCE`), and IDs.
  - Extension fields are mapped to numeric IDs for API consumption.
- **Aggregations:**
  - `ROW_NUMBER()` used for batch partitioning and ordering.

### e. Output Construction
- **JSON_Message:**  
  - Constructs a JSON PATCH payload using concatenated field values and extension fields.
  - Each field is mapped to its corresponding JSON path.

---

# 4. Data Mapping

| Target Table Name | Target Column Name         | Source Table Name                | Source Column Name                | Remarks                          |
|-------------------|---------------------------|----------------------------------|-----------------------------------|-----------------------------------|
| PATCH API Output  | AccountID                 | RCT.Account / RCT.IdOverride     | AccountID / RCT_ID                | 1 to 1 mapping (COALESCE)         |
| PATCH API Output  | LoopInstance              | RCT.Account                      | Calculated via ROW_NUMBER         | Transformation (batching)         |
| PATCH API Output  | UnderwriterId             | RCT.Account                      | UnderwriterId                     | Conditional (NationalAccts check) |
| PATCH API Output  | ExternalUniqueId          | RCT.Account                      | ExternalUniqueId                  | 1 to 1 mapping                    |
| PATCH API Output  | Location.Address.*        | RCT.Account                      | Various Address Fields            | 1 to 1 mapping                    |
| PATCH API Output  | MailingAddress.*          | RCT.Account                      | Various Mailing Fields            | 1 to 1 mapping                    |
| PATCH API Output  | [11], [37], ... [168]     | RCT.Account, lookups, CTEs       | Various business fields           | Transformation, mapping           |
| PATCH API Output  | Name, Phone, Fax, Email   | RCT.Account                      | Name, BusinessPhone, FaxPhone     | 1 to 1 mapping, validation        |
| PATCH API Output  | Notes                     | RCT.Account                      | Notes                            | 1 to 1 mapping, cast              |
| PATCH API Output  | ContactNumber             | RCT.Account                      | ContactNumber                     | 1 to 1 mapping                    |
| PATCH API Output  | SubmissionFlag            | RCT.Account                      | SubmissionFlag                    | 1 to 1 mapping                    |
| PATCH API Output  | JSON_Message              | Final CTE                        | Constructed from all fields       | Transformation (JSON construction)|

*Note: Each extension field ([11], [37], etc.) is mapped from a specific business or account attribute, often with casting and conditional logic.*

---

# 5. Complexity Analysis

| Metric                  | Value/Count | Remarks                                                    |
|-------------------------|------------|------------------------------------------------------------|
| Lines of Code (LOC)     | ~220       | Including comments and formatting                          |
| Cyclomatic Complexity   | ~18        | Multiple joins, conditional logic, CTEs, and output logic  |
| Nesting Depth           | 3          | CTEs nested, conditional logic in SELECT                   |
| Tables                  | 6          | RCT.Account, RCT.AccountID, RCT.IdOverride, PolicyDescriptors, BrandCode, INForceListCode |
| Temporary Tables        | 0          | Only CTEs used                                             |
| DML Statements          | 1 SELECT   | No INSERT/UPDATE/DELETE                                    |
| Joins                   | 5          | Multiple LEFT JOINs                                        |
| Subqueries              | 4          | CTEs and conditional logic                                 |
| CTEs                    | 4          | NationalAccts, INForceListCode, BrandCode, Final           |
| Aggregation Queries     | 2          | ROW_NUMBER(), COALESCE                                     |
| Input Parameters        | 1          | @LoopInstance                                              |
| Output Parameters       | 0          | Output via SELECT                                          |
| Data Transformations    | ~50        | Extensive use of CAST, COALESCE, IIF, REPLACE, LEN         |
| Function Calls          | ~10        | DATEADD, GETDATE, COALESCE, IIF, LEN, REPLACE, CAST        |

**Overall Complexity Score:** **78/100**  
- High due to extensive field mapping, JSON construction, multiple joins, and conditional logic.

---

# 6. Key Outputs

- **SELECT Statement:**  
  Outputs account data and a constructed JSON PATCH message for each account in the batch (`LoopInstance`).
- **Fields Output:**  
  - `AccountID`, `ContactNumber`, `SubmissionFlag`, `LoopInstance`
  - `JSON_Message` (PATCH payload with all mapped fields and extension fields)
- **No Inserts/Updates/Deletes:**  
  The procedure is read-only, designed for data extraction for PATCH API.

---

# 7. Error Handling and Logging

- **Error Handling:**  
  - No explicit TRY-CATCH blocks in this procedure.
  - Data validation is handled via WHERE clause filters (e.g., `Validated IS NULL`, `DateSent IS NULL`, `SubmissionFlag = 0`).
  - Conditional logic for field validity (e.g., email format, phone fallback).
- **Logging:**  
  - No explicit logging or error tables referenced.
  - The procedure relies on input data quality and filtering to prevent errors in output.
- **Retry Mechanisms:**  
  - Not implemented in this procedure; assumed to be handled by API consumer or calling process.

---

# Field Descriptions

| Field Name                        | Description                                                                 |
|-----------------------------------|-----------------------------------------------------------------------------|
| AccountID                         | Unique identifier for the account (from Account or IdOverride)              |
| LoopInstance                      | Batch number for processing (calculated)                                    |
| UnderwriterId                     | Underwriter identifier (conditional on NationalAccts)                       |
| ExternalUniqueId                  | External system unique identifier                                           |
| Location.Address.*                | Primary location address details                                            |
| MailingAddress.*                  | Mailing address details                                                     |
| [11], [37], ... [168]             | Extension fields for business attributes (see mapping above)                |
| Name                              | Account name                                                               |
| Phone                             | Business phone number                                                      |
| Fax                               | Fax number                                                                 |
| Email                             | Email address (validated)                                                  |
| Notes                             | Notes field                                                                |
| ContactNumber                     | Account contact number                                                     |
| SubmissionFlag                    | Submission status flag                                                     |
| JSON_Message                      | Constructed PATCH payload for API                                          |

---

**This documentation provides a comprehensive technical and functional overview of the `[RCT].[uspAPIPatchAccount]` procedure, enabling SQL Server developers and business analysts to understand its logic, data flow, and output structure for API PATCH operations.**