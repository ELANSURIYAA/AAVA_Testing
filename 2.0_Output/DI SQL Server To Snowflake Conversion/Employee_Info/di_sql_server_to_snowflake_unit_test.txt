=============================================
Author:        Ascendion AVA+
Created on:   
Description:   Robust Pytest suite for validating the Snowflake-compatible Employee backup script: ensures backup table creation, correct population, error handling, and compliance with Snowflake best practices.
=============================================

1. Test Case List:
   - Test ID: TC01
     Test Description: Backup table is created when Employee table exists and has rows.
     Input Data: Employee and Salary tables populated with matching EmployeeNo values.
     Expected Output: employee_bkup table exists and contains correct joined data.

   - Test ID: TC02
     Test Description: Backup table is not created when Employee table is empty.
     Input Data: Employee table is empty; Salary table may have data.
     Expected Output: employee_bkup table does not exist.

   - Test ID: TC03
     Test Description: Backup table is not created when Employee table does not exist.
     Input Data: Employee table is missing; Salary table may have data.
     Expected Output: employee_bkup table does not exist.

   - Test ID: TC04
     Test Description: Backup table is dropped if Employee table has no rows.
     Input Data: Employee table exists but has no rows; Salary table may have data.
     Expected Output: employee_bkup table does not exist.

   - Test ID: TC05
     Test Description: Backup table is populated only with employees who have matching Salary records.
     Input Data: Employee and Salary tables populated; some EmployeeNo values in Employee do not exist in Salary.
     Expected Output: employee_bkup table contains only EmployeeNo values present in both tables.

   - Test ID: TC06
     Test Description: Backup table handles NULL DepartmentNo values correctly.
     Input Data: Employee table has rows with NULL DepartmentNo; Salary table has matching EmployeeNo.
     Expected Output: employee_bkup table contains rows with NULL DepartmentNo.

   - Test ID: TC07
     Test Description: Script handles errors gracefully (e.g., Salary table missing).
     Input Data: Employee table exists and has data; Salary table does not exist.
     Expected Output: Script fails gracefully; employee_bkup table is not created.

   - Test ID: TC08
     Test Description: Script complies with Snowflake syntax and does not use unsupported features.
     Input Data: N/A (static code analysis).
     Expected Output: No syntax errors; script runs successfully in Snowflake.

   - Test ID: TC09
     Test Description: Performance: Script completes within acceptable time for large datasets.
     Input Data: Employee and Salary tables populated with large number of rows.
     Expected Output: Script completes within reasonable time; employee_bkup table is correctly populated.

2. Pytest Script for each test case

```python
import pytest
import snowflake.connector
from snowflake.connector.errors import ProgrammingError

# Helper fixtures for Snowflake connection and cleanup
@pytest.fixture(scope="module")
def snowflake_conn():
    # Replace with your Snowflake credentials/environment
    conn = snowflake.connector.connect(
        user='YOUR_USER',
        password='YOUR_PASSWORD',
        account='YOUR_ACCOUNT',
        database='YOUR_DATABASE',
        schema='YOUR_SCHEMA'
    )
    yield conn
    conn.close()

@pytest.fixture(autouse=True)
def cleanup_bkup_table(snowflake_conn):
    # Cleanup employee_bkup before and after each test
    try:
        with snowflake_conn.cursor() as cur:
            cur.execute("DROP TABLE IF EXISTS employee_bkup;")
    except ProgrammingError:
        pass
    yield
    try:
        with snowflake_conn.cursor() as cur:
            cur.execute("DROP TABLE IF EXISTS employee_bkup;")
    except ProgrammingError:
        pass

def run_script(snowflake_conn, script):
    with snowflake_conn.cursor() as cur:
        for stmt in script.split(';'):
            stmt = stmt.strip()
            if stmt:
                try:
                    cur.execute(stmt)
                except ProgrammingError as e:
                    # Allow error for test cases that expect it
                    return str(e)
    return None

# Test data setup helpers
def setup_employee_table(snowflake_conn, rows):
    with snowflake_conn.cursor() as cur:
        cur.execute("DROP TABLE IF EXISTS Employee;")
        cur.execute("""
            CREATE TABLE Employee (
                EmployeeNo INT PRIMARY KEY,
                FirstName STRING,
                LastName STRING,
                DepartmentNo SMALLINT
            );
        """)
        for row in rows:
            cur.execute(
                "INSERT INTO Employee (EmployeeNo, FirstName, LastName, DepartmentNo) VALUES (%s, %s, %s, %s);",
                (row['EmployeeNo'], row['FirstName'], row['LastName'], row['DepartmentNo'])
            )

def setup_salary_table(snowflake_conn, rows):
    with snowflake_conn.cursor() as cur:
        cur.execute("DROP TABLE IF EXISTS Salary;")
        cur.execute("""
            CREATE TABLE Salary (
                EmployeeNo INT PRIMARY KEY,
                NetPay INT
            );
        """)
        for row in rows:
            cur.execute(
                "INSERT INTO Salary (EmployeeNo, NetPay) VALUES (%s, %s);",
                (row['EmployeeNo'], row['NetPay'])
            )

# The Snowflake script under test
SNOWFLAKE_SCRIPT = """
DROP TABLE IF EXISTS employee_bkup;
CREATE TABLE employee_bkup (
    EmployeeNo INT NOT NULL PRIMARY KEY,
    FirstName STRING NOT NULL,
    LastName STRING NOT NULL,
    DepartmentNo SMALLINT,
    NetPay INT
);
BEGIN
    DECLARE employee_count INT;
    SELECT COUNT(*) INTO :employee_count FROM Employee;
    IF employee_count > 0 THEN
        INSERT INTO employee_bkup (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
        SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
        FROM Employee AS e
        INNER JOIN Salary AS s ON e.EmployeeNo = s.EmployeeNo;
    ELSE
        DROP TABLE IF EXISTS employee_bkup;
    END IF;
END;
"""

# TC01: Backup table is created when Employee table exists and has rows
def test_TC01_employee_bkup_created(snowflake_conn):
    setup_employee_table(snowflake_conn, [
        {'EmployeeNo': 1, 'FirstName': 'John', 'LastName': 'Doe', 'DepartmentNo': 10},
        {'EmployeeNo': 2, 'FirstName': 'Jane', 'LastName': 'Smith', 'DepartmentNo': 20}
    ])
    setup_salary_table(snowflake_conn, [
        {'EmployeeNo': 1, 'NetPay': 5000},
        {'EmployeeNo': 2, 'NetPay': 6000}
    ])
    run_script(snowflake_conn, SNOWFLAKE_SCRIPT)
    with snowflake_conn.cursor() as cur:
        cur.execute("SELECT * FROM employee_bkup ORDER BY EmployeeNo;")
        rows = cur.fetchall()
        assert rows == [
            (1, 'John', 'Doe', 10, 5000),
            (2, 'Jane', 'Smith', 20, 6000)
        ], "employee_bkup table should contain correct joined data"

# TC02: Backup table is not created when Employee table is empty
def test_TC02_employee_table_empty(snowflake_conn):
    setup_employee_table(snowflake_conn, [])
    setup_salary_table(snowflake_conn, [
        {'EmployeeNo': 1, 'NetPay': 5000}
    ])
    run_script(snowflake_conn, SNOWFLAKE_SCRIPT)
    with snowflake_conn.cursor() as cur:
        cur.execute("SHOW TABLES LIKE 'employee_bkup';")
        tables = cur.fetchall()
        assert len(tables) == 0, "employee_bkup table should not exist"

# TC03: Backup table is not created when Employee table does not exist
def test_TC03_employee_table_missing(snowflake_conn):
    with snowflake_conn.cursor() as cur:
        cur.execute("DROP TABLE IF EXISTS Employee;")
    setup_salary_table(snowflake_conn, [
        {'EmployeeNo': 1, 'NetPay': 5000}
    ])
    error = run_script(snowflake_conn, SNOWFLAKE_SCRIPT)
    assert "does not exist" in error or "invalid object" in error.lower(), "Script should fail gracefully if Employee table is missing"

# TC04: Backup table is dropped if Employee table has no rows
def test_TC04_employee_table_no_rows(snowflake_conn):
    setup_employee_table(snowflake_conn, [])
    setup_salary_table(snowflake_conn, [])
    run_script(snowflake_conn, SNOWFLAKE_SCRIPT)
    with snowflake_conn.cursor() as cur:
        cur.execute("SHOW TABLES LIKE 'employee_bkup';")
        tables = cur.fetchall()
        assert len(tables) == 0, "employee_bkup table should not exist"

# TC05: Backup table is populated only with employees who have matching Salary records
def test_TC05_partial_salary_match(snowflake_conn):
    setup_employee_table(snowflake_conn, [
        {'EmployeeNo': 1, 'FirstName': 'John', 'LastName': 'Doe', 'DepartmentNo': 10},
        {'EmployeeNo': 2, 'FirstName': 'Jane', 'LastName': 'Smith', 'DepartmentNo': 20},
        {'EmployeeNo': 3, 'FirstName': 'Jim', 'LastName': 'Beam', 'DepartmentNo': 30}
    ])
    setup_salary_table(snowflake_conn, [
        {'EmployeeNo': 1, 'NetPay': 5000},
        {'EmployeeNo': 2, 'NetPay': 6000}
    ])
    run_script(snowflake_conn, SNOWFLAKE_SCRIPT)
    with snowflake_conn.cursor() as cur:
        cur.execute("SELECT EmployeeNo FROM employee_bkup ORDER BY EmployeeNo;")
        rows = cur.fetchall()
        assert rows == [(1,), (2,)], "employee_bkup should only contain employees with matching Salary records"

# TC06: Backup table handles NULL DepartmentNo values correctly
def test_TC06_null_department(snowflake_conn):
    setup_employee_table(snowflake_conn, [
        {'EmployeeNo': 1, 'FirstName': 'John', 'LastName': 'Doe', 'DepartmentNo': None}
    ])
    setup_salary_table(snowflake_conn, [
        {'EmployeeNo': 1, 'NetPay': 5000}
    ])
    run_script(snowflake_conn, SNOWFLAKE_SCRIPT)
    with snowflake_conn.cursor() as cur:
        cur.execute("SELECT DepartmentNo FROM employee_bkup;")
        rows = cur.fetchall()
        assert rows == [(None,)], "employee_bkup should contain rows with NULL DepartmentNo"

# TC07: Script handles errors gracefully (e.g., Salary table missing)
def test_TC07_salary_table_missing(snowflake_conn):
    setup_employee_table(snowflake_conn, [
        {'EmployeeNo': 1, 'FirstName': 'John', 'LastName': 'Doe', 'DepartmentNo': 10}
    ])
    with snowflake_conn.cursor() as cur:
        cur.execute("DROP TABLE IF EXISTS Salary;")
    error = run_script(snowflake_conn, SNOWFLAKE_SCRIPT)
    assert "does not exist" in error or "invalid object" in error.lower(), "Script should fail gracefully if Salary table is missing"

# TC08: Script complies with Snowflake syntax and does not use unsupported features
def test_TC08_snowflake_syntax(snowflake_conn):
    # Static test: run script and ensure no syntax errors
    setup_employee_table(snowflake_conn, [
        {'EmployeeNo': 1, 'FirstName': 'John', 'LastName': 'Doe', 'DepartmentNo': 10}
    ])
    setup_salary_table(snowflake_conn, [
        {'EmployeeNo': 1, 'NetPay': 5000}
    ])
    error = run_script(snowflake_conn, SNOWFLAKE_SCRIPT)
    assert error is None, "Script should run without syntax errors in Snowflake"

# TC09: Performance: Script completes within acceptable time for large datasets
def test_TC09_performance_large_dataset(snowflake_conn):
    import time
    employee_rows = [{'EmployeeNo': i, 'FirstName': f'First{i}', 'LastName': f'Last{i}', 'DepartmentNo': i % 5} for i in range(1, 1001)]
    salary_rows = [{'EmployeeNo': i, 'NetPay': 1000 + i} for i in range(1, 1001)]
    setup_employee_table(snowflake_conn, employee_rows)
    setup_salary_table(snowflake_conn, salary_rows)
    start = time.time()
    run_script(snowflake_conn, SNOWFLAKE_SCRIPT)
    duration = time.time() - start
    assert duration < 10, f"Script should complete within 10 seconds, took {duration:.2f}s"
    with snowflake_conn.cursor() as cur:
        cur.execute("SELECT COUNT(*) FROM employee_bkup;")
        count = cur.fetchone()[0]
        assert count == 1000, "employee_bkup should contain all joined rows for large dataset"
```

3. API Cost Calculation

apiCost: 0.0025 USD