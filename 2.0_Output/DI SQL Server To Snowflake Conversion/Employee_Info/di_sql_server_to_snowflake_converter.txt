=============================================
Author:        Ascendion AVA+
Created on:   
Description:   Snowflake script to create a backup of Employee master data, keyed by EmployeeNo, for troubleshooting, comparison, and recovery use-cases.
=============================================

-- Snowflake-Compatible Query:
-- Note: Snowflake does not support procedural T-SQL constructs like TRY/CATCH, SET NOCOUNT, or USE <db>. 
-- Instead, use Snowflake scripting with error handling via EXCEPTION blocks.
-- All table names are created in the current database/schema context.
-- CHAR(30) is mapped to STRING, SMALLINT to SMALLINT, INT to INT.
-- Primary key constraint is defined inline.
-- Comments are provided for each step.

-- Step 1: Drop and recreate the backup table
DROP TABLE IF EXISTS employee_bkup;

CREATE TABLE employee_bkup (
    EmployeeNo   INT         NOT NULL PRIMARY KEY,   -- Unique Primary Index
    FirstName    STRING      NOT NULL,
    LastName     STRING      NOT NULL,
    DepartmentNo SMALLINT,
    NetPay       INT
);

-- Step 2: Check if Employee table has rows and populate backup table
-- In Snowflake, use a scripting block for conditional logic

BEGIN
    -- Variable to store row count
    DECLARE emp_count INT DEFAULT 0;

    -- Get row count from Employee table
    SELECT COUNT(*) INTO :emp_count FROM Employee;

    -- If Employee table has rows, populate backup table
    IF (:emp_count > 0) THEN
        INSERT INTO employee_bkup (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
        SELECT  e.EmployeeNo,
                e.FirstName,
                e.LastName,
                e.DepartmentNo,
                s.NetPay
        FROM    Employee AS e
        INNER JOIN Salary AS s
            ON e.EmployeeNo = s.EmployeeNo;
    ELSE
        -- If no rows, drop the backup table
        DROP TABLE IF EXISTS employee_bkup;
    END IF;
EXCEPTION
    WHEN OTHER THEN
        -- Reraise the error for troubleshooting
        -- In Snowflake, errors will propagate unless handled
        -- Optionally, you can log or handle errors here
        -- RAISE;
END;

-- Step 3: (Optional) Update statistics is not required in Snowflake; micro-partitioning and automatic optimization are handled by the platform.

-- Step 4: (Optional) Consider retention and purge policy using Snowflake's Time Travel and data retention features.

-- End of script

API Cost Calculations
apiCost: 0.002 USD