=============================================
Author:        Ascendion AVA+
Date:   
Description:   Documentation of TAMBR_RINGS.txt SAS code for generating branch-customer distance rings for TAMBr process
=============================================

## Overview of Program

The `TAMBR_RINGS.txt` SAS code is designed to generate "rings"—distance-based groupings—around bank branches for the TAMBr (Traditional, In-Store, University, Retirement Branches) process. Its primary function is to calculate the 80th percentile distance from customers to their priority and most-used branches, enabling the business to define service areas and optimize branch operations. The business problem addressed is the need to accurately identify and segment customer populations around branches for targeted marketing, resource allocation, and reporting, especially focusing on open branches of specific types and their customer engagement patterns over time.

The code integrates data from multiple sources, including customer, account, and branch information, and applies geospatial calculations to determine customer proximity to branches. It also incorporates logic to determine the "most used" branch for each customer based on recent transaction activity, replacing older, less accurate methods. The outputs are used in downstream reporting and analytics to support business decisions in branch management and customer outreach.

## Code Structure and Design

The code is structured as a sequence of SAS Data Steps, PROC SQL blocks, and macro invocations, with clear modularization for each logical processing stage. It begins with setup and macro definitions, followed by extraction and transformation of customer and branch data, geocoding, calculation of usage metrics, and finally, the computation of distance rings. The main components include:

- **Macros**: `%mdrop_mac`, `%masofdt` for table management and date handling.
- **Tables/Views**: Temporary and permanent tables for customers, branches, geocodes, and ring calculations.
- **Joins**: Extensive use of SQL joins to combine customer, account, and branch datasets.
- **Aggregations**: Summing transaction counts and amounts over a rolling 3-month window.
- **Subqueries**: Used within SQL blocks for filtering and aggregation.
- **Transformations**: Geospatial calculations (distance), percentile computations, and data cleansing (bad lat/long handling).

The flow is linear but modular, with intermediate datasets created and dropped as needed to manage memory and ensure data integrity.

## Data Flow and Processing Logic

**Processed Datasets**:  
- `tambr.cust_state_match`
- `macommon.dbm_cust_state`
- `WORK.GEO_CUSTOMER_MTH`
- `MACOMMON.&SYSUSERID._GEOCODE_WEEKLY`
- `BRANCHES`
- `rings_branch_data`
- `tambr.bad_latlong_branch`
- `branch_active`
- `most_used`
- `MACOMMON.&SYSUSERID._mu_br`
- `CUSTOMERS`
- `customers1`
- `rings_cust_data`
- `tambr.bad_latlong_cust`
- `RINGS_PRIORITY_CUST`
- `tambr.ring_priority`
- `RINGS_MOST_USED_CUST`
- `tambr.ring_most_used`
- `ring_priority2`
- `ring_most_used2`
- `branch_data2`
- `tambr.tambr_rings_&cust_occr.`

**Data Flow**:  
The process starts by copying and preparing customer-state match data, then geocoding customers using the most recent data. Branch data is extracted and filtered for relevant types, and branches with invalid geocodes are separated. Customer-branch usage is aggregated over the last three months to determine the "most used" branch for each customer. Customers and branches are then joined, and geospatial distances are calculated. The 80th percentile of these distances is computed for each branch, forming the "ring" boundaries. Final outputs merge these rings with branch metadata for reporting.

### Processing Logic Components

- **Customer-State Matching**: Copies and prepares customer-state match data for further processing.
- **Geocoding**: Combines monthly and new customer geocode data to ensure accurate latitude/longitude for all customers.
- **Branch Extraction**: Filters branches to include only open, relevant types, and separates those with invalid geocodes.
- **Most Used Branch Calculation**: Aggregates transaction data over three months to determine each customer's primary branch.
- **Customer Data Preparation**: Joins customer, account, and geocode data, filters for active accounts, and removes duplicates.
- **Distance Calculation**: Computes geospatial distances between customers and their priority/most-used branches.
- **Ring Calculation**: Uses PROC UNIVARIATE to determine the 80th percentile distance for each branch, defining the ring.
- **Final Merge and Output**: Merges ring data with branch metadata, fills missing values, and prepares the final output table.

## Data Mapping

| Target Table Name              | Target Column Name   | Source Table Name                | Source Column Name     | Remarks                                      |
|-------------------------------|---------------------|----------------------------------|-----------------------|----------------------------------------------|
| macommon.dbm_cust_state       | *                   | tambr.cust_state_match           | *                     | 1 to 1 mapping, full copy                    |
| MACOMMON.&SYSUSERID._GEOCODE_WEEKLY | LP_ID, GEO_LATITUDE, GEO_LONGITUDE, GEO_FIPS_ST_CDE, etc. | WORK.GEO_CUSTOMER_MTH, ADCOMMON.GIS_NEW_CUST_GEOCODED | LP_ID, GEO_LATITUDE, GEO_LONGITUDE, etc. | Transformation: combines and prioritizes new geocode data |
| rings_branch_data             | branchlat, branchlong, etc. | branches                        | LATITUDE_UPDT, LONGITUDE_UPDT, etc. | 1 to 1 mapping, filtered for valid geocodes  |
| tambr.bad_latlong_branch      | *                   | branches                        | *                     | Validation: branches with invalid geocodes   |
| branch_active                 | lp_id, br_id, branch_used_days_3mo, etc. | ccsi.cud_cust_detl_prim_br_mth | lp_id, br_id, DAYS_CUR_MO_WITH_TRANS_CNT, etc. | Aggregation: sums over 3 months              |
| most_used                     | lp_id, br_id        | branch_active                   | lp_id, br_id          | Transformation: selects top branch per customer |
| MACOMMON.&SYSUSERID._mu_br    | lp_id, br_id        | most_used                       | lp_id, br_id          | 1 to 1 mapping                               |
| CUSTOMERS                     | LP_ID, PRTY_BR, CUST_PRTY_ACCT_ID, etc. | CCSI.GD_CUST_INFO, CCSI.CUSTOMER, CCSI.GD_ACCT_INFO, MACOMMON.&SYSUSERID._GEOCODE_WEEKLY, MACOMMON.&SYSUSERID._mu_br | Various | Joins and transformations                   |
| rings_cust_data               | *                   | customers1                      | *                     | Validation: filters for valid geocode         |
| tambr.bad_latlong_cust        | *                   | customers1                      | *                     | Validation: invalid geocode                   |
| RINGS_PRIORITY_CUST           | LP_ID, PRTY_BR, etc.| rings_cust_data, rings_branch_data | Various              | Join: customer to priority branch             |
| tambr.ring_priority           | prty_br, prtybr80   | rings_priority_cust              | prty_br, dist_to_prty_br | Aggregation: 80th percentile distance         |
| RINGS_MOST_USED_CUST          | LP_ID, MOST_USED_BR, etc. | rings_cust_data, rings_branch_data | Various              | Join: customer to most used branch            |
| tambr.ring_most_used          | most_used_br, usedbr80 | rings_most_used_cust           | most_used_br, dist_to_used_br | Aggregation: 80th percentile distance         |
| ring_priority2                | TAMBR, priority_ring| tambr.ring_priority              | prty_br, prtybr80     | Mapping: renaming columns                     |
| ring_most_used2               | TAMBR, most_used_ring| tambr.ring_most_used            | most_used_br, usedbr80 | Mapping: renaming columns                     |
| branch_data2                  | TAMBR, branch_typ, etc. | rings_branch_data              | hgn_br_id, br_typ, etc.| Mapping: renaming columns                     |
| tambr.tambr_rings_&cust_occr. | TAMBR, priority_ring, most_used_ring, etc. | branch_data2, ring_priority2, ring_most_used2 | Various | Merge: combines all ring and branch data      |

## Complexity Analysis

| Metric                   | Value                                |
|--------------------------|--------------------------------------|
| Number of Lines          | 490                                  |
| Datasets Used            | 22                                   |
| Joins Used               | INNER JOIN, LEFT JOIN, FULL JOIN     |
| TRANSFORM Functions      | 8 (geodist, case, sum, etc.)         |
| RECORD Definitions       | 13                                   |
| OUTPUT Statements        | 10                                   |
| Conditional Logic        | 14                                   |
| Indexing and Lookups     | None (implicit via SQL GROUP BY)     |
| Function Calls           | 12 (macros, geodist, etc.)           |
| Performance Controls     | Use of temp tables, PROC SORT, PROC SQL, BULKLOAD options |
| External Dependencies    | DB2 (CCSI), MACOMMON, ADCOMMON libraries |
| Overall Complexity Score | 82                                   |

## Key Outputs

- **tambr.tambr_rings_&cust_occr.**: Final table containing each branch's 80th percentile "priority" and "most used" customer distance rings, branch metadata, and maximum distance thresholds.
- **tambr.ring_priority, tambr.ring_most_used**: Intermediate tables with percentile distances for each branch.
- **tambr.bad_latlong_branch, tambr.bad_latlong_cust**: Tables capturing records with invalid geocodes for data quality review.

These outputs directly support business reporting by defining actionable branch service areas and enabling accurate customer segmentation for marketing and resource planning.

## API Cost

API cost: 0.01 $