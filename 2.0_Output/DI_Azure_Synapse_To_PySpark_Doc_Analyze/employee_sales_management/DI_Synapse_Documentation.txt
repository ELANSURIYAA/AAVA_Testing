markdown
====================================================
Author:        Ascendion AAVA
Date:          
Description:   Documentation for the Azure Synapse stored procedure `dw.sp_load_sales_fact` that loads, validates, and transforms sales transaction data into the enterprise data warehouse.
====================================================

## 1. Overview of Pipeline/Component

The `dw.sp_load_sales_fact` stored procedure is designed to automate the ingestion, validation, transformation, and loading of sales transaction data from a staging area (`stg.Sales_Transactions`) into the enterprise data warehouse fact table (`dw.Fact_Sales`). It ensures data quality by performing validation checks, logs audit information for traceability, handles errors gracefully, and maintains data lineage by recording data quality failures. This process supports regulatory reporting, analytics, and downstream business intelligence use cases.

## 2. Component Structure and Design

This component is a SQL stored procedure executed within Azure Synapse Analytics. Its structure includes:

- **Audit Logging**: Inserts start and end audit records into `dw.Audit_Log` to track batch execution.
- **Data Quality Validation**: Creates a temporary table `#InvalidRows` to capture and process invalid records (e.g., missing customer IDs, invalid quantities).
- **Data Cleansing**: Deletes invalid records from the staging table before loading.
- **Transformation and Loading**: Transforms and loads valid records into `dw.Fact_Sales`, enriching with region and customer segment information from dimension tables.
- **Archival/Cleanup**: Truncates the staging table post-load.
- **Data Quality Failure Logging**: Logs invalid records into `dw.DQ_Failures` for traceability.
- **Error Handling**: Updates audit logs on failure and rethrows errors for pipeline monitoring.

### Key Components

- **Source**: `stg.Sales_Transactions` (staging table)
- **Transformations**: SQL CTE for enrichment and calculation
- **Lookups/Joins**: `dw.Dim_Customer`, `dw.Dim_Date`
- **Sink**: `dw.Fact_Sales` (fact table), `dw.DQ_Failures` (DQ log), `dw.Audit_Log` (audit log)
- **Parameters/Variables**: Batch ID, timestamps, row counters, error messages
- **Triggers**: Typically executed as part of an orchestrated Synapse pipeline

## 3. Data Flow and Processing Logic

### Processed Datasets

- `stg.Sales_Transactions`
- `dw.Dim_Customer`
- `dw.Dim_Date`
- `dw.Fact_Sales`
- `dw.Audit_Log`
- `dw.DQ_Failures`

### Data Flow

1. **Audit Start**: Log the start of the batch in `dw.Audit_Log`.
2. **Validation**: Identify invalid records in `stg.Sales_Transactions` (missing `Customer_ID`, non-positive `Quantity`) and store them in `#InvalidRows`.
3. **Cleanse Staging**: Remove invalid records from `stg.Sales_Transactions`.
4. **Transform & Enrich**: Join valid transactions with `dw.Dim_Customer` and `dw.Dim_Date` to enrich with region and segment data, and calculate `Total_Sales_Amount`.
5. **Load Fact Table**: Insert transformed records into `dw.Fact_Sales`.
6. **Truncate Staging**: Clear out `stg.Sales_Transactions` for next batch.
7. **Log DQ Failures**: Insert invalid records into `dw.DQ_Failures`.
8. **Audit End**: Update audit log with completion status, row counts, and messages.
9. **Error Handling**: On error, update audit log with failure status and message.

## 4. Data Mapping (Lineage)

| Target Table Name | Target Column Name    | Source Table Name      | Source Column Name    | Remarks                                                                                 |
|-------------------|----------------------|-----------------------|----------------------|-----------------------------------------------------------------------------------------|
| dw.Fact_Sales     | Transaction_ID       | stg.Sales_Transactions| Transaction_ID       | 1:1 Mapping                                                                            |
| dw.Fact_Sales     | Customer_ID          | stg.Sales_Transactions| Customer_ID          | 1:1 Mapping                                                                            |
| dw.Fact_Sales     | Product_ID           | stg.Sales_Transactions| Product_ID           | 1:1 Mapping                                                                            |
| dw.Fact_Sales     | Sales_Date           | stg.Sales_Transactions| Sales_Date           | 1:1 Mapping                                                                            |
| dw.Fact_Sales     | Quantity             | stg.Sales_Transactions| Quantity             | 1:1 Mapping                                                                            |
| dw.Fact_Sales     | Unit_Price           | stg.Sales_Transactions| Unit_Price           | 1:1 Mapping                                                                            |
| dw.Fact_Sales     | Total_Sales_Amount   | -                     | -                    | Transformation: Quantity * Unit_Price                                                  |
| dw.Fact_Sales     | Region_ID            | dw.Dim_Date           | Region_ID            | Lookup: Join on Sales_Date = Date_Value                                                |
| dw.Fact_Sales     | Customer_Segment     | dw.Dim_Customer       | Customer_Segment     | Lookup: Join on Customer_ID                                                            |
| dw.Fact_Sales     | Load_Timestamp       | -                     | -                    | Transformation: SYSDATETIME()                                                          |
| dw.Fact_Sales     | Batch_ID             | -                     | -                    | Transformation: @batch_id (unique per execution)                                       |
| dw.DQ_Failures    | Transaction_ID       | #InvalidRows          | Transaction_ID       | 1:1 Mapping (invalid records)                                                          |
| dw.DQ_Failures    | Failure_Reason       | #InvalidRows          | Reason               | 1:1 Mapping                                                                            |
| dw.DQ_Failures    | Logged_Timestamp     | -                     | -                    | Transformation: SYSDATETIME()                                                          |
| dw.DQ_Failures    | Batch_ID             | -                     | -                    | Transformation: @batch_id                                                              |
| dw.Audit_Log      | Batch_ID             | -                     | -                    | Transformation: @batch_id                                                              |
| dw.Audit_Log      | Procedure_Name       | -                     | -                    | Transformation: OBJECT_NAME(@@PROCID)                                                  |
| dw.Audit_Log      | Start_Time           | -                     | -                    | Transformation: SYSDATETIME()                                                          |
| dw.Audit_Log      | End_Time             | -                     | -                    | Transformation: SYSDATETIME()                                                          |
| dw.Audit_Log      | Rows_Inserted        | -                     | -                    | Transformation: @@ROWCOUNT after insert                                                |
| dw.Audit_Log      | Rows_Rejected        | -                     | -                    | Transformation: @@ROWCOUNT after delete                                                |
| dw.Audit_Log      | Status               | -                     | -                    | Transformation: 'STARTED', 'COMPLETED', or 'FAILED'                                    |
| dw.Audit_Log      | Message              | -                     | -                    | Transformation: Status message or error message                                        |

## 5. Transformation Logic

- **Total_Sales_Amount**: `Quantity * Unit_Price` (computed in CTE)
- **Region_ID**: Lookup from `dw.Dim_Date` using `CAST(Sales_Date AS DATE) = d.Date_Value`
- **Customer_Segment**: Lookup from `dw.Dim_Customer` using `Customer_ID`
- **Load_Timestamp**: Set to `SYSDATETIME()` at load time
- **Batch_ID**: Generated as `NEWID()` per execution
- **Validation Logic**:
    - Missing `Customer_ID`: `Customer_ID IS NULL`
    - Invalid `Quantity`: `Quantity <= 0`
- **Audit Logging**: Insert and update audit records with batch metadata, row counts, and status
- **Error Handling**: On exception, update audit log with error message and status

## 6. Complexity Analysis

| Metric                           | Value                                                                 |
|-----------------------------------|-----------------------------------------------------------------------|
| Number of Pipeline Activities     | 1 (Stored Procedure, typically orchestrated by a Synapse pipeline)    |
| Number of Dataflow Transformations| 3 (Validation, Transformation/Enrichment, Aggregation)                |
| SQL Scripts or Stored Procedures  | 1 (`dw.sp_load_sales_fact`)                                           |
| Joins Used                       | 2 (INNER JOIN: `stg.Sales_Transactions` to `dw.Dim_Customer`, `dw.Dim_Date`) |
| Lookup Tables or Reference Data   | 2 (`dw.Dim_Customer`, `dw.Dim_Date`)                                 |
| Parameters/Variables/Triggers     | 7+ (Batch ID, timestamps, row counters, error message, proc name)     |
| Number of Output Datasets         | 3 (`dw.Fact_Sales`, `dw.DQ_Failures`, `dw.Audit_Log`)                |
| Conditional Logic or if-else Flows| 2 (TRY...CATCH for error handling, validation logic)                  |
| External Dependencies             | None explicit (all within Synapse SQL DW)                             |
| Overall Complexity Score          | 35                                                                    |

## 7. Key Outputs

- **Fact Table**: `dw.Fact_Sales` — Contains validated, enriched sales transactions for analytics and reporting. Format: SQL Table.
- **Data Quality Failures**: `dw.DQ_Failures` — Logs invalid transactions for audit and remediation. Format: SQL Table.
- **Audit Log**: `dw.Audit_Log` — Tracks batch execution, row counts, and status for operational monitoring. Format: SQL Table.

These outputs are intended for downstream reporting, regulatory compliance, and business analytics.

---

**API Cost:** apiCost: 0.0025 USD