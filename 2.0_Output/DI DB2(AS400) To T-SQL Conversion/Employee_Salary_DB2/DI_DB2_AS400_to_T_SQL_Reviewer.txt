====================================================
Author:        AAVA
Date:          
Description:   Returns total salary and bonus count for a department
====================================================

1. **Summary:**
This review compares the original DB2 for i (AS/400) stored procedure for calculating department salary/bonus totals with its T-SQL conversion. The conversion is functionally accurate, with all business logic preserved. However, the T-SQL implementation uses a cursor-based approach, which is less efficient on SQL Server. Several opportunities for optimization and minor improvements are identified.

2. **Conversion Accuracy:**
- The T-SQL code accurately reflects the DB2 business logic:
  - Input/output parameters are mapped correctly.
  - Cursor logic, variable declarations, and error handling (TRY...CATCH) are properly translated.
  - Output parameters are set as in DB2.
  - Null handling is improved in T-SQL using ISNULL().
- All DB2 functionality is present in the T-SQL code.

3. **Discrepancies and Issues:**

| # | Issue Description | T-SQL Line Number | Recommendation |
|---|-------------------|-------------------|----------------|
| 1 | Cursor-based row-by-row aggregation is used instead of set-based aggregation, which is inefficient for SQL Server. | 13-33 | Refactor to use a single SELECT with SUM(ISNULL(SALARY,0)+ISNULL(BONUS,0)) and COUNT(CASE WHEN BONUS > 0 THEN 1 END) for better performance. |
| 2 | In the error handler, only @DEPT_SALARY is set to NULL; @DEPT_BONUS_CNT is not explicitly set, which may cause confusion if the procedure fails. | 36-44 | Set both output parameters to NULL in the CATCH block for clarity and consistency. |
| 3 | The error handler checks CURSOR_STATUS('global','C1') >= -1, but the cursor is declared as local. | 39 | Use CURSOR_STATUS('local','C1') for accuracy. |
| 4 | DEALLOCATE C1 is called both in normal and error paths, but if the cursor was never opened (e.g., error on OPEN), this may throw an error. | 33, 42 | Add checks for CURSOR_STATUS before CLOSE/DEALLOCATE in both paths. |
| 5 | No explicit validation of @DEPT_NUMBER input (e.g., NULL or invalid length). | 4 | Add input validation at the start of the procedure. |
| 6 | The procedure uses CHAR(3) for department number, which may cause issues with trailing spaces in comparisons. | 7, 18 | Consider using VARCHAR and/or TRIM() for comparisons. |
| 7 | No SET XACT_ABORT ON; statement, which is recommended for robust error handling in SQL Server. | 5 | Add SET XACT_ABORT ON; at the start of the procedure. |

**Example Issue Format:**
- *Issue detected at T-SQL Line 13-33: Inefficient cursor-based aggregation. Refactor to set-based aggregation for performance.*

4. **Optimization Suggestions:**
- **Replace Cursor with Set-Based Aggregation:**  
  Instead of looping with a cursor, use a single SELECT statement:
  ```sql
  SELECT 
    @DEPT_SALARY = SUM(ISNULL(SALARY,0) + ISNULL(BONUS,0)),
    @DEPT_BONUS_CNT = SUM(CASE WHEN BONUS > 0 THEN 1 ELSE 0 END)
  FROM CORPDATA.EMPLOYEE
  WHERE WORKDEPT = @DEPT_NUMBER;
  ```
  This improves performance and reduces locking and tempdb usage.  
  *Relevant to T-SQL Lines 13-33.*

- **Add Input Validation:**  
  Check for NULL or invalid @DEPT_NUMBER at the start and set outputs to NULL if invalid.  
  *Relevant to T-SQL Line 4.*

- **Improve Error Handling:**  
  Set both output parameters to NULL in the CATCH block.  
  *Relevant to T-SQL Lines 36-44.*

- **Use CURSOR_STATUS('local',...) for Local Cursors:**  
  *Relevant to T-SQL Line 39.*

- **Add SET XACT_ABORT ON;**  
  Ensures transactions are rolled back on error.  
  *Relevant to T-SQL Line 5.*

- **Indexing:**  
  Ensure an index exists on WORKDEPT for optimal performance.

5. **Overall Assessment:**
- **Score:** Good with minor revisions.
- The conversion is accurate and complete, but the cursor-based approach is suboptimal for SQL Server. Refactoring to set-based logic is highly recommended for performance and maintainability.

6. **Recommendations:**
- Refactor the T-SQL procedure to use set-based aggregation.
- Implement all suggested error handling and input validation improvements.
- Add or verify indexing on WORKDEPT.
- After refactoring, re-run all test cases to confirm correctness.
- Proceed with UAT only after optimizations and successful test results.

7. **API Cost Consumed:**
- 0.004 USD

---

**T-SQL Line Number Reference (for main procedure):**
1:  CREATE OR ALTER PROCEDURE RETURN_DEPT_SALARY
2:      @DEPT_NUMBER CHAR(3),
3:      @DEPT_SALARY DECIMAL(15,2) OUTPUT,
4:      @DEPT_BONUS_CNT INT OUTPUT
5:  AS
6:  BEGIN
7:      -- Prevents extra result sets from interfering with output parameters
8:      SET NOCOUNT ON;
9:  
10:     -- Declare local variables for employee salary and bonus
11:     DECLARE @EMPLOYEE_SALARY DECIMAL(9,2);
12:     DECLARE @EMPLOYEE_BONUS DECIMAL(9,2);
13: 
14:     -- Declare aggregation variables for total salary and bonus count
15:     DECLARE @TOTAL_SALARY DECIMAL(15,2) = 0;
16:     DECLARE @BONUS_CNT INT = 0;
17: 
18:     -- Cursor to iterate through employees in the given department
19:     DECLARE C1 CURSOR FOR
20:         SELECT SALARY, BONUS
21:         FROM CORPDATA.EMPLOYEE
22:         WHERE WORKDEPT = @DEPT_NUMBER;
23: 
24:     -- Begin TRY block for error handling (replaces DB2 HANDLERs)
25:     BEGIN TRY
26:         OPEN C1;
27: 
28:         FETCH NEXT FROM C1 INTO @EMPLOYEE_SALARY, @EMPLOYEE_BONUS;
29: 
30:         -- Loop through all fetched rows; @@FETCH_STATUS = 0 means successful fetch
31:         WHILE @@FETCH_STATUS = 0
32:         BEGIN
33:             -- Add salary and bonus to total
34:             SET @TOTAL_SALARY = @TOTAL_SALARY + ISNULL(@EMPLOYEE_SALARY,0) + ISNULL(@EMPLOYEE_BONUS,0);
35: 
36:             -- Increment bonus count if bonus is greater than zero
37:             IF @EMPLOYEE_BONUS > 0
38:                 SET @BONUS_CNT = @BONUS_CNT + 1;
39: 
40:             FETCH NEXT FROM C1 INTO @EMPLOYEE_SALARY, @EMPLOYEE_BONUS;
41:         END
42: 
43:         -- Close and deallocate the cursor
44:         CLOSE C1;
45:         DEALLOCATE C1;
46: 
47:         -- Set output parameters
48:         SET @DEPT_SALARY = @TOTAL_SALARY;
49:         SET @DEPT_BONUS_CNT = @BONUS_CNT;
50:     END TRY
51:     BEGIN CATCH
52:         -- On error, set output salary to NULL (as in DB2 EXIT HANDLER)
53:         SET @DEPT_SALARY = NULL;
54: 
55:         -- Clean up cursor if open
56:         IF CURSOR_STATUS('global','C1') >= -1
57:         BEGIN
58:             CLOSE C1;
59:             DEALLOCATE C1;
60:         END
61: 
62:         -- Optionally, re-throw or log the error using ERROR_MESSAGE() if needed
63:         -- For strict DB2 parity, only salary is set to NULL here
64:     END CATCH
65: END

---