====================================================
Author:        AAVA
Date:          
Description:   Returns total salary and bonus count for a department
====================================================

CREATE OR ALTER PROCEDURE RETURN_DEPT_SALARY
    @DEPT_NUMBER CHAR(3),
    @DEPT_SALARY DECIMAL(15,2) OUTPUT,
    @DEPT_BONUS_CNT INT OUTPUT
AS
BEGIN
    -- Prevents extra result sets from interfering with output parameters
    SET NOCOUNT ON;

    -- Declare local variables for employee salary and bonus
    DECLARE @EMPLOYEE_SALARY DECIMAL(9,2);
    DECLARE @EMPLOYEE_BONUS DECIMAL(9,2);

    -- Declare aggregation variables for total salary and bonus count
    DECLARE @TOTAL_SALARY DECIMAL(15,2) = 0;
    DECLARE @BONUS_CNT INT = 0;

    -- Cursor to iterate through employees in the given department
    DECLARE C1 CURSOR FOR
        SELECT SALARY, BONUS
        FROM CORPDATA.EMPLOYEE
        WHERE WORKDEPT = @DEPT_NUMBER;

    -- Begin TRY block for error handling (replaces DB2 HANDLERs)
    BEGIN TRY
        OPEN C1;

        FETCH NEXT FROM C1 INTO @EMPLOYEE_SALARY, @EMPLOYEE_BONUS;

        -- Loop through all fetched rows; @@FETCH_STATUS = 0 means successful fetch
        WHILE @@FETCH_STATUS = 0
        BEGIN
            -- Add salary and bonus to total
            SET @TOTAL_SALARY = @TOTAL_SALARY + ISNULL(@EMPLOYEE_SALARY,0) + ISNULL(@EMPLOYEE_BONUS,0);

            -- Increment bonus count if bonus is greater than zero
            IF @EMPLOYEE_BONUS > 0
                SET @BONUS_CNT = @BONUS_CNT + 1;

            FETCH NEXT FROM C1 INTO @EMPLOYEE_SALARY, @EMPLOYEE_BONUS;
        END

        -- Close and deallocate the cursor
        CLOSE C1;
        DEALLOCATE C1;

        -- Set output parameters
        SET @DEPT_SALARY = @TOTAL_SALARY;
        SET @DEPT_BONUS_CNT = @BONUS_CNT;
    END TRY
    BEGIN CATCH
        -- On error, set output salary to NULL (as in DB2 EXIT HANDLER)
        SET @DEPT_SALARY = NULL;

        -- Clean up cursor if open
        IF CURSOR_STATUS('global','C1') >= -1
        BEGIN
            CLOSE C1;
            DEALLOCATE C1;
        END

        -- Optionally, re-throw or log the error using ERROR_MESSAGE() if needed
        -- For strict DB2 parity, only salary is set to NULL here
    END CATCH
END

-- API cost: Estimated 1,200 tokens processed (approx. $0.0024)