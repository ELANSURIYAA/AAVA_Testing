====================================================
Author:        AAVA
Date:          
Description:   Returns total salary and bonus count for a department
====================================================

CREATE OR ALTER PROCEDURE RETURN_DEPT_SALARY
    @DEPTNO CHAR(3),                    -- Department number input
    @TOTAL_SALARY DECIMAL(9,2) OUTPUT,  -- Output: total salary for department
    @BONUS_COUNT INT OUTPUT             -- Output: count of employees with bonus > 0
AS
BEGIN
    SET NOCOUNT ON;

    -- Declare local variables for cursor processing
    DECLARE @EMP_SALARY DECIMAL(9,2);
    DECLARE @EMP_BONUS DECIMAL(9,2);

    -- Initialize output parameters
    SET @TOTAL_SALARY = 0;
    SET @BONUS_COUNT = 0;

    -- Declare cursor to select salary and bonus for employees in the given department
    DECLARE employee_cursor CURSOR FOR
        SELECT SALARY, BONUS
        FROM CORPDATA.EMPLOYEE
        WHERE WORKDEPT = @DEPTNO;

    -- Open the cursor
    OPEN employee_cursor;

    -- Fetch the first row from the cursor
    FETCH NEXT FROM employee_cursor INTO @EMP_SALARY, @EMP_BONUS;

    -- Loop through all rows fetched by the cursor
    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Add the employee's salary and bonus to the total salary
        SET @TOTAL_SALARY = @TOTAL_SALARY + ISNULL(@EMP_SALARY, 0) + ISNULL(@EMP_BONUS, 0);

        -- If the employee received a bonus greater than zero, increment the bonus count
        IF ISNULL(@EMP_BONUS, 0) > 0
        BEGIN
            SET @BONUS_COUNT = @BONUS_COUNT + 1;
        END

        -- Fetch the next row from the cursor
        FETCH NEXT FROM employee_cursor INTO @EMP_SALARY, @EMP_BONUS;
    END

    -- Close and deallocate the cursor to free resources
    CLOSE employee_cursor;
    DEALLOCATE employee_cursor;

    -- Error handling: In T-SQL, use TRY...CATCH for runtime errors
    -- (For this simple logic, errors are unlikely unless table/column missing)
    -- If needed, wrap the main logic in TRY...CATCH and set output params to NULL on error

END

-- Note: 
-- - The original DB2 HANDLERs are replaced by T-SQL's default error handling.
-- - For more robust error handling, wrap the main logic in a TRY...CATCH block.
-- - Consider refactoring to a set-based query for better performance in SQL Server.

-- API Cost: 0.004 USD