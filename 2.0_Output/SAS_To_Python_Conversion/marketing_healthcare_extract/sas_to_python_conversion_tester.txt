=============================================
Author:        Ascendion AVA+
Created on:    (Leave it empty)
Description:   Test cases and Pytest script to validate the correctness of Python code converted from marketing_healthcare_extract.sas scripts.
=============================================

### Test Case List:

#### Test Case ID: TC001
**Test case description:** Verify connection to Teradata database.
**Expected outcome:** Connection is established successfully without errors.

#### Test Case ID: TC002
**Test case description:** Validate the creation of the `marketing_extract` DataFrame.
**Expected outcome:** DataFrame is created with the correct schema and data transformations applied as per the SQL query.

#### Test Case ID: TC003
**Test case description:** Test filtering of eligible members for the campaign.
**Expected outcome:** Only members meeting the eligibility criteria are included in the final DataFrame.

#### Test Case ID: TC004
**Test case description:** Validate export of the final campaign list to a CSV file.
**Expected outcome:** CSV file is created at the specified path with the correct data.

#### Test Case ID: TC005
**Test case description:** Test handling of NULL values in the input data.
**Expected outcome:** NULL values are handled gracefully without causing errors.

#### Test Case ID: TC006
**Test case description:** Test behavior with an empty dataset.
**Expected outcome:** Functions handle the empty dataset without errors and produce appropriate outputs.

#### Test Case ID: TC007
**Test case description:** Test error handling for invalid input data formats.
**Expected outcome:** Appropriate exceptions are raised for invalid input data formats.

#### Test Case ID: TC008
**Test case description:** Test behavior when required columns are missing in the input data.
**Expected outcome:** Appropriate exceptions are raised for missing columns.

---

### Pytest Script for Each Test Case:

```python
import pytest
import pandas as pd
from sqlalchemy import create_engine
from marketing_healthcare_extract import (
    connect_to_teradata,
    create_marketing_extract,
    filter_eligible_members,
    export_final_file,
)

# Mock connection and data
@pytest.fixture
def mock_connection():
    engine = create_engine("sqlite:///:memory:")  # Use in-memory SQLite for testing
    connection = engine.connect()
    yield connection
    connection.close()

@pytest.fixture
def mock_data():
    data = {
        "member_id": [1, 2, 3],
        "member_first_name": ["John", "Jane", "Doe"],
        "member_last_name": ["Doe", "Smith", "Brown"],
        "member_age": [30, 40, 60],
        "plan_id": [101, 102, 103],
        "plan_type": ["PPO", "HMO", "EPO"],
        "region": ["WEST", "SOUTH", "EAST"],
        "plan_status": ["ACTIVE", "ACTIVE", "INACTIVE"],
        "network_type": ["IN_NETWORK", "OUT_NETWORK", "IN_NETWORK"],
    }
    return pd.DataFrame(data)

def test_connect_to_teradata(mock_connection):
    assert mock_connection is not None

def test_create_marketing_extract(mock_connection, mock_data):
    mock_data.to_sql("healthcare_plans", mock_connection, index=False, if_exists="replace")
    df = create_marketing_extract(mock_connection)
    assert not df.empty
    assert "member_id" in df.columns
    assert "is_campaign_eligible" in df.columns

def test_filter_eligible_members(mock_data):
    mock_data["is_campaign_eligible"] = [1, 0, 0]
    eligible_df = filter_eligible_members(mock_data)
    assert not eligible_df.empty
    assert all(eligible_df["is_campaign_eligible"] == 1)

def test_export_final_file(tmpdir, mock_data):
    file_path = tmpdir.join("output.csv")
    export_final_file(mock_data, file_path)
    assert file_path.check(file=1)

def test_null_values(mock_data):
    mock_data.loc[0, "member_age"] = None
    with pytest.raises(Exception):
        create_marketing_extract(mock_data)

def test_empty_dataset(mock_connection):
    empty_df = pd.DataFrame()
    with pytest.raises(Exception):
        create_marketing_extract(mock_connection)

def test_invalid_input_format():
    invalid_data = "This is not a DataFrame"
    with pytest.raises(Exception):
        filter_eligible_members(invalid_data)

def test_missing_columns(mock_data):
    mock_data.drop(columns=["member_age"], inplace=True)
    with pytest.raises(Exception):
        filter_eligible_members(mock_data)
```

---

### API Cost Consumption:
The cost consumed by the API for this call is **0.00 USD** as no external API calls were made.