====================================================
Author:        Ascendion AAVA
Date:          
Description:   Documentation for Synapse SQL Stored Procedure: LOAD_FACT_EXECUTIVE_SUMMARY
====================================================

# 1. Overview of Pipeline/Component

The provided artifact is a Synapse SQL stored procedure (`dbo.LOAD_FACT_EXECUTIVE_SUMMARY`) designed to load the `FACT_EXECUTIVE_SUMMARY` table with summarized holding metrics. It ingests data from the staging table `STG_HOLDING_METRICS`, applies business rules and data quality checks, and ensures referential integrity by joining with dimension tables. This process supports regulatory reporting, executive dashboards, and downstream analytics by providing a cleansed, integrated fact table.

# 2. Component Structure and Design

- **Component Type:** Synapse SQL Stored Procedure
- **Source:** `dbo.STG_HOLDING_METRICS` (staging table)
- **Staging:** Temporary table `#staging_metrics` created from source
- **Transformations:** Business rules applied (e.g., income amount validation)
- **Joins:** Dimension tables for referential integrity:
    - `dbo.DIM_DATE`
    - `dbo.DIM_INSTITUTION`
    - `dbo.DIM_CORPORATION`
    - `dbo.DIM_PRODUCT`
- **Sink:** `dbo.FACT_EXECUTIVE_SUMMARY` (fact table)
- **Audit Logging:** Row count of inserted records is logged
- **Cleanup:** Temporary staging table dropped after processing
- **Parameters/Variables:** Internal variables for row count and error messages
- **Triggers:** Not explicitly defined in the procedure (typically scheduled via Synapse pipeline or manual execution)

# 3. Data Flow and Processing Logic

**Processed Datasets:**
- Source: `STG_HOLDING_METRICS`
- Dimensions: `DIM_DATE`, `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`
- Output: `FACT_EXECUTIVE_SUMMARY`

**Data Flow:**
1. Extract all records from `STG_HOLDING_METRICS` into a temporary staging table.
2. For each staging record, join with dimension tables to resolve surrogate keys.
3. Apply business rules (e.g., set negative or null income amounts to zero).
4. Insert validated and enriched records into `FACT_EXECUTIVE_SUMMARY`.
5. Log the number of inserted records.
6. Drop the temporary staging table.

**Business Rules/Transformations:**
- Income amount is set to zero if null or negative.
- Only records with valid dimension keys are loaded (enforced by INNER JOINs).

# 4. Data Mapping (Lineage)

| Target Table Name        | Target Column Name      | Source Table Name      | Source Column Name      | Remarks                                            |
|-------------------------|------------------------|-----------------------|------------------------|----------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY  | date_key               | DIM_DATE              | date_key               | 1:1 Mapping via join on date_value                 |
| FACT_EXECUTIVE_SUMMARY  | institution_id         | DIM_INSTITUTION       | institution_id         | 1:1 Mapping via join                               |
| FACT_EXECUTIVE_SUMMARY  | corporation_id         | DIM_CORPORATION       | corporation_id         | 1:1 Mapping via join                               |
| FACT_EXECUTIVE_SUMMARY  | product_id             | DIM_PRODUCT           | product_id             | 1:1 Mapping via join                               |
| FACT_EXECUTIVE_SUMMARY  | a120_amount            | STG_HOLDING_METRICS   | a120_amount            | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | a120_count             | STG_HOLDING_METRICS   | a120_count             | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | a30_to_59_amount       | STG_HOLDING_METRICS   | a30_to_59_amount       | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | a30_to_59_count        | STG_HOLDING_METRICS   | a30_to_59_count        | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | a60_to_89_amount       | STG_HOLDING_METRICS   | a60_to_89_amount       | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | a60_to_89_count        | STG_HOLDING_METRICS   | a60_to_89_count        | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | a90_to_119_amount      | STG_HOLDING_METRICS   | a90_to_119_amount      | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | a90_to_119_count       | STG_HOLDING_METRICS   | a90_to_119_count       | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | charge_off_amount      | STG_HOLDING_METRICS   | charge_off_amount      | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | charge_off_count       | STG_HOLDING_METRICS   | charge_off_count       | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | fraud_amount           | STG_HOLDING_METRICS   | fraud_amount           | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | fraud_count            | STG_HOLDING_METRICS   | fraud_count            | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | income_amount          | STG_HOLDING_METRICS   | income_amount          | Transformation: Set to 0 if NULL or < 0            |
| FACT_EXECUTIVE_SUMMARY  | number_of_accounts     | STG_HOLDING_METRICS   | number_of_accounts     | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | purchases_amount       | STG_HOLDING_METRICS   | purchases_amount       | 1:1 Mapping                                        |
| FACT_EXECUTIVE_SUMMARY  | purchases_count        | STG_HOLDING_METRICS   | purchases_count        | 1:1 Mapping                                        |

# 5. Transformation Logic

- **Derived/Computed Columns:**
    - `income_amount`: 
      ```
      CASE 
          WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0
          ELSE stg.income_amount
      END AS income_amount
      ```
      *Ensures only valid, non-negative income amounts are loaded.*

- **Joins:**
    - INNER JOINs to dimension tables ensure only records with valid keys are loaded, enforcing referential integrity.

- **No UDFs or reusable templates are used in this procedure.**

# 6. Complexity Analysis

| Metric                               | Value/Details                                 |
|-------------------------------------- |-----------------------------------------------|
| Number of Pipeline Activities         | 1 (Stored Procedure)                          |
| Number of Dataflow Transformations    | 1 (income_amount transformation)              |
| SQL Scripts or Stored Procedures Used | 1 (this procedure)                            |
| Joins Used                           | 4 (INNER JOINs to dimension tables)           |
| Lookup Tables or Reference Data       | 4 (dimension tables)                          |
| Parameters/Variables/Triggers         | 2 variables, no external parameters/triggers  |
| Number of Output Datasets            | 1 (FACT_EXECUTIVE_SUMMARY)                    |
| Conditional Logic or if-else Flows    | 1 (income_amount CASE statement)              |
| External Dependencies                 | Dimension tables (DIM_DATE, etc.)             |
| Overall Complexity Score              | 25                                            |

# 7. Key Outputs

- **Output Table:** `FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse SQL Table (columnar storage, optimized for analytics)
- **Intended Use:** Executive reporting, regulatory compliance, downstream analytics, and ML model input.

# API Cost

apiCost: 0.007 USD

---
**Note:** Documentation is based solely on the provided SQL stored procedure. No pipeline/dataflow JSON or parameter files were available for review due to file read limitations.