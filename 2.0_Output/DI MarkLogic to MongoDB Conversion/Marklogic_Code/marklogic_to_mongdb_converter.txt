// MongoDB connection setup
const { MongoClient, ObjectId } = require('mongodb');
const uri = 'mongodb://localhost:27017';
const dbName = 'exampleDB';
const collectionName = 'documents';

async function main() {
  const client = new MongoClient(uri);
  try {
    await client.connect();
    const db = client.db(dbName);
    const collection = db.collection(collectionName);

    // Load Documents (equivalent to ns:load-documents)
    async function loadDocuments() {
      // Assuming doc1 and doc2 are identified by their URIs
      const docs = await collection.find({
        uri: { $in: ['/documents/doc1.xml', '/documents/doc2.xml'] }
      }).toArray();
      return docs;
    }

    // Insert Document (equivalent to ns:insert-document)
    async function insertDocument(uri, content) {
      const doc = {
        uri,
        content,
        // You can add a namespace field if needed
        namespace: "http://example.com/ns"
      };
      await collection.insertOne(doc);
      return doc;
    }

    // Search Documents (equivalent to ns:search-documents)
    async function searchDocuments(keyword) {
      // Simple text search in the 'content' field
      const results = await collection.find({
        content: { $regex: keyword, $options: 'i' }
      }).toArray();
      return results;
    }

    // Update Document (equivalent to ns:update-document)
    async function updateDocument(uri, newContent) {
      const result = await collection.updateOne(
        { uri },
        { $set: { content: newContent } }
      );
      return result;
    }

    // Delete Document (equivalent to ns:delete-document)
    async function deleteDocument(uri) {
      const result = await collection.deleteOne({ uri });
      return result;
    }

    // Query Example (equivalent to ns:query-example)
    async function queryExample() {
      const uri = "/examples/sample.xml";
      // Insert a sample document
      await insertDocument(uri, "Learning MarkLogic query language");
      // Search for documents containing "Learning"
      const results = await searchDocuments("Learning");
      return {
        insertedDocumentUri: uri,
        searchResults: results.map(doc => doc.uri)
      };
    }

    // Main function (equivalent to ns:main)
    async function runAll() {
      const loadResult = await loadDocuments();
      const insertResult = await insertDocument("/documents/newdoc.xml", "This is a new document");
      const updateResult = await updateDocument("/documents/doc1.xml", "Updated content here");
      const searchResult = await searchDocuments("example");
      const deleteResult = await deleteDocument("/documents/doc2.xml");
      const queryResult = await queryExample();

      return {
        loadedDocuments: loadResult,
        insertedNewDocument: insertResult,
        updatedDocument: updateResult,
        searchResults: searchResult,
        deletedDocument: deleteResult,
        queryExample: queryResult
      };
    }

    // Run all operations
    const results = await runAll();
    console.log(JSON.stringify(results, null, 2));

  } finally {
    await client.close();
  }
}

main().catch(console.error);