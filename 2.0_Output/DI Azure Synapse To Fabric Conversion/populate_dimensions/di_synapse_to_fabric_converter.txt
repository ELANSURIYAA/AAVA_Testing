Metadata Header:
=============================================
Author:      Ascendion  AAVA
Created on:   
Description:   Converts Azure Synapse stored procedure logic for dimension table population (DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) into Microsoft Fabric SQL code using Delta Lake operations. Ensures idempotent loads, applies data quality filters, and optimizes for Fabric execution.
=============================================

-- Fabric SQL Script: Populate Dimension Tables from Staging Layer

-- This script loads and maintains DIM_INSTITUTION, DIM_CORPORATION, and DIM_PRODUCT tables
-- from the STG_DIMENSION_DATA staging table using Delta Lake MERGE operations.
-- Data quality filters are applied to exclude invalid and test/legacy data.

-- ===========================================
-- 1. Populate DIM_INSTITUTION
-- ===========================================

MERGE INTO lakehouse.DIM_INSTITUTION AS target
USING (
    SELECT DISTINCT 
        institution_id, 
        institution, 
        institution_name
    FROM lakehouse.STG_DIMENSION_DATA
    WHERE institution_id IS NOT NULL 
      AND LEN(institution_id) > 3
) AS source
ON target.institution_id = source.institution_id
WHEN NOT MATCHED THEN
    INSERT (institution_id, institution, institution_name)
    VALUES (source.institution_id, source.institution, source.institution_name);

-- ===========================================
-- 2. Populate DIM_CORPORATION
-- ===========================================

MERGE INTO lakehouse.DIM_CORPORATION AS target
USING (
    SELECT DISTINCT 
        corporation_id, 
        corp_id, 
        corporation, 
        corporation_name,
        sub_corporation, 
        sub_corporation_id, 
        sub_corporation_name,
        master_corporation_dim_key, 
        association, 
        bin, 
        company,
        company_id, 
        company_name
    FROM lakehouse.STG_DIMENSION_DATA
    WHERE UPPER(corporation_name) NOT LIKE 'TEST%'
) AS source
ON target.corporation_id = source.corporation_id
WHEN NOT MATCHED THEN
    INSERT (
        corporation_id, corp_id, corporation, corporation_name,
        sub_corporation, sub_corporation_id, sub_corporation_name,
        master_corporation_dim_key, association, bin, company, 
        company_id, company_name
    )
    VALUES (
        source.corporation_id, source.corp_id, source.corporation, 
        source.corporation_name, source.sub_corporation, 
        source.sub_corporation_id, source.sub_corporation_name,
        source.master_corporation_dim_key, source.association, 
        source.bin, source.company, source.company_id, source.company_name
    );

-- ===========================================
-- 3. Populate DIM_PRODUCT
-- ===========================================

MERGE INTO lakehouse.DIM_PRODUCT AS target
USING (
    SELECT DISTINCT 
        product_id, 
        product, 
        product_description,
        sub_product, 
        processing_code,
        processing_code_description, 
        processing_group
    FROM lakehouse.STG_DIMENSION_DATA
    WHERE processing_group NOT IN ('DEPRECATED', 'LEGACY')
) AS source
ON target.product_id = source.product_id
WHEN NOT MATCHED THEN
    INSERT (
        product_id, product, product_description, sub_product,
        processing_code, processing_code_description, processing_group
    )
    VALUES (
        source.product_id, source.product, source.product_description, 
        source.sub_product, source.processing_code, 
        source.processing_code_description, source.processing_group
    );

-- ===========================================
-- End of Script
-- ===========================================

-- Notes:
-- - Replace "lakehouse" with your actual schema/database name if different.
-- - All operations use Delta Lake transactional semantics for idempotent loads.
-- - Data quality filters and business logic are preserved from the original Synapse procedure.
-- - No PRINT statements; use Fabric logging or notebook cells for operational messages.

API Cost Consumed in dollars: 0.0047 USD