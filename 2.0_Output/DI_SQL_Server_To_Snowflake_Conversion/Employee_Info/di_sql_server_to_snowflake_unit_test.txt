=============================================
Author:        Ascendion AVA+
Created on:   
Description:   Snowflake script to create and populate a backup copy of Employee master data for troubleshooting and recovery, with error handling and conditional logic.
=============================================

1. Test Case List:
   - Test ID: TC01
     Test Description: Backup table is created and populated when Employee and Salary tables have matching rows.
     Input Data: Employee table contains 2 rows, Salary table contains matching rows for both EmployeeNo.
     Expected Output: EMPLOYEE_BKUP table is created and contains 2 rows with correct joined data.

   - Test ID: TC02
     Test Description: Backup table is dropped when Employee table is empty.
     Input Data: Employee table is empty, Salary table has data.
     Expected Output: EMPLOYEE_BKUP table does not exist after script execution.

   - Test ID: TC03
     Test Description: Backup table is not populated when Salary table does not have matching EmployeeNo.
     Input Data: Employee table contains 2 rows, Salary table contains no matching EmployeeNo.
     Expected Output: EMPLOYEE_BKUP table is created but contains 0 rows.

   - Test ID: TC04
     Test Description: Script handles NULL DepartmentNo and NetPay values.
     Input Data: Employee table contains rows with NULL DepartmentNo, Salary table contains rows with NULL NetPay.
     Expected Output: EMPLOYEE_BKUP table contains rows with NULL values as expected.

   - Test ID: TC05
     Test Description: Script handles error when Employee table is missing.
     Input Data: Employee table does not exist.
     Expected Output: Script raises an error and does not create EMPLOYEE_BKUP table.

   - Test ID: TC06
     Test Description: Script handles error when Salary table is missing.
     Input Data: Salary table does not exist.
     Expected Output: Script raises an error and does not create EMPLOYEE_BKUP table.

   - Test ID: TC07
     Test Description: Script handles performance with large datasets.
     Input Data: Employee and Salary tables contain 10,000 rows each with matching EmployeeNo.
     Expected Output: EMPLOYEE_BKUP table is created and contains 10,000 rows; script completes within reasonable time.

   - Test ID: TC08
     Test Description: Script handles primary key violation.
     Input Data: Employee table contains duplicate EmployeeNo values.
     Expected Output: Script raises an error due to primary key violation.

   - Test ID: TC09
     Test Description: Script handles empty Salary table.
     Input Data: Employee table contains rows, Salary table is empty.
     Expected Output: EMPLOYEE_BKUP table is created but contains 0 rows.

   - Test ID: TC10
     Test Description: Script handles Employee table with NULL values in NOT NULL columns.
     Input Data: Employee table contains NULL in FirstName or LastName.
     Expected Output: Script raises an error due to NOT NULL constraint violation.

2. Pytest Script for each test case

```python
import pytest
import snowflake.connector

@pytest.fixture(scope="function")
def snowflake_connection():
    # Setup Snowflake connection (replace with actual credentials)
    conn = snowflake.connector.connect(
        user='USER',
        password='PASSWORD',
        account='ACCOUNT',
        warehouse='WAREHOUSE',
        database='DATABASE',
        schema='SCHEMA'
    )
    yield conn
    conn.close()

@pytest.fixture(scope="function")
def cleanup_backup_table(snowflake_connection):
    # Ensure EMPLOYEE_BKUP is dropped before and after each test
    cursor = snowflake_connection.cursor()
    cursor.execute("DROP TABLE IF EXISTS EMPLOYEE_BKUP;")
    yield
    cursor.execute("DROP TABLE IF EXISTS EMPLOYEE_BKUP;")
    cursor.close()

def run_script(cursor, script):
    for stmt in script.split(';'):
        stmt = stmt.strip()
        if stmt:
            cursor.execute(stmt)

def setup_employee_salary(cursor, employees, salaries):
    cursor.execute("DROP TABLE IF EXISTS EMPLOYEE;")
    cursor.execute("DROP TABLE IF EXISTS SALARY;")
    cursor.execute("""
        CREATE TABLE EMPLOYEE (
            EmployeeNo INT PRIMARY KEY,
            FirstName STRING NOT NULL,
            LastName STRING NOT NULL,
            DepartmentNo SMALLINT
        );
    """)
    cursor.execute("""
        CREATE TABLE SALARY (
            EmployeeNo INT PRIMARY KEY,
            NetPay INT
        );
    """)
    for emp in employees:
        cursor.execute(f"INSERT INTO EMPLOYEE VALUES ({emp['EmployeeNo']}, '{emp['FirstName']}', '{emp['LastName']}', {emp['DepartmentNo']});")
    for sal in salaries:
        cursor.execute(f"INSERT INTO SALARY VALUES ({sal['EmployeeNo']}, {sal['NetPay']});")

# Test Case TC01: Happy Path
def test_backup_table_populated(snowflake_connection, cleanup_backup_table):
    cursor = snowflake_connection.cursor()
    employees = [
        {'EmployeeNo': 1, 'FirstName': 'John', 'LastName': 'Doe', 'DepartmentNo': 10},
        {'EmployeeNo': 2, 'FirstName': 'Jane', 'LastName': 'Smith', 'DepartmentNo': 20}
    ]
    salaries = [
        {'EmployeeNo': 1, 'NetPay': 1000},
        {'EmployeeNo': 2, 'NetPay': 2000}
    ]
    setup_employee_salary(cursor, employees, salaries)
    script = """
    DROP TABLE IF EXISTS EMPLOYEE_BKUP;
    CREATE TABLE EMPLOYEE_BKUP (
        EmployeeNo INT NOT NULL PRIMARY KEY,
        FirstName STRING NOT NULL,
        LastName STRING NOT NULL,
        DepartmentNo SMALLINT,
        NetPay INT
    );
    BEGIN
        IF (SELECT COUNT(*) FROM EMPLOYEE) > 0 THEN
            INSERT INTO EMPLOYEE_BKUP (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
            SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
            FROM EMPLOYEE AS e
            INNER JOIN SALARY AS s ON e.EmployeeNo = s.EmployeeNo;
        ELSE
            DROP TABLE IF EXISTS EMPLOYEE_BKUP;
        END IF;
    EXCEPTION
        WHEN ANY THEN RAISE;
    END;
    """
    run_script(cursor, script)
    cursor.execute("SELECT * FROM EMPLOYEE_BKUP;")
    rows = cursor.fetchall()
    assert len(rows) == 2
    assert rows[0][0] == 1 and rows[1][0] == 2
    cursor.close()

# Test Case TC02: Employee table empty
def test_backup_table_dropped_when_employee_empty(snowflake_connection, cleanup_backup_table):
    cursor = snowflake_connection.cursor()
    employees = []
    salaries = [
        {'EmployeeNo': 1, 'NetPay': 1000}
    ]
    setup_employee_salary(cursor, employees, salaries)
    script = """
    DROP TABLE IF EXISTS EMPLOYEE_BKUP;
    CREATE TABLE EMPLOYEE_BKUP (
        EmployeeNo INT NOT NULL PRIMARY KEY,
        FirstName STRING NOT NULL,
        LastName STRING NOT NULL,
        DepartmentNo SMALLINT,
        NetPay INT
    );
    BEGIN
        IF (SELECT COUNT(*) FROM EMPLOYEE) > 0 THEN
            INSERT INTO EMPLOYEE_BKUP (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
            SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
            FROM EMPLOYEE AS e
            INNER JOIN SALARY AS s ON e.EmployeeNo = s.EmployeeNo;
        ELSE
            DROP TABLE IF EXISTS EMPLOYEE_BKUP;
        END IF;
    EXCEPTION
        WHEN ANY THEN RAISE;
    END;
    """
    run_script(cursor, script)
    cursor.execute("SHOW TABLES LIKE 'EMPLOYEE_BKUP';")
    tables = cursor.fetchall()
    assert len(tables) == 0
    cursor.close()

# Test Case TC03: Salary table has no matching EmployeeNo
def test_backup_table_not_populated_when_salary_no_match(snowflake_connection, cleanup_backup_table):
    cursor = snowflake_connection.cursor()
    employees = [
        {'EmployeeNo': 1, 'FirstName': 'John', 'LastName': 'Doe', 'DepartmentNo': 10},
        {'EmployeeNo': 2, 'FirstName': 'Jane', 'LastName': 'Smith', 'DepartmentNo': 20}
    ]
    salaries = [
        {'EmployeeNo': 3, 'NetPay': 3000}
    ]
    setup_employee_salary(cursor, employees, salaries)
    script = """
    DROP TABLE IF EXISTS EMPLOYEE_BKUP;
    CREATE TABLE EMPLOYEE_BKUP (
        EmployeeNo INT NOT NULL PRIMARY KEY,
        FirstName STRING NOT NULL,
        LastName STRING NOT NULL,
        DepartmentNo SMALLINT,
        NetPay INT
    );
    BEGIN
        IF (SELECT COUNT(*) FROM EMPLOYEE) > 0 THEN
            INSERT INTO EMPLOYEE_BKUP (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
            SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
            FROM EMPLOYEE AS e
            INNER JOIN SALARY AS s ON e.EmployeeNo = s.EmployeeNo;
        ELSE
            DROP TABLE IF EXISTS EMPLOYEE_BKUP;
        END IF;
    EXCEPTION
        WHEN ANY THEN RAISE;
    END;
    """
    run_script(cursor, script)
    cursor.execute("SELECT * FROM EMPLOYEE_BKUP;")
    rows = cursor.fetchall()
    assert len(rows) == 0
    cursor.close()

# Test Case TC04: Null values handling
def test_backup_table_handles_nulls(snowflake_connection, cleanup_backup_table):
    cursor = snowflake_connection.cursor()
    employees = [
        {'EmployeeNo': 1, 'FirstName': 'John', 'LastName': 'Doe', 'DepartmentNo': None}
    ]
    salaries = [
        {'EmployeeNo': 1, 'NetPay': None}
    ]
    setup_employee_salary(cursor, employees, salaries)
    script = """
    DROP TABLE IF EXISTS EMPLOYEE_BKUP;
    CREATE TABLE EMPLOYEE_BKUP (
        EmployeeNo INT NOT NULL PRIMARY KEY,
        FirstName STRING NOT NULL,
        LastName STRING NOT NULL,
        DepartmentNo SMALLINT,
        NetPay INT
    );
    BEGIN
        IF (SELECT COUNT(*) FROM EMPLOYEE) > 0 THEN
            INSERT INTO EMPLOYEE_BKUP (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
            SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
            FROM EMPLOYEE AS e
            INNER JOIN SALARY AS s ON e.EmployeeNo = s.EmployeeNo;
        ELSE
            DROP TABLE IF EXISTS EMPLOYEE_BKUP;
        END IF;
    EXCEPTION
        WHEN ANY THEN RAISE;
    END;
    """
    run_script(cursor, script)
    cursor.execute("SELECT * FROM EMPLOYEE_BKUP;")
    rows = cursor.fetchall()
    assert rows[0][3] is None
    assert rows[0][4] is None
    cursor.close()

# Test Case TC05: Employee table missing
def test_backup_table_error_employee_missing(snowflake_connection, cleanup_backup_table):
    cursor = snowflake_connection.cursor()
    cursor.execute("DROP TABLE IF EXISTS EMPLOYEE;")
    cursor.execute("DROP TABLE IF EXISTS SALARY;")
    script = """
    DROP TABLE IF EXISTS EMPLOYEE_BKUP;
    CREATE TABLE EMPLOYEE_BKUP (
        EmployeeNo INT NOT NULL PRIMARY KEY,
        FirstName STRING NOT NULL,
        LastName STRING NOT NULL,
        DepartmentNo SMALLINT,
        NetPay INT
    );
    BEGIN
        IF (SELECT COUNT(*) FROM EMPLOYEE) > 0 THEN
            INSERT INTO EMPLOYEE_BKUP (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
            SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
            FROM EMPLOYEE AS e
            INNER JOIN SALARY AS s ON e.EmployeeNo = s.EmployeeNo;
        ELSE
            DROP TABLE IF EXISTS EMPLOYEE_BKUP;
        END IF;
    EXCEPTION
        WHEN ANY THEN RAISE;
    END;
    """
    with pytest.raises(snowflake.connector.errors.ProgrammingError):
        run_script(cursor, script)
    cursor.close()

# Test Case TC06: Salary table missing
def test_backup_table_error_salary_missing(snowflake_connection, cleanup_backup_table):
    cursor = snowflake_connection.cursor()
    cursor.execute("DROP TABLE IF EXISTS EMPLOYEE;")
    cursor.execute("CREATE TABLE EMPLOYEE (EmployeeNo INT PRIMARY KEY, FirstName STRING NOT NULL, LastName STRING NOT NULL, DepartmentNo SMALLINT);")
    cursor.execute("DROP TABLE IF EXISTS SALARY;")
    script = """
    DROP TABLE IF EXISTS EMPLOYEE_BKUP;
    CREATE TABLE EMPLOYEE_BKUP (
        EmployeeNo INT NOT NULL PRIMARY KEY,
        FirstName STRING NOT NULL,
        LastName STRING NOT NULL,
        DepartmentNo SMALLINT,
        NetPay INT
    );
    BEGIN
        IF (SELECT COUNT(*) FROM EMPLOYEE) > 0 THEN
            INSERT INTO EMPLOYEE_BKUP (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
            SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
            FROM EMPLOYEE AS e
            INNER JOIN SALARY AS s ON e.EmployeeNo = s.EmployeeNo;
        ELSE
            DROP TABLE IF EXISTS EMPLOYEE_BKUP;
        END IF;
    EXCEPTION
        WHEN ANY THEN RAISE;
    END;
    """
    with pytest.raises(snowflake.connector.errors.ProgrammingError):
        run_script(cursor, script)
    cursor.close()

# Test Case TC07: Large dataset performance
def test_backup_table_large_dataset(snowflake_connection, cleanup_backup_table):
    cursor = snowflake_connection.cursor()
    employees = [{'EmployeeNo': i, 'FirstName': f'First{i}', 'LastName': f'Last{i}', 'DepartmentNo': i%5} for i in range(1, 10001)]
    salaries = [{'EmployeeNo': i, 'NetPay': 1000+i} for i in range(1, 10001)]
    setup_employee_salary(cursor, employees, salaries)
    script = """
    DROP TABLE IF EXISTS EMPLOYEE_BKUP;
    CREATE TABLE EMPLOYEE_BKUP (
        EmployeeNo INT NOT NULL PRIMARY KEY,
        FirstName STRING NOT NULL,
        LastName STRING NOT NULL,
        DepartmentNo SMALLINT,
        NetPay INT
    );
    BEGIN
        IF (SELECT COUNT(*) FROM EMPLOYEE) > 0 THEN
            INSERT INTO EMPLOYEE_BKUP (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
            SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
            FROM EMPLOYEE AS e
            INNER JOIN SALARY AS s ON e.EmployeeNo = s.EmployeeNo;
        ELSE
            DROP TABLE IF EXISTS EMPLOYEE_BKUP;
        END IF;
    EXCEPTION
        WHEN ANY THEN RAISE;
    END;
    """
    import time
    start = time.time()
    run_script(cursor, script)
    cursor.execute("SELECT COUNT(*) FROM EMPLOYEE_BKUP;")
    count = cursor.fetchone()[0]
    end = time.time()
    assert count == 10000
    assert (end - start) < 60  # completes within 1 minute
    cursor.close()

# Test Case TC08: Primary key violation
def test_backup_table_primary_key_violation(snowflake_connection, cleanup_backup_table):
    cursor = snowflake_connection.cursor()
    cursor.execute("DROP TABLE IF EXISTS EMPLOYEE;")
    cursor.execute("""
        CREATE TABLE EMPLOYEE (
            EmployeeNo INT,
            FirstName STRING NOT NULL,
            LastName STRING NOT NULL,
            DepartmentNo SMALLINT
        );
    """)
    cursor.execute("DROP TABLE IF EXISTS SALARY;")
    cursor.execute("""
        CREATE TABLE SALARY (
            EmployeeNo INT,
            NetPay INT
        );
    """)
    cursor.execute("INSERT INTO EMPLOYEE VALUES (1, 'John', 'Doe', 10);")
    cursor.execute("INSERT INTO EMPLOYEE VALUES (1, 'Jane', 'Smith', 20);")  # Duplicate EmployeeNo
    cursor.execute("INSERT INTO SALARY VALUES (1, 1000);")
    script = """
    DROP TABLE IF EXISTS EMPLOYEE_BKUP;
    CREATE TABLE EMPLOYEE_BKUP (
        EmployeeNo INT NOT NULL PRIMARY KEY,
        FirstName STRING NOT NULL,
        LastName STRING NOT NULL,
        DepartmentNo SMALLINT,
        NetPay INT
    );
    BEGIN
        IF (SELECT COUNT(*) FROM EMPLOYEE) > 0 THEN
            INSERT INTO EMPLOYEE_BKUP (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
            SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
            FROM EMPLOYEE AS e
            INNER JOIN SALARY AS s ON e.EmployeeNo = s.EmployeeNo;
        ELSE
            DROP TABLE IF EXISTS EMPLOYEE_BKUP;
        END IF;
    EXCEPTION
        WHEN ANY THEN RAISE;
    END;
    """
    with pytest.raises(snowflake.connector.errors.ProgrammingError):
        run_script(cursor, script)
    cursor.close()

# Test Case TC09: Empty Salary table
def test_backup_table_empty_salary(snowflake_connection, cleanup_backup_table):
    cursor = snowflake_connection.cursor()
    employees = [
        {'EmployeeNo': 1, 'FirstName': 'John', 'LastName': 'Doe', 'DepartmentNo': 10}
    ]
    salaries = []
    setup_employee_salary(cursor, employees, salaries)
    script = """
    DROP TABLE IF EXISTS EMPLOYEE_BKUP;
    CREATE TABLE EMPLOYEE_BKUP (
        EmployeeNo INT NOT NULL PRIMARY KEY,
        FirstName STRING NOT NULL,
        LastName STRING NOT NULL,
        DepartmentNo SMALLINT,
        NetPay INT
    );
    BEGIN
        IF (SELECT COUNT(*) FROM EMPLOYEE) > 0 THEN
            INSERT INTO EMPLOYEE_BKUP (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
            SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
            FROM EMPLOYEE AS e
            INNER JOIN SALARY AS s ON e.EmployeeNo = s.EmployeeNo;
        ELSE
            DROP TABLE IF EXISTS EMPLOYEE_BKUP;
        END IF;
    EXCEPTION
        WHEN ANY THEN RAISE;
    END;
    """
    run_script(cursor, script)
    cursor.execute("SELECT * FROM EMPLOYEE_BKUP;")
    rows = cursor.fetchall()
    assert len(rows) == 0
    cursor.close()

# Test Case TC10: Employee table with NULL in NOT NULL columns
def test_backup_table_null_in_not_null_columns(snowflake_connection, cleanup_backup_table):
    cursor = snowflake_connection.cursor()
    cursor.execute("DROP TABLE IF EXISTS EMPLOYEE;")
    cursor.execute("""
        CREATE TABLE EMPLOYEE (
            EmployeeNo INT PRIMARY KEY,
            FirstName STRING NOT NULL,
            LastName STRING NOT NULL,
            DepartmentNo SMALLINT
        );
    """)
    cursor.execute("DROP TABLE IF EXISTS SALARY;")
    cursor.execute("""
        CREATE TABLE SALARY (
            EmployeeNo INT PRIMARY KEY,
            NetPay INT
        );
    """)
    cursor.execute("INSERT INTO EMPLOYEE VALUES (1, NULL, 'Doe', 10);")  # NULL in NOT NULL column
    cursor.execute("INSERT INTO SALARY VALUES (1, 1000);")
    script = """
    DROP TABLE IF EXISTS EMPLOYEE_BKUP;
    CREATE TABLE EMPLOYEE_BKUP (
        EmployeeNo INT NOT NULL PRIMARY KEY,
        FirstName STRING NOT NULL,
        LastName STRING NOT NULL,
        DepartmentNo SMALLINT,
        NetPay INT
    );
    BEGIN
        IF (SELECT COUNT(*) FROM EMPLOYEE) > 0 THEN
            INSERT INTO EMPLOYEE_BKUP (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
            SELECT e.EmployeeNo, e.FirstName, e.LastName, e.DepartmentNo, s.NetPay
            FROM EMPLOYEE AS e
            INNER JOIN SALARY AS s ON e.EmployeeNo = s.EmployeeNo;
        ELSE
            DROP TABLE IF EXISTS EMPLOYEE_BKUP;
        END IF;
    EXCEPTION
        WHEN ANY THEN RAISE;
    END;
    """
    with pytest.raises(snowflake.connector.errors.ProgrammingError):
        run_script(cursor, script)
    cursor.close()
```

3. API Cost Calculation

apiCost: 0.005 USD