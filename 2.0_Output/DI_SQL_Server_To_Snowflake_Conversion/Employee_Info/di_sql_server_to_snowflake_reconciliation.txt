=============================================
Author:        Ascendion AVA+
Created on:   
Description:   Python script to automate Teradata-to-Snowflake migration validation for Employee backup logic, comparing outputs, handling edge cases, and generating a detailed report.
=============================================

import pytest
import snowflake.connector
import pyodbc
import logging

# Configure logging
logging.basicConfig(filename='migration_validation.log', level=logging.INFO,
                    format='%(asctime)s %(levelname)s: %(message)s')

# --- Snowflake and SQL Server connection details ---
SNOWFLAKE_CONFIG = {
    'user': 'YOUR_USER',
    'password': 'YOUR_PASSWORD',
    'account': 'YOUR_ACCOUNT',
    'warehouse': 'YOUR_WAREHOUSE',
    'database': 'YOUR_DB',
    'schema': 'PUBLIC'
}
SQLSERVER_CONFIG = {
    'driver': '{ODBC Driver 17 for SQL Server}',
    'server': 'YOUR_SQL_SERVER',
    'database': 'tduser',
    'uid': 'YOUR_USER',
    'pwd': 'YOUR_PASSWORD'
}

# --- Original SQL Server script ---
SQLSERVER_BACKUP_SCRIPT = """
IF OBJECT_ID(N'dbo.employee_bkup', N'U') IS NOT NULL
    DROP TABLE dbo.employee_bkup;
CREATE TABLE dbo.employee_bkup
(   EmployeeNo   INT         NOT NULL PRIMARY KEY,
    FirstName    CHAR(30)    NOT NULL,
    LastName     CHAR(30)    NOT NULL,
    DepartmentNo SMALLINT    NULL,
    NetPay       INT         NULL
);
IF EXISTS (SELECT 1 FROM dbo.Employee)
BEGIN
    INSERT INTO dbo.employee_bkup (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
    SELECT  e.EmployeeNo,
            e.FirstName,
            e.LastName,
            e.DepartmentNo,
            s.NetPay
    FROM    dbo.Employee AS e
    INNER   JOIN dbo.Salary   AS s
            ON e.EmployeeNo = s.EmployeeNo;
END
ELSE
BEGIN
    DROP TABLE dbo.employee_bkup;
END
"""

# --- Snowflake script ---
SNOWFLAKE_BACKUP_SCRIPT = """
DROP TABLE IF EXISTS employee_bkup;
CREATE TABLE employee_bkup (
    EmployeeNo   INT         NOT NULL PRIMARY KEY,
    FirstName    STRING      NOT NULL,
    LastName     STRING      NOT NULL,
    DepartmentNo SMALLINT,
    NetPay       INT
);
DECLARE employee_count INT;
BEGIN
    SELECT COUNT(*) INTO :employee_count FROM Employee;
    IF employee_count > 0 THEN
        INSERT INTO employee_bkup (EmployeeNo, FirstName, LastName, DepartmentNo, NetPay)
        SELECT  e.EmployeeNo,
                e.FirstName,
                e.LastName,
                e.DepartmentNo,
                s.NetPay
        FROM    Employee AS e
        INNER JOIN Salary AS s
            ON e.EmployeeNo = s.EmployeeNo;
    ELSE
        DROP TABLE IF EXISTS employee_bkup;
    END IF;
END;
"""

# --- Helper Functions ---
def connect_sqlserver():
    conn_str = (
        f"DRIVER={SQLSERVER_CONFIG['driver']};"
        f"SERVER={SQLSERVER_CONFIG['server']};"
        f"DATABASE={SQLSERVER_CONFIG['database']};"
        f"UID={SQLSERVER_CONFIG['uid']};"
        f"PWD={SQLSERVER_CONFIG['pwd']}"
    )
    return pyodbc.connect(conn_str)

def connect_snowflake():
    return snowflake.connector.connect(**SNOWFLAKE_CONFIG)

def execute_sqlserver_script(cursor, script):
    for stmt in script.split(';'):
        stmt = stmt.strip()
        if stmt:
            try:
                cursor.execute(stmt)
            except Exception as e:
                logging.error(f"SQL Server execution error: {e}")

def execute_snowflake_script(cursor, script):
    for stmt in script.split(';'):
        stmt = stmt.strip()
        if stmt:
            try:
                cursor.execute(stmt)
            except Exception as e:
                logging.error(f"Snowflake execution error: {e}")

def fetch_sqlserver_data(cursor, query):
    cursor.execute(query)
    return cursor.fetchall()

def fetch_snowflake_data(cursor, query):
    cursor.execute(query)
    return cursor.fetchall()

def compare_outputs(sqlserver_rows, snowflake_rows):
    # Compare row sets for inserts, updates, deletes
    sqlserver_set = set(sqlserver_rows)
    snowflake_set = set(snowflake_rows)
    matching = sqlserver_set & snowflake_set
    only_sqlserver = sqlserver_set - snowflake_set
    only_snowflake = snowflake_set - sqlserver_set
    return {
        'matching': list(matching),
        'only_sqlserver': list(only_sqlserver),
        'only_snowflake': list(only_snowflake)
    }

# --- Pytest Test Cases ---
@pytest.fixture(scope="module")
def sqlserver_conn():
    conn = connect_sqlserver()
    cursor = conn.cursor()
    yield cursor
    cursor.close()
    conn.close()

@pytest.fixture(scope="module")
def snowflake_conn():
    conn = connect_snowflake()
    cursor = conn.cursor()
    yield cursor
    cursor.close()
    conn.close()

def setup_tables(cursor, dbtype):
    # Create Employee and Salary tables with sample data
    if dbtype == 'sqlserver':
        cursor.execute("IF OBJECT_ID(N'dbo.Employee', N'U') IS NOT NULL DROP TABLE dbo.Employee;")
        cursor.execute("IF OBJECT_ID(N'dbo.Salary', N'U') IS NOT NULL DROP TABLE dbo.Salary;")
        cursor.execute("CREATE TABLE dbo.Employee (EmployeeNo INT, FirstName CHAR(30), LastName CHAR(30), DepartmentNo SMALLINT)")
        cursor.execute("CREATE TABLE dbo.Salary (EmployeeNo INT, NetPay INT)")
        cursor.execute("INSERT INTO dbo.Employee VALUES (1, 'John', 'Doe', 10), (2, 'Jane', 'Smith', 20)")
        cursor.execute("INSERT INTO dbo.Salary VALUES (1, 5000), (2, 6000)")
    else:
        cursor.execute("DROP TABLE IF EXISTS Employee;")
        cursor.execute("DROP TABLE IF EXISTS Salary;")
        cursor.execute("CREATE TABLE Employee (EmployeeNo INT, FirstName STRING, LastName STRING, DepartmentNo SMALLINT)")
        cursor.execute("CREATE TABLE Salary (EmployeeNo INT, NetPay INT)")
        cursor.execute("INSERT INTO Employee VALUES (1, 'John', 'Doe', 10), (2, 'Jane', 'Smith', 20)")
        cursor.execute("INSERT INTO Salary VALUES (1, 5000), (2, 6000)")

def test_migration_validation(sqlserver_conn, snowflake_conn):
    # Setup tables
    setup_tables(sqlserver_conn, 'sqlserver')
    setup_tables(snowflake_conn, 'snowflake')

    # Run backup scripts
    execute_sqlserver_script(sqlserver_conn, SQLSERVER_BACKUP_SCRIPT)
    execute_snowflake_script(snowflake_conn, SNOWFLAKE_BACKUP_SCRIPT)

    # Fetch backup table data
    sqlserver_rows = fetch_sqlserver_data(sqlserver_conn, "SELECT EmployeeNo, FirstName, LastName, DepartmentNo, NetPay FROM dbo.employee_bkup ORDER BY EmployeeNo")
    snowflake_rows = fetch_snowflake_data(snowflake_conn, "SELECT EmployeeNo, FirstName, LastName, DepartmentNo, NetPay FROM employee_bkup ORDER BY EmployeeNo")

    # Compare outputs
    result = compare_outputs(sqlserver_rows, snowflake_rows)
    logging.info(f"Comparison Result: {result}")

    # Assertions
    assert len(result['only_sqlserver']) == 0, "Records present only in SQL Server backup"
    assert len(result['only_snowflake']) == 0, "Records present only in Snowflake backup"
    assert len(result['matching']) == len(sqlserver_rows), "All records should match"

def test_null_handling(sqlserver_conn, snowflake_conn):
    # Test null values
    # Setup tables with nulls
    if sqlserver_conn:
        sqlserver_conn.execute("DELETE FROM dbo.Employee")
        sqlserver_conn.execute("DELETE FROM dbo.Salary")
        sqlserver_conn.execute("INSERT INTO dbo.Employee VALUES (3, 'Null', 'Guy', NULL)")
        sqlserver_conn.execute("INSERT INTO dbo.Salary VALUES (3, NULL)")
        execute_sqlserver_script(sqlserver_conn, SQLSERVER_BACKUP_SCRIPT)
        sql_rows = fetch_sqlserver_data(sqlserver_conn, "SELECT EmployeeNo, FirstName, LastName, DepartmentNo, NetPay FROM dbo.employee_bkup")
        assert sql_rows[0][3] is None and sql_rows[0][4] is None

    if snowflake_conn:
        snowflake_conn.execute("DELETE FROM Employee")
        snowflake_conn.execute("DELETE FROM Salary")
        snowflake_conn.execute("INSERT INTO Employee VALUES (3, 'Null', 'Guy', NULL)")
        snowflake_conn.execute("INSERT INTO Salary VALUES (3, NULL)")
        execute_snowflake_script(snowflake_conn, SNOWFLAKE_BACKUP_SCRIPT)
        sf_rows = fetch_snowflake_data(snowflake_conn, "SELECT EmployeeNo, FirstName, LastName, DepartmentNo, NetPay FROM employee_bkup")
        assert sf_rows[0][3] is None and sf_rows[0][4] is None

def test_special_characters(sqlserver_conn, snowflake_conn):
    fname = "Jöhn$%^&*()_+=-"
    lname = "Dœ!@#~`|\\"
    if sqlserver_conn:
        sqlserver_conn.execute("DELETE FROM dbo.Employee")
        sqlserver_conn.execute("DELETE FROM dbo.Salary")
        sqlserver_conn.execute(f"INSERT INTO dbo.Employee VALUES (4, '{fname}', '{lname}', 10)")
        sqlserver_conn.execute("INSERT INTO dbo.Salary VALUES (4, 7000)")
        execute_sqlserver_script(sqlserver_conn, SQLSERVER_BACKUP_SCRIPT)
        sql_rows = fetch_sqlserver_data(sqlserver_conn, "SELECT EmployeeNo, FirstName, LastName FROM dbo.employee_bkup")
        assert sql_rows[0][1].strip() == fname and sql_rows[0][2].strip() == lname

    if snowflake_conn:
        snowflake_conn.execute("DELETE FROM Employee")
        snowflake_conn.execute("DELETE FROM Salary")
        snowflake_conn.execute(f"INSERT INTO Employee VALUES (4, '{fname}', '{lname}', 10)")
        snowflake_conn.execute("INSERT INTO Salary VALUES (4, 7000)")
        execute_snowflake_script(snowflake_conn, SNOWFLAKE_BACKUP_SCRIPT)
        sf_rows = fetch_snowflake_data(snowflake_conn, "SELECT EmployeeNo, FirstName, LastName FROM employee_bkup")
        assert sf_rows[0][1] == fname and sf_rows[0][2] == lname

def generate_report(sqlserver_conn, snowflake_conn):
    sql_rows = fetch_sqlserver_data(sqlserver_conn, "SELECT * FROM dbo.employee_bkup")
    sf_rows = fetch_snowflake_data(snowflake_conn, "SELECT * FROM employee_bkup")
    result = compare_outputs(sql_rows, sf_rows)
    report = {
        "records_matching": len(result['matching']),
        "records_only_sqlserver": len(result['only_sqlserver']),
        "records_only_snowflake": len(result['only_snowflake']),
        "details": result
    }
    logging.info(f"Final Comparison Report: {report}")
    return report

if __name__ == "__main__":
    # Automated execution for CI/CD
    try:
        sql_conn = connect_sqlserver()
        sql_cursor = sql_conn.cursor()
        sf_conn = connect_snowflake()
        sf_cursor = sf_conn.cursor()
        setup_tables(sql_cursor, 'sqlserver')
        setup_tables(sf_cursor, 'snowflake')
        execute_sqlserver_script(sql_cursor, SQLSERVER_BACKUP_SCRIPT)
        execute_snowflake_script(sf_cursor, SNOWFLAKE_BACKUP_SCRIPT)
        report = generate_report(sql_cursor, sf_cursor)
        print("Migration Validation Report:", report)
        sql_cursor.close()
        sql_conn.close()
        sf_cursor.close()
        sf_conn.close()
    except Exception as e:
        logging.error(f"Migration validation failed: {e}")
        print("Migration validation failed. See log for details.")

# API Cost Calculation
apiCost = 0.002
print(f"apiCost: {apiCost} USD")