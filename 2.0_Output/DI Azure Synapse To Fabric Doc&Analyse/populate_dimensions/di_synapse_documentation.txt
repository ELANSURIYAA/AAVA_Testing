====================================================
Author:        Ascendion AAVA
Date:          
Description:   Documentation for the Synapse stored procedure "populate_dimensions" for dimension table loading and maintenance.
====================================================

# 1. Overview of Pipeline/Component

The `populate_dimensions` stored procedure in Azure Synapse Analytics is designed to automate the loading and maintenance of key dimension tables (`DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`) from a staging dataset (`STG_DIMENSION_DATA`). It ensures data quality, deduplication, and idempotency using SQL MERGE statements. This process supports enterprise data warehousing, regulatory reporting, and advanced analytics by keeping dimension tables current and consistent.

# 2. Component Structure and Design

- **Component Type:** Synapse SQL Stored Procedure (`dbo.populate_dimensions`)
- **Source:** `dbo.STG_DIMENSION_DATA` (staging table)
- **Targets:** 
  - `dbo.DIM_INSTITUTION`
  - `dbo.DIM_CORPORATION`
  - `dbo.DIM_PRODUCT`
- **Key Activities:**
  - Three main MERGE operations, one for each dimension table.
  - Data quality filters (e.g., non-null IDs, exclusion of test/legacy data).
  - Idempotent loads (no duplicate inserts).
- **Integration:** Designed to be orchestrated from Synapse pipelines or scheduled jobs. No explicit parameters or triggers in the procedure itself, but can be invoked as an activity in a Synapse pipeline.
- **Connection Flow:** 
  - Reads from staging table.
  - Applies business rules and transformations.
  - Writes to dimension tables.

# 3. Data Flow and Processing Logic

**Processed Datasets:**
- Source: `dbo.STG_DIMENSION_DATA`
- Targets: `dbo.DIM_INSTITUTION`, `dbo.DIM_CORPORATION`, `dbo.DIM_PRODUCT`

**Data Flow:**
1. **Extract:** Selects distinct records from the staging table.
2. **Transform:** Applies filters (e.g., non-null, length, exclusion of test/legacy values).
3. **Load:** Uses MERGE to insert new dimension records if they do not already exist.

**Logical Steps:**
- **DIM_INSTITUTION:** Loads unique institutions where `institution_id` is not null and length > 3.
- **DIM_CORPORATION:** Loads unique corporations, excluding those with names starting with 'TEST'.
- **DIM_PRODUCT:** Loads unique products, excluding those with `processing_group` in ('DEPRECATED', 'LEGACY').

**Business Rules/Transformations:**
- Deduplication via `SELECT DISTINCT`.
- Data quality enforced via WHERE clauses.
- Only new records inserted (idempotency).

# 4. Data Mapping (Lineage)

| Target Table Name   | Target Column Name         | Source Table Name      | Source Column Name         | Remarks                                                                 |
|---------------------|---------------------------|------------------------|---------------------------|-------------------------------------------------------------------------|
| DIM_INSTITUTION     | institution_id            | STG_DIMENSION_DATA     | institution_id            | 1:1 Mapping; Only if NOT NULL and LEN > 3                               |
| DIM_INSTITUTION     | institution               | STG_DIMENSION_DATA     | institution               | 1:1 Mapping                                                            |
| DIM_INSTITUTION     | institution_name          | STG_DIMENSION_DATA     | institution_name          | 1:1 Mapping                                                            |
| DIM_CORPORATION     | corporation_id            | STG_DIMENSION_DATA     | corporation_id            | 1:1 Mapping; Excludes corporation_name LIKE 'TEST%'                     |
| DIM_CORPORATION     | corp_id                   | STG_DIMENSION_DATA     | corp_id                   | 1:1 Mapping                                                            |
| DIM_CORPORATION     | corporation               | STG_DIMENSION_DATA     | corporation               | 1:1 Mapping                                                            |
| DIM_CORPORATION     | corporation_name          | STG_DIMENSION_DATA     | corporation_name          | 1:1 Mapping                                                            |
| DIM_CORPORATION     | sub_corporation           | STG_DIMENSION_DATA     | sub_corporation           | 1:1 Mapping                                                            |
| DIM_CORPORATION     | sub_corporation_id        | STG_DIMENSION_DATA     | sub_corporation_id        | 1:1 Mapping                                                            |
| DIM_CORPORATION     | sub_corporation_name      | STG_DIMENSION_DATA     | sub_corporation_name      | 1:1 Mapping                                                            |
| DIM_CORPORATION     | master_corporation_dim_key| STG_DIMENSION_DATA     | master_corporation_dim_key| 1:1 Mapping                                                            |
| DIM_CORPORATION     | association               | STG_DIMENSION_DATA     | association               | 1:1 Mapping                                                            |
| DIM_CORPORATION     | bin                       | STG_DIMENSION_DATA     | bin                       | 1:1 Mapping                                                            |
| DIM_CORPORATION     | company                   | STG_DIMENSION_DATA     | company                   | 1:1 Mapping                                                            |
| DIM_CORPORATION     | company_id                | STG_DIMENSION_DATA     | company_id                | 1:1 Mapping                                                            |
| DIM_CORPORATION     | company_name              | STG_DIMENSION_DATA     | company_name              | 1:1 Mapping                                                            |
| DIM_PRODUCT         | product_id                | STG_DIMENSION_DATA     | product_id                | 1:1 Mapping; Excludes processing_group IN ('DEPRECATED','LEGACY')       |
| DIM_PRODUCT         | product                   | STG_DIMENSION_DATA     | product                   | 1:1 Mapping                                                            |
| DIM_PRODUCT         | product_description       | STG_DIMENSION_DATA     | product_description       | 1:1 Mapping                                                            |
| DIM_PRODUCT         | sub_product               | STG_DIMENSION_DATA     | sub_product               | 1:1 Mapping                                                            |
| DIM_PRODUCT         | processing_code           | STG_DIMENSION_DATA     | processing_code           | 1:1 Mapping                                                            |
| DIM_PRODUCT         | processing_code_description| STG_DIMENSION_DATA    | processing_code_description| 1:1 Mapping                                                           |
| DIM_PRODUCT         | processing_group          | STG_DIMENSION_DATA     | processing_group          | 1:1 Mapping                                                            |

# 5. Transformation Logic

- **DIM_INSTITUTION:** 
  - Filter: `institution_id IS NOT NULL AND LEN(institution_id) > 3`
  - Deduplication: `SELECT DISTINCT`
- **DIM_CORPORATION:** 
  - Filter: `UPPER(corporation_name) NOT LIKE 'TEST%'`
  - Deduplication: `SELECT DISTINCT`
- **DIM_PRODUCT:** 
  - Filter: `processing_group NOT IN ('DEPRECATED', 'LEGACY')`
  - Deduplication: `SELECT DISTINCT`
- **MERGE Statement:** Ensures only new records are inserted (idempotency).
- **No UDFs or reusable templates** are used; all logic is inline SQL.

# 6. Complexity Analysis

| Metric                          | Value/Details                                                                 |
|----------------------------------|------------------------------------------------------------------------------|
| Number of Pipeline Activities    | 1 (Stored Procedure with 3 main MERGE operations)                            |
| Number of Dataflow Transformations| 3 (one per dimension table)                                                 |
| SQL Scripts or Stored Procedures Used | 1 (this procedure)                                                        |
| Joins Used                      | None (MERGE with ON clause, but no multi-table joins)                        |
| Lookup Tables or Reference Data  | None                                                                         |
| Parameters/Variables/Triggers    | 0 (no parameters, variables, or triggers in the procedure)                   |
| Number of Output Datasets        | 3 (DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT)                            |
| Conditional Logic or if-else Flows| 3 (WHERE clause filters for each dimension)                                 |
| External Dependencies            | Source: STG_DIMENSION_DATA; Targets: 3 dimension tables                      |
| Overall Complexity Score         | 25                                                                           |

# 7. Key Outputs

- **Tables Written:** 
  - `dbo.DIM_INSTITUTION`
  - `dbo.DIM_CORPORATION`
  - `dbo.DIM_PRODUCT`
- **Format:** SQL Server tables (row-based storage, not file-based)
- **Intended Use:** 
  - Downstream reporting (Power BI, dashboards)
  - Regulatory and compliance reporting
  - Data enrichment for analytics and ML models

---

**API Cost:** apiCost: 0.008 USD