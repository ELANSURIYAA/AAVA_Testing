Test Case List:

| Test Case ID | Test Case Description                                                                                   | Expected Outcome                                                                                           |
|--------------|--------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------|
| TC01         | Happy path: Multiple customers with sales in 2023, discounts applied, and valid product mappings.      | Top 5 customers per region are returned with correct aggregations, product lists, and sale categories.    |
| TC02         | Edge case: Customer with no sales in 2023.                                                             | Customer is excluded from output.                                                                         |
| TC03         | Edge case: Sales with NULL sale_amount or missing product_id.                                          | Aggregations handle NULLs correctly; product_list excludes NULLs.                                         |
| TC04         | Edge case: Sale with sale_metadata missing 'discount_applied' or 'country' fields.                     | Sale is excluded if discount_applied is not TRUE or country is not 'USA'.                                 |
| TC05         | Edge case: Customer with multiple regions (data anomaly).                                              | Each region treated independently for ranking and aggregation.                                            |
| TC06         | Edge case: Sale with sale_amount exactly 1000 or 500 (boundary for category).                          | sale_category is correctly assigned as 'High Value' (>1000), 'Medium Value' (>500), 'Low Value' (<=500). |
| TC07         | Edge case: Empty dataset (no customers, sales, or products).                                           | Output is empty; no errors.                                                                               |
| TC08         | Error handling: Invalid JSON in metadata fields.                                                        | Query does not fail; invalid JSON results in NULL loyalty_level/source/country.                           |
| TC09         | Error handling: Sales with discount_applied as non-boolean (e.g., string 'TRUE').                      | Only boolean TRUE is accepted; string 'TRUE' is ignored.                                                  |
| TC10         | Performance: Large dataset with many customers and sales.                                              | Query completes successfully; top 5 customers per region returned.                                        |

Pytest Script for BigQuery (PEP 8 compliant):

```python
import pytest
from google.cloud import bigquery

# Helper functions for test setup/teardown
def setup_test_data(client, dataset_id):
    # Create Customers, Sales, Products tables with appropriate schema
    # Insert test data for each test case
    pass

def teardown_test_data(client, dataset_id):
    # Drop test tables
    pass

@pytest.fixture(scope="module")
def bq_client():
    return bigquery.Client()

@pytest.fixture(scope="function")
def test_dataset(bq_client):
    dataset_id = "test_total_sales"
    setup_test_data(bq_client, dataset_id)
    yield dataset_id
    teardown_test_data(bq_client, dataset_id)

def run_query(client, query):
    job = client.query(query)
    return [dict(row) for row in job.result()]

# The BigQuery SQL (converted from Snowflake, with JSON extraction via SAFE_CAST and JSON_VALUE)
QUERY = """
WITH customer_sales AS (
    SELECT 
        c.customer_id,
        c.customer_name,
        c.region,
        SAFE_CAST(JSON_VALUE(c.metadata, '$.loyalty_level') AS STRING) AS loyalty_level,
        SUM(s.sale_amount) AS total_sales,
        COUNT(s.sale_id) AS total_orders,
        ARRAY_AGG(DISTINCT s.product_id IGNORE NULLS) AS product_list
    FROM 
        `test_total_sales.Customers` c
    LEFT JOIN 
        `test_total_sales.Sales` s ON c.customer_id = s.customer_id
    WHERE 
        s.sale_date >= '2023-01-01'
        AND s.sale_date < '2024-01-01'
        AND SAFE_CAST(JSON_VALUE(s.sale_metadata, '$.discount_applied') AS BOOL) = TRUE
    GROUP BY 
        c.customer_id, c.customer_name, c.region, loyalty_level
),
top_customers AS (
    SELECT 
        customer_id,
        customer_name,
        region,
        loyalty_level,
        total_sales,
        total_orders,
        product_list,
        RANK() OVER (PARTITION BY region ORDER BY total_sales DESC) AS region_rank
    FROM 
        customer_sales
),
sales_performance AS (
    SELECT
        s.sale_id,
        s.sale_date,
        s.sale_amount,
        s.discount_percentage,
        SAFE_CAST(JSON_VALUE(s.sale_metadata, '$.source') AS STRING) AS source,
        p.product_name,
        CASE 
            WHEN s.sale_amount > 1000 THEN 'High Value'
            WHEN s.sale_amount > 500 THEN 'Medium Value'
            ELSE 'Low Value'
        END AS sale_category
    FROM 
        `test_total_sales.Sales` s
    INNER JOIN 
        `test_total_sales.Products` p ON s.product_id = p.product_id
    WHERE 
        s.sale_date >= '2023-01-01'
        AND SAFE_CAST(JSON_VALUE(s.sale_metadata, '$.country') AS STRING) = 'USA'
)
SELECT 
    tc.customer_name,
    tc.region,
    tc.loyalty_level,
    tc.total_sales,
    tc.total_orders,
    sp.sale_id,
    sp.sale_date,
    sp.product_name,
    sp.sale_category,
    sp.source
FROM 
    top_customers tc
LEFT JOIN 
    sales_performance sp ON tc.customer_id = sp.customer_id
WHERE 
    tc.region_rank <= 5
ORDER BY 
    tc.region, tc.region_rank, sp.sale_date
"""

# Test Cases

def test_happy_path(bq_client, test_dataset):
    # Insert multiple customers, sales, products with valid data
    # Run query and assert top 5 customers per region, correct aggregations, product_list, sale_category
    results = run_query(bq_client, QUERY)
    assert len(results) > 0
    for row in results:
        assert row["total_sales"] > 0
        assert row["sale_category"] in ["High Value", "Medium Value", "Low Value"]

def test_customer_no_sales(bq_client, test_dataset):
    # Insert customer with no sales in 2023
    # Run query and assert customer is excluded
    results = run_query(bq_client, QUERY)
    customer_ids = [row["customer_name"] for row in results]
    assert "NoSalesCustomer" not in customer_ids

def test_null_sale_amount_and_product_id(bq_client, test_dataset):
    # Insert sales with NULL sale_amount and NULL product_id
    # Run query and assert aggregations handle NULLs, product_list excludes NULLs
    results = run_query(bq_client, QUERY)
    for row in results:
        assert row["total_sales"] is not None
        assert None not in row["product_list"]

def test_missing_discount_applied_or_country(bq_client, test_dataset):
    # Insert sales with missing discount_applied or country fields
    # Run query and assert such sales are excluded
    results = run_query(bq_client, QUERY)
    for row in results:
        assert row["sale_id"] != "MissingDiscountOrCountrySale"

def test_customer_multiple_regions(bq_client, test_dataset):
    # Insert customer with multiple region values (simulate anomaly)
    # Run query and assert regions are treated independently
    results = run_query(bq_client, QUERY)
    regions = set(row["region"] for row in results)
    assert len(regions) > 1

def test_sale_amount_boundaries(bq_client, test_dataset):
    # Insert sales with sale_amount exactly 1000 and 500
    # Run query and assert sale_category is correct
    results = run_query(bq_client, QUERY)
    for row in results:
        if row["sale_amount"] == 1000:
            assert row["sale_category"] == "Medium Value"
        if row["sale_amount"] == 500:
            assert row["sale_category"] == "Low Value"

def test_empty_dataset(bq_client, test_dataset):
    # No data in Customers, Sales, Products
    # Run query and assert output is empty
    results = run_query(bq_client, QUERY)
    assert results == []

def test_invalid_json_metadata(bq_client, test_dataset):
    # Insert rows with invalid JSON in metadata fields
    # Run query and assert loyalty_level/source/country are NULL, query does not fail
    results = run_query(bq_client, QUERY)
    for row in results:
        assert row["loyalty_level"] is None or isinstance(row["loyalty_level"], str)
        assert row["source"] is None or isinstance(row["source"], str)

def test_discount_applied_non_boolean(bq_client, test_dataset):
    # Insert sales with discount_applied as string 'TRUE'
    # Run query and assert such sales are excluded
    results = run_query(bq_client, QUERY)
    for row in results:
        assert row["sale_id"] != "NonBooleanDiscountSale"

def test_large_dataset_performance(bq_client, test_dataset):
    # Insert large volume of customers and sales
    # Run query and assert top 5 customers per region are returned
    results = run_query(bq_client, QUERY)
    region_ranks = [row["region_rank"] for row in results if "region_rank" in row]
    assert all(rank <= 5 for rank in region_ranks)

# Note: The setup_test_data and teardown_test_data functions should be implemented to create/drop tables and insert appropriate test data for each test case.

# apiCost: 0.0075 USD
```