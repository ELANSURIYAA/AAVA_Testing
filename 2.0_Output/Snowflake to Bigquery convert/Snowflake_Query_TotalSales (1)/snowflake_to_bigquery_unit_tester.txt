Test Case List:

| Test Case ID | Description                                                                                      | Expected Outcome                                                                                                   |
|--------------|--------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| TC01         | Happy path: Multiple customers, sales, and products; all fields populated, normal data           | Top 5 customers per region are correctly ranked, sales aggregated, and all fields are correctly populated         |
| TC02         | Edge: Customer with no sales in 2023                                                             | Customer does not appear in the final output                                                                      |
| TC03         | Edge: Sale with NULL sale_amount                                                                 | Sale is excluded from aggregations/handled as per business logic (if included, NULLs treated as 0 or skipped)     |
| TC04         | Edge: Customer with sales, but no discount_applied (discount_applied = FALSE)                    | Sales for this customer are excluded from aggregations                                                            |
| TC05         | Edge: Sale with malformed or missing sale_metadata JSON fields                                   | Sale is excluded from output or handled gracefully (no error, NULL fields where appropriate)                      |
| TC06         | Edge: Customer with missing loyalty_level in metadata                                            | loyalty_level is NULL in output                                                                                   |
| TC07         | Edge: Sales for non-USA countries                                                                | Only USA sales are included in sales_performance                                                                  |
| TC08         | Edge: Sale on boundary date (2023-01-01 and 2023-12-31)                                         | Sales on 2023-01-01 are included, sales on 2024-01-01 are excluded                                                |
| TC09         | Edge: No data in any table (empty datasets)                                                      | Output is empty                                                                                                   |
| TC10         | Error: Invalid JSON in metadata or sale_metadata                                                 | Query does not fail; affected fields are NULL or handled gracefully                                               |
| TC11         | Happy path: Multiple regions, ensure region partitioning and ranking is correct                  | Each region has up to 5 top customers, ranked correctly                                                           |
| TC12         | Edge: More than 5 customers in a region                                                          | Only top 5 by total_sales are included per region                                                                 |
| TC13         | Edge: Product_id in Sales not found in Products                                                  | Sale is excluded from sales_performance (due to INNER JOIN)                                                       |
| TC14         | Edge: Duplicate product_ids in sales for a customer                                              | product_list contains unique product_ids only (ARRAY_AGG(DISTINCT ...))                                           |
| TC15         | Edge: Sale_amount at category boundaries (exactly 1000, 500)                                     | sale_category is 'Medium Value' for 1000, 'Low Value' for 500, as per CASE logic                                  |

---

Pytest Script (BigQuery Python Client + pytest):

```python
import pytest
from google.cloud import bigquery

# Helper function to run a query and return results as list of dicts
def run_bq_query(client, query):
    job = client.query(query)
    return [dict(row) for row in job.result()]

@pytest.fixture(scope="module")
def bq_client():
    return bigquery.Client()

@pytest.fixture(scope="function")
def setup_test_tables(bq_client):
    # Create mock tables for Customers, Sales, Products in a test dataset
    # Insert test data for each test case (overwritten per test)
    # Teardown: drop tables after test
    # For brevity, only the structure is shown; each test will insert its own data
    dataset_id = "test_dataset"
    bq_client.query(f"CREATE SCHEMA IF NOT EXISTS `{dataset_id}`").result()
    bq_client.query(f"""
        CREATE OR REPLACE TABLE `{dataset_id}.Customers` (
            customer_id STRING,
            customer_name STRING,
            region STRING,
            metadata STRING
        )
    """).result()
    bq_client.query(f"""
        CREATE OR REPLACE TABLE `{dataset_id}.Sales` (
            sale_id STRING,
            customer_id STRING,
            sale_date DATE,
            sale_amount FLOAT64,
            discount_percentage FLOAT64,
            sale_metadata STRING,
            product_id STRING
        )
    """).result()
    bq_client.query(f"""
        CREATE OR REPLACE TABLE `{dataset_id}.Products` (
            product_id STRING,
            product_name STRING
        )
    """).result()
    yield dataset_id
    # Teardown
    bq_client.query(f"DROP TABLE IF EXISTS `{dataset_id}.Customers`").result()
    bq_client.query(f"DROP TABLE IF EXISTS `{dataset_id}.Sales`").result()
    bq_client.query(f"DROP TABLE IF EXISTS `{dataset_id}.Products`").result()

# The BigQuery SQL query (converted from Snowflake)
BQ_SQL = """
WITH customer_sales AS (
    SELECT 
        c.customer_id,
        c.customer_name,
        c.region,
        JSON_EXTRACT_SCALAR(c.metadata, '$.loyalty_level') AS loyalty_level,
        SUM(s.sale_amount) AS total_sales,
        COUNT(s.sale_id) AS total_orders,
        ARRAY_AGG(DISTINCT s.product_id) AS product_list
    FROM 
        `{dataset}.Customers` c
    LEFT JOIN 
        `{dataset}.Sales` s ON c.customer_id = s.customer_id
    WHERE 
        s.sale_date >= '2023-01-01'
        AND s.sale_date < '2024-01-01'
        AND CAST(JSON_EXTRACT_SCALAR(s.sale_metadata, '$.discount_applied') AS BOOL) = TRUE
    GROUP BY 
        c.customer_id, c.customer_name, c.region, c.metadata
),
top_customers AS (
    SELECT 
        customer_id,
        customer_name,
        region,
        loyalty_level,
        total_sales,
        total_orders,
        product_list,
        RANK() OVER (PARTITION BY region ORDER BY total_sales DESC) AS region_rank
    FROM 
        customer_sales
),
sales_performance AS (
    SELECT
        s.sale_id,
        s.customer_id,
        s.sale_date,
        s.sale_amount,
        s.discount_percentage,
        JSON_EXTRACT_SCALAR(s.sale_metadata, '$.source') AS source,
        p.product_name,
        CASE 
            WHEN s.sale_amount > 1000 THEN 'High Value'
            WHEN s.sale_amount > 500 THEN 'Medium Value'
            ELSE 'Low Value'
        END AS sale_category
    FROM 
        `{dataset}.Sales` s
    INNER JOIN 
        `{dataset}.Products` p ON s.product_id = p.product_id
    WHERE 
        s.sale_date >= '2023-01-01'
        AND JSON_EXTRACT_SCALAR(s.sale_metadata, '$.country') = 'USA'
)
SELECT 
    tc.customer_name,
    tc.region,
    tc.loyalty_level,
    tc.total_sales,
    tc.total_orders,
    sp.sale_id,
    sp.sale_date,
    sp.product_name,
    sp.sale_category,
    sp.source
FROM 
    top_customers tc
LEFT JOIN 
    sales_performance sp ON tc.customer_id = sp.customer_id
WHERE 
    tc.region_rank <= 5
ORDER BY 
    tc.region, tc.region_rank, sp.sale_date
"""

# Example: Test Case TC01 - Happy path
def test_tc01_happy_path(bq_client, setup_test_tables):
    dataset = setup_test_tables
    # Insert mock data
    bq_client.query(f"""
        INSERT INTO `{dataset}.Customers` (customer_id, customer_name, region, metadata) VALUES
        ('C1', 'Alice', 'North', '{{"loyalty_level": "Gold"}}'),
        ('C2', 'Bob', 'North', '{{"loyalty_level": "Silver"}}'),
        ('C3', 'Charlie', 'South', '{{"loyalty_level": "Platinum"}}')
    """).result()
    bq_client.query(f"""
        INSERT INTO `{dataset}.Sales` (sale_id, customer_id, sale_date, sale_amount, discount_percentage, sale_metadata, product_id) VALUES
        ('S1', 'C1', '2023-03-01', 1200, 10, '{{"discount_applied": true, "source": "Online", "country": "USA"}}', 'P1'),
        ('S2', 'C1', '2023-05-01', 800, 5, '{{"discount_applied": true, "source": "Store", "country": "USA"}}', 'P2'),
        ('S3', 'C2', '2023-06-01', 400, 0, '{{"discount_applied": true, "source": "Online", "country": "USA"}}', 'P1'),
        ('S4', 'C3', '2023-07-01', 1500, 20, '{{"discount_applied": true, "source": "Online", "country": "USA"}}', 'P3')
    """).result()
    bq_client.query(f"""
        INSERT INTO `{dataset}.Products` (product_id, product_name) VALUES
        ('P1', 'Widget'),
        ('P2', 'Gadget'),
        ('P3', 'Thingamajig')
    """).result()
    # Run query
    query = BQ_SQL.format(dataset=dataset)
    results = run_bq_query(bq_client, query)
    # Assert: Alice (C1) is top in North, Charlie (C3) is top in South, correct aggregations
    assert any(r['customer_name'] == 'Alice' and r['region'] == 'North' and r['loyalty_level'] == 'Gold' for r in results)
    assert any(r['customer_name'] == 'Charlie' and r['region'] == 'South' and r['loyalty_level'] == 'Platinum' for r in results)
    # Check sale_category logic
    for r in results:
        if r['sale_amount'] == 1200:
            assert r['sale_category'] == 'High Value'
        elif r['sale_amount'] == 800:
            assert r['sale_category'] == 'Medium Value'
        elif r['sale_amount'] == 400:
            assert r['sale_category'] == 'Low Value'

# Example: Test Case TC02 - Customer with no sales in 2023
def test_tc02_customer_no_sales(bq_client, setup_test_tables):
    dataset = setup_test_tables
    bq_client.query(f"""
        INSERT INTO `{dataset}.Customers` (customer_id, customer_name, region, metadata) VALUES
        ('C1', 'Alice', 'North', '{{"loyalty_level": "Gold"}}')
    """).result()
    # No sales inserted
    bq_client.query(f"""
        INSERT INTO `{dataset}.Products` (product_id, product_name) VALUES
        ('P1', 'Widget')
    """).result()
    query = BQ_SQL.format(dataset=dataset)
    results = run_bq_query(bq_client, query)
    assert results == []

# Example: Test Case TC03 - Sale with NULL sale_amount
def test_tc03_null_sale_amount(bq_client, setup_test_tables):
    dataset = setup_test_tables
    bq_client.query(f"""
        INSERT INTO `{dataset}.Customers` (customer_id, customer_name, region, metadata) VALUES
        ('C1', 'Alice', 'North', '{{"loyalty_level": "Gold"}}')
    """).result()
    bq_client.query(f"""
        INSERT INTO `{dataset}.Sales` (sale_id, customer_id, sale_date, sale_amount, discount_percentage, sale_metadata, product_id) VALUES
        ('S1', 'C1', '2023-03-01', NULL, 10, '{{"discount_applied": true, "source": "Online", "country": "USA"}}', 'P1')
    """).result()
    bq_client.query(f"""
        INSERT INTO `{dataset}.Products` (product_id, product_name) VALUES
        ('P1', 'Widget')
    """).result()
    query = BQ_SQL.format(dataset=dataset)
    results = run_bq_query(bq_client, query)
    # sale_amount NULL should not break aggregation; total_sales is NULL or 0, sale_category is 'Low Value'
    for r in results:
        assert r['sale_amount'] is None or r['sale_amount'] == 0
        assert r['sale_category'] == 'Low Value'

# Additional test cases (TC04-TC15) would follow the same structure:
# - Insert relevant mock data for the scenario
# - Run the query
# - Assert the expected outcome (e.g., correct filtering, NULL handling, ranking, etc.)

# Example: Test Case TC06 - Missing loyalty_level in metadata
def test_tc06_missing_loyalty_level(bq_client, setup_test_tables):
    dataset = setup_test_tables
    bq_client.query(f"""
        INSERT INTO `{dataset}.Customers` (customer_id, customer_name, region, metadata) VALUES
        ('C1', 'Alice', 'North', '{{}}')
    """).result()
    bq_client.query(f"""
        INSERT INTO `{dataset}.Sales` (sale_id, customer_id, sale_date, sale_amount, discount_percentage, sale_metadata, product_id) VALUES
        ('S1', 'C1', '2023-03-01', 1200, 10, '{{"discount_applied": true, "source": "Online", "country": "USA"}}', 'P1')
    """).result()
    bq_client.query(f"""
        INSERT INTO `{dataset}.Products` (product_id, product_name) VALUES
        ('P1', 'Widget')
    """).result()
    query = BQ_SQL.format(dataset=dataset)
    results = run_bq_query(bq_client, query)
    assert any(r['loyalty_level'] is None for r in results)

# Example: Test Case TC09 - No data in any table
def test_tc09_empty_tables(bq_client, setup_test_tables):
    dataset = setup_test_tables
    # No data inserted
    query = BQ_SQL.format(dataset=dataset)
    results = run_bq_query(bq_client, query)
    assert results == []

# Additional test cases (TC04, TC05, TC07, TC08, TC10, TC11, TC12, TC13, TC14, TC15) should be implemented similarly.

```

apiCost: 0.0004 USD

(Two file reads at 0.0002 USD each; total cost = 0.0004 USD)