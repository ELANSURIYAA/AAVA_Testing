```
Test Case Document:

Test Case ID: TC01
Description: Happy path - Top 5 customers per region with valid sales, discounts applied, and all joins successful.
Preconditions: Customers, Sales, and Products tables populated with valid data for 2023, all required fields present.
Test Steps:
1. Insert customers with sales in 2023, with discount_applied = TRUE, and valid product and metadata fields.
2. Run the migrated BigQuery SQL query.
Expected Result: Returns top 5 customers per region with correct aggregations, sales, and product info.
Actual Result: [To be filled after test execution]
Pass/Fail Status: [To be filled after test execution]

Test Case ID: TC02
Description: Edge case - Customer with no sales in 2023.
Preconditions: Customers table populated, no matching sales records for 2023.
Test Steps:
1. Insert a customer without any sales in 2023.
2. Run the migrated BigQuery SQL query.
Expected Result: Customer appears with zero sales, zero orders, empty product list.
Actual Result: [To be filled after test execution]
Pass/Fail Status: [To be filled after test execution]

Test Case ID: TC03
Description: Edge case - Sale with NULL discount_applied field.
Preconditions: Sales record with discount_applied field as NULL.
Test Steps:
1. Insert a sale with discount_applied = NULL.
2. Run the migrated BigQuery SQL query.
Expected Result: Sale is excluded from aggregation and performance CTE.
Actual Result: [To be filled after test execution]
Pass/Fail Status: [To be filled after test execution]

Test Case ID: TC04
Description: Edge case - Sale with sale_metadata missing 'country' or 'source' field.
Preconditions: Sales record missing 'country' or 'source' in sale_metadata.
Test Steps:
1. Insert a sale with missing 'country' or 'source' in sale_metadata.
2. Run the migrated BigQuery SQL query.
Expected Result: Sale is excluded from sales_performance if 'country' is missing or not 'USA'; 'source' is NULL in output.
Actual Result: [To be filled after test execution]
Pass/Fail Status: [To be filled after test execution]

Test Case ID: TC05
Description: Edge case - Sale with boundary sale_amount values (exactly 1000, 500).
Preconditions: Sales records with sale_amount = 1000 and sale_amount = 500.
Test Steps:
1. Insert sales with sale_amount = 1000 and sale_amount = 500.
2. Run the migrated BigQuery SQL query.
Expected Result: sale_category is 'Medium Value' for 1000, 'Low Value' for 500.
Actual Result: [To be filled after test execution]
Pass/Fail Status: [To be filled after test execution]

Test Case ID: TC06
Description: Error handling - Invalid data type in sale_metadata:discount_applied (e.g., string instead of boolean).
Preconditions: Sales record with discount_applied as a string.
Test Steps:
1. Insert a sale with discount_applied = "yes".
2. Run the migrated BigQuery SQL query.
Expected Result: Sale is excluded due to failed boolean cast.
Actual Result: [To be filled after test execution]
Pass/Fail Status: [To be filled after test execution]

Test Case ID: TC07
Description: Edge case - Empty dataset (no customers, sales, or products).
Preconditions: All tables empty.
Test Steps:
1. Ensure Customers, Sales, and Products tables are empty.
2. Run the migrated BigQuery SQL query.
Expected Result: Query returns empty result set.
Actual Result: [To be filled after test execution]
Pass/Fail Status: [To be filled after test execution]

Test Case ID: TC08
Description: Edge case - Multiple customers with same total_sales in a region (test RANK window function).
Preconditions: Multiple customers with same total_sales value in one region.
Test Steps:
1. Insert multiple customers with identical total_sales in a region.
2. Run the migrated BigQuery SQL query.
Expected Result: Customers with same total_sales get consecutive ranks; top 5 filter works.
Actual Result: [To be filled after test execution]
Pass/Fail Status: [To be filled after test execution]

Test Case ID: TC09
Description: Edge case - Customer with multiple products in product_list aggregation.
Preconditions: Customer with sales for multiple distinct products.
Test Steps:
1. Insert sales for one customer with different product_ids.
2. Run the migrated BigQuery SQL query.
Expected Result: product_list contains all distinct product_ids.
Actual Result: [To be filled after test execution]
Pass/Fail Status: [To be filled after test execution]

Test Case ID: TC10
Description: Error handling - Sale with sale_date outside 2023.
Preconditions: Sales record with sale_date not in 2023.
Test Steps:
1. Insert a sale with sale_date outside 2023.
2. Run the migrated BigQuery SQL query.
Expected Result: Sale is excluded from all aggregations and performance CTE.
Actual Result: [To be filled after test execution]
Pass/Fail Status: [To be filled after test execution]

---

Pytest Script for each test case.

```python
import pytest
from google.cloud import bigquery

def setup_test_data(client, dataset_id, customers, sales, products):
    client.query(f"DELETE FROM `{dataset_id}.Customers`").result()
    client.query(f"DELETE FROM `{dataset_id}.Sales`").result()
    client.query(f"DELETE FROM `{dataset_id}.Products`").result()
    if customers:
        client.insert_rows_json(f"{dataset_id}.Customers", customers)
    if sales:
        client.insert_rows_json(f"{dataset_id}.Sales", sales)
    if products:
        client.insert_rows_json(f"{dataset_id}.Products", products)

def run_query(client, query):
    return list(client.query(query).result())

MIGRATED_SQL = """
WITH customer_sales AS (
    SELECT 
        c.customer_id,
        c.customer_name,
        c.region,
        CAST(c.metadata['loyalty_level'] AS STRING) AS loyalty_level,
        SUM(s.sale_amount) AS total_sales,
        COUNT(s.sale_id) AS total_orders,
        ARRAY_AGG(DISTINCT s.product_id) AS product_list
    FROM 
        `{dataset}.Customers` c
    LEFT JOIN 
        `{dataset}.Sales` s ON c.customer_id = s.customer_id
    WHERE 
        s.sale_date >= '2023-01-01' 
        AND s.sale_date < '2024-01-01'
        AND CAST(s.sale_metadata['discount_applied'] AS BOOL) = TRUE
    GROUP BY 
        c.customer_id, c.customer_name, c.region, c.metadata['loyalty_level']
),
top_customers AS (
    SELECT 
        customer_id,
        customer_name,
        region,
        loyalty_level,
        total_sales,
        total_orders,
        product_list,
        RANK() OVER (PARTITION BY region ORDER BY total_sales DESC) AS region_rank
    FROM 
        customer_sales
),
sales_performance AS (
    SELECT
        s.sale_id,
        s.sale_date,
        s.sale_amount,
        s.discount_percentage,
        CAST(s.sale_metadata['source'] AS STRING) AS source,
        p.product_name,
        CASE 
            WHEN s.sale_amount > 1000 THEN 'High Value'
            WHEN s.sale_amount > 500 THEN 'Medium Value'
            ELSE 'Low Value'
        END AS sale_category
    FROM 
        `{dataset}.Sales` s
    INNER JOIN 
        `{dataset}.Products` p ON s.product_id = p.product_id
    WHERE 
        s.sale_date >= '2023-01-01'
        AND CAST(s.sale_metadata['country'] AS STRING) = 'USA'
)
SELECT 
    tc.customer_name,
    tc.region,
    tc.loyalty_level,
    tc.total_sales,
    tc.total_orders,
    sp.sale_id,
    sp.sale_date,
    sp.product_name,
    sp.sale_category,
    sp.source
FROM 
    top_customers tc
LEFT JOIN 
    sales_performance sp ON tc.customer_id = sp.customer_id
WHERE 
    tc.region_rank <= 5
ORDER BY 
    tc.region, tc.region_rank, sp.sale_date
"""

@pytest.fixture(scope="module")
def bq_client():
    return bigquery.Client()

@pytest.fixture(scope="function")
def dataset_id():
    return "your_project.your_test_dataset"

@pytest.mark.parametrize("test_case,customers,sales,products,expected", [
    # TC01: Happy path
    ("TC01",
     [{"customer_id": "C1", "customer_name": "Alice", "region": "West", "metadata": {"loyalty_level": "Gold"}}],
     [{"sale_id": "S1", "customer_id": "C1", "sale_date": "2023-06-01", "sale_amount": 1200, "discount_percentage": 10, "product_id": "P1", "sale_metadata": {"discount_applied": True, "country": "USA", "source": "Online"}},
      {"sale_id": "S2", "customer_id": "C1", "sale_date": "2023-07-01", "sale_amount": 800, "discount_percentage": 5, "product_id": "P2", "sale_metadata": {"discount_applied": True, "country": "USA", "source": "Store"}}],
     [{"product_id": "P1", "product_name": "Widget"}, {"product_id": "P2", "product_name": "Gadget"}],
     [{"customer_name": "Alice", "region": "West", "loyalty_level": "Gold", "total_sales": 2000, "total_orders": 2, "sale_id": "S1", "sale_date": "2023-06-01", "product_name": "Widget", "sale_category": "High Value", "source": "Online"}]
    ),
    # TC02: Customer with no sales
    ("TC02",
     [{"customer_id": "C2", "customer_name": "Bob", "region": "East", "metadata": {"loyalty_level": "Silver"}}],
     [],
     [],
     [{"customer_name": "Bob", "region": "East", "loyalty_level": "Silver", "total_sales": None, "total_orders": 0, "sale_id": None, "sale_date": None, "product_name": None, "sale_category": None, "source": None}]
    ),
    # TC03: Sale with NULL discount_applied
    ("TC03",
     [{"customer_id": "C3", "customer_name": "Carol", "region": "North", "metadata": {"loyalty_level": "Bronze"}}],
     [{"sale_id": "S3", "customer_id": "C3", "sale_date": "2023-08-01", "sale_amount": 600, "discount_percentage": 5, "product_id": "P3", "sale_metadata": {"discount_applied": None, "country": "USA", "source": "Online"}}],
     [{"product_id": "P3", "product_name": "Thingamajig"}],
     []  # Should be excluded
    ),
    # TC04: Sale with missing country/source
    ("TC04",
     [{"customer_id": "C4", "customer_name": "Dave", "region": "South", "metadata": {"loyalty_level": "Gold"}}],
     [{"sale_id": "S4", "customer_id": "C4", "sale_date": "2023-09-01", "sale_amount": 700, "discount_percentage": 15, "product_id": "P4", "sale_metadata": {"discount_applied": True, "source": "Online"}}],  # missing country
     [{"product_id": "P4", "product_name": "Doodad"}],
     []  # Should be excluded
    ),
    # TC05: Boundary sale_amount values
    ("TC05",
     [{"customer_id": "C5", "customer_name": "Eve", "region": "West", "metadata": {"loyalty_level": "Silver"}}],
     [{"sale_id": "S5", "customer_id": "C5", "sale_date": "2023-10-01", "sale_amount": 1000, "discount_percentage": 20, "product_id": "P5", "sale_metadata": {"discount_applied": True, "country": "USA", "source": "Online"}},
      {"sale_id": "S6", "customer_id": "C5", "sale_date": "2023-11-01", "sale_amount": 500, "discount_percentage": 10, "product_id": "P6", "sale_metadata": {"discount_applied": True, "country": "USA", "source": "Store"}}],
     [{"product_id": "P5", "product_name": "Gizmo"}, {"product_id": "P6", "product_name": "Contraption"}],
     [{"customer_name": "Eve", "region": "West", "loyalty_level": "Silver", "total_sales": 1500, "total_orders": 2, "sale_id": "S5", "sale_date": "2023-10-01", "product_name": "Gizmo", "sale_category": "Medium Value", "source": "Online"},
      {"customer_name": "Eve", "region": "West", "loyalty_level": "Silver", "total_sales": 1500, "total_orders": 2, "sale_id": "S6", "sale_date": "2023-11-01", "product_name": "Contraption", "sale_category": "Low Value", "source": "Store"}]
    ),
    # TC06: Invalid data type in discount_applied
    ("TC06",
     [{"customer_id": "C6", "customer_name": "Frank", "region": "East", "metadata": {"loyalty_level": "Gold"}}],
     [{"sale_id": "S7", "customer_id": "C6", "sale_date": "2023-12-01", "sale_amount": 900, "discount_percentage": 15, "product_id": "P7", "sale_metadata": {"discount_applied": "yes", "country": "USA", "source": "Online"}}],
     [{"product_id": "P7", "product_name": "Device"}],
     []  # Should be excluded
    ),
    # TC07: Empty dataset
    ("TC07", [], [], [], []),
    # TC08: Multiple customers with same total_sales
    ("TC08",
     [{"customer_id": "C8a", "customer_name": "Grace", "region": "North", "metadata": {"loyalty_level": "Gold"}},
      {"customer_id": "C8b", "customer_name": "Heidi", "region": "North", "metadata": {"loyalty_level": "Silver"}}],
     [{"sale_id": "S8a", "customer_id": "C8a", "sale_date": "2023-02-01", "sale_amount": 1000, "discount_percentage": 5, "product_id": "P8", "sale_metadata": {"discount_applied": True, "country": "USA", "source": "Online"}},
      {"sale_id": "S8b", "customer_id": "C8b", "sale_date": "2023-03-01", "sale_amount": 1000, "discount_percentage": 5, "product_id": "P9", "sale_metadata": {"discount_applied": True, "country": "USA", "source": "Store"}}],
     [{"product_id": "P8", "product_name": "Apparatus"}, {"product_id": "P9", "product_name": "Instrument"}],
     [{"customer_name": "Grace", "region": "North", "loyalty_level": "Gold", "total_sales": 1000, "total_orders": 1, "sale_id": "S8a", "sale_date": "2023-02-01", "product_name": "Apparatus", "sale_category": "Medium Value", "source": "Online"},
      {"customer_name": "Heidi", "region": "North", "loyalty_level": "Silver", "total_sales": 1000, "total_orders": 1, "sale_id": "S8b", "sale_date": "2023-03-01", "product_name": "Instrument", "sale_category": "Medium Value", "source": "Store"}]
    ),
    # TC09: Customer with multiple products
    ("TC09",
     [{"customer_id": "C9", "customer_name": "Ivan", "region": "South", "metadata": {"loyalty_level": "Bronze"}}],
     [{"sale_id": "S9a", "customer_id": "C9", "sale_date": "2023-04-01", "sale_amount": 300, "discount_percentage": 10, "product_id": "P10", "sale_metadata": {"discount_applied": True, "country": "USA", "source": "Online"}},
      {"sale_id": "S9b", "customer_id": "C9", "sale_date": "2023-05-01", "sale_amount": 400, "discount_percentage": 5, "product_id": "P11", "sale_metadata": {"discount_applied": True, "country": "USA", "source": "Store"}}],
     [{"product_id": "P10", "product_name": "Module"}, {"product_id": "P11", "product_name": "Component"}],
     [{"customer_name": "Ivan", "region": "South", "loyalty_level": "Bronze", "total_sales": 700, "total_orders": 2, "sale_id": "S9a", "sale_date": "2023-04-01", "product_name": "Module", "sale_category": "Low Value", "source": "Online"},
      {"customer_name": "Ivan", "region": "South", "loyalty_level": "Bronze", "total_sales": 700, "total_orders": 2, "sale_id": "S9b", "sale_date": "2023-05-01", "product_name": "Component", "sale_category": "Low Value", "source": "Store"}]
    ),
    # TC10: Sale with sale_date outside 2023
    ("TC10",
     [{"customer_id": "C10", "customer_name": "Judy", "region": "East", "metadata": {"loyalty_level": "Silver"}}],
     [{"sale_id": "S10", "customer_id": "C10", "sale_date": "2022-12-31", "sale_amount": 1000, "discount_percentage": 10, "product_id": "P12", "sale_metadata": {"discount_applied": True, "country": "USA", "source": "Online"}}],
     [{"product_id": "P12", "product_name": "Accessory"}],
     []  # Should be excluded
    ),
])
def test_total_sales_query(bq_client, dataset_id, test_case, customers, sales, products, expected):
    setup_test_data(bq_client, dataset_id, customers, sales, products)
    query = MIGRATED_SQL.replace("{dataset}", dataset_id)
    result = run_query(bq_client, query)
    result_dicts = [{k: row[k] if k in row else None for k in expected[0].keys()} for row in result] if expected else []
    assert result_dicts == expected

```

Test Execution Report Template:

| Test Case ID | Description | Preconditions | Test Steps | Expected Result | Actual Result | Pass/Fail Status |
|--------------|-------------|---------------|------------|-----------------|---------------|------------------|
| TCxx         | ...         | ...           | ...        | ...             | ...           | ...              |

---

API Cost Consumed

**API Cost for this call:**  
0.0042 USD

---
End of Answer