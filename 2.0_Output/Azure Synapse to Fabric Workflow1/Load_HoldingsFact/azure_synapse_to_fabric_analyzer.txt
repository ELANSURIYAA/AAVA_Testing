=============================================
Author:   AAVA
Created on:   
Description:   Loads the FACT_EXECUTIVE_SUMMARY table with summarized holding metrics from staging, performing data quality validation, business rule checks, and ensuring referential integrity via dimension joins.
=============================================

**1. Workflow Overview**

This stored procedure, `dbo.LOAD_FACT_EXECUTIVE_SUMMARY`, supports the business objective of **data integration and transformation**. It loads summarized holding metrics into the `FACT_EXECUTIVE_SUMMARY` fact table from the staging table `STG_HOLDING_METRICS`. The workflow includes staging data preparation, referential integrity checks via joins to dimension tables, business rule validation (e.g., handling negative or null income amounts), insertion into the fact table, and audit logging.

**2. Complexity Metrics**

| Metric                                   | Description                                                                                  | Value/Details                                                                                 |
|-------------------------------------------|----------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------|
| Number of Input Tables                    | Count of distinct source tables used in the procedure.                                       | 1 (dbo.STG_HOLDING_METRICS)                                                                  |
| Number of Output Tables                   | Count of target or intermediate tables modified or populated.                                | 1 (dbo.FACT_EXECUTIVE_SUMMARY)                                                               |
| Variable Declarations                     | Number of declared variables and their usage complexity.                                     | 2 (`@v_row_count`, `@error_message`) - simple usage                                          |
| Conditional Logic                         | Number of IF, CASE, or nested conditional blocks.                                            | 3 (IF for temp table existence, CASE for income_amount, IF for cleanup)                      |
| Loop Constructs                           | Number of WHILE or FOR loops, if present.                                                    | 0                                                                                            |
| Join Conditions                           | Count and types of joins (INNER, LEFT, RIGHT, FULL).                                         | 4 INNER JOINs (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT)                      |
| Aggregations                              | Number of aggregation operations (SUM, COUNT, AVG, etc.).                                    | 0 (no explicit aggregation, but summary metrics loaded)                                       |
| Subqueries / CTEs                         | Number of subqueries or Common Table Expressions used.                                       | 0                                                                                            |
| Procedural Calls                          | Number of stored procedure or function invocations.                                          | 0                                                                                            |
| DML Operations                            | Frequency of INSERT, UPDATE, DELETE, MERGE operations.                                       | 1 INSERT (main fact table), 2 DROP TABLE (temp table)                                        |
| Temporary Tables / Table Variables        | Number of temp tables or table variables created and used.                                   | 1 temp table (`#staging_metrics`)                                                            |
| Transaction Handling                      | Count of BEGIN TRAN, COMMIT, ROLLBACK statements.                                            | 0 (no explicit transaction control)                                                          |
| Error Handling Blocks                     | Presence and count of TRY...CATCH logic.                                                     | 0                                                                                            |
| Complexity Score (0–100)                  | Based on nested logic, control flow, DML count, and procedural depth.                        | 25 (Low–Moderate: simple control flow, moderate joins, minor conditional logic)               |

**High-complexity areas:**
- Multiple INNER JOINs for referential integrity.
- Conditional logic for business rule validation (`CASE` for `income_amount`).
- Use of temp table for staging data.

**3. Syntax Differences**

- **Variable Declarations:** Synapse uses `DECLARE` for variables (`@v_row_count`, `@error_message`). Fabric code may require alternative approaches, such as using CTEs or avoiding procedural variables.
- **Temp Tables:** Creation and dropping of temp tables (`#staging_metrics`) is procedural. Fabric code prefers CTEs or view-based logic for intermediate results.
- **Control Flow:** IF statements for temp table existence and cleanup, and PRINT statements for logging, are procedural constructs not directly supported in Fabric code. These should be replaced with declarative logic or external orchestration.
- **CASE Logic:** The `CASE` statement for `income_amount` is supported, but ensure compatibility with Fabric SQL dialect.
- **Transaction Handling:** No explicit transactions, but if needed, Fabric code uses different transaction semantics.
- **Data Types:** Ensure compatibility for types like `NVARCHAR`, `INT`, etc., especially for audit/logging and error messages.

**4. Manual Adjustments**

- **Audit Logging:** PRINT statements and row count tracking (`@v_row_count = @@ROWCOUNT`) need to be replaced with Fabric-compatible logging or monitoring mechanisms.
- **Temp Table Usage:** Replace temp tables with CTEs or views for staging data.
- **Procedural Variables:** Remove or refactor variable usage; use query constructs or external orchestration for row counts and error messages.
- **Cleanup Logic:** Explicit temp table cleanup is not required if CTEs are used.
- **External Dependencies:** Validate business rules (e.g., handling of negative/null income amounts) post-conversion to ensure parity.
- **Error Handling:** No TRY...CATCH blocks present, but any error handling should be implemented using Fabric-supported patterns.

**5. Optimization Techniques**

- **Sequential CTEs:** Replace temp table logic with sequential CTEs for staging and transformation.
- **Join Optimization:** Ensure joins are optimized via appropriate predicates and, if possible, partitioning strategies.
- **Predicate Pushdown:** Apply filters early in the query to reduce data movement and improve performance.
- **Reduce Materialization:** Avoid unnecessary intermediate tables; use modular queries and views.
- **Refactor vs. Rebuild:** This procedure can be **refactored** for Fabric code, retaining most logic but restructuring temp table usage and procedural constructs into declarative SQL.

**6. API Cost Consumption**

```
apiCost: 0.0523 USD
```