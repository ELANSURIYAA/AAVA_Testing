=============================================
Author:   AAVA
Created on:   
Description:   Loads the FACT_EXECUTIVE_SUMMARY table with summarized holding metrics from staging, performing data validation, business rule checks, and ensuring referential integrity via joins to dimension tables.
=============================================

**1. Workflow Overview**

This stored procedure, `dbo.LOAD_FACT_EXECUTIVE_SUMMARY`, is designed to load the `FACT_EXECUTIVE_SUMMARY` fact table from the staging table `STG_HOLDING_METRICS`. The workflow includes preparing staging data, validating and transforming records, joining with dimension tables to ensure referential integrity, inserting cleansed data into the fact table, and performing audit logging. The key business objective is **data integration and transformation** for executive summary reporting.

**2. Complexity Metrics**

| Metric                                    | Description                                                                 | Value / Notes                                           |
|--------------------------------------------|-----------------------------------------------------------------------------|---------------------------------------------------------|
| Number of Input Tables                     | Count of distinct source tables used in the procedure.                      | 1 (`STG_HOLDING_METRICS`)                              |
| Number of Output Tables                    | Count of target or intermediate tables modified or populated.                | 1 (`FACT_EXECUTIVE_SUMMARY`), 1 temp table (`#staging_metrics`) |
| Variable Declarations                      | Number of declared variables and their usage complexity.                     | 2 (`@v_row_count`, `@error_message`)                   |
| Conditional Logic                         | Number of IF, CASE, or nested conditional blocks.                           | 3 (IF for temp table existence, CASE for income_amount, IF for cleanup) |
| Loop Constructs                           | Number of WHILE or FOR loops, if present.                                   | 0                                                      |
| Join Conditions                           | Count and types of joins (INNER, LEFT, RIGHT, FULL).                        | 4 INNER JOINs (to dimension tables)                    |
| Aggregations                              | Number of aggregation operations (SUM, COUNT, AVG, etc.).                   | 0 (no explicit aggregation)                            |
| Subqueries / CTEs                         | Number of subqueries or Common Table Expressions used.                       | 0                                                      |
| Procedural Calls                          | Number of stored procedure or function invocations.                          | 0                                                      |
| DML Operations                            | Frequency of INSERT, UPDATE, DELETE, MERGE operations.                       | 1 INSERT, 2 DROP TABLE (temp table)                    |
| Temporary Tables / Table Variables         | Number of temp tables or table variables created and used.                   | 1 temp table (`#staging_metrics`)                      |
| Transaction Handling                      | Count of BEGIN TRAN, COMMIT, ROLLBACK statements.                            | 0                                                      |
| Error Handling Blocks                     | Presence and count of TRY...CATCH logic.                                     | 0                                                      |
| Complexity Score (0â€“100)                   | Based on nested logic, control flow, DML count, and procedural depth.        | 30 (Low to moderate: simple control flow, joins, minimal variables) |

**High-complexity areas:**
- Multiple joins to dimension tables for referential integrity
- Conditional logic for data cleansing (`CASE` for income_amount)
- Use of temporary table for staging

**3. Syntax Differences**

- **Variable Declarations:** Fabric code does not support T-SQL `DECLARE` statements for procedural variables. Logic relying on variables (e.g., `@v_row_count`, `@error_message`) must be refactored into query-based constructs or omitted if not critical.
- **Temporary Tables:** Fabric code prefers CTEs or views over temp tables (`#staging_metrics`). Replace temp table usage with sequential CTEs or direct query chaining.
- **Control Flow:** IF statements and procedural `PRINT` statements are not supported. Replace with declarative logic or logging mechanisms as supported by Fabric.
- **CASE Expressions:** Supported in Fabric SQL, but ensure syntax compatibility.
- **Transaction Handling:** No explicit transaction blocks (`BEGIN TRAN`, `COMMIT`, `ROLLBACK`) present, but if needed, must be handled via Fabric-supported mechanisms.
- **Error Handling:** TRY...CATCH blocks are not present; if error handling is required, must be implemented using Fabric-specific patterns.
- **Data Type Differences:** Validate that all data types (e.g., `NVARCHAR`, `INT`) are compatible or require conversion (e.g., `DATETIME` to `TIMESTAMP`).

**4. Manual Adjustments**

- **Audit Logging:** `PRINT` statements and row count tracking via variables must be replaced with Fabric-supported logging or monitoring (if available).
- **Temp Table Replacement:** Refactor temp table logic into CTEs or views.
- **Business Rule Validation:** Conditional logic (e.g., `CASE` for income_amount) should be reviewed post-conversion to ensure parity.
- **External Dependencies:** No external function calls or system procedures detected, but validate if any referenced objects (dimension tables) require schema adjustments.
- **Procedural Constructs:** Any procedural logic (variables, IF statements) must be manually reviewed and re-implemented using Fabric declarative SQL.

**5. Optimization Techniques**

- **Sequential CTEs:** Replace temp table creation and usage with sequential CTEs for staging and transformation.
- **Join Optimization:** Ensure joins to dimension tables are performed efficiently; consider predicate pushdown and partitioning if supported by Fabric.
- **Reduce Materializations:** Minimize intermediate table creation; chain queries using CTEs or views.
- **Simplify Logic:** Consolidate conditional logic into query expressions; avoid procedural constructs.
- **Refactor vs. Rebuild:** Recommend **Refactor** for this workflow, as logic is straightforward and can be adapted to Fabric code with moderate changes.

**6. API Cost Consumption**

```
apiCost: 0.0523 USD
```