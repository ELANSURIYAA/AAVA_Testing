=============================================
Author:   AAVA
Created on:   
Description:   Loads the FACT_EXECUTIVE_SUMMARY table with summarized holding metrics from staging, performing data quality validation, referential integrity checks, and audit logging.
=============================================

**1. Workflow Overview**

This stored procedure, `dbo.LOAD_FACT_EXECUTIVE_SUMMARY`, is designed to populate the `FACT_EXECUTIVE_SUMMARY` fact table in Azure Synapse. It extracts data from the staging table `STG_HOLDING_METRICS`, applies business rule validations and data quality checks, joins with multiple dimension tables to ensure referential integrity, and logs audit information about the load process. The primary business objective is data integration and transformation, supporting downstream reporting and analytics on holdings metrics.

**2. Complexity Metrics**

| Metric                                   | Description                                                                 | Value / Notes                                   |
|-------------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------|
| Number of Input Tables                    | Count of distinct source tables used in the procedure.                      | 1 (`STG_HOLDING_METRICS`)                       |
| Number of Output Tables                   | Count of target or intermediate tables modified or populated.                | 1 (`FACT_EXECUTIVE_SUMMARY`), 1 temp table      |
| Variable Declarations                     | Number of declared variables and their usage complexity.                     | 2 (`@v_row_count`, `@error_message`)            |
| Conditional Logic                         | Number of IF, CASE, or nested conditional blocks.                           | 2 IFs (temp table existence), 1 CASE            |
| Loop Constructs                           | Number of WHILE or FOR loops, if present.                                   | 0                                               |
| Join Conditions                           | Count and types of joins (INNER, LEFT, RIGHT, FULL).                        | 4 INNER JOINs                                   |
| Aggregations                              | Number of aggregation operations (SUM, COUNT, AVG, etc.).                   | 0                                               |
| Subqueries / CTEs                         | Number of subqueries or Common Table Expressions used.                       | 0                                               |
| Procedural Calls                          | Number of stored procedure or function invocations.                          | 0                                               |
| DML Operations                            | Frequency of INSERT, UPDATE, DELETE, MERGE operations.                       | 1 INSERT, 1 SELECT INTO, 2 DROP TABLE           |
| Temporary Tables / Table Variables        | Number of temp tables or table variables created and used.                   | 1 temp table (`#staging_metrics`)               |
| Transaction Handling                      | Count of BEGIN TRAN, COMMIT, ROLLBACK statements.                            | 0                                               |
| Error Handling Blocks                     | Presence and count of TRY...CATCH logic.                                    | 0                                               |
| Complexity Score (0â€“100)                  | Based on nested logic, control flow, DML count, and procedural depth.        | 30                                              |

**High-Complexity Areas:**
- Multiple joins to dimension tables for referential integrity.
- Conditional logic for temp table management and business rule enforcement via CASE.
- Use of temporary staging table for intermediate data handling.

**3. Syntax Differences**

- **Variable Declarations:** Fabric code does not support procedural variable declarations (`DECLARE @var`). Replace with derived columns or CTE logic.
- **Procedural Blocks:** Fabric code is declarative; procedural constructs like `BEGIN...END`, `PRINT`, and procedural flow must be restructured as modular queries or notebook cells.
- **Temporary Tables:** Use CTEs or views instead of temp tables (`#staging_metrics`).
- **Control-Flow Logic:** IF statements and CASE expressions must be replaced with WHERE clauses, CTEs, or view logic. CASE expressions in SELECT are supported but procedural IFs are not.
- **Transaction Handling:** No explicit transaction control (`BEGIN TRAN`, `COMMIT`, `ROLLBACK`) in Fabric code; ensure atomicity through query design.
- **Error Handling:** TRY...CATCH blocks are not supported; error handling must be managed externally or via monitoring.
- **Data Type Differences:** Ensure compatibility for types like `DATETIME` (use `TIMESTAMP` in Fabric), and adjust precision for decimals if needed.

**4. Manual Adjustments**

- **Audit Logging:** PRINT statements and audit row counts must be replaced with Fabric-compatible logging or monitoring mechanisms.
- **Temp Table Cleanup:** Explicit DROP TABLE statements are not needed; use ephemeral CTEs or views.
- **Business Rule Validation:** CASE logic for `income_amount` should be validated post-conversion to ensure correct handling of nulls and negatives.
- **External Dependencies:** If any pre/post job scripts or external system procedures exist, these must be manually re-implemented or orchestrated outside Fabric.
- **Referential Integrity:** Ensure joins to dimension tables are valid and perform as expected in Fabric.

**5. Optimization Techniques**

- **Modularize Queries:** Convert procedural steps into sequential CTEs for clarity and maintainability.
- **Predicate Pushdown:** Apply filters early in CTEs to minimize data scanned during joins.
- **Join Optimization:** For large dimension tables, consider partitioning or indexing strategies supported by Fabric.
- **Reduce Materializations:** Avoid unnecessary intermediate tables; use views or CTEs for transient data.
- **Refactor vs. Rebuild:** Refactor is feasible for this procedure since logic is straightforward and not deeply nested; a full rebuild is not required unless performance profiling in Fabric suggests otherwise.

**6. API Cost Consumption**

```
apiCost: 0.0523 USD
```