```
=============================================
Author:   AAVA
Created on:   
Description:   Loads FACT_EXECUTIVE_SUMMARY fact table with summarized holding metrics from staging, performing data validation, referential integrity checks, and audit logging.
=============================================

**1. Workflow Overview**

This stored procedure (`dbo.LOAD_FACT_EXECUTIVE_SUMMARY`) supports the business objective of data integration and transformation. It loads the `FACT_EXECUTIVE_SUMMARY` fact table from the staging table `STG_HOLDING_METRICS`, applies data quality validation and business rule checks, ensures referential integrity by joining to dimension tables, and performs audit logging of the inserted records.

**2. Complexity Metrics**

| Metric                                 | Description                                                                                  | Value/Notes                                                      |
|-----------------------------------------|----------------------------------------------------------------------------------------------|------------------------------------------------------------------|
| Number of Input Tables                  | Count of distinct source tables used in the procedure.                                       | 1 (dbo.STG_HOLDING_METRICS)                                      |
| Number of Output Tables                 | Count of target or intermediate tables modified or populated.                                | 1 (dbo.FACT_EXECUTIVE_SUMMARY)                                   |
| Variable Declarations                   | Number of declared variables and their usage complexity.                                     | 2 (`@v_row_count`, `@error_message`) – simple usage              |
| Conditional Logic                       | Number of IF, CASE, or nested conditional blocks.                                            | 3 (IF for temp table existence, CASE for income_amount, IF for cleanup) |
| Loop Constructs                         | Number of WHILE or FOR loops, if present.                                                    | 0                                                                |
| Join Conditions                         | Count and types of joins (INNER, LEFT, RIGHT, FULL).                                         | 4 INNER JOINs (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Aggregations                            | Number of aggregation operations (SUM, COUNT, AVG, etc.).                                    | 0 (no explicit aggregation)                                      |
| Subqueries / CTEs                       | Number of subqueries or Common Table Expressions used.                                       | 0                                                                |
| Procedural Calls                        | Number of stored procedure or function invocations.                                          | 0                                                                |
| DML Operations                          | Frequency of INSERT, UPDATE, DELETE, MERGE operations.                                       | 1 INSERT, 2 DROP TABLEs                                          |
| Temporary Tables / Table Variables      | Number of temp tables or table variables created and used.                                   | 1 temp table (#staging_metrics)                                  |
| Transaction Handling                    | Count of BEGIN TRAN, COMMIT, ROLLBACK statements.                                            | 0                                                                |
| Error Handling Blocks                   | Presence and count of TRY...CATCH logic.                                                     | 0                                                                |
| Complexity Score (0–100)                | Based on nested logic, control flow, DML count, and procedural depth.                        | 25 (Low–Moderate; mainly joins, simple control flow)             |

**High-Complexity Areas:**
- Conditional logic for temp table management and business rule enforcement (income_amount).
- Multiple joins for referential integrity.
- Use of temp table for staging.
- No dynamic SQL, procedural loops, or deep nesting.

**3. Syntax Differences**

- **Variable Declarations:** Synapse uses `DECLARE` for variables; Fabric code may require different syntax or may not support procedural variable usage directly.
- **Temp Tables:** Creation and management of temp tables (`#staging_metrics`) may need to be replaced with CTEs or views in Fabric code.
- **Control Flow:** IF statements for object existence and CASE logic for business rules must be translated to declarative SQL or modular query logic.
- **PRINT Statements:** Logging via PRINT is not supported in Fabric code; consider using audit tables or Fabric-native logging.
- **Transaction Handling:** No explicit transactions here, but if present, would need to be refactored.
- **Data Type Conversion:** Ensure NVARCHAR, INT, etc., are compatible; DATETIME/TIMESTAMP conversions may be needed.
- **Object Existence Checks:** `OBJECT_ID` checks for temp tables are procedural and should be replaced with logic that avoids procedural existence checks.

**4. Manual Adjustments**

- **Audit Logging:** PRINT statements for audit must be replaced with Fabric-compatible logging or table-based audit.
- **Temp Table Usage:** Replace temp table logic with CTEs or views, as Fabric code does not support temp tables in the same way.
- **Variable Usage:** Refactor logic that uses variables (`@v_row_count`) to use query-based row counts or output tables.
- **Conditional Logic:** CASE logic for business rules (e.g., income_amount) should be validated post-conversion to ensure parity.
- **Cleanup Steps:** Explicit DROP TABLE for temp tables should be omitted or replaced with Fabric-compatible cleanup.
- **External Dependencies:** No external function calls or system procedures, but ensure business rules are validated after conversion.

**5. Optimization Techniques**

- **Use Sequential CTEs:** Replace temp table staging with sequential CTEs to modularize logic and improve readability.
- **Predicate Pushdown:** Ensure joins are filtered as early as possible to optimize performance.
- **Reduce Materializations:** Avoid unnecessary intermediate tables; use views or CTEs for transformations.
- **Combine Queries:** Merge simple validation and transformation logic into the main SELECT/INSERT to minimize steps.
- **Refactor vs. Rebuild:** This procedure can be refactored, retaining most logic as-is, but temp table and variable usage should be restructured for Fabric code efficiency.

**6. API Cost Consumption**

```
apiCost: 0.0523 USD