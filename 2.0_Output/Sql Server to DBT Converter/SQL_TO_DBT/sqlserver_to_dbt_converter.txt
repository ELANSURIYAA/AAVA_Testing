-- Original SQL Server Query:
WITH customer_orders AS (
    SELECT
        o.id AS order_id,
        o.user_id,
        u.name AS customer_name,
        u.email AS customer_email,
        o.total_amount,
        o.created_at AS order_date,
        p.category AS product_category,
        p.price AS product_price
    FROM raw.orders o
    JOIN raw.users u ON o.user_id = u.id
    JOIN raw.order_items oi ON o.id = oi.order_id
    JOIN raw.products p ON oi.product_id = p.id
    WHERE o.status = 'completed'
),

order_summary AS (
    SELECT 
        user_id,
        customer_name,
        customer_email,
        COUNT(order_id) AS total_orders,
        SUM(total_amount) AS total_spent,
        AVG(total_amount) AS avg_order_value,
        ARRAY_AGG(DISTINCT product_category) AS categories_bought
    FROM customer_orders
    GROUP BY user_id, customer_name, customer_email
)

SELECT * FROM order_summary
ORDER BY total_spent DESC;

-- DBT-Compatible Query:
-- This query is rewritten for DBT compatibility (assuming a platform like BigQuery, Snowflake, or Redshift).
-- ARRAY_AGG(DISTINCT ...) is not supported in all warehouses; use appropriate syntax per warehouse.
-- For BigQuery: ARRAY_AGG(DISTINCT ...)
-- For Snowflake: ARRAY_AGG(DISTINCT ...) is supported.
-- For Redshift: Use LISTAGG(DISTINCT ...) or array_agg(distinct ...) if available.

WITH customer_orders AS (
    SELECT
        o.id AS order_id,
        o.user_id,
        u.name AS customer_name,
        u.email AS customer_email,
        o.total_amount,
        o.created_at AS order_date,
        p.category AS product_category,
        p.price AS product_price
    FROM {{ ref('orders') }} o
    JOIN {{ ref('users') }} u ON o.user_id = u.id
    JOIN {{ ref('order_items') }} oi ON o.id = oi.order_id
    JOIN {{ ref('products') }} p ON oi.product_id = p.id
    WHERE o.status = 'completed'
),

order_summary AS (
    SELECT 
        user_id,
        customer_name,
        customer_email,
        COUNT(order_id) AS total_orders,
        SUM(total_amount) AS total_spent,
        AVG(total_amount) AS avg_order_value,
        -- Use warehouse-specific syntax for array aggregation
        {% if target.type == 'bigquery' %}
            ARRAY_AGG(DISTINCT product_category) AS categories_bought
        {% elif target.type == 'snowflake' %}
            ARRAY_AGG(DISTINCT product_category) AS categories_bought
        {% elif target.type == 'redshift' %}
            LISTAGG(DISTINCT product_category, ',') AS categories_bought
        {% else %}
            ARRAY_AGG(product_category) AS categories_bought
        {% endif %}
    FROM customer_orders
    GROUP BY user_id, customer_name, customer_email
)

SELECT * FROM order_summary
ORDER BY total_spent DESC;

-- Notes:
-- 1. The {{ ref('table_name') }} macro is used for DBT model referencing.
-- 2. The array aggregation for categories_bought is handled with a DBT Jinja conditional for warehouse compatibility.
-- 3. This query is ready to be placed in a DBT model file (.sql) and will render correctly depending on your target warehouse.
-- 4. Test this model in your DBT environment to ensure compatibility and correctness.