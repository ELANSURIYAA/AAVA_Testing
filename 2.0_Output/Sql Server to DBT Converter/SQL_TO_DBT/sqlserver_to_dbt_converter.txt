-- Original SQL Server Query:
WITH customer_orders AS (
    SELECT
        o.id AS order_id,
        o.user_id,
        u.name AS customer_name,
        u.email AS customer_email,
        o.total_amount,
        o.created_at AS order_date,
        p.category AS product_category,
        p.price AS product_price
    FROM raw.orders o
    JOIN raw.users u ON o.user_id = u.id
    JOIN raw.order_items oi ON o.id = oi.order_id
    JOIN raw.products p ON oi.product_id = p.id
    WHERE o.status = 'completed'
),

order_summary AS (
    SELECT 
        user_id,
        customer_name,
        customer_email,
        COUNT(order_id) AS total_orders,
        SUM(total_amount) AS total_spent,
        AVG(total_amount) AS avg_order_value,
        ARRAY_AGG(DISTINCT product_category) AS categories_bought
    FROM customer_orders
    GROUP BY user_id, customer_name, customer_email
)

SELECT * FROM order_summary
ORDER BY total_spent DESC;

-- DBT-Compatible Query:
{{ 
    config(
        materialized='table'
    )
}}

-- CTE to collect completed customer orders
with customer_orders as (
    select
        o.id as order_id,
        o.user_id,
        u.name as customer_name,
        u.email as customer_email,
        o.total_amount,
        o.created_at as order_date,
        p.category as product_category,
        p.price as product_price
    from {{ ref('orders') }} o
    join {{ ref('users') }} u on o.user_id = u.id
    join {{ ref('order_items') }} oi on o.id = oi.order_id
    join {{ ref('products') }} p on oi.product_id = p.id
    where o.status = 'completed'
),

-- CTE to summarize orders by customer
order_summary as (
    select
        user_id,
        customer_name,
        customer_email,
        count(order_id) as total_orders,
        sum(total_amount) as total_spent,
        avg(total_amount) as avg_order_value,
        -- Use array_agg for supported warehouses (BigQuery, Snowflake, Redshift)
        array_agg(distinct product_category) as categories_bought
    from customer_orders
    group by user_id, customer_name, customer_email
)

select * from order_summary
order by total_spent desc

-- Notes:
-- 1. Table references use {{ ref('table_name') }} for DBT best practices.
-- 2. ARRAY_AGG is supported in BigQuery, Snowflake, and Redshift. For other warehouses, use the equivalent aggregation function.
-- 3. The config block at the top materializes this model as a table for performance.
-- 4. All logic and output remain the same as the original query.