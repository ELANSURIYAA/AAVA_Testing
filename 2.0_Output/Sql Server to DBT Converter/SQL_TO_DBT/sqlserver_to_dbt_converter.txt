-- Original SQL Server Query:
WITH customer_orders AS (
    SELECT
        o.id AS order_id,
        o.user_id,
        u.name AS customer_name,
        u.email AS customer_email,
        o.total_amount,
        o.created_at AS order_date,
        p.category AS product_category,
        p.price AS product_price
    FROM raw.orders o
    JOIN raw.users u ON o.user_id = u.id
    JOIN raw.order_items oi ON o.id = oi.order_id
    JOIN raw.products p ON oi.product_id = p.id
    WHERE o.status = 'completed'
),

order_summary AS (
    SELECT 
        user_id,
        customer_name,
        customer_email,
        COUNT(order_id) AS total_orders,
        SUM(total_amount) AS total_spent,
        AVG(total_amount) AS avg_order_value,
        ARRAY_AGG(DISTINCT product_category) AS categories_bought
    FROM customer_orders
    GROUP BY user_id, customer_name, customer_email
)

SELECT * FROM order_summary
ORDER BY total_spent DESC;

-- DBT-Compatible Query:
-- Note: ARRAY_AGG(DISTINCT ...) is not supported in all DBT target databases (e.g., BigQuery supports ARRAY_AGG(DISTINCT ...), but Snowflake uses ARRAY_AGG and DISTINCT inside it is not allowed; Redshift uses LISTAGG or ARRAY_AGG). 
-- For portability, we use STRING_AGG(DISTINCT ...) for Snowflake/Redshift, or ARRAY_AGG(DISTINCT ...) for BigQuery. 
-- Adjust the aggregation function as per your warehouse. 
-- Also, DBT models typically reference sources using {{ ref('...') }} or {{ source('...', '...') }}.

WITH customer_orders AS (
    SELECT
        o.id AS order_id,
        o.user_id,
        u.name AS customer_name,
        u.email AS customer_email,
        o.total_amount,
        o.created_at AS order_date,
        p.category AS product_category,
        p.price AS product_price
    FROM {{ source('raw', 'orders') }} o
    JOIN {{ source('raw', 'users') }} u ON o.user_id = u.id
    JOIN {{ source('raw', 'order_items') }} oi ON o.id = oi.order_id
    JOIN {{ source('raw', 'products') }} p ON oi.product_id = p.id
    WHERE o.status = 'completed'
),

order_summary AS (
    SELECT 
        user_id,
        customer_name,
        customer_email,
        COUNT(order_id) AS total_orders,
        SUM(total_amount) AS total_spent,
        AVG(total_amount) AS avg_order_value,
        -- For BigQuery:
        -- ARRAY_AGG(DISTINCT product_category) AS categories_bought
        -- For Snowflake/Redshift:
        STRING_AGG(DISTINCT product_category, ', ') AS categories_bought
    FROM customer_orders
    GROUP BY user_id, customer_name, customer_email
)

SELECT * FROM order_summary
ORDER BY total_spent DESC;

-- DBT Optimization Notes:
-- 1. Use {{ source('raw', 'table_name') }} for referencing source tables.
-- 2. If using BigQuery, you can uncomment ARRAY_AGG(DISTINCT product_category).
-- 3. If using Snowflake/Redshift, use STRING_AGG(DISTINCT product_category, ', ') to get a comma-separated list.
-- 4. For materialization, consider using 'table' or 'incremental' in your dbt model config block as appropriate.
-- 5. Test this query in your DBT environment and adjust the aggregation function for categories_bought as per your data warehouse.