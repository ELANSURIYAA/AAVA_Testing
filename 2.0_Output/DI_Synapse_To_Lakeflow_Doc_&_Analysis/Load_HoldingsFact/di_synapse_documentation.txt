# Azure Synapse & Databricks Pipeline Documentation

====================================================
Author:        Ascendion AAVA  
Date:          
Description:   Documentation for the Synapse pipeline and stored procedure loading executive summary fact table, including Databricks DBU pricing and data volume context.
====================================================

## 1. Overview of Pipeline/Component

This solution orchestrates the loading of the `FACT_EXECUTIVE_SUMMARY` table in Synapse Analytics using a stored procedure that summarizes holding metrics from staging data. The pipeline ensures data quality, applies business rules, and maintains referential integrity by joining to dimension tables. It is designed for high-volume enterprise data warehousing, supporting regulatory reporting and advanced analytics. Databricks DBU pricing and indicative data volumes are provided for cost and capacity planning.

---

## 2. Component Structure and Design

- **Source(s):**
  - `dbo.STG_HOLDING_METRICS` (staging table for holding metrics)
  - Dimension tables: `dbo.DIM_DATE`, `dbo.DIM_INSTITUTION`, `dbo.DIM_CORPORATION`, `dbo.DIM_PRODUCT`
- **Transformation/Processing:**
  - Temporary staging table `#staging_metrics` is created from the source.
  - Data validation and business rule checks are performed (e.g., non-negative income).
  - Joins to dimension tables ensure referential integrity.
- **Sink:**
  - `dbo.FACT_EXECUTIVE_SUMMARY` (target fact table)
- **Activities:**
  - SQL Stored Procedure (`dbo.LOAD_FACT_EXECUTIVE_SUMMARY`)
  - Audit logging and cleanup steps
- **Parameters/Variables:**
  - Internal variables for row count and error messages.
- **Triggers:**
  - Not explicitly defined in the code, but typically orchestrated via Synapse pipeline triggers.

---

## 3. Data Flow and Processing Logic

**Processed Datasets:**
- `dbo.STG_HOLDING_METRICS`
- `dbo.DIM_DATE`
- `dbo.DIM_INSTITUTION`
- `dbo.DIM_CORPORATION`
- `dbo.DIM_PRODUCT`
- `dbo.FACT_EXECUTIVE_SUMMARY`

**Data Flow:**
1. Data is extracted from `STG_HOLDING_METRICS` into a temporary table.
2. Data is validated and joined with dimension tables to ensure referential integrity.
3. Business rules (e.g., non-negative income) are applied.
4. Validated and transformed data is inserted into `FACT_EXECUTIVE_SUMMARY`.
5. Audit logging captures the number of inserted records.
6. Temporary resources are cleaned up.

**Business Rules/Transformations:**
- Income amount is set to 0 if null or negative.
- Only records with matching dimension keys are loaded.

---

## 4. Data Mapping (Lineage)

| Target Table Name         | Target Column Name     | Source Table Name         | Source Column Name     | Remarks                                              |
|--------------------------|-----------------------|--------------------------|-----------------------|------------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key              | DIM_DATE                 | date_key              | 1:1 Mapping via join on stg.date_value               |
| FACT_EXECUTIVE_SUMMARY   | institution_id        | DIM_INSTITUTION          | institution_id        | 1:1 Mapping via join                                 |
| FACT_EXECUTIVE_SUMMARY   | corporation_id        | DIM_CORPORATION          | corporation_id        | 1:1 Mapping via join                                 |
| FACT_EXECUTIVE_SUMMARY   | product_id            | DIM_PRODUCT              | product_id            | 1:1 Mapping via join                                 |
| FACT_EXECUTIVE_SUMMARY   | a120_amount           | STG_HOLDING_METRICS      | a120_amount           | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | a120_count            | STG_HOLDING_METRICS      | a120_count            | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount      | STG_HOLDING_METRICS      | a30_to_59_amount      | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count       | STG_HOLDING_METRICS      | a30_to_59_count       | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount      | STG_HOLDING_METRICS      | a60_to_89_amount      | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count       | STG_HOLDING_METRICS      | a60_to_89_count       | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount     | STG_HOLDING_METRICS      | a90_to_119_amount     | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count      | STG_HOLDING_METRICS      | a90_to_119_count      | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount     | STG_HOLDING_METRICS      | charge_off_amount     | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count      | STG_HOLDING_METRICS      | charge_off_count      | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount          | STG_HOLDING_METRICS      | fraud_amount          | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | fraud_count           | STG_HOLDING_METRICS      | fraud_count           | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | income_amount         | STG_HOLDING_METRICS      | income_amount         | Transformation: IF NULL or <0 THEN 0 ELSE value      |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts    | STG_HOLDING_METRICS      | number_of_accounts    | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount      | STG_HOLDING_METRICS      | purchases_amount      | 1:1 Mapping                                          |
| FACT_EXECUTIVE_SUMMARY   | purchases_count       | STG_HOLDING_METRICS      | purchases_count       | 1:1 Mapping                                          |

---

## 5. Transformation Logic

- **income_amount**:  
  `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`  
  Ensures only non-negative, non-null income values are loaded.

- **Joins**:  
  - `stg.date_value = dt.date_key`
  - `stg.institution_id = inst.institution_id`
  - `stg.corporation_id = corp.corporation_id`
  - `stg.product_id = prod.product_id`
  These enforce referential integrity and filter out orphan records.

- **Audit Logging**:  
  - Captures row count of inserted records for monitoring and traceability.

- **Cleanup**:  
  - Drops temporary staging table after processing.

---

## 6. Complexity Analysis

| Metric                        | Value / Details                                      |
|-------------------------------|-----------------------------------------------------|
| Number of Pipeline Activities | 1 (Stored Procedure)                                |
| Number of Dataflow Transformations | 1 (income_amount transformation)               |
| SQL Scripts or Stored Procedures Used | 1 (dbo.LOAD_FACT_EXECUTIVE_SUMMARY)         |
| Joins Used                    | 4 (INNER JOINs to dimension tables)                 |
| Lookup Tables or Reference Data| 4 (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Parameters/Variables/Triggers | 2 variables, triggers not shown                     |
| Number of Output Datasets     | 1 (FACT_EXECUTIVE_SUMMARY)                          |
| Conditional Logic or if-else Flows | 1 (income_amount transformation)               |
| External Dependencies         | Synapse SQL Pool, dimension tables                  |
| Overall Complexity Score      | 30                                                  |

---

## 7. Key Outputs

- **Output Table:** `dbo.FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse SQL Table (row-based storage, suitable for analytics and reporting)
- **Intended Use:** Downstream reporting, executive dashboards, regulatory submissions, and advanced analytics.

---

## Databricks DBU Pricing & Data Volume Context

- **Enterprise DBU Cost:** $0.15 - $0.75 per hour
- **Indicative Table Volumes:**
  - `dbo.DIM_INSTITUTION`: ~700 GB
  - `dbo.STG_DIMENSION_DATA`: ~150 GB
  - `dbo.DIM_PRODUCT`: ~100 GB
  - `dbo.populate_dimensions` (Target): ~1 TB
  - `stg.Sales_Transactions`: ~700 GB
  - `dw.Dim_Customer`: ~150 GB
  - `dw.Dim_Date`: ~100 GB
  - `dw.Fact_Sales` (Target): ~1 TB
- **Processed Data Volume (10%):** ~650 GB

---

## API Cost

apiCost: 0.007 USD