# ====================================================
Author:        Ascendion AAVA  
Date:          
Description:   Documentation of the Synapse pipeline and SQL logic for loading executive summary fact tables, including data lineage, transformation logic, and complexity analysis.
====================================================

## 1. Overview of Pipeline/Component

This solution orchestrates the loading of executive summary fact tables in Azure Synapse Analytics. It ingests, validates, and transforms holding metrics from staging tables, ensuring data quality and referential integrity by joining with dimension tables. The pipeline supports regulatory reporting, business analytics, and downstream data enrichment, leveraging scalable SQL-based transformations.

## 2. Component Structure and Design

- **Source**:  
  - `dbo.STG_HOLDING_METRICS` (staging table with raw holding metrics)
  - Dimension tables: `dbo.DIM_DATE`, `dbo.DIM_INSTITUTION`, `dbo.DIM_CORPORATION`, `dbo.DIM_PRODUCT`
- **Transformation**:  
  - Temporary staging table `#staging_metrics` created from the staging source.
  - Data validation and business rule enforcement (e.g., non-negative income).
  - Joins to dimension tables for referential integrity.
- **Sink**:  
  - `dbo.FACT_EXECUTIVE_SUMMARY` (target fact table)
- **Orchestration**:  
  - Implemented as a stored procedure (`dbo.LOAD_FACT_EXECUTIVE_SUMMARY`) in Synapse DW.
  - Includes audit logging, error handling, and cleanup.
- **Parameters/Variables**:  
  - Local variables for row count and error messages.
- **Triggers**:  
  - Not explicitly defined in the SQL, but typically invoked by Synapse pipeline activities.

## 3. Data Flow and Processing Logic

**Processed Datasets:**  
- `dbo.STG_HOLDING_METRICS`
- `dbo.DIM_DATE`
- `dbo.DIM_INSTITUTION`
- `dbo.DIM_CORPORATION`
- `dbo.DIM_PRODUCT`
- `dbo.FACT_EXECUTIVE_SUMMARY`

**Data Flow:**  
1. Data is ingested into `dbo.STG_HOLDING_METRICS`.
2. All records are copied to a temporary table `#staging_metrics`.
3. Data is validated and joined with dimension tables to ensure referential integrity.
4. Business rules are applied (e.g., negative or null income set to 0).
5. Validated and enriched records are inserted into `dbo.FACT_EXECUTIVE_SUMMARY`.
6. Row count is logged for auditing.
7. Temporary resources are cleaned up.

**Business Rules & Transformations:**  
- Income amounts that are NULL or negative are set to 0.
- Only records with matching keys in all dimension tables are loaded.

**SQL Scripts/Stored Procedures Used:**  
- `dbo.LOAD_FACT_EXECUTIVE_SUMMARY` (main stored procedure)

## 4. Data Mapping (Lineage)

| Target Table Name         | Target Column Name     | Source Table Name         | Source Column Name     | Remarks                                                      |
|--------------------------|-----------------------|--------------------------|-----------------------|--------------------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key              | DIM_DATE                 | date_key              | 1:1 Mapping (join on stg.date_value = dt.date_key)           |
| FACT_EXECUTIVE_SUMMARY   | institution_id        | DIM_INSTITUTION          | institution_id        | 1:1 Mapping (join on stg.institution_id = inst.institution_id)|
| FACT_EXECUTIVE_SUMMARY   | corporation_id        | DIM_CORPORATION          | corporation_id        | 1:1 Mapping (join on stg.corporation_id = corp.corporation_id)|
| FACT_EXECUTIVE_SUMMARY   | product_id            | DIM_PRODUCT              | product_id            | 1:1 Mapping (join on stg.product_id = prod.product_id)       |
| FACT_EXECUTIVE_SUMMARY   | a120_amount           | STG_HOLDING_METRICS      | a120_amount           | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | a120_count            | STG_HOLDING_METRICS      | a120_count            | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount      | STG_HOLDING_METRICS      | a30_to_59_amount      | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count       | STG_HOLDING_METRICS      | a30_to_59_count       | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount      | STG_HOLDING_METRICS      | a60_to_89_amount      | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count       | STG_HOLDING_METRICS      | a60_to_89_count       | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount     | STG_HOLDING_METRICS      | a90_to_119_amount     | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count      | STG_HOLDING_METRICS      | a90_to_119_count      | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount     | STG_HOLDING_METRICS      | charge_off_amount     | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count      | STG_HOLDING_METRICS      | charge_off_count      | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount          | STG_HOLDING_METRICS      | fraud_amount          | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | fraud_count           | STG_HOLDING_METRICS      | fraud_count           | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | income_amount         | STG_HOLDING_METRICS      | income_amount         | Transformation: NULL/negative set to 0                       |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts    | STG_HOLDING_METRICS      | number_of_accounts    | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount      | STG_HOLDING_METRICS      | purchases_amount      | 1:1 Mapping                                                 |
| FACT_EXECUTIVE_SUMMARY   | purchases_count       | STG_HOLDING_METRICS      | purchases_count       | 1:1 Mapping                                                 |

## 5. Transformation Logic

- **income_amount**:  
  `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`  
  Ensures only non-negative, non-null income values are loaded.

- **Joins**:  
  - `INNER JOIN` between staging and dimension tables to enforce referential integrity.

- **Audit Logging**:  
  - Row count of inserted records is captured and printed for auditing.

- **Cleanup**:  
  - Temporary table `#staging_metrics` is dropped after processing.

- **No UDFs or reusable templates** are used in this logic.

## 6. Complexity Analysis

| Metric                             | Value/Details                                             |
|------------------------------------|----------------------------------------------------------|
| Number of Pipeline Activities      | 1 (main stored procedure)                                |
| Number of Dataflow Transformations | 1 (staging, validation, joins, insert)                   |
| SQL Scripts or Stored Procedures   | 1 (`dbo.LOAD_FACT_EXECUTIVE_SUMMARY`)                    |
| Joins Used                        | 4 (INNER JOINs to dimension tables)                      |
| Lookup Tables or Reference Data    | 4 (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Parameters/Variables/Triggers      | 2 variables, 0 parameters, 0 triggers in SQL             |
| Number of Output Datasets          | 1 (`FACT_EXECUTIVE_SUMMARY`)                             |
| Conditional Logic or if-else Flows | 1 (income_amount transformation)                         |
| External Dependencies              | None (all in-database tables)                            |
| Overall Complexity Score           | 25                                                       |

## 7. Key Outputs

- **Target Table**: `dbo.FACT_EXECUTIVE_SUMMARY`
- **Format**: SQL Table (row-based storage in Synapse DW)
- **Intended Use**:  
  - Executive reporting
  - Regulatory compliance
  - Downstream analytics and enrichment
- **Data Volume**: Up to ~1 TB (indicative)

---

**API Cost:**  
apiCost: 0.008 USD