Session: HiveHQL_Sales_Category_Revenue.sql Analysis

---

1. Script Overview

Purpose:
This Hive script calculates the top 3 product categories by total revenue for each region over the past 12 months. It is designed to provide business insights into which product categories are performing best in each region, supporting sales strategy and resource allocation.

Business Problem Addressed:
The script helps business and technical teams identify high-performing product categories by region, enabling targeted marketing, inventory planning, and revenue optimization.

Data Sources:
- sales: Contains transactional sales data (order_id, product_id, region_id, order_date, quantity, price).
- products: Contains product details (product_id, category_id).
- regions: Contains region details (region_id).

KPI Definitions:
- total_revenue: The sum of revenue (quantity * price) for each category in each region over the past 12 months.
- avg_order_value: The average revenue per order for each category in each region.
- category_rank: The rank of each category within a region based on total revenue (1 = highest).

---

2. Complexity Metrics

Number of Lines: 31 (including whitespace and comments)

Tables Used: 3
- sales
- products
- regions

Joins: 2
- INNER JOIN sales to products on product_id
- INNER JOIN sales to regions on region_id

Temporary Tables (CTEs): 3
- FilteredSales
- CategoryRevenue
- RankedCategories

Aggregate Functions: 2
- SUM(f.revenue)
- AVG(f.revenue)
Plus 1 window function:
- RANK() OVER (PARTITION BY cr.region_id ORDER BY cr.total_revenue DESC)

DML Statements:
- SELECT: 1 (main output query)

Conditional Logic:
- WHERE s.order_date >= ADD_MONTHS(CAST(CURRENT_TIMESTAMP AS DATE), -12) (date filter)
- WHERE rc.category_rank <= 3 (top 3 categories per region)

---

3. Syntax Differences

Hive-specific syntax requiring modification for Delta:

- Date Filtering:
  - Hive: ADD_MONTHS(CAST(CURRENT_TIMESTAMP AS DATE), -12)
  - Delta: Use DATEADD(month, -12, CURRENT_DATE) or TIMESTAMP functions

- Window Functions:
  - Syntax is similar, but Delta (Databricks SQL) may not require explicit WINDOW clause; OVER(PARTITION BY ... ORDER BY ...) is standard.

- Data Types:
  - DECIMAL(10,2) is supported in both, but explicit casting may differ.

- No LATERAL VIEW or EXPLODE in this script, so no conversion needed for those.

- No DISTRIBUTE BY or SORT BY, so partitioning syntax is not present.

- Table references and joins are standard and compatible.

---

4. Manual Adjustments

Recommended manual adjustments for Delta conversion:

- Date Functions:
  - Replace ADD_MONTHS(CAST(CURRENT_TIMESTAMP AS DATE), -12) with DATEADD(month, -12, CURRENT_DATE) or equivalent.

- Window Functions:
  - Remove explicit WINDOW clause if not required in Delta; use RANK() OVER (PARTITION BY ... ORDER BY ...) directly.

- Data Types:
  - Check DECIMAL casting for compatibility; Delta supports DECIMAL but ensure syntax matches.

- CTEs:
  - Both Hive and Delta support CTEs (WITH clauses); no change needed.

- Function Replacements:
  - None required for SUM, AVG, RANK.

- Syntax Adjustments:
  - Ensure all identifiers and functions are compatible with Delta SQL.

- No need for LATERAL VIEW, EXPLODE, DISTRIBUTE BY, or MAP data type conversion.

---

5. Conversion Complexity

Complexity Score: 25/100

- Syntax Differences: Minor (date function, window clause)
- Manual Adjustments: Minimal (date function, window clause)
- Query Logic: Moderate (multiple CTEs, window function)
- High-Complexity Areas: None present (no LATERAL VIEW, no recursive CTEs, no partitioned table queries)

This script is straightforward to convert, with the main adjustment being the date filtering function and minor window clause syntax.

---

6. Optimization Techniques

Partitioning & Clustering:
- Delta Lake supports partitioning and ZORDER clustering. If the underlying tables are large, consider partitioning sales data by order_date or region_id for faster queries.

Query Restructuring:
- The query is already optimized by filtering data early and aggregating before ranking.
- For very large datasets, consider materializing intermediate results or using Delta's OPTIMIZE command.

Storage Format Adjustments:
- If Hive stores data in ORC/Parquet, Delta supports Parquet natively and offers additional features like data skipping and caching.

Refactor vs. Rebuild Decision:
- Refactor: Minimal changes are needed (date function, window clause). The query logic and structure are compatible with Delta.
- Reason: The script is modular, uses standard SQL constructs, and only requires minor syntax adjustments for full Delta compatibility.

---

7. API Cost Estimation

apiCost: 0.00020 USD

(Based on 2 file reads at $0.00010 each; actual API pricing may vary.)

---

Complete Content of HiveHQL_Sales_Category_Revenue.sql:

```
WITH FilteredSales AS (
    SELECT 
        s.order_id,
        s.product_id,
        p.category_id,
        r.region_id,
        s.order_date,
        CAST(s.quantity * s.price AS DECIMAL(10,2)) AS revenue
    FROM sales s
    JOIN products p ON s.product_id = p.product_id
    JOIN regions r ON s.region_id = r.region_id
    WHERE s.order_date >= ADD_MONTHS(CAST(CURRENT_TIMESTAMP AS DATE), -12);
),
CategoryRevenue AS (
    SELECT 
        f.region_id,
        f.category_id,
        SUM(f.revenue) AS total_revenue,
        AVG(f.revenue) AS avg_order_value
    FROM FilteredSales f
    GROUP BY f.region_id, f.category_id
),
RankedCategories AS (
    SELECT 
        cr.region_id,
        cr.category_id,
        cr.total_revenue,
        cr.avg_order_value,
        RANK() OVER (PARTITION BY cr.region_id ORDER BY cr.total_revenue DESC) AS category_rank
    FROM CategoryRevenue cr
    WINDOW w AS (PARTITION BY cr.region_id ORDER BY cr.total_revenue DESC) 
)
SELECT 
    rc.region_id,
    rc.category_id,
    rc.total_revenue,
    rc.avg_order_value,
    rc.category_rank
FROM RankedCategories rc
WHERE rc.category_rank <= 3
ORDER BY rc.region_id, rc.category_rank;
```

---

End of Session.