=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads cleaned sales transaction data from staging into the sales fact table, applying data quality checks, transformations, and audit logging.
=============================================

Procedure Overview:
The stored procedure `dw.sp_load_sales_fact` is designed to load sales transaction data from the staging table (`stg.Sales_Transactions`) into the sales fact table (`dw.Fact_Sales`). It performs essential data quality checks, applies business logic transformations, logs audit information, and manages data validation failures. This procedure is a core component of the ETL pipeline, ensuring only high-quality, validated sales data is loaded into the data warehouse for analytics and reporting. It addresses the business need for accurate, reliable sales data and supports downstream reporting and decision-making processes.

Logic Details:
- Main purpose: Cleans, transforms, and loads sales data from staging to fact table, while logging audit and data quality results.
- Structure: 
  - Audit logging (start/end)
  - Data quality validation (temporary table for invalid rows)
  - Data transformation (CTE for business logic)
  - Data load (insert into fact table)
  - Staging table cleanup
  - Data quality failure logging
  - Error handling and audit updates
- Key SQL operations: INSERT, DELETE, SELECT, JOIN, CTE, TRUNCATE, TRY/CATCH, variable declarations.
- Input parameters: None (uses internal variables for batch/audit tracking).
- Output: Data loaded into `dw.Fact_Sales`, audit logs, and data quality failure records.

Data Flow Details:
1. Audit log entry is created to mark the start of the batch.
2. Temporary table `#InvalidRows` is created to capture validation failures.
3. Data quality checks identify missing `Customer_ID` and invalid `Quantity` in `stg.Sales_Transactions`. Invalid rows are logged in `#InvalidRows`.
4. Invalid rows are deleted from the staging table.
5. Cleaned data is transformed using a CTE (`transformed`), joining with `dw.Dim_Customer` and `dw.Dim_Date` for enrichment.
6. Transformed data is inserted into `dw.Fact_Sales`.
7. Staging table is truncated to prepare for the next batch.
8. Data quality failures are logged to `dw.DQ_Failures`.
9. Audit log is updated with batch completion status, row counts, and messages.
10. Error handling updates audit log with failure status if an exception occurs.
11. Temporary table is dropped as final cleanup.

Data Transformations:
- Calculates `Total_Sales_Amount` as `Quantity * Unit_Price`.
- Enriches sales data with `Region_ID` (from `Dim_Date`) and `Customer_Segment` (from `Dim_Customer`).
- Adds `Load_Timestamp` and `Batch_ID` for traceability.
- Filters out rows with missing `Customer_ID` or invalid `Quantity` (<=0).
- Ensures only valid, enriched, and traceable sales transactions are loaded.

Data Mapping:

| Target Table Name | Target Column Name    | Source Table Name   | Source Column Name    | Remarks                                 |
|-------------------|----------------------|---------------------|----------------------|------------------------------------------|
| dw.Fact_Sales     | Transaction_ID       | stg.Sales_Transactions | Transaction_ID     | 1 to 1 mapping                          |
| dw.Fact_Sales     | Customer_ID          | stg.Sales_Transactions | Customer_ID        | 1 to 1 mapping, validated not null       |
| dw.Fact_Sales     | Product_ID           | stg.Sales_Transactions | Product_ID         | 1 to 1 mapping                          |
| dw.Fact_Sales     | Sales_Date           | stg.Sales_Transactions | Sales_Date         | 1 to 1 mapping                          |
| dw.Fact_Sales     | Quantity             | stg.Sales_Transactions | Quantity           | 1 to 1 mapping, validated > 0            |
| dw.Fact_Sales     | Unit_Price           | stg.Sales_Transactions | Unit_Price         | 1 to 1 mapping                          |
| dw.Fact_Sales     | Total_Sales_Amount   | stg.Sales_Transactions | Quantity, Unit_Price | Transformation: Quantity * Unit_Price   |
| dw.Fact_Sales     | Region_ID            | dw.Dim_Date            | Region_ID          | Enrichment via join on Sales_Date        |
| dw.Fact_Sales     | Customer_Segment     | dw.Dim_Customer        | Customer_Segment   | Enrichment via join on Customer_ID       |
| dw.Fact_Sales     | Load_Timestamp       | (generated)            | (generated)        | Transformation: SYSDATETIME()            |
| dw.Fact_Sales     | Batch_ID             | (generated)            | (generated)        | Transformation: NEWID() per batch        |

Advanced logic: Data validation, enrichment via dimension joins, batch and timestamp tracking.

Technical Complexity:

| Parameter         | Value                          |
|-------------------|-------------------------------|
| Procedure Name    | dw.sp_load_sales_fact          |
| Source Tables     | 3 (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables     | 3 (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures) |
| Data Flows        | 4 (staging, temp table, CTE, final load) |
| Transformations   | 5 (validation, enrichment, calculation, timestamp, batch tracking) |
| Joins and Filters | 3 joins, 2 filters             |
| Variables         | 7 declared variables           |
| Parameters        | 0 input/output parameters      |
| Dependencies      | 0 dependent views/procedures   |
| Complexity Score  | 65                             |

Key Outputs:
- Cleaned and enriched sales data loaded into `dw.Fact_Sales` for analytics and reporting.
- Audit logs in `dw.Audit_Log` for traceability and operational monitoring.
- Data quality failure records in `dw.DQ_Failures` for compliance and process improvement.
- Staging table is cleared for next batch, ensuring efficient pipeline operation.
- Outputs support business goals of reliable sales analytics, operational transparency, and data quality management.

API Cost:
apiCost: 0.0125 USD