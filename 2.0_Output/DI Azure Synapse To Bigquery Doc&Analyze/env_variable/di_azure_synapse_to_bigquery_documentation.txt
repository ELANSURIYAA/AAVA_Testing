=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads cleaned and validated sales transaction data from staging into the sales fact table, performing data quality checks, transformations, and audit logging.
=============================================

Procedure Overview:
This stored procedure, `dw.sp_load_sales_fact`, orchestrates the ETL (Extract, Transform, Load) process for sales transaction data. It validates, cleans, and transforms raw sales data from the staging table (`stg.Sales_Transactions`), loads the processed data into the sales fact table (`dw.Fact_Sales`), and logs both successful and failed records for auditing and data quality purposes. The procedure ensures only high-quality, business-relevant data is loaded into the data warehouse, supporting accurate reporting and analytics. It also maintains an audit trail for traceability and error handling, aligning with organizational data governance standards.

Logic Details:
- The procedure begins by initializing audit logging and declaring variables for tracking batch execution.
- It creates a temporary table (`#InvalidRows`) to capture data validation failures.
- Basic data quality checks are performed to identify missing `Customer_ID` and invalid `Quantity` values.
- Invalid records are deleted from the staging table and their count is tracked.
- Valid records are transformed (e.g., calculating `Total_Sales_Amount`) and loaded into the `dw.Fact_Sales` table, joining with dimension tables for enrichment.
- The staging table is truncated post-load.
- Validation failures are logged in the `dw.DQ_Failures` table.
- The audit log is updated with execution results, and error handling ensures failures are logged and surfaced for monitoring.

Data Flow Details:
1. **Audit Logging Start:** Inserts a new batch record into `dw.Audit_Log` to track the procedure run.
2. **Validation Table Creation:** Creates `#InvalidRows` to store IDs and reasons for failed validations.
3. **Data Quality Checks:** 
   - Inserts records with missing `Customer_ID` or non-positive `Quantity` into `#InvalidRows`.
4. **Staging Cleanup:** Deletes invalid records from `stg.Sales_Transactions` based on `#InvalidRows`.
5. **Transformation & Load:** 
   - Selects valid records, joins with `dw.Dim_Customer` and `dw.Dim_Date` for enrichment, calculates `Total_Sales_Amount`, and loads into `dw.Fact_Sales`.
6. **Staging Table Truncation:** Clears the staging table for the next load cycle.
7. **DQ Failure Logging:** Inserts invalid records and reasons into `dw.DQ_Failures`.
8. **Audit Logging End:** Updates the audit log with row counts, status, and messages.
9. **Error Handling:** On error, updates the audit log with failure status and error message.
10. **Cleanup:** Drops the temporary table.

Data Transformations:
- **Data Cleaning:** Removes records with missing `Customer_ID` or non-positive `Quantity`.
- **Data Enrichment:** Joins with `dw.Dim_Customer` for `Customer_Segment` and with `dw.Dim_Date` for `Region_ID`.
- **Calculations:** Computes `Total_Sales_Amount` as `Quantity * Unit_Price`.
- **Audit & DQ Logging:** Tracks batch execution and validation failures for traceability.
- **Timestamping:** Adds `Load_Timestamp` and `Batch_ID` to each loaded record.

Data Mapping:

| Target Table Name | Target Column Name    | Source Table Name      | Source Column Name   | Remarks                                    |
|-------------------|----------------------|------------------------|---------------------|---------------------------------------------|
| dw.Fact_Sales     | Transaction_ID       | stg.Sales_Transactions | Transaction_ID      | 1 to 1 mapping                             |
| dw.Fact_Sales     | Customer_ID          | stg.Sales_Transactions | Customer_ID         | 1 to 1 mapping (validated for NOT NULL)     |
| dw.Fact_Sales     | Product_ID           | stg.Sales_Transactions | Product_ID          | 1 to 1 mapping                             |
| dw.Fact_Sales     | Sales_Date           | stg.Sales_Transactions | Sales_Date          | 1 to 1 mapping                             |
| dw.Fact_Sales     | Quantity             | stg.Sales_Transactions | Quantity            | 1 to 1 mapping (validated > 0)              |
| dw.Fact_Sales     | Unit_Price           | stg.Sales_Transactions | Unit_Price          | 1 to 1 mapping                             |
| dw.Fact_Sales     | Total_Sales_Amount   | Computed               | Quantity, Unit_Price| Transformation: Quantity * Unit_Price       |
| dw.Fact_Sales     | Region_ID            | dw.Dim_Date            | Region_ID           | Enrichment via join on Sales_Date           |
| dw.Fact_Sales     | Customer_Segment     | dw.Dim_Customer        | Customer_Segment    | Enrichment via join on Customer_ID          |
| dw.Fact_Sales     | Load_Timestamp       | System                 | SYSDATETIME()       | Transformation: Load timestamp              |
| dw.Fact_Sales     | Batch_ID             | System                 | @batch_id           | Transformation: Unique batch identifier     |

Technical Complexity:

| Parameter         | Value                                   |
|-------------------|-----------------------------------------|
| Procedure Name    | dw.sp_load_sales_fact                   |
| Source Tables     | 3 (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables     | 3 (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures) |
| Data Flows        | 4 (Validation, Clean, Transform/Load, DQ Log) |
| Transformations   | 5 (Validation, Join, Calculation, Enrichment, Timestamping) |
| Joins and Filters | 3 (2 joins, 1 filter for validation)    |
| Variables         | 7 (batch_id, start_time, end_time, rows_inserted, rows_rejected, error_message, proc_name) |
| Parameters        | 0 (no input/output parameters)          |
| Dependencies      | 0 (no explicit dependent procs/views)   |
| Complexity Score  | 65                                      |

Key Outputs:
- **dw.Fact_Sales:** Contains cleaned, validated, and enriched sales transaction records ready for analytics and reporting.
- **dw.Audit_Log:** Tracks the execution status, row counts, and error messages for each batch run, supporting traceability and operational monitoring.
- **dw.DQ_Failures:** Stores details of records rejected during validation, supporting data quality improvement and root cause analysis.

These outputs ensure only high-quality, business-relevant data is loaded into the warehouse, supporting accurate business intelligence and compliance with data governance.

apiCost: 0.0000 USD