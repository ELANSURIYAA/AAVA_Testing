=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads cleaned and validated sales transactions from staging into the sales fact table, applying data quality checks, transformations, and audit logging.
=============================================

Procedure Overview:
This stored procedure, dw.sp_load_sales_fact, is designed to extract, validate, transform, and load sales transaction data from the staging table (stg.Sales_Transactions) into the enterprise data warehouse fact table (dw.Fact_Sales). It performs data quality checks, logs audit information, manages rejected records, and ensures only clean, validated data is loaded for downstream analytics and reporting. The procedure supports business needs for reliable, traceable, and high-quality sales data, enabling accurate reporting and business decision-making.

Logic Details:
- Main Purpose: ETL (Extract, Transform, Load) process for sales transactions.
- Structure: The procedure follows a stepwise approachâ€”starting with audit logging, performing data validation, cleaning the staging table, transforming and loading data into the fact table, handling rejected records, and updating audit logs.
- Key SQL Operations: INSERT, DELETE, SELECT, CTE (Common Table Expression), TRUNCATE, TRY/CATCH error handling.
- Input Parameters: None (all variables are internally declared).
- Output: Data loaded into dw.Fact_Sales, rejected records logged in dw.DQ_Failures, audit trail in dw.Audit_Log.

Data Flow Details:
1. Audit logging is initiated to track the ETL batch.
2. A temporary table (#InvalidRows) is created to capture validation failures.
3. Data quality checks are performed:
   - Transactions with missing Customer_ID are flagged.
   - Transactions with non-positive Quantity are flagged.
4. Invalid records are deleted from the staging table and counted as rejected.
5. Cleaned data is transformed (with joins to dimension tables and calculated fields) and loaded into the fact table.
6. The staging table is truncated to prepare for the next batch.
7. Validation failures are logged in the data quality failures table.
8. The audit log is updated with completion status, row counts, and messages.
9. If any error occurs, the audit log is updated with failure status and error message.
10. Temporary tables are cleaned up.

Data Transformations:
- Calculation of Total_Sales_Amount as Quantity * Unit_Price.
- Enrichment with Region_ID (from dw.Dim_Date) and Customer_Segment (from dw.Dim_Customer) via joins.
- Addition of system-generated Load_Timestamp and Batch_ID for traceability.
- Data validation rules:
  - Customer_ID must not be NULL.
  - Quantity must be greater than 0.
- Only records passing validation are loaded; rejected records are logged for quality monitoring.

Data Mapping:

| Target Table Name | Target Column Name   | Source Table Name   | Source Column Name   | Remarks                                  |
|-------------------|---------------------|---------------------|----------------------|-------------------------------------------|
| dw.Fact_Sales     | Transaction_ID      | stg.Sales_Transactions | Transaction_ID   | 1 to 1 mapping                           |
| dw.Fact_Sales     | Customer_ID         | stg.Sales_Transactions | Customer_ID      | 1 to 1 mapping; validated not null        |
| dw.Fact_Sales     | Product_ID          | stg.Sales_Transactions | Product_ID       | 1 to 1 mapping                           |
| dw.Fact_Sales     | Sales_Date          | stg.Sales_Transactions | Sales_Date       | 1 to 1 mapping                           |
| dw.Fact_Sales     | Quantity            | stg.Sales_Transactions | Quantity         | 1 to 1 mapping; validated > 0             |
| dw.Fact_Sales     | Unit_Price          | stg.Sales_Transactions | Unit_Price       | 1 to 1 mapping                           |
| dw.Fact_Sales     | Total_Sales_Amount  | Calculated             | Quantity, Unit_Price | Transformation: Quantity * Unit_Price |
| dw.Fact_Sales     | Region_ID           | dw.Dim_Date            | Region_ID         | Transformation: join on Sales_Date        |
| dw.Fact_Sales     | Customer_Segment    | dw.Dim_Customer        | Customer_Segment  | Transformation: join on Customer_ID       |
| dw.Fact_Sales     | Load_Timestamp      | System                 | SYSDATETIME()     | System-generated timestamp                |
| dw.Fact_Sales     | Batch_ID            | System                 | @batch_id         | System-generated batch identifier         |

Technical Complexity:

| Parameter         | Value                 |
|-------------------|----------------------|
| Procedure Name    | dw.sp_load_sales_fact |
| Source Tables     | 3 (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables     | 3 (dw.Fact_Sales, dw.DQ_Failures, dw.Audit_Log) |
| Data Flows        | 4 (validation, cleaning, transformation/load, logging) |
| Transformations   | 5 (validation, calculation, joins, timestamp, batch ID) |
| Joins and Filters | 3 (2 joins, 1 filter in validation) |
| Variables         | 7 (batch_id, start_time, end_time, rows_inserted, rows_rejected, error_message, proc_name) |
| Parameters        | 0 (no input/output parameters) |
| Dependencies      | 0 (no dependent procedures or views called) |
| Complexity Score  | 60                     |

Key Outputs:
- Cleaned and enriched sales transactions are loaded into dw.Fact_Sales for analytics and reporting.
- Data quality failures are logged in dw.DQ_Failures for monitoring and remediation.
- Audit logs in dw.Audit_Log provide traceability, batch status, and error tracking.
- These outputs support business reporting, operational monitoring, and compliance requirements.

apiCost: 0.0110 USD