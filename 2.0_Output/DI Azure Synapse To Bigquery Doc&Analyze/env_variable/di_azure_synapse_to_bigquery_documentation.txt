=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads, transforms, and validates sales transaction data from staging to the Fact_Sales table, capturing audit and data quality results.
=============================================

Procedure Overview:
The stored procedure [dw.sp_load_sales_fact] is designed to automate the ETL process for sales transaction data. It extracts raw sales data from the staging table, applies data quality checks, transforms and loads valid records into the Fact_Sales table, and logs both audit and data quality outcomes. This procedure ensures only clean, validated data is loaded into the data warehouse, supporting accurate reporting and analytics. It also provides robust audit logging for traceability and error handling, aligning with business requirements for data governance and compliance.

Logic Details:
- Main Purpose: To validate, transform, and load sales transaction data from the staging area into the Fact_Sales table, while capturing audit and data quality logs.
- Structure: The procedure uses variables for audit and error tracking, temporary tables for invalid data, and CTEs for transformation.
- Key SQL Operations: INSERT, DELETE, TRUNCATE, INNER JOIN, CTE (Common Table Expression), error handling (TRY...CATCH), and audit logging.
- Input Parameters: None (all variables are internally declared).
- Output: Data loaded into Fact_Sales, audit records in Audit_Log, and data quality failures in DQ_Failures.

Data Flow Details:
1. Audit Logging: Begins by inserting a 'STARTED' status into the Audit_Log table with a unique batch ID and timestamp.
2. Temporary Table Creation: Creates #InvalidRows to capture failed validation records.
3. Data Quality Checks: Inserts into #InvalidRows any transactions missing Customer_ID or having invalid Quantity (<=0).
4. Cleansing: Deletes invalid records from stg.Sales_Transactions based on #InvalidRows.
5. Transformation & Load: Uses a CTE to join cleaned staging data with Dim_Customer and Dim_Date, calculates Total_Sales_Amount, and inserts the result into Fact_Sales.
6. Staging Cleanup: Truncates the staging table after successful load.
7. DQ Logging: Inserts all failed validation records into DQ_Failures for traceability.
8. Audit Completion: Updates Audit_Log with row counts and status.
9. Error Handling: On error, updates Audit_Log with failure status and rethrows the error.
10. Cleanup: Drops the temporary table #InvalidRows.

Data Transformations:
- Filters out transactions with missing Customer_ID or invalid Quantity.
- Calculates Total_Sales_Amount as Quantity * Unit_Price.
- Enriches sales data by joining with Dim_Customer (to get Customer_Segment) and Dim_Date (to get Region_ID).
- Adds Load_Timestamp and Batch_ID for traceability.
- All transformations ensure data quality and enrich the fact table for downstream analytics.

Data Mapping:

| Target Table Name | Target Column Name   | Source Table Name      | Source Column Name   | Remarks (1 to 1 mapping, Transformation, Validation)            |
|-------------------|---------------------|------------------------|---------------------|------------------------------------------------------------------|
| Fact_Sales        | Transaction_ID      | Sales_Transactions     | Transaction_ID      | 1 to 1 mapping, after validation                                |
| Fact_Sales        | Customer_ID         | Sales_Transactions     | Customer_ID         | 1 to 1 mapping, after validation                                |
| Fact_Sales        | Product_ID          | Sales_Transactions     | Product_ID          | 1 to 1 mapping                                                  |
| Fact_Sales        | Sales_Date          | Sales_Transactions     | Sales_Date          | 1 to 1 mapping                                                  |
| Fact_Sales        | Quantity            | Sales_Transactions     | Quantity            | 1 to 1 mapping, after validation                                |
| Fact_Sales        | Unit_Price          | Sales_Transactions     | Unit_Price          | 1 to 1 mapping                                                  |
| Fact_Sales        | Total_Sales_Amount  | (calculated)           | Quantity, Unit_Price| Transformation: Quantity * Unit_Price                           |
| Fact_Sales        | Region_ID           | Dim_Date               | Region_ID           | Transformation: Join on Sales_Date to get Region_ID             |
| Fact_Sales        | Customer_Segment    | Dim_Customer           | Customer_Segment    | Transformation: Join on Customer_ID to get Customer_Segment     |
| Fact_Sales        | Load_Timestamp      | (system)               | SYSDATETIME()       | Transformation: Current timestamp                               |
| Fact_Sales        | Batch_ID            | (variable)             | @batch_id           | Transformation: Unique batch identifier                         |

Advanced logic includes validation (missing Customer_ID, invalid Quantity), calculated fields, and enrichment via joins.

Technical Complexity:

| Parameter           | Value                |
|---------------------|---------------------|
| Procedure Name      | dw.sp_load_sales_fact|
| Source Tables       | 3 (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables       | 3 (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures) |
| Data Flows          | 2 (main flow, invalid rows flow) |
| Transformations     | 5 (validation, calculation, joins, timestamp, batch_id) |
| Joins and Filters   | 4 (2 joins, 2 filters) |
| Variables           | 7                    |
| Parameters          | 0                    |
| Dependencies        | 0 (no dependent views/procedures) |
| Complexity Score    | 65                   |

Key Outputs:
- Cleaned and enriched sales data loaded into dw.Fact_Sales for analytics and reporting.
- Audit logs in dw.Audit_Log for traceability and operational monitoring.
- Data quality failures captured in dw.DQ_Failures for compliance and remediation.
- Outputs are used for business intelligence, operational dashboards, and compliance reporting.

apiCost: 0.0125 USD