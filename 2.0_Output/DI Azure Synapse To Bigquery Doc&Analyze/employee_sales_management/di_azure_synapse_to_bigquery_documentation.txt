=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads, validates, and transforms sales transaction data from staging to the sales fact table, with audit logging and data quality checks.
=============================================

Procedure Overview:
The stored procedure [dw.sp_load_sales_fact] is designed to automate the ETL (Extract, Transform, Load) process for sales transaction data. It ingests raw sales transactions from the staging table, validates and cleans the data, applies business logic transformations, and loads the processed data into the enterprise sales fact table. The procedure also logs audit information, tracks data quality failures, and ensures traceability for compliance and troubleshooting. This process is essential for maintaining a reliable, accurate, and analytics-ready sales dataset, supporting business reporting, and enabling data-driven decision-making.

Logic Details:
- Main Purpose: To extract sales transactions from [stg.Sales_Transactions], validate and transform the data, and load it into [dw.Fact_Sales] while logging the process and capturing data quality failures.
- Structure: The procedure uses variables for audit tracking, temporary tables for invalid data, and CTEs for transformation.
- Key SQL Operations: INSERT, DELETE, TRUNCATE, INNER JOIN, CTE (Common Table Expression), error handling (TRY...CATCH), and audit logging.
- Input Parameters: None (all variables are internally declared).
- Output: Data loaded into [dw.Fact_Sales], data quality failures logged in [dw.DQ_Failures], and audit logs updated in [dw.Audit_Log].

Data Flow Details:
1. Audit Logging: Begins by inserting a new audit log entry to track the batch.
2. Data Validation: Creates a temporary table [#InvalidRows] to capture invalid transactions (missing Customer_ID or invalid Quantity).
3. Data Cleansing: Deletes invalid rows from [stg.Sales_Transactions] based on validation results.
4. Data Transformation: Uses a CTE ([transformed]) to join cleaned transactions with customer and date dimensions, calculate [Total_Sales_Amount], and enrich with [Region_ID] and [Customer_Segment].
5. Data Loading: Inserts transformed records into [dw.Fact_Sales].
6. Staging Cleanup: Truncates the staging table to prepare for the next batch.
7. Data Quality Logging: Inserts validation failures into [dw.DQ_Failures] for traceability.
8. Audit Completion: Updates the audit log with row counts and status.
9. Error Handling: On failure, updates the audit log with error details and rethrows the error.
10. Cleanup: Drops the temporary table to release resources.

Data Transformations:
- Calculates [Total_Sales_Amount] as [Quantity] * [Unit_Price].
- Enriches sales transactions with [Region_ID] (from [dw.Dim_Date]) and [Customer_Segment] (from [dw.Dim_Customer]).
- Filters out transactions with missing [Customer_ID] or non-positive [Quantity].
- Adds [Load_Timestamp] and [Batch_ID] for traceability.
- Applies business logic to ensure only valid, complete, and enriched sales data is loaded into the fact table.

Data Mapping:

| Target Table Name | Target Column Name   | Source Table Name    | Source Column Name   | Remarks                                  |
|-------------------|---------------------|----------------------|----------------------|-------------------------------------------|
| dw.Fact_Sales     | Transaction_ID      | stg.Sales_Transactions | Transaction_ID     | 1 to 1 mapping                           |
| dw.Fact_Sales     | Customer_ID         | stg.Sales_Transactions | Customer_ID        | 1 to 1 mapping                           |
| dw.Fact_Sales     | Product_ID          | stg.Sales_Transactions | Product_ID         | 1 to 1 mapping                           |
| dw.Fact_Sales     | Sales_Date          | stg.Sales_Transactions | Sales_Date         | 1 to 1 mapping                           |
| dw.Fact_Sales     | Quantity            | stg.Sales_Transactions | Quantity           | 1 to 1 mapping; validation applied        |
| dw.Fact_Sales     | Unit_Price          | stg.Sales_Transactions | Unit_Price         | 1 to 1 mapping                           |
| dw.Fact_Sales     | Total_Sales_Amount  | stg.Sales_Transactions | Quantity, Unit_Price | Transformation: Quantity * Unit_Price  |
| dw.Fact_Sales     | Region_ID           | dw.Dim_Date           | Region_ID           | Enrichment via join on Sales_Date         |
| dw.Fact_Sales     | Customer_Segment    | dw.Dim_Customer       | Customer_Segment    | Enrichment via join on Customer_ID        |
| dw.Fact_Sales     | Load_Timestamp      | System                | SYSDATETIME()       | Transformation: Load timestamp            |
| dw.Fact_Sales     | Batch_ID            | System                | @batch_id           | Transformation: Batch identifier          |

- Validation: [Quantity] must be > 0; [Customer_ID] must not be NULL.
- Advanced Logic: Joins to dimension tables for enrichment; audit and DQ logging for traceability.

Technical Complexity:

| Parameter         | Value                 |
|-------------------|----------------------|
| Procedure Name    | dw.sp_load_sales_fact |
| Source Tables     | 3 (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables     | 3 (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures) |
| Data Flows        | 4 (validation, cleansing, transformation, loading) |
| Transformations   | 5 (validation, enrichment, calculation, audit logging, DQ logging) |
| Joins and Filters | 3 (2 joins, 1 filter per validation) |
| Variables         | 7 (batch_id, start_time, end_time, rows_inserted, rows_rejected, error_message, proc_name) |
| Parameters        | 0 (no input/output parameters) |
| Dependencies      | 0 (no dependent procedures/views explicitly called) |
| Complexity Score  | 65                      |

Key Outputs:
- Cleaned and enriched sales transactions loaded into [dw.Fact_Sales].
- Data quality failures logged in [dw.DQ_Failures] for rejected records.
- Audit logs in [dw.Audit_Log] capturing process status, row counts, and errors.
- These outputs ensure high data quality, traceability, and support for business analytics and reporting.

apiCost: 0.0100 USD