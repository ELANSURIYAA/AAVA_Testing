=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads, validates, and transforms sales transaction data from staging into the sales fact table, with audit logging and data quality checks.
=============================================

Procedure Overview:
The stored procedure [dw.sp_load_sales_fact] is designed to automate the ETL (Extract, Transform, Load) process for sales transaction data. It ingests new sales transactions from the staging table, applies data quality checks, transforms and enriches the data, and loads it into the Fact_Sales table. The procedure also logs audit information and data quality failures, ensuring traceability and compliance with business rules. This process supports accurate sales analytics and reporting, which are critical for business decision-making.

Logic Details:
- Main Purpose: To validate, transform, and load sales transaction data from the staging area into the data warehouse's Fact_Sales table, while logging audit and data quality information.
- Structure: The procedure uses variables for audit and error handling, temporary tables for validation, and CTEs for transformation. It is wrapped in TRY/CATCH for robust error management.
- Key SQL Operations: INSERT, DELETE, TRUNCATE, INNER JOIN, CTE (Common Table Expression), and audit logging.
- Input Parameters: None (all variables are internally declared).
- Output: Data loaded into Fact_Sales, audit logs in Audit_Log, and data quality failures in DQ_Failures.

Data Flow Details:
1. Audit Logging Start: Inserts a new record in Audit_Log to mark the beginning of the batch process.
2. Data Validation: Creates a temporary table (#InvalidRows) to capture records from stg.Sales_Transactions with missing or invalid data (e.g., missing Customer_ID, non-positive Quantity).
3. Data Cleansing: Deletes invalid records from the staging table based on validations.
4. Data Transformation & Enrichment: Uses a CTE to join cleaned staging data with dimension tables (Dim_Customer, Dim_Date), calculates Total_Sales_Amount, and adds enrichment fields (Region_ID, Customer_Segment, Load_Timestamp, Batch_ID).
5. Data Loading: Inserts the transformed data into dw.Fact_Sales.
6. Staging Cleanup: Truncates the staging table to prepare for the next batch.
7. Data Quality Logging: Inserts details of invalid records into dw.DQ_Failures for traceability.
8. Audit Logging End: Updates the Audit_Log with process completion status, row counts, and messages.
9. Error Handling: On error, updates the Audit_Log with failure status and error message, then rethrows the error.
10. Cleanup: Drops the temporary validation table.

Data Transformations:
- Data Validation: Removes records with missing Customer_ID or non-positive Quantity.
- Data Enrichment: Adds Region_ID (from Dim_Date), Customer_Segment (from Dim_Customer), Load_Timestamp, and Batch_ID.
- Calculation: Computes Total_Sales_Amount as Quantity * Unit_Price.
- Data Cleansing: Only validated, clean data is loaded to Fact_Sales.
- Audit & DQ Logging: Captures both successful and failed data processing for compliance and troubleshooting.

Data Mapping:

| Target Table Name | Target Column Name   | Source Table Name    | Source Column Name   | Remarks                                   |
|-------------------|---------------------|----------------------|----------------------|--------------------------------------------|
| Fact_Sales        | Transaction_ID      | Sales_Transactions   | Transaction_ID       | 1 to 1 mapping                            |
| Fact_Sales        | Customer_ID         | Sales_Transactions   | Customer_ID          | 1 to 1 mapping                            |
| Fact_Sales        | Product_ID          | Sales_Transactions   | Product_ID           | 1 to 1 mapping                            |
| Fact_Sales        | Sales_Date          | Sales_Transactions   | Sales_Date           | 1 to 1 mapping                            |
| Fact_Sales        | Quantity            | Sales_Transactions   | Quantity             | 1 to 1 mapping, validated (>0)             |
| Fact_Sales        | Unit_Price          | Sales_Transactions   | Unit_Price           | 1 to 1 mapping                            |
| Fact_Sales        | Total_Sales_Amount  | Sales_Transactions   | (Quantity * Unit_Price) | Transformation (calculation)           |
| Fact_Sales        | Region_ID           | Dim_Date             | Region_ID            | Enrichment via join on Sales_Date          |
| Fact_Sales        | Customer_Segment    | Dim_Customer         | Customer_Segment     | Enrichment via join on Customer_ID         |
| Fact_Sales        | Load_Timestamp      | (System)             | SYSDATETIME()        | Transformation (system timestamp)          |
| Fact_Sales        | Batch_ID            | (Procedure Variable) | @batch_id            | Transformation (unique per run)            |

Technical Complexity:

| Parameter         | Value       |
|-------------------|------------|
| Procedure Name    | dw.sp_load_sales_fact |
| Source Tables     | 3          |  (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables     | 3          |  (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures) |
| Data Flows        | 2          |  (#InvalidRows temp table, transformed CTE) |
| Transformations   | 4          |  (Validation, Calculation, Enrichment, Cleansing) |
| Joins and Filters | 3          |  (2 joins, 1 filter in CTE, plus validation filters) |
| Variables         | 7          |  (@batch_id, @start_time, @end_time, @rows_inserted, @rows_rejected, @error_message, @proc_name) |
| Parameters        | 0          |  (No input/output parameters) |
| Dependencies      | 0          |  (No dependent procedures/views called) |
| Complexity Score  | 65         |  (Moderate complexity: multiple steps, error handling, logging, and transformations) |

Key Outputs:
- The procedure produces a cleaned, validated, and enriched dataset in dw.Fact_Sales, ready for analytics and reporting.
- Audit logs are written to dw.Audit_Log, supporting traceability and operational monitoring.
- Data quality failures are logged in dw.DQ_Failures for further review and remediation.
- These outputs ensure only high-quality, business-ready sales data is available for downstream processes, supporting accurate business intelligence and compliance.

apiCost: 0.0100 USD