=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads cleaned and validated sales transactions from staging into the sales fact table, with audit logging and data quality checks.
=============================================

Procedure Overview:
The stored procedure [dw].[sp_load_sales_fact] is designed to automate the ETL process for loading sales transaction data from a staging area into the enterprise sales fact table. It performs data validation, transformation, and audit logging to ensure high data quality and traceability. The procedure identifies and removes invalid records, transforms and loads clean data into the target table, and logs both successful and failed operations for compliance and troubleshooting. This process supports the business need for accurate, timely, and auditable sales reporting, enabling reliable analytics and decision-making.

Logic Details:
- The procedure begins by initializing audit logging and batch metadata.
- It creates a temporary table to capture validation failures.
- Basic data quality checks are performed to identify missing or invalid data (e.g., missing Customer_ID, non-positive Quantity).
- Invalid rows are deleted from the staging table and logged.
- Cleaned data is joined with dimension tables, transformed, and loaded into the sales fact table.
- The staging table is truncated, and validation failures are logged for review.
- The audit log is updated with row counts and status.
- Error handling ensures failures are logged and surfaced for pipeline monitoring.

Data Flow Details:
1. Audit logging starts with a new batch entry in [dw].[Audit_Log].
2. A temporary table (#InvalidRows) is created to capture failed data quality checks.
3. Data quality checks are performed on [stg].[Sales_Transactions] for missing Customer_ID and invalid Quantity. Failed records are inserted into #InvalidRows.
4. Invalid records are deleted from the staging table, and the count is recorded.
5. Cleaned records are joined with [dw].[Dim_Customer] and [dw].[Dim_Date], transformed, and loaded into [dw].[Fact_Sales].
6. The staging table is truncated to prevent duplicate loads.
7. Validation failures are logged to [dw].[DQ_Failures] for auditing.
8. The audit log is updated with final counts and status.
9. If errors occur, the audit log is updated with failure status and the error message is surfaced.
10. Temporary resources are cleaned up.

Data Transformations:
- Calculates [Total_Sales_Amount] as Quantity * Unit_Price.
- Adds [Load_Timestamp] and [Batch_ID] for traceability.
- Joins with [dw].[Dim_Customer] to enrich with [Customer_Segment].
- Joins with [dw].[Dim_Date] to add [Region_ID].
- Filters out records with missing Customer_ID or invalid Quantity.
- All transformations ensure only valid, enriched, and traceable data is loaded into the fact table.

Data Mapping:

| Target Table Name | Target Column Name    | Source Table Name      | Source Column Name    | Remarks                                      |
|-------------------|----------------------|------------------------|----------------------|----------------------------------------------|
| dw.Fact_Sales     | Transaction_ID       | stg.Sales_Transactions | Transaction_ID       | 1 to 1 mapping                              |
| dw.Fact_Sales     | Customer_ID          | stg.Sales_Transactions | Customer_ID          | 1 to 1 mapping, validated for NOT NULL       |
| dw.Fact_Sales     | Product_ID           | stg.Sales_Transactions | Product_ID           | 1 to 1 mapping                              |
| dw.Fact_Sales     | Sales_Date           | stg.Sales_Transactions | Sales_Date           | 1 to 1 mapping, joined to Dim_Date           |
| dw.Fact_Sales     | Quantity             | stg.Sales_Transactions | Quantity             | 1 to 1 mapping, validated for > 0            |
| dw.Fact_Sales     | Unit_Price           | stg.Sales_Transactions | Unit_Price           | 1 to 1 mapping                              |
| dw.Fact_Sales     | Total_Sales_Amount   | Calculated             | Quantity, Unit_Price | Transformation: Quantity * Unit_Price        |
| dw.Fact_Sales     | Region_ID            | dw.Dim_Date            | Region_ID            | Joined via Sales_Date = Date_Value           |
| dw.Fact_Sales     | Customer_Segment     | dw.Dim_Customer        | Customer_Segment     | Joined via Customer_ID                       |
| dw.Fact_Sales     | Load_Timestamp       | System                 | SYSDATETIME()        | Transformation: Load timestamp               |
| dw.Fact_Sales     | Batch_ID             | Variable               | @batch_id            | Transformation: Unique batch identifier      |

Technical Complexity:

| Parameter         | Value                |
|-------------------|---------------------|
| Procedure Name    | dw.sp_load_sales_fact|
| Source Tables     | 3                   |
| Target Tables     | 2                   |
| Data Flows        | 4                   |
| Transformations   | 6                   |
| Joins and Filters | 4                   |
| Variables         | 7                   |
| Parameters        | 0                   |
| Dependencies      | 0                   |
| Complexity Score  | 70                  |

Key Outputs:
- Cleaned and validated sales transactions are loaded into [dw].[Fact_Sales], enriched with region and customer segment data, and tagged with batch and load metadata.
- Invalid records are logged in [dw].[DQ_Failures] for data quality review.
- Audit logs in [dw].[Audit_Log] provide traceability, including row counts, status, and error messages.
- The outputs support accurate sales analytics, operational reporting, and compliance with data governance requirements.

apiCost: 0.0125 USD