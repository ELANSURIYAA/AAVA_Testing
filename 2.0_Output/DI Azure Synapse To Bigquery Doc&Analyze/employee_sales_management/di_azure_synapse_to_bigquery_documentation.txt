=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads cleaned sales transaction data from staging into the sales fact table, with audit logging and data quality validation.
=============================================

--------------------------------------------------------------------------------
Procedure Overview
--------------------------------------------------------------------------------
Purpose:  
This stored procedure, dw.sp_load_sales_fact, automates the ETL (Extract, Transform, Load) process for sales transaction data. It validates, cleans, and loads sales data from a staging table into the sales fact table, while maintaining audit logs and capturing data quality failures.

Business Problem:  
Ensures only high-quality, validated sales transactions are loaded into the data warehouse, supporting accurate reporting and analytics. It also provides transparency and traceability for data operations via audit and data quality logs.

Value:  
- Improves data quality and reliability for downstream analytics.
- Enables operational monitoring and troubleshooting.
- Supports compliance and governance with detailed logging.

--------------------------------------------------------------------------------
Logic Details
--------------------------------------------------------------------------------
Summary of Logic:  
1. Initializes audit logging for the ETL batch.
2. Validates sales transactions for missing or invalid data.
3. Removes invalid records from the staging table.
4. Transforms and loads valid records into the fact table.
5. Archives or truncates the staging table.
6. Logs data quality failures.
7. Updates audit logs with batch results.
8. Handles errors and logs failures.
9. Cleans up temporary resources.

Main Purpose:  
To ensure only valid sales transactions are loaded into the fact table, with full traceability and error handling.

Structure:  
- Uses TRY/CATCH blocks for error handling.
- Employs temporary tables for validation.
- Utilizes CTEs for transformation.
- Performs audit logging at start and end.

Key SQL Operations:  
- INSERT, DELETE, TRUNCATE, UPDATE
- INNER JOINs for dimension lookups
- Data transformation via CTE
- Audit and DQ logging

Input/Output:  
Input: stg.Sales_Transactions (staging sales data)  
Output: dw.Fact_Sales (fact table), dw.Audit_Log (audit), dw.DQ_Failures (data quality failures)

--------------------------------------------------------------------------------
Data Flow Details
--------------------------------------------------------------------------------
Step-by-Step Data Flow:
1. **Audit Log Start:**  
   - Inserts a new batch record in dw.Audit_Log with status 'STARTED'.

2. **Temporary Table Creation:**  
   - Drops and recreates #InvalidRows for tracking validation failures.

3. **Data Quality Checks:**  
   - Inserts into #InvalidRows any transactions with missing Customer_ID or invalid Quantity.

4. **Invalid Data Removal:**  
   - Deletes invalid transactions from stg.Sales_Transactions using #InvalidRows.

5. **Transformation & Load:**  
   - Uses a CTE to join cleaned staging data with customer and date dimensions.
   - Calculates Total_Sales_Amount.
   - Inserts transformed records into dw.Fact_Sales.

6. **Staging Table Cleanup:**  
   - Truncates stg.Sales_Transactions to archive or reset for the next batch.

7. **DQ Failure Logging:**  
   - Inserts validation failures from #InvalidRows into dw.DQ_Failures.

8. **Audit Log Completion:**  
   - Updates dw.Audit_Log with end time, row counts, and status.

9. **Error Handling:**  
   - On error, updates audit log with failure status and error message, then rethrows.

10. **Final Cleanup:**  
    - Drops #InvalidRows temporary table.

Connections, Joins, Transformations:
- Joins staging data to customer and date dimensions for enrichment.
- Transforms raw data by calculating sales amount and adding metadata.
- Removes invalid data prior to loading.

Temporary Tables:
- #InvalidRows: Tracks rows failing validation.

Conditional Logic:
- Validation checks for missing/invalid fields.
- Error handling via TRY/CATCH.

--------------------------------------------------------------------------------
Data Transformations
--------------------------------------------------------------------------------
Detailed Changes:
- **Validation:**  
  - Filters out transactions with NULL Customer_ID or Quantity <= 0.

- **Enrichment:**  
  - Adds Region_ID from Dim_Date and Customer_Segment from Dim_Customer.

- **Calculation:**  
  - Computes Total_Sales_Amount as Quantity * Unit_Price.

- **Metadata:**  
  - Adds Load_Timestamp and Batch_ID for traceability.

Cleaning & Filtering:
- Removes invalid records prior to loading.
- Only valid, enriched records are loaded to fact table.

Business Logic Examples:
- Transaction with Quantity = 0 is rejected.
- Transaction with missing Customer_ID is rejected.
- Valid transaction is joined to dimensions and loaded.

--------------------------------------------------------------------------------
Data Mapping
--------------------------------------------------------------------------------
| Target Table Name | Target Column Name   | Source Table Name         | Source Column Name    | Remarks (1 to 1 mapping, Transformation, Validation)       |
|-------------------|---------------------|--------------------------|----------------------|------------------------------------------------------------|
| dw.Fact_Sales     | Transaction_ID      | stg.Sales_Transactions   | Transaction_ID       | 1 to 1 mapping                                             |
| dw.Fact_Sales     | Customer_ID         | stg.Sales_Transactions   | Customer_ID          | 1 to 1 mapping; Validation: must not be NULL               |
| dw.Fact_Sales     | Product_ID          | stg.Sales_Transactions   | Product_ID           | 1 to 1 mapping                                             |
| dw.Fact_Sales     | Sales_Date          | stg.Sales_Transactions   | Sales_Date           | 1 to 1 mapping                                             |
| dw.Fact_Sales     | Quantity            | stg.Sales_Transactions   | Quantity             | 1 to 1 mapping; Validation: must be > 0                    |
| dw.Fact_Sales     | Unit_Price          | stg.Sales_Transactions   | Unit_Price           | 1 to 1 mapping                                             |
| dw.Fact_Sales     | Total_Sales_Amount  | stg.Sales_Transactions   | Quantity, Unit_Price | Transformation: Quantity * Unit_Price                      |
| dw.Fact_Sales     | Region_ID           | dw.Dim_Date              | Region_ID            | Transformation: Lookup via Sales_Date                      |
| dw.Fact_Sales     | Customer_Segment    | dw.Dim_Customer          | Customer_Segment     | Transformation: Lookup via Customer_ID                     |
| dw.Fact_Sales     | Load_Timestamp      | (procedure metadata)     | (N/A)                | Transformation: Set to SYSDATETIME()                       |
| dw.Fact_Sales     | Batch_ID            | (procedure metadata)     | (N/A)                | Transformation: Set to @batch_id                           |

--------------------------------------------------------------------------------
Technical Complexity
--------------------------------------------------------------------------------
| Parameter        | Value  |
|------------------|--------|
| Procedure Name   | dw.sp_load_sales_fact |
| Source Tables    | 1      |
| Target Tables    | 1      |
| Data Flows       | 2      |
| Transformations  | 4      |
| Joins and Filters| 4      |
| Variables        | 7      |
| Parameters       | 0      |
| Dependencies     | 2      |
| Complexity Score | 65     |

--------------------------------------------------------------------------------
Key Outputs
--------------------------------------------------------------------------------
Final Results:
- **dw.Fact_Sales:** Contains cleaned, validated, enriched sales transactions for analytics.
- **dw.Audit_Log:** Tracks batch execution, status, row counts, error messages.
- **dw.DQ_Failures:** Records rejected transactions and reasons for traceability.

Business Alignment:
- Ensures only valid data is loaded for reporting.
- Provides audit trail for compliance.
- Captures data quality issues for remediation.

Output Format:
- Fact table: Structured rows with all required dimensions and metrics.
- Audit log: Batch-level metadata.
- DQ failures: Transaction-level rejection details.

--------------------------------------------------------------------------------
API Cost
--------------------------------------------------------------------------------
apiCost: 0.0125 USD