=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads, validates, transforms, and audits sales transaction data from staging to fact table in the data warehouse.
=============================================

Procedure Overview:
The stored procedure `dw.sp_load_sales_fact` automates the ETL process for loading sales transaction data from a staging table (`stg.Sales_Transactions`) into the main fact table (`dw.Fact_Sales`). It performs audit logging, data quality validation, transformation, and error handling. The business goal is to ensure only clean, validated sales data is loaded for downstream analytics and reporting, while tracking operational metrics and failures for compliance and troubleshooting.

Logic Details:
- Declares variables for batch tracking, timestamps, row counts, error messages, and procedure name.
- Begins audit logging to track the start of the load process.
- Creates a temporary table `#InvalidRows` to capture failed validation records.
- Performs data quality checks for missing `Customer_ID` and invalid `Quantity` (<= 0).
- Deletes invalid records from the staging table and counts rejected rows.
- Transforms and loads valid records into the fact table, joining with customer and date dimensions for enrichment.
- Tracks the number of rows inserted.
- Optionally truncates the staging table after processing.
- Logs validation failures into a dedicated DQ failures table.
- Completes audit logging with row counts and status.
- Implements error handling and updates audit logs on failure.
- Cleans up temporary tables.

Data Flow Details:
1. Audit log entry is created to mark the start of the batch.
2. Temporary table `#InvalidRows` is created for validation failures.
3. Data quality checks are run on `stg.Sales_Transactions`, and failed records are inserted into `#InvalidRows`.
4. Invalid records are deleted from the staging table.
5. Valid records are selected, enriched via joins to `dw.Dim_Customer` and `dw.Dim_Date`, transformed, and loaded into `dw.Fact_Sales`.
6. Staging table is truncated.
7. Validation failures are logged into `dw.DQ_Failures`.
8. Audit log is updated with results.
9. Error handling updates audit log if exceptions occur.
10. Temporary tables are dropped.

Data Transformations:
- Calculates `Total_Sales_Amount` as `Quantity * Unit_Price`.
- Enriches data with `Region_ID` from `dw.Dim_Date` and `Customer_Segment` from `dw.Dim_Customer`.
- Adds `Load_Timestamp` and `Batch_ID` for traceability.
- Filters out invalid records based on business rules (missing customer, invalid quantity).

Data Mapping:

| Target Table Name | Target Column Name    | Source Table Name      | Source Column Name    | Remarks                                   |
|-------------------|----------------------|-----------------------|----------------------|--------------------------------------------|
| dw.Fact_Sales     | Transaction_ID       | stg.Sales_Transactions| Transaction_ID       | 1 to 1 mapping                            |
| dw.Fact_Sales     | Customer_ID          | stg.Sales_Transactions| Customer_ID          | 1 to 1 mapping, validated (not null)       |
| dw.Fact_Sales     | Product_ID           | stg.Sales_Transactions| Product_ID           | 1 to 1 mapping                            |
| dw.Fact_Sales     | Sales_Date           | stg.Sales_Transactions| Sales_Date           | 1 to 1 mapping                            |
| dw.Fact_Sales     | Quantity             | stg.Sales_Transactions| Quantity             | 1 to 1 mapping, validated (> 0)            |
| dw.Fact_Sales     | Unit_Price           | stg.Sales_Transactions| Unit_Price           | 1 to 1 mapping                            |
| dw.Fact_Sales     | Total_Sales_Amount   | stg.Sales_Transactions| Quantity, Unit_Price | Transformation: Quantity * Unit_Price      |
| dw.Fact_Sales     | Region_ID            | dw.Dim_Date           | Region_ID            | Enrichment via join on Sales_Date          |
| dw.Fact_Sales     | Customer_Segment     | dw.Dim_Customer       | Customer_Segment     | Enrichment via join on Customer_ID         |
| dw.Fact_Sales     | Load_Timestamp       | (generated)           | (generated)          | Transformation: SYSDATETIME()              |
| dw.Fact_Sales     | Batch_ID             | (generated)           | (generated)          | Transformation: NEWID()                    |

Technical Complexity:

| Parameter          | Value                     |
|--------------------|--------------------------|
| Procedure Name     | dw.sp_load_sales_fact     |
| Source Tables      | 3 (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables      | 3 (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures)          |
| Data Flows         | 4 (staging, temp table, fact table, DQ failures)         |
| Transformations    | 5 (validation, enrichment, calculation, audit, error handling) |
| Joins and Filters  | 2 joins, 2 filters       |
| Variables          | 7 declared variables     |
| Parameters         | 0 input/output parameters|
| Dependencies       | 2 (dw.Dim_Customer, dw.Dim_Date)                         |
| Complexity Score   | 75                       |

Key Outputs:
- Cleaned and enriched sales data loaded into `dw.Fact_Sales`.
- Audit logs in `dw.Audit_Log` for traceability and operational metrics.
- Data quality failure records in `dw.DQ_Failures` for compliance and troubleshooting.
- Metrics on rows inserted and rejected, supporting business reporting and data governance.

apiCost: 0.0125 USD