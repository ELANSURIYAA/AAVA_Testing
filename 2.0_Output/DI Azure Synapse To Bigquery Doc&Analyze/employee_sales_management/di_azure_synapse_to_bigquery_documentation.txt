=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads cleaned and validated sales transactions from staging into the sales fact table, while logging audit and data quality information.
============================================

Procedure Overview:
The stored procedure `dw.sp_load_sales_fact` is designed to automate the ETL process for loading sales transaction data from a staging table (`stg.Sales_Transactions`) into the main sales fact table (`dw.Fact_Sales`). It performs data quality checks, logs audit information, manages data validation failures, and ensures only clean data is loaded into the target table. This procedure is critical for maintaining high data quality and traceability in the organization's sales analytics pipeline, supporting accurate reporting and business decision-making.

Logic Details:
- The procedure begins by initializing audit logging to track the ETL batch.
- It declares variables for batch tracking, timestamps, row counts, error messages, and procedure name.
- Temporary table `#InvalidRows` is created to capture validation failures.
- Data quality checks are performed for missing `Customer_ID` and invalid `Quantity` values.
- Invalid rows are deleted from the staging table and counted.
- Cleaned data is joined with dimension tables (`dw.Dim_Customer`, `dw.Dim_Date`), transformed, and inserted into the fact table.
- The staging table is truncated after successful load.
- Validation failures are logged in `dw.DQ_Failures`.
- Audit log is updated with completion status, row counts, and messages.
- Error handling updates the audit log on failure and rethrows the error for monitoring.
- Temporary resources are cleaned up at the end.

Data Flow Details:
1. Audit log entry is created to record the start of the batch.
2. Temporary table `#InvalidRows` is created for tracking failed validations.
3. Data quality validation:
   - Records with missing `Customer_ID` or non-positive `Quantity` are inserted into `#InvalidRows`.
4. Invalid records are deleted from `stg.Sales_Transactions` based on `#InvalidRows`.
5. Cleaned staging data is joined with `dw.Dim_Customer` and `dw.Dim_Date` for enrichment.
6. Transformed records are inserted into `dw.Fact_Sales`, including calculated fields and batch metadata.
7. Staging table is truncated to prevent duplicate processing.
8. Validation failures are logged into `dw.DQ_Failures` for audit and review.
9. Audit log is updated with completion details.
10. Error handling updates the audit log and rethrows errors if any occur.
11. Temporary table is dropped for cleanup.

Data Transformations:
- Data quality checks filter out records with missing `Customer_ID` and invalid `Quantity`.
- Calculation of `Total_Sales_Amount` as `Quantity * Unit_Price`.
- Enrichment of sales data with `Region_ID` (from `dw.Dim_Date`) and `Customer_Segment` (from `dw.Dim_Customer`).
- Addition of metadata fields: `Load_Timestamp` and `Batch_ID`.
- Removal of invalid data ensures only high-quality records are loaded.

Data Mapping:

| Target Table Name | Target Column Name    | Source Table Name      | Source Column Name    | Remarks (1 to 1 mapping, Transformation, Validation)                  |
|-------------------|----------------------|------------------------|----------------------|------------------------------------------------------------------------|
| dw.Fact_Sales     | Transaction_ID       | stg.Sales_Transactions | Transaction_ID       | 1 to 1 mapping                                                         |
| dw.Fact_Sales     | Customer_ID          | stg.Sales_Transactions | Customer_ID          | 1 to 1 mapping, validated for NOT NULL                                 |
| dw.Fact_Sales     | Product_ID           | stg.Sales_Transactions | Product_ID           | 1 to 1 mapping                                                         |
| dw.Fact_Sales     | Sales_Date           | stg.Sales_Transactions | Sales_Date           | 1 to 1 mapping                                                         |
| dw.Fact_Sales     | Quantity             | stg.Sales_Transactions | Quantity             | 1 to 1 mapping, validated for > 0                                      |
| dw.Fact_Sales     | Unit_Price           | stg.Sales_Transactions | Unit_Price           | 1 to 1 mapping                                                         |
| dw.Fact_Sales     | Total_Sales_Amount   | stg.Sales_Transactions | Quantity, Unit_Price | Transformation: Quantity * Unit_Price                                  |
| dw.Fact_Sales     | Region_ID            | dw.Dim_Date            | Region_ID            | 1 to 1 mapping via join on Sales_Date                                  |
| dw.Fact_Sales     | Customer_Segment     | dw.Dim_Customer        | Customer_Segment     | 1 to 1 mapping via join on Customer_ID                                 |
| dw.Fact_Sales     | Load_Timestamp       | (system)               | SYSDATETIME()        | Transformation: load timestamp                                         |
| dw.Fact_Sales     | Batch_ID             | (variable)             | @batch_id            | Transformation: batch identifier for traceability                      |

Advanced business logic includes validation, enrichment via joins, and calculated fields.

Technical Complexity:

| Parameter         | Value         |
|-------------------|--------------|
| Procedure Name    | dw.sp_load_sales_fact |
| Source Tables     | 3 (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables     | 3 (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures) |
| Data Flows        | 4 (staging, temp table, transformation, target) |
| Transformations   | 6 (validation, joins, calculation, enrichment, truncation, audit logging) |
| Joins and Filters | 3 (2 joins, 1 filter for validation) |
| Variables         | 7 (batch_id, start_time, end_time, rows_inserted, rows_rejected, error_message, proc_name) |
| Parameters        | 0 (no input/output parameters) |
| Dependencies      | 0 (no dependent views/procedures, only tables) |
| Complexity Score  | 65          |

Key Outputs:
- Cleaned and enriched sales transaction records inserted into `dw.Fact_Sales`.
- Audit log entries in `dw.Audit_Log` for traceability and monitoring.
- Data quality failure records in `dw.DQ_Failures` for review and remediation.
- Staging table is cleared after processing to prevent duplicate loads.
- Outputs support business analytics, reporting, and compliance requirements.

apiCost: 0.0125 USD