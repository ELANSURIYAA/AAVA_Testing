=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads cleaned and validated sales transaction data from staging into the Fact_Sales table, applying data quality checks, transformations, and audit logging.
=============================================

Procedure Overview:
This stored procedure, `dw.sp_load_sales_fact`, is designed to automate the ETL process for loading sales transaction data from the staging area (`stg.Sales_Transactions`) into the data warehouse fact table (`dw.Fact_Sales`). It performs data quality checks, applies business logic transformations, manages audit logging, and handles error reporting. The procedure ensures only clean, validated data is loaded into the warehouse, supporting accurate reporting and analytics. This process is critical for maintaining high data quality and traceability in the organization's sales reporting pipeline.

Logic Details:
- The procedure starts by initializing audit logging for traceability.
- It declares variables for batch tracking, timing, and error handling.
- Temporary tables are used to capture and process invalid data.
- Data quality checks are performed to identify missing or invalid records.
- Invalid records are removed from the staging table and logged for review.
- Cleaned and transformed data is loaded into the `dw.Fact_Sales` table, joining with dimension tables for enrichment.
- The staging table is truncated post-load.
- Data quality failures are logged in a dedicated table.
- Audit logs are updated with the outcome, and errors are handled with detailed logging and optional rethrowing for pipeline monitoring.

Data Flow Details:
1. The procedure begins by inserting an audit log entry to track the ETL batch.
2. A temporary table `#InvalidRows` is created to store IDs and reasons for failed data quality checks.
3. Data quality checks are executed:
   - Transactions with missing `Customer_ID` are flagged.
   - Transactions with non-positive `Quantity` are flagged.
4. Invalid rows are deleted from the staging table, and the count is tracked.
5. Cleaned data is selected from the staging table, joined with `dw.Dim_Customer` and `dw.Dim_Date` for enrichment, and transformed (e.g., calculating `Total_Sales_Amount`).
6. The transformed data is inserted into `dw.Fact_Sales`.
7. The staging table is truncated to prepare for the next batch.
8. Data quality failures are logged in `dw.DQ_Failures`.
9. The audit log is updated with the batch outcome, including counts of inserted and rejected rows.
10. In case of errors, the audit log is updated with failure status and error messages.
11. Temporary resources are cleaned up at the end.

Data Transformations:
- Calculation of `Total_Sales_Amount` as `Quantity * Unit_Price`.
- Enrichment with `Region_ID` from `dw.Dim_Date` and `Customer_Segment` from `dw.Dim_Customer`.
- Addition of audit fields: `Load_Timestamp` and `Batch_ID`.
- Data quality transformations:
  - Removal of records with missing `Customer_ID` or invalid `Quantity`.
- Logging of rejected records for traceability.

Data Mapping:

| Target Table Name | Target Column Name   | Source Table Name    | Source Column Name   | Remarks                               |
|-------------------|---------------------|----------------------|----------------------|----------------------------------------|
| dw.Fact_Sales     | Transaction_ID      | stg.Sales_Transactions | Transaction_ID     | 1 to 1 mapping                        |
| dw.Fact_Sales     | Customer_ID         | stg.Sales_Transactions | Customer_ID        | 1 to 1 mapping                        |
| dw.Fact_Sales     | Product_ID          | stg.Sales_Transactions | Product_ID         | 1 to 1 mapping                        |
| dw.Fact_Sales     | Sales_Date          | stg.Sales_Transactions | Sales_Date         | 1 to 1 mapping                        |
| dw.Fact_Sales     | Quantity            | stg.Sales_Transactions | Quantity           | 1 to 1 mapping, validated > 0         |
| dw.Fact_Sales     | Unit_Price          | stg.Sales_Transactions | Unit_Price         | 1 to 1 mapping                        |
| dw.Fact_Sales     | Total_Sales_Amount  | stg.Sales_Transactions | Quantity, Unit_Price | Transformation: Quantity * Unit_Price |
| dw.Fact_Sales     | Region_ID           | dw.Dim_Date          | Region_ID           | Enrichment via join on Sales_Date      |
| dw.Fact_Sales     | Customer_Segment    | dw.Dim_Customer      | Customer_Segment    | Enrichment via join on Customer_ID     |
| dw.Fact_Sales     | Load_Timestamp      | -                    | -                   | Transformation: SYSDATETIME()          |
| dw.Fact_Sales     | Batch_ID            | -                    | -                   | Transformation: NEWID() per batch      |

Technical Complexity:

| Parameter         | Value      |
|-------------------|-----------|
| Procedure Name    | dw.sp_load_sales_fact |
| Source Tables     | 3         |  (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables     | 3         |  (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures) |
| Data Flows        | 4         |  (staging, temp table, fact table, DQ failures) |
| Transformations   | 5         |  (DQ checks, calculation, enrichment, audit, logging) |
| Joins and Filters | 3         |  (2 joins, 1 filter for DQ) |
| Variables         | 7         |  (@batch_id, @start_time, @end_time, @rows_inserted, @rows_rejected, @error_message, @proc_name) |
| Parameters        | 0         |  (No input/output parameters) |
| Dependencies      | 0         |  (No explicit dependent procs/views) |
| Complexity Score  | 65        |  (Moderate: multiple steps, DQ, logging, joins, but clear structure) |

Key Outputs:
- The main output is the insertion of cleaned, validated, and enriched sales transaction data into `dw.Fact_Sales`.
- Data quality failures are logged in `dw.DQ_Failures` for auditing and remediation.
- Audit logs in `dw.Audit_Log` provide traceability and operational transparency for each ETL batch.
- The outputs support accurate sales reporting, business analytics, and compliance with data governance standards.

apiCost: 0.0125 USD