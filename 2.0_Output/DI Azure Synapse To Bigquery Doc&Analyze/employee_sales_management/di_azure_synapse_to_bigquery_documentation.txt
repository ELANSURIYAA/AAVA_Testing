=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads, validates, and audits sales transaction data from staging to fact table, with data quality checks, enrichment, and logging.
=============================================

Procedure Overview:
The stored procedure `dw.sp_load_sales_fact` automates the ETL process for sales transaction data. It validates, cleans, enriches, and loads data from a staging table into the main fact table, while logging audit information and tracking data quality failures. This ensures only high-quality, enriched data is available for analytics and reporting, supporting business decisions and compliance.

Logic Details:
- Initializes batch and audit variables.
- Logs start of batch in audit table.
- Creates a temporary table to capture invalid rows.
- Performs data quality checks (missing Customer_ID, invalid Quantity).
- Deletes invalid rows from staging and counts rejected rows.
- Transforms and enriches valid data (joins with customer and date dimensions, calculates total sales amount).
- Loads cleaned/enriched data into the fact table.
- Truncates the staging table.
- Logs data quality failures to a dedicated table.
- Updates audit log with row counts and status.
- Handles errors with TRY/CATCH, logs failures, and cleans up temporary objects.

Data Flow Details:
1. Source data is read from `stg.Sales_Transactions`.
2. Data quality checks identify and remove invalid records, which are logged separately.
3. Valid records are joined with `dw.Dim_Customer` and `dw.Dim_Date` for enrichment.
4. Transformed data is inserted into `dw.Fact_Sales`.
5. Staging table is truncated to prepare for next batch.
6. Audit and DQ failure logs are updated at each step.
7. Error handling ensures failures are logged and batch status is updated.

Data Transformations:
- Filters out transactions with missing Customer_ID or non-positive Quantity.
- Calculates `Total_Sales_Amount` as `Quantity * Unit_Price`.
- Enriches records with `Region_ID` (from date dimension) and `Customer_Segment` (from customer dimension).
- Adds batch and timestamp metadata to each fact record.

Data Mapping:
| Target Table Name | Target Column Name   | Source Table Name      | Source Column Name   | Remarks                                  |
|-------------------|---------------------|------------------------|---------------------|-------------------------------------------|
| dw.Fact_Sales     | Transaction_ID      | stg.Sales_Transactions | Transaction_ID      | 1 to 1 mapping                            |
| dw.Fact_Sales     | Customer_ID         | stg.Sales_Transactions | Customer_ID         | 1 to 1 mapping (validated not null)       |
| dw.Fact_Sales     | Product_ID          | stg.Sales_Transactions | Product_ID          | 1 to 1 mapping                            |
| dw.Fact_Sales     | Sales_Date          | stg.Sales_Transactions | Sales_Date          | 1 to 1 mapping                            |
| dw.Fact_Sales     | Quantity            | stg.Sales_Transactions | Quantity            | 1 to 1 mapping (validated > 0)            |
| dw.Fact_Sales     | Unit_Price          | stg.Sales_Transactions | Unit_Price          | 1 to 1 mapping                            |
| dw.Fact_Sales     | Total_Sales_Amount  | stg.Sales_Transactions | Quantity, Unit_Price| Transformation: Quantity * Unit_Price     |
| dw.Fact_Sales     | Region_ID           | dw.Dim_Date            | Region_ID           | Transformation: join on Sales_Date        |
| dw.Fact_Sales     | Customer_Segment    | dw.Dim_Customer        | Customer_Segment    | Transformation: join on Customer_ID       |
| dw.Fact_Sales     | Load_Timestamp      | (generated)            | (generated)         | Transformation: SYSDATETIME()             |
| dw.Fact_Sales     | Batch_ID            | (generated)            | (generated)         | Transformation: NEWID()                   |
| dw.DQ_Failures    | Transaction_ID      | stg.Sales_Transactions | Transaction_ID      | Only for invalid rows                     |
| dw.DQ_Failures    | Failure_Reason      | (generated)            | (generated)         | Transformation: validation reason         |
| dw.Audit_Log      | Batch_ID            | (generated)            | (generated)         | Transformation: NEWID()                   |
| dw.Audit_Log      | Procedure_Name      | (generated)            | (generated)         | Transformation: OBJECT_NAME(@@PROCID)     |
| dw.Audit_Log      | Start_Time          | (generated)            | (generated)         | Transformation: SYSDATETIME()             |
| dw.Audit_Log      | End_Time            | (generated)            | (generated)         | Transformation: SYSDATETIME()             |
| dw.Audit_Log      | Rows_Inserted       | (generated)            | (generated)         | Transformation: @@ROWCOUNT                |
| dw.Audit_Log      | Rows_Rejected       | (generated)            | (generated)         | Transformation: @@ROWCOUNT                |
| dw.Audit_Log      | Status              | (generated)            | (generated)         | Transformation: 'STARTED', 'COMPLETED'    |
| dw.Audit_Log      | Message             | (generated)            | (generated)         | Transformation: status message            |

Technical Complexity:
| Parameter        | Value           |
|------------------|-----------------|
| Procedure Name   | dw.sp_load_sales_fact |
| Source Tables    | 3 (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables    | 3 (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures) |
| Data Flows       | 4 (staging → validation → enrichment → fact/DQ/audit) |
| Transformations  | 5 (validation, enrichment, calculation, audit, error handling) |
| Joins and Filters| 3 (2 joins, 1 filter for validation) |
| Variables        | 7 (batch_id, start_time, end_time, rows_inserted, rows_rejected, error_message, proc_name) |
| Parameters       | 0 (no input/output parameters) |
| Dependencies     | 0 (no dependent views or stored procedures) |
| Complexity Score | 65 |

Key Outputs:
- Cleaned and enriched sales fact data in `dw.Fact_Sales` for analytics and reporting.
- Audit log records in `dw.Audit_Log` for traceability and monitoring.
- Data quality failure records in `dw.DQ_Failures` for compliance and remediation.

apiCost: 0.0000 USD