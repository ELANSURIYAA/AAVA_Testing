=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads cleaned and validated sales transactions from staging into the Fact_Sales table, applying business rules, audit logging, and data quality checks.
=============================================

Procedure Overview:
This stored procedure, dw.sp_load_sales_fact, is designed to extract sales transaction data from the staging table (stg.Sales_Transactions), perform data quality checks and business rule validations, and load the cleaned and transformed data into the data warehouse's Fact_Sales table (dw.Fact_Sales). It also logs audit information and data quality failures, ensuring traceability and operational transparency. The procedure supports the business need for reliable, high-quality sales data for analytics, reporting, and decision-making.

Logic Details:
- The procedure begins by initializing audit logging and generating a unique batch ID.
- It creates a temporary table (#InvalidRows) to capture validation failures.
- Basic data quality checks are performed (e.g., missing Customer_ID, invalid Quantity).
- Invalid records are deleted from the staging table and logged for review.
- Valid records are transformed (e.g., calculating Total_Sales_Amount, joining with dimension tables) and loaded into the Fact_Sales table.
- The staging table is truncated after successful load.
- Data quality failures are logged to a dedicated table (dw.DQ_Failures).
- Audit logs are updated with row counts and status.
- Error handling ensures failures are logged and surfaced for monitoring.

Data Flow Details:
1. Audit log entry is created to mark the start of the batch.
2. Temporary table #InvalidRows is created for capturing validation failures.
3. Data quality checks are performed on stg.Sales_Transactions:
   - Records with missing Customer_ID or invalid Quantity are flagged.
4. Invalid records are deleted from stg.Sales_Transactions and counted.
5. Valid records are joined with dw.Dim_Customer and dw.Dim_Date for enrichment.
6. Transformed records are inserted into dw.Fact_Sales, including calculated fields and batch metadata.
7. The staging table is truncated to prepare for the next batch.
8. Validation failures are logged in dw.DQ_Failures for traceability.
9. Audit log is updated with process completion status and row counts.
10. In case of errors, the audit log is updated with failure status and error message.

Data Transformations:
- Calculation of Total_Sales_Amount as Quantity * Unit_Price.
- Enrichment of sales data with Region_ID (from dw.Dim_Date) and Customer_Segment (from dw.Dim_Customer).
- Addition of Load_Timestamp and Batch_ID for traceability.
- Data quality checks ensure only records with valid Customer_ID and positive Quantity are loaded.
- Invalid records are excluded from the Fact_Sales table and logged for further investigation.

Data Mapping:

| Target Table Name | Target Column Name   | Source Table Name     | Source Column Name   | Remarks (1 to 1 mapping, Transformation, Validation)           |
|-------------------|---------------------|-----------------------|----------------------|----------------------------------------------------------------|
| dw.Fact_Sales     | Transaction_ID      | stg.Sales_Transactions| Transaction_ID       | 1 to 1 mapping                                               |
| dw.Fact_Sales     | Customer_ID         | stg.Sales_Transactions| Customer_ID          | 1 to 1 mapping, validated not null                            |
| dw.Fact_Sales     | Product_ID          | stg.Sales_Transactions| Product_ID           | 1 to 1 mapping                                               |
| dw.Fact_Sales     | Sales_Date          | stg.Sales_Transactions| Sales_Date           | 1 to 1 mapping                                               |
| dw.Fact_Sales     | Quantity            | stg.Sales_Transactions| Quantity             | 1 to 1 mapping, validated > 0                                 |
| dw.Fact_Sales     | Unit_Price          | stg.Sales_Transactions| Unit_Price           | 1 to 1 mapping                                               |
| dw.Fact_Sales     | Total_Sales_Amount  | stg.Sales_Transactions| Quantity, Unit_Price | Transformation: Quantity * Unit_Price                        |
| dw.Fact_Sales     | Region_ID           | dw.Dim_Date           | Region_ID            | Enrichment via join on Sales_Date = Date_Value                |
| dw.Fact_Sales     | Customer_Segment    | dw.Dim_Customer       | Customer_Segment     | Enrichment via join on Customer_ID                            |
| dw.Fact_Sales     | Load_Timestamp      | -                     | -                    | Transformation: SYSDATETIME()                                 |
| dw.Fact_Sales     | Batch_ID            | -                     | -                    | Transformation: @batch_id (unique per run)                    |

Technical Complexity:

| Parameter         | Value     |
|-------------------|----------|
| Procedure Name    | dw.sp_load_sales_fact |
| Source Tables     | 3        |  (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables     | 3        |  (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures)          |
| Data Flows        | 2        |  (Main load, Invalid rows handling)                     |
| Transformations   | 5        |  (Total_Sales_Amount calc, joins, enrichment, validation, timestamp) |
| Joins and Filters | 3        |  (2 joins, 1 filter per validation)                     |
| Variables         | 7        |  (@batch_id, @start_time, @end_time, @rows_inserted, @rows_rejected, @error_message, @proc_name) |
| Parameters        | 0        |  (No input/output parameters)                           |
| Dependencies      | 0        |  (No dependent views or procedures)                     |
| Complexity Score  | 65       |  (Moderate: multiple steps, error handling, audit, transformations) |

Key Outputs:
- The main output is the population of dw.Fact_Sales with cleaned, validated, and enriched sales transaction data, ready for analytics and reporting.
- Data quality failures are captured in dw.DQ_Failures for monitoring and remediation.
- Audit logs in dw.Audit_Log provide traceability and operational transparency, supporting compliance and troubleshooting.
- The outputs support business reporting, sales analytics, and data governance initiatives.

apiCost: 0.0125 USD