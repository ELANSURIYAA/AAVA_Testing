=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads cleaned and validated sales transactions from staging to the Fact_Sales table, applying data quality checks, transformations, and audit logging.
=============================================

Procedure Overview:
This stored procedure, dw.sp_load_sales_fact, automates the ETL process for loading sales transaction data from the staging table (stg.Sales_Transactions) into the data warehouse fact table (dw.Fact_Sales). It performs data quality checks, applies business rules and transformations, maintains audit logs, and records data quality failures. The procedure ensures only clean, validated, and enriched sales data is loaded into the fact table, supporting accurate reporting and analytics. It also logs process metadata for traceability and error handling.

Logic Details:
- Main Purpose: To extract, validate, transform, and load sales transaction data from staging into the Fact_Sales table, while logging audit and data quality information.
- Structure: The procedure uses variables for batch and timing, audit logging, temporary tables for validation, CTE for transformation, and error handling with TRY/CATCH.
- Key SQL Operations: INSERT, DELETE, TRUNCATE, CTE-based SELECT, INNER JOIN, aggregation (Total_Sales_Amount), and audit updates.
- Input Parameters: None (all variables are internally declared).
- Output: Populates dw.Fact_Sales, dw.Audit_Log, and dw.DQ_Failures tables. Truncates stg.Sales_Transactions.

Data Flow Details:
1. Audit log entry is created to mark the start of the batch.
2. A temporary table (#InvalidRows) is created to capture validation failures.
3. Data quality checks are performed:
   - Transactions with missing Customer_ID are flagged.
   - Transactions with non-positive Quantity are flagged.
4. Invalid rows are deleted from staging, and the count is tracked.
5. Cleaned data is selected, joined with customer and date dimensions, and transformed (e.g., calculating Total_Sales_Amount).
6. Transformed data is inserted into dw.Fact_Sales.
7. The staging table is truncated to prevent duplicate loads.
8. Validation failures are logged to dw.DQ_Failures.
9. Audit log is updated with process results.
10. If an error occurs, the audit log is updated with failure status and error message.
11. Temporary tables are cleaned up.

Data Transformations:
- Calculation of Total_Sales_Amount as Quantity * Unit_Price.
- Enrichment with Region_ID (from Dim_Date) and Customer_Segment (from Dim_Customer).
- Data quality filtering: Only transactions with valid Customer_ID and positive Quantity are processed.
- Addition of Load_Timestamp and Batch_ID for traceability.
- Mapping of sales date to the date dimension for consistent reporting.

Data Mapping:

| Target Table Name | Target Column Name   | Source Table Name      | Source Column Name   | Remarks                                    |
|-------------------|---------------------|------------------------|---------------------|---------------------------------------------|
| dw.Fact_Sales     | Transaction_ID      | stg.Sales_Transactions | Transaction_ID      | 1 to 1 mapping                             |
| dw.Fact_Sales     | Customer_ID         | stg.Sales_Transactions | Customer_ID         | 1 to 1 mapping                             |
| dw.Fact_Sales     | Product_ID          | stg.Sales_Transactions | Product_ID          | 1 to 1 mapping                             |
| dw.Fact_Sales     | Sales_Date          | stg.Sales_Transactions | Sales_Date          | 1 to 1 mapping                             |
| dw.Fact_Sales     | Quantity            | stg.Sales_Transactions | Quantity            | 1 to 1 mapping, validated (>0)              |
| dw.Fact_Sales     | Unit_Price          | stg.Sales_Transactions | Unit_Price          | 1 to 1 mapping                             |
| dw.Fact_Sales     | Total_Sales_Amount  | Calculated             | Quantity, Unit_Price| Transformation: Quantity * Unit_Price       |
| dw.Fact_Sales     | Region_ID           | dw.Dim_Date            | Region_ID           | Joined via Sales_Date = Date_Value          |
| dw.Fact_Sales     | Customer_Segment    | dw.Dim_Customer        | Customer_Segment    | Joined via Customer_ID                      |
| dw.Fact_Sales     | Load_Timestamp      | System                 | SYSDATETIME()       | Transformation: Load timestamp              |
| dw.Fact_Sales     | Batch_ID            | Generated              | @batch_id           | Transformation: Unique batch identifier     |

- Advanced logic: Data is only loaded if it passes validation; invalid records are logged and not loaded.

Technical Complexity:

| Parameter         | Value                |
|-------------------|----------------------|
| Procedure Name    | dw.sp_load_sales_fact|
| Source Tables     | 3 (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables     | 3 (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures) |
| Data Flows        | 4 (staging -> temp table for invalids -> transformation CTE -> fact table) |
| Transformations   | 5 (validation, calculation, joins, enrichment, timestamping) |
| Joins and Filters | 3 (2 joins, 1 main filter for validation) |
| Variables         | 7 (batch_id, start_time, end_time, rows_inserted, rows_rejected, error_message, proc_name) |
| Parameters        | 0 (no input/output parameters) |
| Dependencies      | 0 (no dependent procs/views called) |
| Complexity Score  | 65                          |

Key Outputs:
- The procedure produces a cleaned and enriched sales fact dataset in dw.Fact_Sales, ready for analytics and reporting.
- Data quality failures are logged in dw.DQ_Failures for review and remediation.
- Audit logs in dw.Audit_Log provide traceability, row counts, and error tracking for compliance and monitoring.
- The outputs support business reporting, data quality management, and operational transparency.

apiCost: 0.0125 USD