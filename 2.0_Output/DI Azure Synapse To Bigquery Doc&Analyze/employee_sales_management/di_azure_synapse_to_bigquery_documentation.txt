=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads cleaned and validated sales transactions from staging into the sales fact table, applies data quality checks, logs audit and validation results, and manages batch processing.
============================================

Procedure Overview:
The stored procedure [dw.sp_load_sales_fact] is designed to automate the ETL (Extract, Transform, Load) process for loading sales transaction data from a staging table into the enterprise data warehouse's sales fact table. It performs data quality validation, logs audit information, manages batch processing, and ensures only clean and validated data is loaded into the target table. This procedure is critical for maintaining high data quality and traceability in the organization's sales reporting pipeline, directly supporting business analytics, reporting, and decision-making.

Logic Details:
- The procedure initializes batch and audit variables for traceability.
- It logs the start of the batch in an audit log.
- Temporary tables are created to capture validation failures.
- Basic data quality checks are performed (e.g., missing Customer_ID, invalid Quantity).
- Invalid records are removed from the staging table and counted.
- Valid, transformed data is loaded into the Fact_Sales table using joins with dimension tables.
- The staging table is truncated after successful load.
- Validation failures are logged in a dedicated table.
- The audit log is updated with the outcome and row counts.
- Comprehensive error handling ensures failures are logged and surfaced for monitoring.

Data Flow Details:
1. The process begins by logging the start of the ETL batch in the audit log.
2. A temporary table (#InvalidRows) is created to collect rows failing validation.
3. Data quality checks are run on stg.Sales_Transactions to find missing Customer_IDs and invalid Quantities, and results are inserted into #InvalidRows.
4. Invalid records are deleted from the staging table based on #InvalidRows.
5. Valid records are joined with customer and date dimension tables, transformed, and inserted into dw.Fact_Sales.
6. The staging table is truncated to prepare for the next batch.
7. All validation failures are logged into dw.DQ_Failures for traceability.
8. The audit log is updated with the batch outcome, including counts of inserted and rejected rows.
9. In case of errors, the audit log is updated with failure status and error messages.
10. Temporary resources are cleaned up at the end.

Data Transformations:
- Calculation of Total_Sales_Amount as Quantity * Unit_Price.
- Enrichment of sales records with Region_ID (from Dim_Date) and Customer_Segment (from Dim_Customer).
- Addition of Load_Timestamp and Batch_ID for traceability.
- Filtering out records with missing Customer_ID or non-positive Quantity.
- Only records with valid dimension table matches are loaded.
- All transformations align with business rules for clean, enriched, and auditable sales data.

Data Mapping:

| Target Table Name | Target Column Name   | Source Table Name      | Source Column Name   | Remarks                                    |
|-------------------|---------------------|------------------------|---------------------|---------------------------------------------|
| dw.Fact_Sales     | Transaction_ID      | stg.Sales_Transactions | Transaction_ID      | 1 to 1 mapping                             |
| dw.Fact_Sales     | Customer_ID         | stg.Sales_Transactions | Customer_ID         | 1 to 1 mapping, only if not NULL            |
| dw.Fact_Sales     | Product_ID          | stg.Sales_Transactions | Product_ID          | 1 to 1 mapping                             |
| dw.Fact_Sales     | Sales_Date          | stg.Sales_Transactions | Sales_Date          | 1 to 1 mapping, joined to dw.Dim_Date       |
| dw.Fact_Sales     | Quantity            | stg.Sales_Transactions | Quantity            | 1 to 1 mapping, must be > 0                 |
| dw.Fact_Sales     | Unit_Price          | stg.Sales_Transactions | Unit_Price          | 1 to 1 mapping                             |
| dw.Fact_Sales     | Total_Sales_Amount  | stg.Sales_Transactions | Quantity, Unit_Price| Transformation: Quantity * Unit_Price       |
| dw.Fact_Sales     | Region_ID           | dw.Dim_Date            | Region_ID           | Enrichment via join on Sales_Date           |
| dw.Fact_Sales     | Customer_Segment    | dw.Dim_Customer        | Customer_Segment    | Enrichment via join on Customer_ID          |
| dw.Fact_Sales     | Load_Timestamp      | -                      | -                   | Transformation: SYSDATETIME()               |
| dw.Fact_Sales     | Batch_ID            | -                      | -                   | Transformation: Generated per batch         |

Advanced/Complex Logic:
- Validation and removal of invalid records prior to load.
- Dynamic batch and timestamp assignment for traceability.
- Multi-table joins for enrichment.

Technical Complexity:

| Parameter         | Value                |
|-------------------|---------------------|
| Procedure Name    | dw.sp_load_sales_fact|
| Source Tables     | 3 (stg.Sales_Transactions, dw.Dim_Customer, dw.Dim_Date) |
| Target Tables     | 3 (dw.Fact_Sales, dw.Audit_Log, dw.DQ_Failures) |
| Data Flows        | 4 (validation, deletion, transformation/load, logging) |
| Transformations   | 5 (validation, calculation, enrichment, timestamp, batch ID) |
| Joins and Filters | 4 (2 joins, 2 filters) |
| Variables         | 7 (@batch_id, @start_time, @end_time, @rows_inserted, @rows_rejected, @error_message, @proc_name) |
| Parameters        | 0 (no input/output parameters) |
| Dependencies      | 0 (no dependent procedures or views called) |
| Complexity Score  | 65                   |

Key Outputs:
- Cleaned and enriched sales transaction records in dw.Fact_Sales, ready for analytics and reporting.
- Audit log entries in dw.Audit_Log for traceability and monitoring.
- Data quality failure records in dw.DQ_Failures for compliance and remediation.
- The outputs enable accurate, timely, and auditable sales reporting for business decision-making.

apiCost: 0.0125 USD