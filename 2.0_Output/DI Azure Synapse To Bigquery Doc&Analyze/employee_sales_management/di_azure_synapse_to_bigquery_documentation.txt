=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads, audits, and validates sales transactions from staging to the Fact_Sales table, including data quality checks, audit logging, and error handling.
=============================================

Procedure Overview:
This stored procedure (`dw.sp_load_sales_fact`) orchestrates the ETL process for loading sales transactions from a staging table (`stg.Sales_Transactions`) into the data warehouse fact table (`dw.Fact_Sales`). It performs data quality checks, logs audit information, manages rejected records, and handles errors robustly. The business objective is to ensure only clean, validated sales data is loaded into analytics-ready tables, supporting accurate reporting and downstream analytics.

Logic Details:
- The procedure begins by initializing audit logging for the ETL batch.
- It creates a temporary table for invalid rows and performs data quality checks (missing CustomerID, invalid Quantity).
- Invalid records are deleted from the staging table and logged for audit purposes.
- Cleaned data is joined with dimension tables (`dw.Dim_Customer`, `dw.Dim_Date`), transformed (calculates Total_Sales_Amount), and loaded into the fact table (`dw.Fact_Sales`).
- The staging table is truncated after the load.
- All rejected records are logged to the data quality failures table (`dw.DQ_Failures`).
- Audit log is updated with row counts and status.
- Robust error handling updates the audit log on failure and rethrows the error for pipeline monitoring.
- Temporary tables are cleaned up at the end.

Data Flow Details:
1. Extract data from `stg.Sales_Transactions`.
2. Validate data for missing/invalid values and log failures.
3. Remove invalid records from staging.
4. Transform and enrich valid records by joining with dimension tables.
5. Load transformed records into `dw.Fact_Sales`.
6. Truncate staging table.
7. Log rejected records to `dw.DQ_Failures`.
8. Update audit logs with process status and row counts.
9. Handle errors and clean up temporary tables.

Data Transformations:
- Calculation of `Total_Sales_Amount` as `Quantity * Unit_Price`.
- Enrichment of sales records with `Region_ID` (from `dw.Dim_Date`) and `Customer_Segment` (from `dw.Dim_Customer`).
- Data quality validation for missing CustomerID and invalid Quantity.
- Audit and error messages dynamically generated for each batch.

Data Mapping:

| Target Table Name | Target Column Name    | Source Table Name      | Source Column Name    | Remarks (1 to 1 mapping, Transformation, Validation)                 |
|-------------------|----------------------|-----------------------|----------------------|-----------------------------------------------------------------------|
| dw.Fact_Sales     | Transaction_ID       | stg.Sales_Transactions| Transaction_ID       | 1 to 1 mapping                                                        |
| dw.Fact_Sales     | Customer_ID          | stg.Sales_Transactions| Customer_ID          | 1 to 1 mapping, validated (not null)                                  |
| dw.Fact_Sales     | Product_ID           | stg.Sales_Transactions| Product_ID           | 1 to 1 mapping                                                        |
| dw.Fact_Sales     | Sales_Date           | stg.Sales_Transactions| Sales_Date           | 1 to 1 mapping                                                        |
| dw.Fact_Sales     | Quantity             | stg.Sales_Transactions| Quantity             | 1 to 1 mapping, validated (>0)                                        |
| dw.Fact_Sales     | Unit_Price           | stg.Sales_Transactions| Unit_Price           | 1 to 1 mapping                                                        |
| dw.Fact_Sales     | Total_Sales_Amount   | stg.Sales_Transactions| Quantity, Unit_Price | Transformation: Quantity * Unit_Price                                 |
| dw.Fact_Sales     | Region_ID            | dw.Dim_Date           | Region_ID            | Transformation: join on Sales_Date                                    |
| dw.Fact_Sales     | Customer_Segment     | dw.Dim_Customer       | Customer_Segment     | Transformation: join on Customer_ID                                   |
| dw.Fact_Sales     | Load_Timestamp       | System                | SYSDATETIME()        | Transformation: current timestamp                                     |
| dw.Fact_Sales     | Batch_ID             | System                | @batch_id            | Transformation: batch identifier                                      |

Technical Complexity:

| Parameter         | Value   |
|-------------------|---------|
| Procedure Name    | dw.sp_load_sales_fact |
| Source Tables     | 3       |
| Target Tables     | 3       |
| Data Flows        | 3       |
| Transformations   | 5       |
| Joins and Filters | 4       |
| Variables         | 7       |
| Parameters        | 0       |
| Dependencies      | 2       |
| Complexity Score  | 65      |

Key Outputs:
- Cleaned and validated sales transactions loaded into `dw.Fact_Sales`.
- Audit logs in `dw.Audit_Log` for batch tracking, row counts, and error messages.
- Data quality failures logged in `dw.DQ_Failures` for rejected transactions and reasons.
- Outputs support business reporting, analytics, and data governance.

apiCost: 0.0125 USD