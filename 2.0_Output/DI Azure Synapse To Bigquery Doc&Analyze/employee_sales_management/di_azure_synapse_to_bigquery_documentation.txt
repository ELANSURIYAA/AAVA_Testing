=============================================
Author:        Ascendion AVA
Created on:    
Description:   Loads, validates, and transforms sales transactions from staging into the Fact_Sales table, with audit logging and data quality checks.
=============================================

Procedure Overview:
The stored procedure `dw.sp_load_sales_fact` is designed to automate the ETL process for sales transaction data. It extracts data from the staging table (`stg.Sales_Transactions`), performs data quality validation, enriches records via dimension lookups, loads cleansed and transformed data into the `dw.Fact_Sales` fact table, logs audit information, and records any data quality failures. This process ensures that only high-quality, validated sales data is loaded for analytics and reporting, supporting business decision-making and compliance.

Logic Details:
- Main purpose: To validate, transform, and load sales transaction data into the data warehouse fact table.
- Structure: The procedure uses batch variables, audit logging, temporary tables for validation, data cleansing, enrichment via joins, and error handling.
- Key SQL operations: INSERT, DELETE, TRUNCATE, UPDATE, SELECT, CTE (for transformation).
- Input parameters: None (batch variables are declared internally).
- Output: Rows loaded into `dw.Fact_Sales`, audit log entries, and data quality failure records.

Data Flow Details:
1. Audit log entry is created to mark the start of the process.
2. Temporary table `#InvalidRows` is created to capture validation failures.
3. Data quality checks are performed on the staging table for missing `Customer_ID` and invalid `Quantity`; failed records are logged in `#InvalidRows`.
4. Invalid rows are deleted from the staging table.
5. Cleaned data is enriched by joining with `dw.Dim_Customer` and `dw.Dim_Date` for additional attributes, and transformed (e.g., calculating `Total_Sales_Amount`).
6. Transformed data is inserted into `dw.Fact_Sales`.
7. Staging table is truncated to prepare for the next batch.
8. Data quality failures are logged into `dw.DQ_Failures`.
9. Audit log is updated with completion status and row counts.
10. Error handling ensures failures are logged and the process is traceable.
11. Temporary table is dropped at the end.

Data Transformations:
- Data validation: Removes records with missing `Customer_ID` or non-positive `Quantity`.
- Enrichment: Joins with customer and date dimensions to add `Region_ID` and `Customer_Segment`.
- Calculation: Computes `Total_Sales_Amount` as `Quantity * Unit_Price`.
- Audit and DQ logging: Tracks batch processing, row counts, and failure reasons.

Data Mapping:

| Target Table Name | Target Column Name   | Source Table Name      | Source Column Name    | Remarks                                    |
|-------------------|---------------------|------------------------|----------------------|---------------------------------------------|
| dw.Fact_Sales     | Transaction_ID      | stg.Sales_Transactions | Transaction_ID       | 1 to 1 mapping                             |
| dw.Fact_Sales     | Customer_ID         | stg.Sales_Transactions | Customer_ID          | 1 to 1 mapping                             |
| dw.Fact_Sales     | Product_ID          | stg.Sales_Transactions | Product_ID           | 1 to 1 mapping                             |
| dw.Fact_Sales     | Sales_Date          | stg.Sales_Transactions | Sales_Date           | 1 to 1 mapping                             |
| dw.Fact_Sales     | Quantity            | stg.Sales_Transactions | Quantity             | 1 to 1 mapping, validated (Quantity > 0)   |
| dw.Fact_Sales     | Unit_Price          | stg.Sales_Transactions | Unit_Price           | 1 to 1 mapping                             |
| dw.Fact_Sales     | Total_Sales_Amount  | stg.Sales_Transactions | Quantity, Unit_Price | Transformation (Quantity * Unit_Price)     |
| dw.Fact_Sales     | Region_ID           | dw.Dim_Date            | Region_ID            | Enrichment via join on Sales_Date           |
| dw.Fact_Sales     | Customer_Segment    | dw.Dim_Customer        | Customer_Segment     | Enrichment via join on Customer_ID          |
| dw.Fact_Sales     | Load_Timestamp      | (generated)            | (generated)          | Transformation (SYSDATETIME())              |
| dw.Fact_Sales     | Batch_ID            | (generated)            | (generated)          | Transformation (NEWID())                    |

Advanced logic: Validation, enrichment via joins, calculation, and audit/DQ logging.

Technical Complexity:

| Parameter         | Value                |
|-------------------|---------------------|
| Procedure Name    | dw.sp_load_sales_fact|
| Source Tables     | 1                    |
| Target Tables     | 3 (Fact_Sales, Audit_Log, DQ_Failures) |
| Data Flows        | 4 (staging, temp table, fact table, DQ log) |
| Transformations   | 5 (validation, enrichment, calculation, audit, DQ logging) |
| Joins and Filters | 2 joins, 2 filters   |
| Variables         | 7 declared           |
| Parameters        | 0 input/output       |
| Dependencies      | 2 (Dim_Customer, Dim_Date) |
| Complexity Score  | 65                   |

Key Outputs:
- Cleaned and enriched sales data loaded into `dw.Fact_Sales`.
- Audit logs in `dw.Audit_Log` for traceability and monitoring.
- Data quality failure records in `dw.DQ_Failures` for rejected rows.
- Outputs support business reporting, analytics, and compliance.

apiCost: 0.0125 USD