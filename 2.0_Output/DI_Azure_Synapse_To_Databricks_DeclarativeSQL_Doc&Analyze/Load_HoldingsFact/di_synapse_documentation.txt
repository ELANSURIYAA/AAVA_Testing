====================================================
Author:        Ascendion AAVA
Date:          
Description:   Documentation for Synapse Stored Procedure: LOAD_FACT_EXECUTIVE_SUMMARY
====================================================

# 1. Overview of Pipeline/Component

The `LOAD_FACT_EXECUTIVE_SUMMARY` stored procedure in Azure Synapse Analytics is designed to load the `FACT_EXECUTIVE_SUMMARY` table with summarized holding metrics. It ingests data from the staging table `STG_HOLDING_METRICS`, applies business rule validations, ensures referential integrity through joins to dimension tables, and performs audit logging. This process supports enterprise reporting and analytics by providing a cleansed, validated, and enriched fact table for downstream consumption.

# 2. Component Structure and Design

- **Source:** `STG_HOLDING_METRICS` (staging table containing raw metrics)
- **Copy Activity:** Data is selected from the staging table into a temporary table `#staging_metrics`.
- **Dataflow Transformation:** 
    - Joins to dimension tables: `DIM_DATE`, `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`
    - Business rule validation: income amount normalization
- **Stored Procedure Activity:** The entire logic is encapsulated in the stored procedure `dbo.LOAD_FACT_EXECUTIVE_SUMMARY`.
- **Sink:** `FACT_EXECUTIVE_SUMMARY` (target fact table)
- **Parameters/Variables:** Internal variables for row count and error message.
- **Triggers:** Not specified in the code, but typically invoked by pipeline or schedule.

**Connection Flow:**  
1. Data is copied from `STG_HOLDING_METRICS` to `#staging_metrics`.
2. Data is joined with dimension tables to ensure referential integrity.
3. Validated and transformed data is inserted into `FACT_EXECUTIVE_SUMMARY`.
4. Audit logging is performed.
5. Temporary resources are cleaned up.

# 3. Data Flow and Processing Logic

**Processed Datasets:**
- `STG_HOLDING_METRICS`
- `DIM_DATE`
- `DIM_INSTITUTION`
- `DIM_CORPORATION`
- `DIM_PRODUCT`
- `FACT_EXECUTIVE_SUMMARY`

**Data Flow:**
1. **Staging:** Raw metrics are staged in a temp table.
2. **Transformation & Validation:** Data is joined with dimension tables and business rules are applied (e.g., income normalization).
3. **Load:** Transformed data is loaded into the fact table.
4. **Audit:** Row count is logged for monitoring.
5. **Cleanup:** Temporary staging table is dropped.

**Business Rules/Transformations:**
- Income amount is set to 0 if null or negative.
- Referential integrity enforced via INNER JOINs to dimension tables.

# 4. Data Mapping (Lineage)

| Target Table Name       | Target Column Name      | Source Table Name      | Source Column Name      | Remarks                                     |
|------------------------|------------------------|------------------------|------------------------|----------------------------------------------|
| FACT_EXECUTIVE_SUMMARY | date_key               | DIM_DATE               | date_key               | 1:1 Mapping via join                         |
| FACT_EXECUTIVE_SUMMARY | institution_id         | DIM_INSTITUTION        | institution_id         | 1:1 Mapping via join                         |
| FACT_EXECUTIVE_SUMMARY | corporation_id         | DIM_CORPORATION        | corporation_id         | 1:1 Mapping via join                         |
| FACT_EXECUTIVE_SUMMARY | product_id             | DIM_PRODUCT            | product_id             | 1:1 Mapping via join                         |
| FACT_EXECUTIVE_SUMMARY | a120_amount            | STG_HOLDING_METRICS    | a120_amount            | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | a120_count             | STG_HOLDING_METRICS    | a120_count             | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | a30_to_59_amount       | STG_HOLDING_METRICS    | a30_to_59_amount       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | a30_to_59_count        | STG_HOLDING_METRICS    | a30_to_59_count        | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | a60_to_89_amount       | STG_HOLDING_METRICS    | a60_to_89_amount       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | a60_to_89_count        | STG_HOLDING_METRICS    | a60_to_89_count        | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | a90_to_119_amount      | STG_HOLDING_METRICS    | a90_to_119_amount      | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | a90_to_119_count       | STG_HOLDING_METRICS    | a90_to_119_count       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | charge_off_amount      | STG_HOLDING_METRICS    | charge_off_amount      | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | charge_off_count       | STG_HOLDING_METRICS    | charge_off_count       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | fraud_amount           | STG_HOLDING_METRICS    | fraud_amount           | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | fraud_count            | STG_HOLDING_METRICS    | fraud_count            | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | income_amount          | STG_HOLDING_METRICS    | income_amount          | Transformation: Null/negative set to 0       |
| FACT_EXECUTIVE_SUMMARY | number_of_accounts     | STG_HOLDING_METRICS    | number_of_accounts     | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | purchases_amount       | STG_HOLDING_METRICS    | purchases_amount       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY | purchases_count        | STG_HOLDING_METRICS    | purchases_count        | 1:1 Mapping                                  |

# 5. Transformation Logic

- **income_amount:**  
  `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`  
  Ensures that income is non-negative and not null.

- **Joins:**  
  - `INNER JOIN` to `DIM_DATE` on `date_key`
  - `INNER JOIN` to `DIM_INSTITUTION` on `institution_id`
  - `INNER JOIN` to `DIM_CORPORATION` on `corporation_id`
  - `INNER JOIN` to `DIM_PRODUCT` on `product_id`

- **Audit Logging:**  
  - Row count of inserted records is captured and printed.

- **Cleanup:**  
  - Temporary table `#staging_metrics` is dropped after processing.

# 6. Complexity Analysis

| Metric                             | Value/Details                                  |
|-------------------------------------|------------------------------------------------|
| Number of Pipeline Activities       | 1 (Stored Procedure)                           |
| Number of Dataflow Transformations  | 1 (income_amount CASE, joins)                  |
| SQL Scripts or Stored Procedures    | 1 (LOAD_FACT_EXECUTIVE_SUMMARY)                |
| Joins Used                         | INNER JOIN (4: DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Lookup Tables or Reference Data     | 4 (dimension tables)                           |
| Parameters/Variables/Triggers       | 2 variables, no explicit parameters/triggers   |
| Number of Output Datasets          | 1 (FACT_EXECUTIVE_SUMMARY)                     |
| Conditional Logic or if-else Flows | 1 (income_amount CASE)                         |
| External Dependencies              | Dimension tables (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Overall Complexity Score           | 35                                             |

# 7. Key Outputs

- **Output Table:** `FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse SQL Table
- **Intended Use:** Enterprise reporting, analytics, and downstream data processing. The table provides validated, enriched summary metrics for holdings across institutions, corporations, products, and dates.

---

**API Cost:**  
apiCost: 0.005 USD