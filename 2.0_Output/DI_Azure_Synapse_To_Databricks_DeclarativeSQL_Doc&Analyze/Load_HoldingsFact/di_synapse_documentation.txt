====================================================
Author:        Ascendion AAVA
Date:          
Description:   Loads FACT_EXECUTIVE_SUMMARY table with summarized holding metrics from staging, applying business rules and data quality checks.
====================================================

## 1. Overview of Pipeline/Component

This Azure Synapse stored procedure (`dbo.LOAD_FACT_EXECUTIVE_SUMMARY`) is designed to load the `FACT_EXECUTIVE_SUMMARY` fact table from the staging table `STG_HOLDING_METRICS`. It performs data quality validation, applies business rule checks, and ensures referential integrity by joining to dimension tables. The procedure supports regulatory reporting and advanced analytics by summarizing holdings data for downstream consumption.

## 2. Component Structure and Design

- **Source:** `dbo.STG_HOLDING_METRICS` (staging table)
- **Copy Activity:** Data is selected into a temporary table `#staging_metrics` from the staging source.
- **Dataflow Transformation:** Joins are performed with dimension tables (`DIM_DATE`, `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`) to enrich and validate the data.
- **Stored Procedure Activity:** The logic is encapsulated in the stored procedure `dbo.LOAD_FACT_EXECUTIVE_SUMMARY`.
- **Sink:** Final data is inserted into `dbo.FACT_EXECUTIVE_SUMMARY` (Synapse fact table).
- **Parameters/Variables:** Uses local variables for row count and error message.
- **Triggers:** Not explicitly defined in the code, but typically executed as part of a scheduled pipeline.

**Connection Flow:**  
1. Data is copied from the staging table to a temp table.  
2. Data is validated and joined with dimension tables.  
3. Business rules are applied (e.g., income amount normalization).  
4. Valid records are inserted into the fact table.  
5. Audit logging and cleanup are performed.

## 3. Data Flow and Processing Logic

**Processed Datasets:**  
- `STG_HOLDING_METRICS` (source/staging)
- `DIM_DATE`
- `DIM_INSTITUTION`
- `DIM_CORPORATION`
- `DIM_PRODUCT`
- `FACT_EXECUTIVE_SUMMARY` (target/fact)

**Data Flow:**  
- Data is staged from `STG_HOLDING_METRICS` into `#staging_metrics`.
- Each record is joined with dimension tables to ensure referential integrity.
- Business rules (e.g., income amount normalization) are applied.
- Validated and enriched records are inserted into `FACT_EXECUTIVE_SUMMARY`.
- Audit logging captures the number of records inserted.

**Business Rules/Transformations:**  
- Income amount is set to 0 if null or negative.
- Only records matching dimension tables are loaded.

## 4. Data Mapping (Lineage)

| Target Table Name         | Target Column Name    | Source Table Name      | Source Column Name      | Remarks                                         |
|--------------------------|----------------------|------------------------|------------------------|-------------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key             | DIM_DATE               | date_key               | 1:1 Mapping via join on date_value              |
| FACT_EXECUTIVE_SUMMARY   | institution_id       | DIM_INSTITUTION        | institution_id         | 1:1 Mapping via join                            |
| FACT_EXECUTIVE_SUMMARY   | corporation_id       | DIM_CORPORATION        | corporation_id         | 1:1 Mapping via join                            |
| FACT_EXECUTIVE_SUMMARY   | product_id           | DIM_PRODUCT            | product_id             | 1:1 Mapping via join                            |
| FACT_EXECUTIVE_SUMMARY   | a120_amount          | STG_HOLDING_METRICS    | a120_amount            | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | a120_count           | STG_HOLDING_METRICS    | a120_count             | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount     | STG_HOLDING_METRICS    | a30_to_59_amount       | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count      | STG_HOLDING_METRICS    | a30_to_59_count        | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount     | STG_HOLDING_METRICS    | a60_to_89_amount       | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count      | STG_HOLDING_METRICS    | a60_to_89_count        | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount    | STG_HOLDING_METRICS    | a90_to_119_amount      | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count     | STG_HOLDING_METRICS    | a90_to_119_count       | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount    | STG_HOLDING_METRICS    | charge_off_amount      | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count     | STG_HOLDING_METRICS    | charge_off_count       | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount         | STG_HOLDING_METRICS    | fraud_amount           | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | fraud_count          | STG_HOLDING_METRICS    | fraud_count            | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | income_amount        | STG_HOLDING_METRICS    | income_amount          | Transformation: Null/negative set to 0          |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts   | STG_HOLDING_METRICS    | number_of_accounts     | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount     | STG_HOLDING_METRICS    | purchases_amount       | 1:1 Mapping                                     |
| FACT_EXECUTIVE_SUMMARY   | purchases_count      | STG_HOLDING_METRICS    | purchases_count        | 1:1 Mapping                                     |

## 5. Transformation Logic

- **income_amount:**  
  `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`  
  Ensures that income amounts are non-negative and not null.

- **Joins:**  
  - `INNER JOIN dbo.DIM_DATE ON dt.date_key = stg.date_value`
  - `INNER JOIN dbo.DIM_INSTITUTION ON inst.institution_id = stg.institution_id`
  - `INNER JOIN dbo.DIM_CORPORATION ON corp.corporation_id = stg.corporation_id`
  - `INNER JOIN dbo.DIM_PRODUCT ON prod.product_id = stg.product_id`

- **Audit Logging:**  
  - Captures row count of inserted records for monitoring.

- **Cleanup:**  
  - Drops temporary staging table after processing.

## 6. Complexity Analysis

| Metric                              | Value/Details                                 |
|--------------------------------------|-----------------------------------------------|
| Number of Pipeline Activities        | 1 (Stored Procedure)                          |
| Number of Dataflow Transformations   | 1 (income_amount transformation)              |
| SQL Scripts or Stored Procedures Used| 1 (LOAD_FACT_EXECUTIVE_SUMMARY)               |
| Joins Used                          | 4 (INNER JOINs to dimension tables)           |
| Lookup Tables or Reference Data      | 4 (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Parameters/Variables/Triggers        | 2 (row count, error message)                  |
| Number of Output Datasets            | 1 (FACT_EXECUTIVE_SUMMARY)                    |
| Conditional Logic or if-else Flows   | 1 (income_amount normalization)               |
| External Dependencies                | None explicit in code (assumes Synapse tables)|
| Overall Complexity Score             | 35                                            |

## 7. Key Outputs

- **Output Table:** `FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse Table (columnar storage, optimized for analytics)
- **Intended Use:** Regulatory reporting, executive dashboards, advanced analytics, ML model input, and downstream data processing.

---

**API Cost:**  
apiCost: 0.007 USD