====================================================
Author:        Ascendion AAVA
Date:          
Description:   Documentation for Synapse pipeline loading FACT_EXECUTIVE_SUMMARY from STG_HOLDING_METRICS
====================================================

# 1. Overview of Pipeline/Component

This Azure Synapse component is a stored procedure (`dbo.LOAD_FACT_EXECUTIVE_SUMMARY`) designed to load the `FACT_EXECUTIVE_SUMMARY` fact table from the staging table `STG_HOLDING_METRICS`. It performs data quality validation, applies business rules, and ensures referential integrity by joining to dimension tables. The procedure supports regulatory reporting and advanced analytics by summarizing holding metrics for downstream consumption.

# 2. Component Structure and Design

- **Source:** `dbo.STG_HOLDING_METRICS` (staging table)
- **Copy Activity:** Data is selected from the staging table into a temporary table `#staging_metrics`.
- **Dataflow Transformation:** Joins are performed with dimension tables (`DIM_DATE`, `DIM_INSTITUTION`, `DIM_CORPORATION`, `DIM_PRODUCT`) to enrich the data.
- **Stored Procedure Activity:** The main logic is encapsulated in the stored procedure.
- **Sink:** `dbo.FACT_EXECUTIVE_SUMMARY` (fact table)
- **Parameters/Variables:** Internal variables for row count and error message.
- **Triggers:** Not explicitly defined in the code, but typically invoked by pipeline orchestration.
- **Connection Flow:** 
    - Data is staged in a temp table.
    - Valid records are inserted into the fact table after joining with dimensions.
    - Audit logging is performed.
    - Temp resources are cleaned up.

# 3. Data Flow and Processing Logic

**Processed Datasets:**
- STG_HOLDING_METRICS (source)
- DIM_DATE
- DIM_INSTITUTION
- DIM_CORPORATION
- DIM_PRODUCT
- FACT_EXECUTIVE_SUMMARY (target)

**Data Flow:**
1. Data is copied from `STG_HOLDING_METRICS` into a temporary staging table.
2. The staging data is joined with dimension tables to ensure referential integrity and enrich records.
3. Business rules (e.g., null/negative income handling) are applied during transformation.
4. Valid records are inserted into `FACT_EXECUTIVE_SUMMARY`.
5. Audit logging captures the number of inserted records.
6. Temporary resources are cleaned up.

**Business Rules/Transformations:**
- Income amounts that are null or negative are set to zero.
- Only records with valid dimension references are loaded.

# 4. Data Mapping (Lineage)

| Target Table Name         | Target Column Name      | Source Table Name      | Source Column Name      | Remarks                                       |
|--------------------------|------------------------|-----------------------|------------------------|-----------------------------------------------|
| FACT_EXECUTIVE_SUMMARY   | date_key               | DIM_DATE              | date_key               | 1:1 Mapping via join on stg.date_value        |
| FACT_EXECUTIVE_SUMMARY   | institution_id         | DIM_INSTITUTION       | institution_id         | 1:1 Mapping via join on stg.institution_id    |
| FACT_EXECUTIVE_SUMMARY   | corporation_id         | DIM_CORPORATION       | corporation_id         | 1:1 Mapping via join on stg.corporation_id    |
| FACT_EXECUTIVE_SUMMARY   | product_id             | DIM_PRODUCT           | product_id             | 1:1 Mapping via join on stg.product_id        |
| FACT_EXECUTIVE_SUMMARY   | a120_amount            | STG_HOLDING_METRICS   | a120_amount            | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a120_count             | STG_HOLDING_METRICS   | a120_count             | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_amount       | STG_HOLDING_METRICS   | a30_to_59_amount       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a30_to_59_count        | STG_HOLDING_METRICS   | a30_to_59_count        | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_amount       | STG_HOLDING_METRICS   | a60_to_89_amount       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a60_to_89_count        | STG_HOLDING_METRICS   | a60_to_89_count        | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_amount      | STG_HOLDING_METRICS   | a90_to_119_amount      | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | a90_to_119_count       | STG_HOLDING_METRICS   | a90_to_119_count       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | charge_off_amount      | STG_HOLDING_METRICS   | charge_off_amount      | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | charge_off_count       | STG_HOLDING_METRICS   | charge_off_count       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | fraud_amount           | STG_HOLDING_METRICS   | fraud_amount           | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | fraud_count            | STG_HOLDING_METRICS   | fraud_count            | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | income_amount          | STG_HOLDING_METRICS   | income_amount          | Transformation: NULL/negative set to zero     |
| FACT_EXECUTIVE_SUMMARY   | number_of_accounts     | STG_HOLDING_METRICS   | number_of_accounts     | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | purchases_amount       | STG_HOLDING_METRICS   | purchases_amount       | 1:1 Mapping                                  |
| FACT_EXECUTIVE_SUMMARY   | purchases_count        | STG_HOLDING_METRICS   | purchases_count        | 1:1 Mapping                                  |

# 5. Transformation Logic

- **income_amount:** 
  - Expression: `CASE WHEN stg.income_amount IS NULL OR stg.income_amount < 0 THEN 0 ELSE stg.income_amount END`
  - Purpose: Ensures income values are non-negative and not null.
- **Joins:** 
  - `INNER JOIN` to dimension tables ensures only valid references are loaded.
- **Audit Logging:** 
  - `@@ROWCOUNT` is used to log the number of inserted records.
- **Temp Table Usage:** 
  - Data is staged in `#staging_metrics` for intermediate processing.

# 6. Complexity Analysis

| Metric                              | Value/Details                                  |
|--------------------------------------|------------------------------------------------|
| Number of Pipeline Activities        | 1 (Stored Procedure)                           |
| Number of Dataflow Transformations   | 1 (Join + CASE transformation)                 |
| SQL Scripts or Stored Procedures Used| 1 (LOAD_FACT_EXECUTIVE_SUMMARY)                |
| Joins Used                          | 4 (INNER JOINs to dimension tables)            |
| Lookup Tables or Reference Data      | 4 (DIM_DATE, DIM_INSTITUTION, DIM_CORPORATION, DIM_PRODUCT) |
| Parameters/Variables/Triggers        | 2 variables, no explicit parameters/triggers   |
| Number of Output Datasets           | 1 (FACT_EXECUTIVE_SUMMARY)                     |
| Conditional Logic or if-else Flows   | 1 (CASE for income_amount)                     |
| External Dependencies                | Dimension tables, staging table                |
| Overall Complexity Score             | 30                                             |

# 7. Key Outputs

- **Output Table:** `FACT_EXECUTIVE_SUMMARY`
- **Format:** Synapse SQL Table
- **Intended Use:** Regulatory reporting, executive dashboards, advanced analytics, and downstream data processing.

---

**API Cost:** apiCost: 0.004 USD