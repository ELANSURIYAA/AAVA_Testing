---
# MarkLogic to MongoDB Migration Plan

## 1. MarkLogic Script Analysis

### 1.1 Key Functions, Queries, and Structures

**Namespaces:**  
- All functions use the namespace `http://example.com/ns`.

**Functions:**
- `ns:load-documents()`: Loads `/documents/doc1.xml` and `/documents/doc2.xml`.
- `ns:insert-document($uri, $content)`: Inserts a new document at the given URI, wraps content in `<doc>`.
- `ns:search-documents($keyword)`: Full-text search using `cts:word-query` and `cts:search`.
- `ns:update-document($uri, $newContent)`: Updates a document’s content at the given URI.
- `ns:delete-document($uri)`: Deletes a document at the given URI.
- `ns:query-example()`: Demonstrates insert and search.
- `ns:main()`: Orchestrates all the above.

**Data Model:**
- Documents are XML, with root elements `<doc>` or `<sample>`, all in the namespace.
- No explicit relationships between documents.

**Indexing:**
- Uses MarkLogic’s default document and word indexes for search.
- No explicit range, reverse, or geospatial indexes.

---

### 1.2 Syntax Differences: MarkLogic vs. MongoDB

| MarkLogic (XQuery)                | MongoDB (JavaScript/Python/Driver)                |
|-----------------------------------|---------------------------------------------------|
| `xdmp:document-load($uri)`        | `db.collection.findOne({uri: $uri})`              |
| `xdmp:document-insert($uri, $doc)`| `db.collection.insertOne({...})` or `.updateOne()`|
| `cts:word-query($keyword)`        | `{ $text: { $search: "keyword" } }`               |
| `cts:search(fn:doc(), $query)`    | `db.collection.find({ $text: { $search: ... } })` |
| `xdmp:document-delete($uri)`      | `db.collection.deleteOne({uri: $uri})`            |
| XML with namespaces               | JSON/BSON, namespaces as fields                   |

---

### 1.3 Areas Requiring Manual Intervention

- **XML to JSON/BSON Transformation:**  
  - XML elements and attributes must be mapped to JSON fields.
  - XML namespaces have no direct equivalent; store as a field (e.g., `"namespace": "http://example.com/ns"`).
  - Nested XML structures require recursive mapping.
- **Query Translation:**  
  - XQuery logic (e.g., `let`, `return`, function composition) must be rewritten in application code (e.g., JavaScript/Python).
  - Full-text search logic must use MongoDB’s text index and query syntax.
- **Indexing:**  
  - Explicitly define text indexes in MongoDB.
- **Error Handling & Logging:**  
  - MarkLogic code lacks error handling; must be implemented in MongoDB application layer.
- **Testing:**  
  - Unit and integration tests must be rewritten for the new environment.

---

## 2. Effort Estimation for Conversion and Testing

### 2.1 Manual Code Fixes (Conversion)

| Task                                      | Estimated Effort (hours) |
|-------------------------------------------|--------------------------|
| XML to JSON/BSON transformation logic     | 8                        |
| Rewriting CRUD operations in app code     | 6                        |
| Search query translation (text search)    | 4                        |
| Index definition and validation           | 2                        |
| Namespace handling (as field)             | 2                        |
| Error handling & logging implementation   | 4                        |
| **Subtotal**                              | **26**                   |

### 2.2 Testing Effort

| Task                                      | Estimated Effort (hours) |
|-------------------------------------------|--------------------------|
| Unit test development for CRUD/search     | 6                        |
| Integration test development              | 6                        |
| Test data setup and migration validation  | 4                        |
| Performance/load testing                  | 4                        |
| **Subtotal**                              | **20**                   |

### 2.3 Total Estimated Effort

- **Manual Code Fixes:** 26 hours
- **Testing:** 20 hours
- **Total:** **46 hours**

---

## 3. MongoDB Pricing and Performance Factors

### 3.1 Data Volume and Query Processing

**Data Volumes (from environment file):**
- DOCUMENTS_XML: ~1 TB
- SEARCH_INDEX: ~500 GB
- TRANSACTION_LOGS: ~200 GB
- OUTPUT_RESULTS: ~100 GB

**Assumption:**  
- 10% of each table is processed per query execution.

### 3.2 MongoDB Atlas Pricing Estimate

- **Storage:**  
  - 1 TB (primary data) + 500 GB (search index) + 200 GB (logs) + 100 GB (results) = **1.8 TB total**
- **Text Indexing:**  
  - MongoDB Atlas charges for storage and compute. Text indexes increase storage usage by ~20-30%.
  - Estimated storage with indexes: **2.2 TB**

- **Cluster Tier Recommendation:**  
  - For 2.2 TB data, a **M60** or **M80** cluster (with sharding) is recommended.
  - **M60** (as of 2024): ~$3.50/hour (~$2,500/month)
  - **M80**: ~$7.00/hour (~$5,000/month)
  - (Pricing may vary by region and backup/replica settings.)

- **Query Execution Cost:**  
  - Each query processes ~10% of data (180 GB/query).
  - MongoDB Atlas includes compute in the cluster cost; high query concurrency may require scaling up.
  - For heavy search workloads, consider **Atlas Search** (included in cluster cost).

### 3.3 Cost Breakdown

| Resource         | Estimate (monthly) |
|------------------|-------------------|
| Storage (2.2 TB) | Included in M60/M80|
| Compute (M60)    | ~$2,500           |
| Compute (M80)    | ~$5,000           |
| Backups          | +10%               |
| **Total**        | **$2,750–$5,500**  |

- **Note:** Actual cost depends on region, backup, and replica requirements.  
- **Performance:** Proper indexing (text on `content`, `title`, `body`; unique on `uri`) is essential for search and CRUD efficiency.

---

## 4. Structured Migration Plan

### 4.1 Migration Steps

1. **Schema Mapping**
   - Map MarkLogic URIs to MongoDB collections (e.g., `/documents/` → `documents`, `/examples/` → `examples`).
   - Define JSON/BSON schema for each document type.

2. **Data Transformation**
   - Develop scripts to convert XML documents to JSON/BSON.
   - Store namespace as a field.
   - Preserve all content fields.

3. **Indexing Strategy**
   - Create text indexes on `content`, `title`, `body`.
   - Create unique index on `uri`.
   - Add additional indexes as needed for query optimization.

4. **Code Conversion**
   - Rewrite CRUD and search operations in application code (e.g., Node.js, Python).
   - Replace XQuery logic with MongoDB driver queries.
   - Implement error handling and logging.

5. **Testing**
   - Develop unit tests for all CRUD and search operations.
   - Develop integration tests for end-to-end flows.
   - Validate data integrity and search accuracy.
   - Conduct performance/load testing.

6. **Deployment and Monitoring**
   - Deploy to MongoDB Atlas (M60/M80 cluster).
   - Set up monitoring and alerting.
   - Optimize indexes and queries based on workload.

---

### 4.2 Manual Fixes and Testing Effort

| Task                       | Effort (hours) |
|----------------------------|---------------|
| Manual Code Fixes          | 26            |
| Unit & Integration Testing | 20            |
| **Total**                  | **46**        |

---

### 4.3 Estimated MongoDB Cost

- **Monthly Cost:** $2,750–$5,500 (storage, compute, and backups for 2.2 TB data, M60/M80 cluster)
- **Query Cost:** Included in cluster cost; ensure proper indexing for performance.

---

## 5. Summary Table

| Area                  | Details / Recommendations                                                |
|-----------------------|--------------------------------------------------------------------------|
| Code Complexity       | Low–Moderate (CRUD + search, straightforward mapping)                    |
| Manual Fixes Needed   | XML→JSON mapping, query translation, error handling, logging             |
| Testing Effort        | Unit, integration, and performance tests                                 |
| Indexing Strategy     | Text index on search fields, unique index on `uri`                       |
| Estimated Effort      | 46 hours (26 for code, 20 for testing)                                   |
| Estimated Cost        | $2,750–$5,500/month (MongoDB Atlas M60/M80, 2.2 TB data + indexes)       |
| Performance           | Comparable to MarkLogic; optimize with proper indexes                    |
| Manual Intervention   | Required for XML/namespace handling, query translation, error handling   |
| Additional Notes      | Implement robust logging and monitoring in MongoDB application layer      |

---

## 6. Action Items for Technical Team

1. **Review and approve schema mapping and transformation scripts.**
2. **Develop and test data migration scripts (XML→JSON/BSON).**
3. **Set up MongoDB Atlas cluster and indexes.**
4. **Rewrite application logic for CRUD/search in MongoDB.**
5. **Implement error handling and logging.**
6. **Develop and execute unit/integration/performance tests.**
7. **Monitor and optimize MongoDB cluster post-migration.**

---

## 7. References

- **MarkLogic Code:** See attached Marklogic_Code.txt
- **MongoDB Atlas Pricing:** https://www.mongodb.com/atlas/pricing
- **MongoDB Text Indexes:** https://docs.mongodb.com/manual/core/index-text/
- **Data Volumes:** See attached Marklogic_Code%20env.txt

---

**This plan provides a clear, actionable roadmap for migrating from MarkLogic to MongoDB, including code analysis, manual intervention points, effort estimation, and cost breakdown.**