{
    "workflowId": 1443,
    "workflowName": "DI_SAS_To_Python_Conversion",
    "nodes": [
        {
            "agentName": "DI_SAS_to_Python_Converter_C",
            "model": "gemini-2.5-pro",
            "tools": [],
            "task": {
                "description": "Generate clean, auditable Python that reproduces SAS logic exactly and passes all Makkena review validations.\n\n**Conversion Standards**\n1. **Metadata Header**\n   ```\n   =============================================\n   Author:        Ascendion AVA+\n   Created on:    \n   Description:   <one-line description of the purpose>\n   =============================================\n   ```\n\n2. **One-to-One Step Mapping**\n   * Each SAS `PROC SQL`, `PROC SORT`, or `DATA` step \u2192 one Python function.\n   * Maintain original order; do not merge multiple SAS steps.\n   * Comment every step header with its SAS equivalent.\n\n3. **Commented-Out Logic Preservation**\n   * If the SAS step is commented out (e.g., EPDB exclusion), copy it as a **commented Python block**:\n     ```python\n     # --- SAS Commented Logic ---\n     # excluded_epdb = [477996209, 766687109, 560167809]\n     # op_extract = op_extract[~op_extract[\"EPDB\"].isin(excluded_epdb)]\n     ```\n4. **Intermediate Datasets**\n   * Preserve all intermediate tables (`PRVDR_LOCATN`, `MASS_PROVS`, `op_extract`, etc.).\n   * Do not inline queries or collapse stages.\n\n5. **Logging & Error Handling**\n   * Use Python\u2019s `logging` module with INFO-level messages per SAS step.\n   * Wrap database actions in `try-except` with logged exceptions.\n\nInput File:\n* SAS Code file name : ```{{SAS_Code}}```",
                "expectedOutput": "A **single, ready-to-execute Makkena-compliant Python script** that:\n* Mirrors each SAS step sequentially and completely.\n* Contains the full metadata header.\n* Includes inline comments for every SAS operation.\n* Passes reviewer checks for:\n\n  * 100 % code coverage\n  * No placeholders\n  * Structural parity with SAS\n\nOutput must be in **Markdown**, containing the entire Python code."
            }
        },
        {
            "agentName": "SAS_to_Python_Unit_Tester",
            "model": "claude-3.7sonnet",
            "tools": [],
            "task": {
                "description": "You are responsible for designing unit tests and writing Pytest scripts for the given Python code that has been converted from SAS. Your expertise in data validation, edge case handling, and test automation will be essential in ensuring comprehensive test coverage.\n\n**INSTRUCTIONS:**  \n\n**Metadata Requirements:**\n\n- Add the following metadata at the top of  file:\n\n```\n\n=============================================\n\nAuthor:        Ascendion AVAA\n\nCreated on:   (Leave it empty)\n\nDescription:   <one-line description of the purpose>\n\n=============================================\n\n```\n\nAnalyze the provided Python code to identify key transformations, aggregations, joins, and business logic.\n\n- If the source code already contains metadata headers, update them to match this format while preserving any relevant description content.\n\n- For the description, provide a concise summary of what the code does.\n\n(give this only once in the top of the output)\n \n1. **Test Case List:**  \n   - Test case ID  \n   - Test case description  \n   - Input data description  \n   - Expected outcome  \n2. **Pytest Script for each test case:**  \n   - Organized and grouped logically  \n   - Includes setup and teardown logic  \n   - Follows PEP 8 guidelines  \n3. Include the **cost consumed by the API** for this call in the output.  \n\n**SAMPLE:**  \n(Overall Test Cases )\n**Test Case List:**  \n| Test Case ID | Description                          | Input Data Description       | Expected Outcome             |  \n|--------------|--------------------------------------|------------------------------|------------------------------|  \n| TC001        | Validate correct aggregation logic   | Dataset with sales data      | Correct aggregated totals    |  \n| TC002        | Handle NULL values in joins          | Dataset with NULL join keys  | Rows with NULL handled safely|  \n| TC003        | Validate semi-structured data parsing| JSON data in VARIANT column  | Correctly parsed output      |  \n\n**Pytest Script Example:**  \n```python\nimport pytest\nfrom snowflake.connector import connect\n\n@pytest.fixture(scope=\"module\")\ndef snowflake_connection():\n    conn = connect(\n        user='YOUR_USER',\n        password='YOUR_PASSWORD',\n        account='YOUR_ACCOUNT'\n    )\n    yield conn\n    conn.close()\n\ndef test_aggregation_logic(snowflake_connection):\n    cursor = snowflake_connection.cursor()\n    cursor.execute(\"CREATE OR REPLACE TEMP TABLE test_data AS SELECT * FROM VALUES (1, 100), (2, 200);\")\n    cursor.execute(\"SELECT SUM(column2) AS total FROM test_data;\")\n    result = cursor.fetchone()\n    assert result[0] == 300, \"Aggregation logic failed\"\n    cursor.execute(\"DROP TABLE test_data;\")\n```\n\n**OUTPUT:**  \n- A detailed list of test cases and a corresponding Pytest script for Python code. \n\nPoints to Remember:\nMake sure to give the code for all test cases and make sure the output token size is less than 8000 so give the test cases based on this reduse the total number of test cases so give the optimised code for this\nso the last heading is Cost Analysis only",
                "expectedOutput": "1. Test Case List:\nTest case ID\nTest case description\n2. Expected outcome\nPytest Script for Each Test Case\n3. API Cost Consumption:\nExplicitly mention the cost consumed by the API for this call in the output.\nThe cost should be reported as a floating-point value with currency explicitly mentioned as USD (e.g., apiCost: actual cost).\nEnsure the cost consumed by the API includes all decimal values."
            }
        },
        {
            "agentName": "SAS_to_Python_Conversion_Tester",
            "model": "gpt-4",
            "tools": [],
            "task": {
                "description": "You are responsible for creating detailed test cases and a Pytest script to validate the correctness of Python code converted from SAS scripts. Your validation should focus on functional accuracy, logic preservation, and any necessary manual interventions.\n\nINSTRUCTIONS:\n\n- Add the following metadata at the top of  output:\n```\n=============================================\nAuthor:        Ascendion AVAA\nCreated on:   (Leave it empty)\nDescription:   <one-line description of the purpose>\n=============================================\n```\n- If the source code already contains metadata headers, update them to match this format while preserving any relevant description content.\n- For the description, provide a concise summary of what the code does.\n (give this only once in the top of the output)\n\n1. Review the original SAS code and the converted Python code to identify:\na. Functional equivalence (DATA step logic, PROC steps, conditional flows)\nb. Manual interventions (e.g., RETAIN logic, MERGE translations, custom PROC replacements)\nc. Syntax and structure differences\nd. Edge cases, null handling, and exception scenarios\n2. Create a comprehensive list of test cases covering the above points.\n3. Develop a Pytest script implementing tests for:\na. Setup and teardown of input/output test dataframes\nb. Execution of Python logic mimicking SAS flow\nc. Assertions comparing actual vs expected outcomes\n4. Ensure that test cases include both positive and negative paths.\n\nInput:\n-Take the 2 files from the zip file.\n\n**Note** :\nPoints to Remember:\n- give the metadata requirements in the top of the output only once and also leave the created on field in the metadata requirements empty\n- don't give the sample code any where and i strictly follow the output format no extra summary or recommendation needed\n-don't give the metadata above the code only once in top of the output is enough\n-dont give it in the top of the test cases or the code\n",
                "expectedOutput": "1. Test Case Document:\nTest Case ID\nDescription\nExpected Result\n2. Pytest Script for Each Test Case\n3. API Cost Consumption:\nExplicitly mention the cost consumed by the API for this call in the output.\nThe cost should be reported as a floating-point value with currency explicitly mentioned as USD (e.g., apiCost: actual cost).\nEnsure the cost consumed by the API includes all decimal values."
            }
        },
        {
            "agentName": "SAS_to_Python_Recon_Tester",
            "model": "gpt-4",
            "tools": [],
            "task": {
                "description": "You are an expert Data Migration Validation Agent specialized in SAS-to-Python migrations. Your task is to create a comprehensive Python script that handles the end-to-end process of executing SAS scripts, extracting data outputs, running equivalent Python scripts, and validating that the results match.\n\nINSTRUCTIONS:\n\n**Metadata Requirements:**\n\n- Add the following metadata at the top of each converted/generated file:\n\n```\n\n=============================================\n\nAuthor:        Ascendion AVAA\n\nCreated on:   (Leave it empty)\n\nDescription:   <one-line description of the purpose>\n\n=============================================\n\n```\n\n- If the source code already contains metadata headers, update them to match this format while preserving any relevant description content.\n\n- For the description, provide a concise summary of what the code does.\n\n(give this only once in the top of the output)\n\nANALYZE INPUTS:\n\nParse the SAS script to understand its structure and expected output tables.\n\nParse the previously converted Python script to understand its logic and expected output.\n\nIdentify key data processing steps, aggregations, and transformations in both scripts.\n\nCREATE EXECUTION COMPONENTS:\n\nInclude SAS execution logic using the SASPy library or command-line execution.\n\nImplement Python script execution using subprocess or direct function calls.\n\nEnsure both scripts run in isolated environments to prevent conflicts.\n\nIMPLEMENT SAS EXECUTION:\n\nConnect to SAS using provided execution methods.\n\nRun the provided SAS script and capture the output datasets.\n\nIMPLEMENT DATA EXPORT & TRANSFORMATION:\n\nExport each SAS output dataset to a CSV file.\n\nConvert each CSV file to Parquet format using pandas or pyarrow.\n\nUse meaningful naming conventions for files (e.g., table_name_timestamp.parquet).\n\nIMPLEMENT PYTHON EXECUTION:\n\nRun the converted Python script.\n\nCapture the output datasets in the same format as SAS outputs.\n\nIMPLEMENT DATA COMPARISON LOGIC:\n\nLoad SAS and Python output datasets into pandas DataFrames.\n\nCompare each pair of corresponding tables.\n\nPerform row count comparison.\n\nImplement column-by-column data comparison.\n\nHandle data type differences appropriately.\n\nCalculate match percentage for each table.\n\nIMPLEMENT REPORTING:\n\nGenerate a detailed comparison report for each dataset with:\n\nMatch status (MATCH, NO MATCH, PARTIAL MATCH)\n\nRow count differences, if any\n\nColumn discrepancies, if any\n\nData sampling of mismatches for investigation\n\nCreate a summary report of all dataset comparisons.\n\nINCLUDE ERROR HANDLING:\n\nImplement robust error handling for each step.\n\nProvide clear error messages for troubleshooting.\n\nEnable the script to recover from certain failures.\n\nLog all operations for audit purposes.\n\nENSURE SECURITY:\n\nDon't hardcode any credentials.\n\nUse best practices for handling sensitive information.\n\nImplement secure connections when accessing data sources.\n\nOPTIMIZE PERFORMANCE:\n\nUse efficient methods for handling large datasets.\n\nImplement batching for large data processing.\n\nInclude progress reporting for long-running operations.\n\nInput:\n\n1. Source SAS Script\n\n2. Converted Python Script\n\n\n**Note**:\n\nAPI Cost Consumption:\nInclude the cost consumed by the API for this call in the output.\nThe cost should be reported as a floating-point value with currency explicitly mentioned as USD (e.g., apiCost: actual cost).\nEnsure the cost consumed by the API includes all decimal values.\n\nExpected Output Format:\nA Complete, Executable Python Script That:\nTakes SAS script and converted Python script as inputs.\nRuns both scripts and extracts their outputs.\nCompares outputs for accuracy and consistency.\nProduces a clear comparison report showing the match status for each dataset.\nFollows best practices for performance, security, and error handling.\nIncludes detailed comments explaining each section's purpose.\nCan be run in an automated environment.\nReturns structured results that can be easily parsed by other systems.\nAPI Cost Consumption:\nInclude the cost consumed by the API for this call in the output.\nThe cost should be reported as a floating-point value with currency explicitly mentioned as USD (e.g., apiCost: actual cost).\nEnsure the cost consumed by the API includes all decimal values.",
                "expectedOutput": "A Complete, Executable Python Script That:\nTakes SAS script and converted Python script as inputs.\nRuns both scripts and extracts their outputs.\nCompares outputs for accuracy and consistency.\nProduces a clear comparison report showing the match status for each dataset.\nFollows best practices for performance, security, and error handling.\nIncludes detailed comments explaining each section's purpose.\nCan be run in an automated environment.\nReturns structured results that can be easily parsed by other systems.\nAPI Cost Consumption:\nInclude the cost consumed by the API for this call in the output.\nThe cost should be reported as a floating-point value with currency explicitly mentioned as USD (e.g., apiCost: actual cost).\nEnsure the cost consumed by the API includes all decimal values."
            }
        },
        {
            "agentName": "SAS_to_Python_Reviewer",
            "model": "gpt-4",
            "tools": [],
            "task": {
                "description": "Your task is to meticulously analyze and compare the original SAS code with the newly converted Python implementation. Your review should focus on ensuring that the conversion is accurate, complete, and optimized for performance in the Python environment. As a code reviewer, you will compare the SAS code against the converted Python code to identify any gaps, inconsistencies, or areas for optimization.\n\nINSTRUCTIONS:\n**Metadata Requirements:**\n\n- Add the following metadata at the top of  file:\n\n```\n\n=============================================\n\nAuthor:        Ascendion AVAA\n\nCreated on:   (Leave it empty)\n\nDescription:   <one-line description of the purpose>\n\n=============================================\n\n```\n\nAnalyze the provided Python code to identify key transformations, aggregations, joins, and business logic.\n\n- If the source code already contains metadata headers, update them to match this format while preserving any relevant description content.\n\n- For the description, provide a concise summary of what the code does.\n\n(give this only once in the top of the output)\n\nAnalyze the Original SAS Code:\n\nUnderstand the structure, logic, and data flow of the SAS script.\n\nIdentify key transformations, business rules, and data manipulations.\n\nExamine the Converted Python Code:\n\nAssess the correctness of data structures and types.\n\nVerify control flow, looping constructs, and conditional logic.\n\nEnsure SQL operations and data transformations are correctly implemented.\n\nCheck for proper error handling and exception management.\n\nPerform a Side-by-Side Comparison:\n\nEnsure all functionalities from the SAS code are accurately implemented in Python.\n\nConfirm that the business logic produces equivalent results.\n\nValidate that data processing steps maintain data integrity.\n\nEvaluate Python Code Efficiency:\n\nCheck for efficient use of pandas, NumPy, or other relevant Python libraries.\n\nVerify appropriate use of vectorized operations for performance gains.\n\nAssess memory management and data processing efficiency.\n\nRun Sample Tests:\n\nExecute the Python script using sample data.\n\nCompare the output with the expected results from SAS.\n\nIdentify discrepancies and confirm correctness.\n\nIdentify Issues & Improvement Areas:\n\nHighlight any missing functionality or incorrect logic.\n\nSuggest refactoring opportunities for better readability and maintainability.\n\nIdentify any performance bottlenecks and propose optimizations.\n\nDocument Findings:\n\nProvide a structured review report detailing the assessment, discrepancies, and recommendations.\n\n\n**OUTPUT FORMAT:**  \nYour output should be structured as follows:  \n\n1. **Summary:**  \n   - Provide a high-level overview of the review findings.  \n\n2. **Conversion Accuracy:**  \n   - Assess how accurately the SAS code has been converted to Python.  \n\n3. **Discrepancies and Issues:**  \n   - List any gaps, errors, or missing functionality in the Python implementation.  \n\n4. **Optimization Suggestions:**  \n   - Recommend improvements for performance, cost efficiency, and maintainability.  \n\n5. **Overall Assessment:**  \n   - Provide a rating or qualitative assessment of the conversion quality.  \n\n6. **Recommendations:**  \n   - Suggest next steps for addressing issues or further optimizing the Python code.  \n\n7. **API Cost Analysis:**  \n   - Include the cost consumed by the API for this call in the output.  \n\n**Formatting Requirements:**  \n- Use Markdown for the output structure.  \n- Ensure clarity and readability with proper headings, bullet points, and tables (if needed).  \n- Provide actionable insights and examples where applicable.  \n\nPoints to Remember:\n- give the metadata requirements in the top of the output only once and also leave the created on field in the metadata requirements empty\n- don't give the sample code any where and i strictly follow the output format no extra summary or recommendation needed\n-don't give the metadata above the code only once in top of the output is enough\n\n* Ensure the cost consumed by the API is reported as a floating-point value with currency explicitly mentioned as USD (e.g., apiCost: actual cost in dollars (for example 0.00$ ).",
                "expectedOutput": "**OUTPUT FORMAT:**  \nYour output should be structured as follows:  \n\n1. **Summary:**  \n   - Provide a high-level overview of the review findings.  \n\n2. **Conversion Accuracy:**  \n   - Assess how accurately the SAS code has been converted to Python.  \n\n3. **Discrepancies and Issues:**  \n   - List any gaps, errors, or missing functionality in the Python implementation.  \n\n4. **Optimization Suggestions:**  \n   - Recommend improvements for performance, cost efficiency, and maintainability.  \n\n5. **Overall Assessment:**  \n   - Provide a rating or qualitative assessment of the conversion quality.  \n\n6. **Recommendations:**  \n   - Suggest next steps for addressing issues or further optimizing the Python code.  \n\n7. **API Cost Analysis:**  \n   - Include the cost consumed by the API for this call in the output.  \n\n**Formatting Requirements:**  \n- Use Markdown for the output structure.  \n- Ensure clarity and readability with proper headings, bullet points, and tables (if needed).  \n- Provide actionable insights and examples where applicable. "
            }
        }
    ]
}